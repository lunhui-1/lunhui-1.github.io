<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的世界全版本指令辅助 | 轮回道尘</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JSZip & FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- i18next 多语言支持 -->
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.16/dist/umd/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
    
    <!-- Highlight.js 语法高亮 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    
    <!-- Three.js for 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- SkinView3D -->
    <script src="https://cdn.jsdelivr.net/npm/skinview3d@3.0.1/dist/skinview3d.min.js"></script>
    
    <!-- NBTify -->
    <script src="https://cdn.jsdelivr.net/npm/nbtify@2.2.0/dist/index.umd.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+SC:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --mc-green: #5D8C3A;
            --mc-dark-green: #3D6E2E;
            --mc-light-green: #7EB356;
            --mc-orange: #d97706;
            --mc-red: #dc2626;
            --mc-blue: #2563eb;
            --mc-cyan: #06b6d4;
            --mc-gold: #fbbf24;
            --mc-purple: #9333ea;
            --sidebar-width: 280px;
            --toolbar-width: 60px;
            --bg-dark: #0a0f1c;
            --glass-bg: rgba(20, 25, 40, 0.95);
            --hover-bg: rgba(93, 140, 58, 0.15);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Noto Sans SC', sans-serif; 
            background: var(--bg-dark); 
            color: #e2e8f0; 
            margin: 0; 
            min-height: 100vh; 
            overflow-x: hidden;
        }
        
        .pixel-font { font-family: 'VT323', monospace; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }
        
        /* Minecraft Block Background Pattern */
        .mc-block-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3;
            background-color: var(--bg-dark);
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 31px, rgba(93,140,58,0.03) 31px, rgba(93,140,58,0.03) 32px),
                repeating-linear-gradient(90deg, transparent, transparent 31px, rgba(93,140,58,0.03) 31px, rgba(93,140,58,0.03) 32px);
        }
        
        /* Animated particles */
        .particles { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -2; 
            overflow: hidden; 
            pointer-events: none; 
        }
        .particle { 
            position: absolute; 
            width: 4px; 
            height: 4px; 
            background: var(--mc-green); 
            border-radius: 0;
            opacity: 0.6; 
            animation: float-up linear infinite;
            box-shadow: 0 0 6px var(--mc-green);
        }
        @keyframes float-up { 
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 
            10% { opacity: 0.8; } 
            90% { opacity: 0.8; } 
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; } 
        }
        
        /* Toolbar */
        .toolbar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: var(--toolbar-width);
            background: linear-gradient(180deg, rgba(15,20,30,0.98), rgba(10,15,25,0.98));
            border-right: 2px solid rgba(93,140,58,0.3);
            z-index: 101;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            transition: width 0.3s ease;
        }
        
        .toolbar.expanded {
            width: 200px;
        }
        
        .toolbar-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid var(--mc-green);
        }
        .toolbar-logo:hover { transform: scale(1.1); }
        
        .toolbar-item {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            margin: 4px 0;
            transition: all 0.2s;
            color: #94a3b8;
            position: relative;
        }
        .toolbar-item:hover {
            background: rgba(93,140,58,0.2);
            color: var(--mc-light-green);
        }
        .toolbar-item.active {
            background: linear-gradient(135deg, var(--mc-green), var(--mc-dark-green));
            color: #fff;
        }
        .toolbar-item i { font-size: 1.3rem; }
        
        .toolbar-tooltip {
            position: absolute;
            left: 60px;
            background: rgba(0,0,0,0.9);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 102;
        }
        .toolbar-item:hover .toolbar-tooltip { opacity: 1; }
        
        /* Sidebar */
        .sidebar { 
            position: fixed; 
            left: var(--toolbar-width);
            top: 0; 
            height: 100vh; 
            width: var(--sidebar-width); 
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); 
            border-right: 1px solid rgba(255,255,255,0.08); 
            z-index: 100; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
            overflow-x: hidden; 
            transition: transform 0.3s ease; 
        }
        
        .logo-area { 
            padding: 20px 16px; 
            border-bottom: 1px solid rgba(255,255,255,0.08); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        .logo-img { 
            width: 40px; 
            height: 40px; 
            border-radius: 8px; 
            object-fit: cover; 
            border: 2px solid var(--mc-green);
            box-shadow: 0 0 15px rgba(93,140,58,0.3);
        }
        .logo-text h1 { 
            font-size: 1.1rem; 
            font-weight: 700; 
            background: linear-gradient(90deg, #fff, var(--mc-light-green)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin: 0; 
            line-height: 1.2; 
        }
        .logo-text span { 
            font-size: 0.7rem; 
            color: #64748b; 
        }
        
        .nav-container { flex: 1; padding: 12px 10px; }
        .nav-section { margin-bottom: 4px; }
        .nav-parent { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 10px 14px; 
            border-radius: 10px; 
            cursor: pointer; 
            color: #94a3b8; 
            transition: all 0.2s; 
            margin-bottom: 4px; 
            font-weight: 500; 
            font-size: 0.9rem;
        }
        .nav-parent:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-parent.active { background: var(--hover-bg); color: var(--mc-light-green); }
        .nav-parent-left { display: flex; align-items: center; gap: 10px; }
        .nav-icon { width: 20px; text-align: center; font-size: 1rem; }
        .expand-icon { font-size: 0.75rem; transition: transform 0.3s; }
        .nav-parent.expanded .expand-icon { transform: rotate(180deg); }
        .nav-children { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding-left: 6px; }
        .nav-parent.expanded + .nav-children { max-height: 800px; }
        .nav-child { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 8px 14px 8px 36px; 
            margin: 2px 0; 
            border-radius: 8px; 
            cursor: pointer; 
            color: #94a3b8; 
            font-size: 0.85rem; 
            transition: all 0.2s; 
            position: relative; 
        }
        .nav-child::before { 
            content: ''; 
            position: absolute; 
            left: 22px; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 4px; 
            height: 4px; 
            background: currentColor; 
            border-radius: 50%; 
            opacity: 0.5; 
        }
        .nav-child:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-child.active { background: rgba(93,140,58,0.2); color: var(--mc-light-green); }
        .nav-child.active::before { background: var(--mc-light-green); opacity: 1; }
        
        .nav-divider { 
            font-size: 0.65rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
            color: #64748b; 
            padding: 14px 14px 6px; 
            font-weight: 600; 
        }
        
        .sidebar-footer { 
            padding: 14px; 
            border-top: 1px solid rgba(255,255,255,0.08); 
            background: rgba(0,0,0,0.2); 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
        }
        .stat-box { 
            background: rgba(255,255,255,0.05); 
            border-radius: 8px; 
            padding: 10px; 
            text-align: center; 
        }
        .stat-value { 
            font-family: 'VT323', monospace; 
            font-size: 1.6rem; 
            color: var(--mc-light-green); 
            line-height: 1; 
        }
        .stat-label { 
            font-size: 0.65rem; 
            color: #64748b; 
            margin-top: 2px; 
        }
        
        /* Main Content */
        .main-content { 
            margin-left: calc(var(--toolbar-width) + var(--sidebar-width)); 
            min-height: 100vh; 
            padding: 24px; 
            transition: margin-left 0.3s; 
        }
        
        .page-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            padding-bottom: 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.08); 
            flex-wrap: wrap; 
            gap: 16px; 
        }
        .page-title { 
            font-size: 1.6rem; 
            font-weight: 700; 
            background: linear-gradient(90deg, #fff, var(--mc-light-green)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        .page-subtitle { 
            font-size: 0.85rem; 
            color: #64748b; 
            margin-top: 4px; 
        }
        
        /* Cards */
        .content-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 16px; 
        }
        .card { 
            background: linear-gradient(135deg, rgba(30,41,59,0.8), rgba(15,23,42,0.9)); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 14px; 
            padding: 18px; 
            cursor: pointer; 
            transition: all 0.3s; 
            position: relative; 
            overflow: hidden; 
        }
        .card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 3px; 
            background: linear-gradient(90deg, var(--mc-green), var(--mc-gold)); 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        .card:hover { 
            transform: translateY(-4px); 
            border-color: rgba(93,140,58,0.4); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
        }
        .card:hover::before { opacity: 1; }
        .card-cmd { border-top: 3px solid var(--mc-green); }
        .card-block { border-top: 3px solid var(--mc-orange); }
        .card-redstone { border-top: 3px solid var(--mc-red); }
        .card-item { border-top: 3px solid var(--mc-blue); }
        .card-adv { border-top: 3px solid var(--mc-cyan); }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: start; 
            margin-bottom: 10px; 
        }
        .card-title { 
            font-family: 'VT323', monospace; 
            font-size: 1.4rem; 
            color: #fff; 
            margin: 0; 
            line-height: 1.2; 
        }
        .card-version { 
            font-size: 0.7rem; 
            color: #64748b; 
            background: rgba(0,0,0,0.3); 
            padding: 3px 6px; 
            border-radius: 4px; 
            font-family: 'JetBrains Mono', monospace; 
        }
        .card-desc { 
            color: #94a3b8; 
            font-size: 0.85rem; 
            line-height: 1.5; 
            display: -webkit-box; 
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
        }
        
        .tag { 
            padding: 3px 8px; 
            background: rgba(93,140,58,0.2); 
            color: var(--mc-light-green); 
            border-radius: 5px; 
            font-size: 0.75rem; 
            font-weight: 500; 
        }
        .tag-red { background: rgba(220,38,38,0.2); color: #fca5a5; }
        .tag-blue { background: rgba(37,99,235,0.2); color: #60a5fa; }
        .tag-cyan { background: rgba(6,182,212,0.2); color: #22d3ee; }
        .tag-orange { background: rgba(217,119,6,0.2); color: #fbbf24; }
        .tag-purple { background: rgba(147,51,234,0.2); color: #c084fc; }
        .tag-gold { background: rgba(251,191,36,0.2); color: #fbbf24; }
        
        .id-block { 
            background: rgba(0,0,0,0.4); 
            padding: 8px 12px; 
            border-radius: 6px; 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.85rem; 
            color: var(--mc-gold); 
            border: 1px solid rgba(251,191,36,0.3); 
            margin-top: 10px; 
            cursor: pointer; 
            transition: all 0.2s; 
            word-break: break-all; 
        }
        .id-block:hover { border-color: var(--mc-gold); background: rgba(251,191,36,0.1); }
        
        /* Input Areas */
        .input-area { 
            background: rgba(30,41,59,0.6); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 14px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        
        .command-textarea { 
            width: 100%; 
            min-height: 180px; 
            background: rgba(0,0,0,0.4); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; 
            padding: 14px; 
            color: #e2e8f0; 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.85rem; 
            line-height: 1.6; 
            resize: vertical; 
            transition: all 0.3s; 
        }
        .command-textarea:focus { 
            outline: none; 
            border-color: var(--mc-green); 
            box-shadow: 0 0 0 3px rgba(93,140,58,0.1); 
        }
        
        .search-box { position: relative; margin-bottom: 20px; }
        .search-input { 
            width: 100%; 
            padding: 12px 18px; 
            background: rgba(30,41,59,0.6); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; 
            color: #fff; 
            font-size: 0.9rem; 
            transition: all 0.3s; 
        }
        .search-input:focus { 
            outline: none; 
            border-color: var(--mc-green); 
            box-shadow: 0 0 0 3px rgba(93,140,58,0.1); 
        }
        
        .filter-chips { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin-bottom: 20px; 
        }
        .chip { 
            padding: 6px 14px; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 50px; 
            font-size: 0.8rem; 
            cursor: pointer; 
            transition: all 0.2s; 
            color: #cbd5e1; 
        }
        .chip:hover { background: rgba(93,140,58,0.1); border-color: rgba(93,140,58,0.3); }
        .chip.active { 
            background: linear-gradient(135deg, var(--mc-green), var(--mc-dark-green)); 
            border-color: transparent; 
            color: #fff; 
        }
        
        /* Buttons */
        .btn { 
            padding: 10px 20px; 
            border-radius: 10px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
            border: none; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.9rem; 
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--mc-green), var(--mc-dark-green)); 
            color: #fff; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(93,140,58,0.3); 
        }
        .btn-secondary { 
            background: rgba(255,255,255,0.1); 
            color: #e2e8f0; 
            border: 1px solid rgba(255,255,255,0.2); 
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.15); }
        .btn-gold { 
            background: linear-gradient(135deg, var(--mc-gold), #f59e0b); 
            color: #000; 
        }
        .btn-gold:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(251,191,36,0.3); 
        }
        .btn-purple { 
            background: linear-gradient(135deg, var(--mc-purple), #7c3aed); 
            color: #fff; 
        }
        .btn-purple:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(147,51,234,0.3); 
        }
        
        .action-buttons { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            margin-top: 14px; 
        }
        
        /* Tab Group */
        .tab-group { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding-bottom: 14px; 
            flex-wrap: wrap; 
        }
        .tab-btn { 
            padding: 8px 16px; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; 
            color: #94a3b8; 
            cursor: pointer; 
            transition: all 0.2s; 
            font-weight: 500; 
            font-size: 0.85rem;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .tab-btn.active { 
            background: linear-gradient(135deg, var(--mc-green), var(--mc-dark-green)); 
            border-color: transparent; 
            color: #fff; 
        }
        
        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(10px); 
            z-index: 200; 
            overflow-y: auto; 
            padding: 20px; 
        }
        .modal-content { 
            background: linear-gradient(135deg, rgba(30,41,59,0.98), rgba(15,23,42,0.98)); 
            border: 1px solid rgba(93,140,58,0.3); 
            border-radius: 20px; 
            max-width: 900px; 
            margin: 40px auto; 
            padding: 28px; 
            position: relative; 
            max-height: 90vh; 
            overflow-y: auto; 
        }
        .modal-close { 
            position: absolute; 
            top: 16px; 
            right: 16px; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: #94a3b8; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s; 
        }
        .modal-close:hover { 
            background: rgba(220,38,38,0.2); 
            color: #fff; 
            transform: rotate(90deg); 
        }
        
        /* Toast */
        .toast { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%) translateY(100px); 
            background: linear-gradient(135deg, var(--mc-green), var(--mc-dark-green)); 
            color: #fff; 
            padding: 14px 28px; 
            border-radius: 50px; 
            font-weight: 500; 
            z-index: 3000; 
            opacity: 0; 
            transition: all 0.3s; 
            border: 1px solid rgba(255,255,255,0.2); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            max-width: 90vw; 
            text-align: center; 
            font-size: 0.9rem;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Result Panel */
        .result-panel { 
            background: rgba(0,0,0,0.4); 
            border-radius: 12px; 
            padding: 18px; 
            margin-top: 18px; 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .result-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 14px; 
            padding-bottom: 14px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            flex-wrap: wrap; 
            gap: 12px; 
        }
        .result-title { 
            font-weight: 600; 
            color: var(--mc-light-green); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        /* MCFunction Editor */
        .mcfunction-editor {
            background: #1e1e1e;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .mcfunction-line {
            display: flex;
            padding: 2px 0;
        }
        .mcfunction-line:hover { background: rgba(255,255,255,0.05); }
        .mcfunction-lineno {
            color: #858585;
            text-align: right;
            padding: 0 12px;
            min-width: 40px;
            user-select: none;
            font-size: 0.8rem;
        }
        .mcfunction-code {
            flex: 1;
            padding: 0 8px;
            white-space: pre;
            font-size: 0.85rem;
        }
        
        /* Syntax Highlighting */
        .token-command { color: #4ec9b0; font-weight: bold; }
        .token-selector { color: #9cdcfe; }
        .token-string { color: #ce9178; }
        .token-number { color: #b5cea8; }
        .token-comment { color: #6a9955; font-style: italic; }
        .token-keyword { color: #c586c0; }
        .token-operator { color: #d4d4d4; }
        
        /* NBT Tree */
        .nbt-tree { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }
        .nbt-node { 
            padding: 3px 0; 
            transition: background-color 0.2s;
            border-radius: 4px;
        }
        .nbt-node:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .nbt-key { color: var(--mc-gold); }
        .nbt-string { color: #ce9178; }
        .nbt-number { color: #b5cea8; }
        .nbt-boolean { color: #569cd6; }
        .nbt-list { 
            margin-left: 16px; 
            border-left: 1px solid rgba(255,255,255,0.1); 
            padding-left: 8px; 
        }
        
        /* NBT Collapsible */
        .collapsible {
            user-select: none;
        }
        .collapsible:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .collapsible i {
            transition: transform 0.2s;
        }
        .collapsible.collapsed i {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            display: block;
        }
        .collapsible-content.collapsed {
            display: none;
        }
        
        /* Tool Panel */
        .tool-panel {
            background: rgba(30,41,59,0.6);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .tool-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .tool-card:hover {
            background: rgba(93,140,58,0.1);
            border-color: var(--mc-green);
            transform: translateY(-2px);
        }
        .tool-card i {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: var(--mc-light-green);
        }
        .tool-card-title {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* Skin Viewer */
        .skin-viewer-container {
            width: 100%;
            height: 400px;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        /* Enchantment Calculator */
        .enchantment-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        .enchantment-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .enchantment-item input {
            width: 50px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            padding: 4px 8px;
            color: #fff;
        }
        
        /* Progress Bar */
        .progress-bar { 
            width: 100%; 
            height: 4px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 2px; 
            overflow: hidden; 
            margin: 14px 0; 
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--mc-green), var(--mc-gold)); 
            border-radius: 2px; 
            transition: width 0.3s; 
        }
        
        /* Empty State */
        .empty-state { 
            grid-column: 1 / -1; 
            text-align: center; 
            padding: 60px 20px; 
            color: #64748b; 
            background: rgba(30,41,59,0.3); 
            border-radius: 16px; 
            border: 2px dashed rgba(255,255,255,0.1); 
        }
        
        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px var(--mc-green), 0 0 10px var(--mc-green); }
            50% { box-shadow: 0 0 10px var(--mc-green), 0 0 20px var(--mc-green); }
        }
        @keyframes block-break {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        .card { animation: fadeInUp 0.5s ease backwards; }
        .card:nth-child(1) { animation-delay: 0.05s; }
        .card:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3) { animation-delay: 0.15s; }
        .card:nth-child(4) { animation-delay: 0.2s; }
        
        /* Mobile Toggle */
        .mobile-toggle { 
            display: none; 
            position: fixed; 
            top: 16px; 
            left: 70px; 
            z-index: 99; 
            width: 40px; 
            height: 40px; 
            background: var(--glass-bg); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; 
            color: #fff; 
            cursor: pointer; 
            backdrop-filter: blur(10px); 
        }
        
        .overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 90; 
            backdrop-filter: blur(4px); 
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: var(--mc-green); border-radius: 3px; }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .toolbar { display: none; }
            .sidebar { 
                left: 0; 
                transform: translateX(-100%); 
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                touch-action: pan-y;
            }
            .sidebar.open { transform: translateX(0); }
            .main-content { 
                margin-left: 0; 
                padding: 70px 16px 80px; 
            }
            .mobile-toggle { 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                left: 16px;
            }
            .overlay.show { display: block; }
            .content-grid { grid-template-columns: 1fr; }
            .page-title { font-size: 1.3rem; }
            
            /* Mobile Bottom Navigation */
            .mobile-nav {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 65px;
                background: var(--glass-bg);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-top: 1px solid rgba(255,255,255,0.1);
                z-index: 999;
                justify-content: space-around;
                align-items: center;
                padding: 0 8px;
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
            
            .mobile-nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                min-width: 44px;
                min-height: 44px;
                color: #94a3b8;
                font-size: 0.7rem;
                gap: 4px;
                cursor: pointer;
                transition: all 0.2s ease;
                border-radius: 12px;
                margin: 0 2px;
                position: relative;
                overflow: hidden;
            }
            
            .mobile-nav-item::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                background: radial-gradient(circle, rgba(93,140,58,0.3) 0%, transparent 70%);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                transition: width 0.3s, height 0.3s;
            }
            
            .mobile-nav-item:active::before {
                width: 60px;
                height: 60px;
            }
            
            .mobile-nav-item i {
                font-size: 1.3rem;
                transition: all 0.2s ease;
            }
            
            .mobile-nav-item.active {
                color: var(--mc-green);
            }
            
            .mobile-nav-item.active i {
                transform: translateY(-2px);
                filter: drop-shadow(0 2px 4px rgba(93,140,58,0.4));
            }
            
            /* Touch-friendly buttons */
            .btn, .nav-child, .nav-parent, .card, .command-card, 
            .favorite-item, .modal-close, .toolbar-item,
            button, [role="button"], input[type="button"], input[type="submit"] {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Touch feedback */
            .btn:active, .nav-child:active, .card:active, 
            .command-card:active, .mobile-nav-item:active {
                transform: scale(0.97);
                opacity: 0.9;
            }
            
            /* Improved modal for mobile */
            .modal-content {
                max-height: 85vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Font size adjustments based on mobile setting */
            body.font-size-small { font-size: 14px; }
            body.font-size-large { font-size: 18px; }
            body.font-size-small .page-title { font-size: 1.2rem; }
            body.font-size-large .page-title { font-size: 1.5rem; }
            
            /* Compact mode */
            body.compact-mode .command-card { padding: 12px; }
            body.compact-mode .card { padding: 12px; }
            body.compact-mode .nav-child { padding: 8px 12px; }
            body.compact-mode .main-content { padding-top: 60px; padding-bottom: 70px; }
            body.compact-mode .mobile-nav { height: 58px; }
            
            /* Touch optimization - larger touch targets */
            body.touch-optimized .btn { padding: 12px 20px; }
            body.touch-optimized .nav-child { padding: 14px 16px; }
            body.touch-optimized .mobile-nav-item { padding: 8px 4px; }
            body.touch-optimized .mobile-nav { height: 72px; }
            body.touch-optimized .main-content { padding-bottom: 85px; }
        }
        
        @media (max-width: 640px) {
            .main-content { padding: 65px 12px 80px; }
            .modal-content { padding: 20px; margin: 20px auto; }
            .action-buttons { flex-direction: column; }
            .action-buttons .btn { width: 100%; justify-content: center; }
            .mobile-nav { height: 60px; }
            .mobile-nav-item { font-size: 0.65rem; }
            .mobile-nav-item i { font-size: 1.2rem; }
        }
        
        /* Hide mobile nav on desktop */
        .mobile-nav { display: none; }
    </style>
</head>
<body>
    <!-- Minecraft Block Background -->
    <div class="mc-block-bg"></div>
    
    <!-- Animated Particles -->
    <div class="particles" id="particles"></div>
    
    <!-- Mobile Toggle -->
    <button class="mobile-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    
    <!-- Toolbar -->
    <aside class="toolbar" id="toolbar">
        <a href="https://afdian.com/a/daoze1" target="_blank" title="支持作者">
            <img src="image.png" alt="Logo" class="toolbar-logo"
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%235D8C3A%22 width=%22100%22 height=%22100%22 rx=%2210%22/%3E%3Ctext x=%2250%22 y=%2265%22 font-size=%2250%22 text-anchor=%22middle%22 fill=%22white%22%3EMC%3C/text%3E%3C/svg%3E'">
        </a>
        
        <div class="toolbar-item active" onclick="switchTool('home', event)" title="主页">
            <i class="fas fa-home"></i>
            <span class="toolbar-tooltip">主页</span>
        </div>
        
        <div class="toolbar-item" onclick="switchTool('database', event)" title="数据库">
            <i class="fas fa-database"></i>
            <span class="toolbar-tooltip">数据库</span>
        </div>
        
        <div class="toolbar-item" onclick="switchTool('tools', event)" title="工具箱">
            <i class="fas fa-toolbox"></i>
            <span class="toolbar-tooltip">工具箱</span>
        </div>
        
        <div class="toolbar-item" onclick="switchTool('favorites', event)" title="收藏夹">
            <i class="fas fa-star"></i>
            <span class="toolbar-tooltip">收藏夹</span>
            <span class="tag" id="toolbar-fav-badge" style="position: absolute; top: 4px; right: 4px; font-size: 0.65rem; padding: 1px 4px; display: none;">0</span>
        </div>
        
        <div class="toolbar-item" onclick="switchTool('converter', event)" title="转换器">
            <i class="fas fa-exchange-alt"></i>
            <span class="toolbar-tooltip">转换器</span>
        </div>
        
        <div style="flex: 1;"></div>
        
        <div class="toolbar-item" onclick="showThemeSettings()" title="设置">
            <i class="fas fa-cog"></i>
            <span class="toolbar-tooltip">设置</span>
        </div>
    </aside>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="logo-area">
            <a href="https://afdian.com/a/daoze1" target="_blank" title="支持作者">
                <img src="image.png" alt="" class="logo-img" 
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%235D8C3A%22 width=%22100%22 height=%22100%22 rx=%2210%22/%3E%3Ctext x=%2250%22 y=%2265%22 font-size=%2250%22 text-anchor=%22middle%22 fill=%22white%22%3EMC%3C/text%3E%3C/svg%3E'">
            </a>
            <div class="logo-text">
                <h1 data-i18n="title">MC游戏辅助</h1>
                <span>v1.16.9 data版</span><br>
                <span>轮回道尘制作</span>
            </div>
        </div>
        
        <nav class="nav-container">
            <div class="nav-divider" data-i18n="nav_data">数据分类</div>
            <div class="nav-section">
                <div class="nav-parent expanded" onclick="toggleMenu(this)">
                    <div class="nav-parent-left">
                        <span class="nav-icon"><i class="fas fa-terminal"></i></span>
                        <span data-i18n="commands">指令</span>
                    </div>
                    <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="nav-children" style="max-height: 500px;">
                    <div class="nav-child active" onclick="switchTab('commands', this)">
                        <span data-i18n="all_commands">全部指令</span>
                        <span class="tag" id="badge-cmd">0</span>
                    </div>
                    <div class="nav-child" onclick="switchTab('blocks', this)">
                        <span data-i18n="command_blocks">命令方块</span>
                        <span class="tag" id="badge-block">0</span>
                    </div>
                    <div class="nav-child" onclick="switchTab('redstone', this)">
                        <span data-i18n="redstone">红石元件</span>
                        <span class="tag" id="badge-redstone">0</span>
                    </div>
                    <div class="nav-child" onclick="switchTab('items', this)">
                        <span data-i18n="items">物品ID</span>
                        <span class="tag" id="badge-item">0</span>
                    </div>
                    <div class="nav-child" onclick="switchTab('advancements', this)">
                        <span data-i18n="advancements">准则ID</span>
                        <span class="tag" id="badge-adv">0</span>
                    </div>
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-parent" onclick="toggleMenu(this)">
                    <div class="nav-parent-left">
                        <span class="nav-icon"><i class="fas fa-wrench"></i></span>
                        <span data-i18n="tools">实用工具</span>
                    </div>
                    <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="nav-children">
                    <div class="nav-child" onclick="switchToolPage('generator', this)">
                        <i class="fas fa-magic" style="margin-right: 8px; color: var(--mc-purple);"></i>
                        <span data-i18n="command_generator">指令生成器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('selector', this)">
                        <i class="fas fa-crosshairs" style="margin-right: 8px; color: var(--mc-cyan);"></i>
                        <span data-i18n="target_selector">目标选择器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('nbt', this)">
                        <i class="fas fa-code" style="margin-right: 8px; color: var(--mc-gold);"></i>
                        <span data-i18n="nbt_editor">NBT编辑器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('mcfunction', this)">
                        <i class="fas fa-file-code" style="margin-right: 8px; color: var(--mc-blue);"></i>
                        <span data-i18n="function_editor">函数编辑器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('skin', this)">
                        <i class="fas fa-user" style="margin-right: 8px; color: #f59e0b;"></i>
                        <span data-i18n="skin_editor">皮肤编辑器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('particle', this)">
                        <i class="fas fa-snowflake" style="margin-right: 8px; color: #22d3ee;"></i>
                        <span data-i18n="particle_editor">粒子编辑器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('materials', this)">
                        <i class="fas fa-calculator" style="margin-right: 8px; color: #4ade80;"></i>
                        <span data-i18n="material_calculator">材料计算</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('seedmap', this)">
                        <i class="fas fa-map" style="margin-right: 8px; color: #a78bfa;"></i>
                        <span data-i18n="seed_map">种子地图</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('slime', this)">
                        <i class="fas fa-th" style="margin-right: 8px; color: #4ade80;"></i>
                        <span data-i18n="slime_finder">史莱姆查找</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('enchant', this)">
                        <i class="fas fa-gem" style="margin-right: 8px; color: #60a5fa;"></i>
                        <span data-i18n="enchantment">附魔工具</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('xp', this)">
                        <i class="fas fa-chart-line" style="margin-right: 8px; color: #fbbf24;"></i>
                        <span data-i18n="xp_calculator">经验计算</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('smelt', this)">
                        <i class="fas fa-fire" style="margin-right: 8px; color: #f97316;"></i>
                        <span data-i18n="smelting">熔炼计算</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('coords', this)">
                        <i class="fas fa-compass" style="margin-right: 8px; color: #22d3ee;"></i>
                        <span data-i18n="coord_convert">坐标转换</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('structure', this)">
                        <i class="fas fa-cubes" style="margin-right: 8px; color: #a8a29e;"></i>
                        <span data-i18n="structure_extract">结构提取</span>
                    </div>
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-parent" onclick="toggleMenu(this)">
                    <div class="nav-parent-left">
                        <span class="nav-icon"><i class="fas fa-robot"></i></span>
                        <span data-i18n="ai_features">AI功能</span>
                    </div>
                    <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="nav-children">
                    <div class="nav-child" onclick="switchToolPage('ai', this)">
                        <i class="fas fa-brain" style="margin-right: 8px; color: var(--mc-purple);"></i>
                        <span data-i18n="ai_assistant">AI指令助手</span>
                        <span class="tag tag-purple">NEW</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('compare', this)">
                        <i class="fas fa-code-branch" style="margin-right: 8px; color: var(--mc-green);"></i>
                        <span data-i18n="version_compare">版本对比</span>
                    </div>
                </div>
            </div>
            
            <div class="nav-divider" data-i18n="nav_contribution">贡献</div>
            <div class="nav-section">
                <div class="nav-parent" onclick="toggleMenu(this)">
                    <div class="nav-parent-left">
                        <span class="nav-icon"><i class="fas fa-award"></i></span>
                        <span data-i18n="credits">鸣谢名单</span>
                    </div>
                    <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="nav-children">
                    <div class="nav-child" onclick="showCredits('credits', this)">
                        <span data-i18n="supporters">支持者</span>
                        <span class="tag" id="badge-credits">0</span>
                    </div>
                    <div class="nav-child" onclick="showCredits('contributors', this)">
                        <span data-i18n="developers">开发者</span>
                        <span class="tag" id="badge-contributors">0</span>
                    </div>
                </div>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label" data-i18n="total_data">总数据</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-cmd">0</div>
                    <div class="stat-label" data-i18n="commands">指令</div>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content" id="main-content"></main>
    
    <!-- Modal -->
    <div class="modal" id="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav" id="mobileNav">
        <div class="mobile-nav-item active" onclick="switchMobileTab('home', this)" data-tab="home">
            <i class="fas fa-home"></i>
            <span data-i18n="home">主页</span>
        </div>
        <div class="mobile-nav-item" onclick="switchMobileTab('database', this)" data-tab="database">
            <i class="fas fa-database"></i>
            <span data-i18n="database">数据库</span>
        </div>
        <div class="mobile-nav-item" onclick="switchMobileTab('tools', this)" data-tab="tools">
            <i class="fas fa-toolbox"></i>
            <span data-i18n="tools">工具箱</span>
        </div>
        <div class="mobile-nav-item" onclick="switchMobileTab('favorites', this)" data-tab="favorites">
            <i class="fas fa-star"></i>
            <span data-i18n="favorites">收藏夹</span>
        </div>
        <div class="mobile-nav-item" onclick="switchMobileTab('settings', this)" data-tab="settings">
            <i class="fas fa-cog"></i>
            <span data-i18n="settings">设置</span>
        </div>
    </nav>

    <script>
    // ==================== Global Variables & Constants ====================
    const STORAGE_KEY = 'mc_command_helper_data_v3';
    const FAVORITES_STORAGE_KEY = 'mc_helper_favorites_v3';
    const SETTINGS_STORAGE_KEY = 'mc_helper_settings_v3';
    
    // App State
    const appState = {
        theme: 'dark',
        language: 'zh-CN',
        shortcuts: true,
        autoSave: true,
        errorReporting: true,
        compactMode: false,
        touchOptimized: false
    };
    
    // Data Storage
    const data = {
        commands: new Map(),
        blocks: [],
        redstone: [],
        items: [],
        advancements: [],
        favorites: [],
        credits: [],
        contributors: []
    };
    
    // ==================== Built-in Data ====================
    // ==================== 指令数据分类 ====================
    const COMMAND_CATEGORIES = {
        basic: { name: '基础指令', icon: 'fa-cube', color: '#7EB356' },
        entity: { name: '实体管理', icon: 'fa-ghost', color: '#a855f7' },
        world: { name: '世界操作', icon: 'fa-globe', color: '#22d3ee' },
        gameplay: { name: '游戏玩法', icon: 'fa-gamepad', color: '#f59e0b' },
        system: { name: '系统设置', icon: 'fa-cog', color: '#64748b' },
        advanced: { name: '高级指令', icon: 'fa-code', color: '#ec4899' }
    };
    
    const BUILTIN_COMMANDS = [
        // 基础指令
        { name: 'give', category: 'basic', source: 'java', desc: '给予玩家指定物品，支持NBT标签', syntax: '/give <target> <item> [count]', examples: ['/give @p minecraft:diamond 64', '/give @a minecraft:diamond_sword{Enchantments:[{id:"sharpness",lvl:5}]}'], difficulty: 'easy' },
        { name: 'clear', category: 'basic', source: 'java', desc: '清除玩家背包中的物品', syntax: '/clear [<target>] [<item>] [<maxCount>]', examples: ['/clear @p minecraft:stone', '/clear @p'], difficulty: 'easy' },
        { name: 'kill', category: 'basic', source: 'java', desc: '移除（杀死）指定实体', syntax: '/kill [<target>]', examples: ['/kill @e[type=zombie]', '/kill @p'], difficulty: 'easy' },
        { name: 'say', category: 'basic', source: 'java', desc: '向所有人发送公共消息', syntax: '/say <message>', examples: ['/say 欢迎来到我的世界！', '/say 游戏开始！'], difficulty: 'easy' },
        { name: 'tell', category: 'basic', source: 'java', desc: '向指定玩家发送私人消息', syntax: '/tell <target> <message>', examples: ['/tell @p 你好！', '/tell Steve 跟我来'], difficulty: 'easy' },
        { name: 'me', category: 'basic', source: 'java', desc: '以第三人称发送动作消息', syntax: '/me <action>', examples: ['/me 在挖矿', '/me 高兴地跳了起来'], difficulty: 'easy' },
        
        // 实体管理
        { name: 'tp', category: 'entity', source: 'java', desc: '传送实体到指定位置或玩家', syntax: '/tp <target> (<destination>|<location>)', examples: ['/tp @p ~ ~10 ~', '/tp @e[type=zombie] @p', '/tp Steve 100 64 200'], difficulty: 'medium' },
        { name: 'summon', category: 'entity', source: 'java', desc: '召唤指定类型的实体，可带NBT标签', syntax: '/summon <entity> [<pos>] [<nbt>]', examples: ['/summon minecraft:creeper ~ ~ ~', '/summon minecraft:zombie ~ ~ ~ {IsBaby:1b,CustomName:"\\"小僵尸\\""}'], difficulty: 'medium' },
        { name: 'effect', category: 'entity', source: 'java', desc: '给予或清除实体的状态效果', syntax: '/effect (give|clear) <target> [<effect>] [<seconds>] [<amplifier>] [hideParticles]', examples: ['/effect give @p minecraft:speed 60 1', '/effect give @a night_vision 999999 0 true', '/effect clear @p'], difficulty: 'medium' },
        { name: 'attribute', category: 'entity', source: 'java', desc: '查看和修改实体的属性', syntax: '/attribute <target> <attribute> (get|base|modifier) ...', examples: ['/attribute @p minecraft:generic.max_health base set 40', '/attribute @e[type=zombie] minecraft:generic.attack_damage get'], difficulty: 'hard' },
        { name: 'tag', category: 'entity', source: 'java', desc: '管理实体的标签，用于分组和识别', syntax: '/tag <target> (add|remove|list) [<tag>]', examples: ['/tag @p add vip', '/tag @e[type=zombie] remove hostile', '/tag @e list'], difficulty: 'medium' },
        { name: 'team', category: 'entity', source: 'java', desc: '管理队伍和队员', syntax: '/team (add|remove|join|leave|list|empty) ...', examples: ['/team add red "红队"', '/team join red @p', '/team leave @p'], difficulty: 'medium' },
        { name: 'enchant', category: 'entity', source: 'java', desc: '给玩家持有的物品附魔', syntax: '/enchant <target> <enchantment> [<level>]', examples: ['/enchant @p minecraft:sharpness 5', '/enchant @a minecraft:unbreaking 3'], difficulty: 'easy' },
        
        // 世界操作
        { name: 'setblock', category: 'world', source: 'java', desc: '在指定位置放置方块', syntax: '/setblock <pos> <block> [destroy|keep|replace]', examples: ['/setblock ~ ~-1 ~ minecraft:stone', '/setblock ~ ~ ~ minecraft:chest[facing=north]{Items:[{Slot:0b,id:"diamond",Count:1b}]}'], difficulty: 'medium' },
        { name: 'fill', category: 'world', source: 'java', desc: '填充两点之间的矩形区域', syntax: '/fill <from> <to> <block> [destroy|hollow|keep|outline|replace] [<replaceFilter>]', examples: ['/fill ~ ~ ~ ~10 ~10 ~10 minecraft:stone', '/fill ~ ~ ~ ~5 ~5 ~5 minecraft:air replace minecraft:stone'], difficulty: 'medium' },
        { name: 'clone', category: 'world', source: 'java', desc: '复制一个区域到另一位置', syntax: '/clone <begin> <end> <destination> [replace|masked|filtered] [force|move|normal]', examples: ['/clone ~ ~ ~ ~10 ~10 ~10 100 64 100', '/clone ~ ~ ~ ~5 ~5 ~5 ~ ~20 ~ replace move'], difficulty: 'hard' },
        { name: 'place', category: 'world', source: 'java', desc: '放置特定结构或功能方块', syntax: '/place (feature|jigsaw|structure|template) ...', examples: ['/place feature minecraft:oak', '/place structure minecraft:village_plains'], difficulty: 'hard' },
        { name: 'particle', category: 'world', source: 'java', desc: '生成粒子效果', syntax: '/particle <name> [<pos>] [<delta>] <speed> <count> [force|normal] [<viewers>]', examples: ['/particle minecraft:flame ~ ~ ~ 0 0 0 0 10', '/particle minecraft:happy_villager ~ ~1 ~ 0.5 0.5 0.5 0 20'], difficulty: 'medium' },
        { name: 'playsound', category: 'world', source: 'java', desc: '播放音效', syntax: '/playsound <sound> (master|music|record|weather|block|hostile|neutral|player|ambient|voice) <targets> [<pos>] [<volume>] [<pitch>] [<minVolume>]', examples: ['/playsound minecraft:entity.player.levelup master @p', '/playsound minecraft:block.note_block.pling record @a ~ ~ ~ 1 2'], difficulty: 'medium' },
        
        // 游戏玩法
        { name: 'gamemode', category: 'gameplay', source: 'java', desc: '切换玩家的游戏模式', syntax: '/gamemode <mode> [<target>]', examples: ['/gamemode creative', '/gamemode survival @p', '/gamemode adventure @a'], difficulty: 'easy' },
        { name: 'time', category: 'gameplay', source: 'java', desc: '设置或查询游戏时间', syntax: '/time (add|query|set) <value>', examples: ['/time set day', '/time set 0', '/time add 1000', '/time query daytime'], difficulty: 'easy' },
        { name: 'weather', category: 'gameplay', source: 'java', desc: '设置天气', syntax: '/weather (clear|rain|thunder) [duration]', examples: ['/weather clear', '/weather rain 6000', '/weather thunder 12000'], difficulty: 'easy' },
        { name: 'difficulty', category: 'gameplay', source: 'java', desc: '设置游戏难度', syntax: '/difficulty (peaceful|easy|normal|hard)', examples: ['/difficulty peaceful', '/difficulty hard'], difficulty: 'easy' },
        { name: 'spawnpoint', category: 'gameplay', source: 'java', desc: '设置玩家的重生点', syntax: '/spawnpoint [<targets>] [<pos>] [<angle>]', examples: ['/spawnpoint @p', '/spawnpoint @p 100 64 100'], difficulty: 'easy' },
        { name: 'setworldspawn', category: 'gameplay', source: 'java', desc: '设置世界重生点', syntax: '/setworldspawn [<pos>] [<angle>]', examples: ['/setworldspawn', '/setworldspawn 0 100 0'], difficulty: 'easy' },
        { name: 'experience', category: 'gameplay', source: 'java', desc: '给予或设置玩家经验值', syntax: '/experience (add|set|query) ...', examples: ['/experience add @p 100 levels', '/experience set @p 0 points', '/experience query @p levels'], difficulty: 'medium' },
        { name: 'advancement', category: 'gameplay', source: 'java', desc: '管理玩家进度奖励', syntax: '/advancement (grant|revoke) <targets> (only|until|from|through|everything) [<advancement>]', examples: ['/advancement grant @p everything', '/advancement revoke @a only minecraft:story/mine_stone'], difficulty: 'medium' },
        { name: 'recipe', category: 'gameplay', source: 'java', desc: '给予或剥夺玩家配方', syntax: '/recipe (give|take) <targets> [<recipe>]', examples: ['/recipe give @p *', '/recipe give @a minecraft:diamond_pickaxe'], difficulty: 'easy' },
        
        // 系统设置
        { name: 'gamerule', category: 'system', source: 'java', desc: '设置或查询游戏规则', syntax: '/gamerule <rule> [<value>]', examples: ['/gamerule keepInventory true', '/gamerule doDaylightCycle false', '/gamerule randomTickSpeed 100'], difficulty: 'medium' },
        { name: 'defaultgamemode', category: 'system', source: 'java', desc: '设置默认游戏模式', syntax: '/defaultgamemode <mode>', examples: ['/defaultgamemode survival', '/defaultgamemode creative'], difficulty: 'easy' },
        { name: 'worldborder', category: 'system', source: 'java', desc: '管理世界边界', syntax: '/worldborder (add|center|damage|get|set|warning) ...', examples: ['/worldborder set 1000', '/worldborder center 0 0', '/worldborder add 100 10'], difficulty: 'medium' },
        { name: 'op', category: 'system', source: 'java', desc: '给予玩家管理员权限', syntax: '/op <targets>', examples: ['/op Steve', '/op @p'], difficulty: 'easy' },
        { name: 'deop', category: 'system', source: 'java', desc: '剥夺玩家管理员权限', syntax: '/deop <targets>', examples: ['/deop Steve', '/deop @p'], difficulty: 'easy' },
        { name: 'ban', category: 'system', source: 'java', desc: '封禁玩家', syntax: '/ban <targets> [<reason>]', examples: ['/ban Steve 使用外挂', '/ban @p'], difficulty: 'easy' },
        { name: 'kick', category: 'system', source: 'java', desc: '踢出玩家', syntax: '/kick <targets> [<reason>]', examples: ['/kick Steve', '/kick @p 请重新登录'], difficulty: 'easy' },
        { name: 'whitelist', category: 'system', source: 'java', desc: '管理服务器白名单', syntax: '/whitelist (on|off|list|add|remove|reload)', examples: ['/whitelist on', '/whitelist add Steve', '/whitelist remove Steve'], difficulty: 'easy' },
        
        // 高级指令
        { name: 'execute', category: 'advanced', source: 'java', desc: '执行子命令，支持条件判断和坐标变换', syntax: '/execute (align|anchored|as|at|facing|if|in|positioned|rotated|run|store|unless) ...', examples: ['/execute as @p at @s run say 我在@s的位置', '/execute if entity @e[type=zombie,distance=..10] run say 有僵尸靠近'], difficulty: 'hard' },
        { name: 'scoreboard', category: 'advanced', source: 'java', desc: '计分板系统，用于跟踪和存储数值', syntax: '/scoreboard (objectives|players|display) ...', examples: ['/scoreboard objectives add kills totalKillCount', '/scoreboard players add @p kills 1', '/scoreboard objectives setdisplay sidebar kills'], difficulty: 'hard' },
        { name: 'data', category: 'advanced', source: 'java', desc: '查看和修改NBT数据', syntax: '/data (get|merge|remove|modify) ...', examples: ['/data get entity @p Inventory', '/data merge block ~ ~ ~ {CustomName:\'"\\"我的箱子\\""\'}', '/data remove entity @e[type=item,limit=1] PickupDelay'], difficulty: 'hard' },
        { name: 'function', category: 'advanced', source: 'java', desc: '执行函数文件中的命令', syntax: '/function <name>', examples: ['/function mydatapack:start', '/function minecraft:tree/branch'], difficulty: 'medium' },
        { name: 'schedule', category: 'advanced', source: 'java', desc: '定时执行函数', syntax: '/schedule (function|clear) <function> <time> [(append|replace)]', examples: ['/schedule function mypack:tick 10t', '/schedule function mypack:event 5s append'], difficulty: 'medium' },
        { name: 'bossbar', category: 'advanced', source: 'java', desc: '管理Boss血条显示', syntax: '/bossbar (add|get|list|remove|set) ...', examples: ['/bossbar add boss1 "Boss名称"', '/bossbar set boss1 players @a', '/bossbar set boss1 value 50'], difficulty: 'medium' },
        { name: 'loot', category: 'advanced', source: 'java', desc: '生成或操作战利品', syntax: '/loot (give|insert|spawn|replace) ...', examples: ['/loot give @p loot minecraft:chests/simple_dungeon', '/loot spawn ~ ~ ~ loot minecraft:entities/creeper'], difficulty: 'medium' },
        { name: 'item', category: 'advanced', source: 'java', desc: '替换容器中的物品', syntax: '/item (replace|modify) ...', examples: ['/item replace entity @p weapon.mainhand with diamond_sword', '/item modify entity @p armor.chest mypack:glint'], difficulty: 'hard' },
        { name: 'forceload', category: 'advanced', source: 'java', desc: '强制加载区块', syntax: '/forceload (add|remove|query) [<from>] [<to>]', examples: ['/forceload add 0 0', '/forceload add ~-10 ~-10 ~10 ~10', '/forceload remove all'], difficulty: 'medium' },
        { name: 'locate', category: 'advanced', source: 'java', desc: '定位结构或生物群系', syntax: '/locate (structure|biome|poi) <id>', examples: ['/locate structure minecraft:village', '/locate biome minecraft:desert', '/locate poi minecraft:home'], difficulty: 'easy' },
        
        // 消息指令
        { name: 'tellraw', category: 'basic', source: 'java', desc: '发送JSON格式消息，支持样式和事件', syntax: '/tellraw <target> <json>', examples: ['/tellraw @p {"text":"你好","color":"green","clickEvent":{"action":"run_command","value":"/say hi"}}', '/tellraw @a [{"selector":"@p"},{"text":" 获得了胜利"}]'], difficulty: 'hard' },
        { name: 'title', category: 'advanced', source: 'java', desc: '显示屏幕标题和副标题', syntax: '/title <targets> (clear|reset|times|title|subtitle|actionbar) ...', examples: ['/title @p title {"text":"欢迎","color":"gold"}', '/title @a subtitle {"text":"准备开始游戏"}', '/title @p times 10 70 20'], difficulty: 'medium' },
        { name: 'debug', category: 'system', source: 'java', desc: '调试命令', syntax: '/debug (start|stop|function)', examples: ['/debug start', '/debug stop'], difficulty: 'easy' },
        { name: 'seed', category: 'system', source: 'java', desc: '显示世界种子', syntax: '/seed', examples: ['/seed'], difficulty: 'easy' },
        { name: 'save-all', category: 'system', source: 'java', desc: '保存世界数据到磁盘', syntax: '/save-all [flush]', examples: ['/save-all', '/save-all flush'], difficulty: 'easy' },
        { name: 'reload', category: 'system', source: 'java', desc: '重新加载数据包和资源', syntax: '/reload', examples: ['/reload'], difficulty: 'easy' },
        { name: 'datapack', category: 'system', source: 'java', desc: '管理数据包', syntax: '/datapack (disable|enable|list)', examples: ['/datapack list', '/datapack enable "file/mydata"', '/datapack disable "vanilla"'], difficulty: 'medium' }
    ];
    
    const BUILTIN_ITEMS = [
        { id: 'minecraft:stone', name: '石头', category: '建筑', desc: '基础建筑方块' },
        { id: 'minecraft:granite', name: '花岗岩', category: '建筑', desc: '花岗岩石头' },
        { id: 'minecraft:diorite', name: '闪长岩', category: '建筑', desc: '闪长岩石头' },
        { id: 'minecraft:andesite', name: '安山岩', category: '建筑', desc: '安山岩石头' },
        { id: 'minecraft:dirt', name: '泥土', category: '建筑', desc: '基础土壤方块' },
        { id: 'minecraft:grass_block', name: '草方块', category: '建筑', desc: '覆盖草的泥土' },
        { id: 'minecraft:cobblestone', name: '圆石', category: '建筑', desc: '挖掘石头掉落' },
        { id: 'minecraft:oak_planks', name: '橡木木板', category: '建筑', desc: '柴油木材制成' },
        { id: 'minecraft:spruce_planks', name: '云杉木板', category: '建筑', desc: '深色木材' },
        { id: 'minecraft:birch_planks', name: '白杉木板', category: '建筑', desc: '浅色木材' },
        { id: 'minecraft:jungle_planks', name: '丛林木板', category: '建筑', desc: '热带木材' },
        { id: 'minecraft:acacia_planks', name: '金合欢木板', category: '建筑', desc: '浅色热带木材' },
        { id: 'minecraft:dark_oak_planks', name: '深色橡木木板', category: '建筑', desc: '深色木材' },
        { id: 'minecraft:oak_log', name: '橡木原木', category: '建筑', desc: '柴油原木' },
        { id: 'minecraft:spruce_log', name: '云杉原木', category: '建筑', desc: '云杉原木' },
        { id: 'minecraft:birch_log', name: '白杉原木', category: '建筑', desc: '白杉原木' },
        { id: 'minecraft:jungle_log', name: '丛林原木', category: '建筑', desc: '丛林原木' },
        { id: 'minecraft:acacia_log', name: '金合欢原木', category: '建筑', desc: '金合欢原木' },
        { id: 'minecraft:dark_oak_log', name: '深色橡木原木', category: '建筑', desc: '深色橡木原木' },
        { id: 'minecraft:bedrock', name: '基岩', category: '建筑', desc: '不可破坏的方块' },
        { id: 'minecraft:sand', name: '沙子', category: '建筑', desc: '可下落的方块' },
        { id: 'minecraft:red_sand', name: '红沙', category: '建筑', desc: '红色沙子' },
        { id: 'minecraft:gravel', name: '碎石', category: '建筑', desc: '可下落的方块' },
        { id: 'minecraft:coal_ore', name: '煤矿石', category: '矿石', desc: '可挖掘煤炭' },
        { id: 'minecraft:iron_ore', name: '铁矿石', category: '矿石', desc: '可炼成铁锭' },
        { id: 'minecraft:gold_ore', name: '金矿石', category: '矿石', desc: '可炼成金锭' },
        { id: 'minecraft:diamond_ore', name: '钻石矿石', category: '矿石', desc: '掉落钻石' },
        { id: 'minecraft:emerald_ore', name: '绿宝石矿石', category: '矿石', desc: '掉落绿宝石' },
        { id: 'minecraft:redstone_ore', name: '红石矿石', category: '矿石', desc: '掉落红石粉' },
        { id: 'minecraft:lapis_ore', name: '青金石矿石', category: '矿石', desc: '掉落青金石' },
        { id: 'minecraft:coal', name: '煤炭', category: '材料', desc: '燃料' },
        { id: 'minecraft:charcoal', name: '木炭', category: '材料', desc: '木头炼制的燃料' },
        { id: 'minecraft:iron_ingot', name: '铁锭', category: '材料', desc: '金属材料' },
        { id: 'minecraft:gold_ingot', name: '金锭', category: '材料', desc: '金属材料' },
        { id: 'minecraft:diamond', name: '钻石', category: '材料', desc: '珍贵材料' },
        { id: 'minecraft:emerald', name: '绿宝石', category: '材料', desc: '交易货币' },
        { id: 'minecraft:redstone', name: '红石粉', category: '材料', desc: '红石电路材料' },
        { id: 'minecraft:lapis_lazuli', name: '青金石', category: '材料', desc: '染料' },
        { id: 'minecraft:quartz', name: '下界石英', category: '材料', desc: '下界材料' },
        { id: 'minecraft:iron_sword', name: '铁剑', category: '战斗', desc: '基础近战武器' },
        { id: 'minecraft:diamond_sword', name: '钻石剑', category: '战斗', desc: '高级近战武器' },
        { id: 'minecraft:iron_pickaxe', name: '铁镐', category: '工具', desc: '挖掘工具' },
        { id: 'minecraft:diamond_pickaxe', name: '钻石镐', category: '工具', desc: '高级挖掘工具' },
        { id: 'minecraft:iron_axe', name: '铁斧', category: '工具', desc: '砍树工具' },
        { id: 'minecraft:diamond_axe', name: '钻石斧', category: '工具', desc: '高级砍树工具' },
        { id: 'minecraft:iron_shovel', name: '铁锹', category: '工具', desc: '挖土工具' },
        { id: 'minecraft:diamond_shovel', name: '钻石锹', category: '工具', desc: '高级挖土工具' },
        { id: 'minecraft:iron_hoe', name: '铁锄', category: '工具', desc: '耕地工具' },
        { id: 'minecraft:diamond_hoe', name: '钻石锄', category: '工具', desc: '高级耕地工具' },
        { id: 'minecraft:bow', name: '弓', category: '战斗', desc: '远程武器' },
        { id: 'minecraft:arrow', name: '箭', category: '战斗', desc: '弓的弹药' },
        { id: 'minecraft:shield', name: '盾牌', category: '战斗', desc: '防御武器' },
        { id: 'minecraft:leather_helmet', name: '皮革帽子', category: '防具', desc: '基础头盔' },
        { id: 'minecraft:iron_helmet', name: '铁头盔', category: '防具', desc: '中级头盔' },
        { id: 'minecraft:diamond_helmet', name: '钻石头盔', category: '防具', desc: '高级头盔' },
        { id: 'minecraft:leather_chestplate', name: '皮革外套', category: '防具', desc: '基础胸甲' },
        { id: 'minecraft:iron_chestplate', name: '铁胸甲', category: '防具', desc: '中级胸甲' },
        { id: 'minecraft:diamond_chestplate', name: '钻石胸甲', category: '防具', desc: '高级胸甲' },
        { id: 'minecraft:leather_leggings', name: '皮革护腿', category: '防具', desc: '基础护腿' },
        { id: 'minecraft:iron_leggings', name: '铁护腿', category: '防具', desc: '中级护腿' },
        { id: 'minecraft:diamond_leggings', name: '钻石护腿', category: '防具', desc: '高级护腿' },
        { id: 'minecraft:leather_boots', name: '皮革靴子', category: '防具', desc: '基础靴子' },
        { id: 'minecraft:iron_boots', name: '铁靴子', category: '防具', desc: '中级靴子' },
        { id: 'minecraft:diamond_boots', name: '钻石靴子', category: '防具', desc: '高级靴子' },
        { id: 'minecraft:apple', name: '苹果', category: '食物', desc: '基础食物' },
        { id: 'minecraft:golden_apple', name: '金苹果', category: '食物', desc: '恢复生命值' },
        { id: 'minecraft:enchanted_golden_apple', name: '附魔金苹果', category: '食物', desc: '强力恢复' },
        { id: 'minecraft:bread', name: '面包', category: '食物', desc: '基础食物' },
        { id: 'minecraft:cooked_porkchop', name: '熟猪排', category: '食物', desc: '高饱食度食物' },
        { id: 'minecraft:cooked_beef', name: '牛排', category: '食物', desc: '高饱食度食物' },
        { id: 'minecraft:cooked_chicken', name: '熟鸡肉', category: '食物', desc: '中等饱食度食物' },
        { id: 'minecraft:water_bucket', name: '水桶', category: '工具', desc: '装水的桶' },
        { id: 'minecraft:lava_bucket', name: '岩浆桶', category: '工具', desc: '装岩浆的桶，可作燃料' },
        { id: 'minecraft:milk_bucket', name: '牛奶桶', category: '食物', desc: '可解除效果' },
        { id: 'minecraft:bucket', name: '桶', category: '工具', desc: '装液体皅容器' },
        { id: 'minecraft:flint_and_steel', name: '打火石', category: '工具', desc: '可以点火' },
        { id: 'minecraft:fishing_rod', name: '钓鱼竿', category: '工具', desc: '用于钓鱼' },
        { id: 'minecraft:compass', name: '指南针', category: '工具', desc: '指向出生点' },
        { id: 'minecraft:clock', name: '钟', category: '工具', desc: '显示游戏时间' },
        { id: 'minecraft:map', name: '地图', category: '工具', desc: '区域地图' },
        { id: 'minecraft:shears', name: '剪刀', category: '工具', desc: '剪羊毛等' },
        { id: 'minecraft:lead', name: '缰绳', category: '工具', desc: '牵引动物' },
        { id: 'minecraft:name_tag', name: '命名牌', category: '工具', desc: '给实体命名' },
        { id: 'minecraft:experience_bottle', name: '附魔之瓶', category: '杂项', desc: '投掷获取经验' },
        { id: 'minecraft:ender_pearl', name: '末影珍', category: '杂项', desc: '传送道具' },
        { id: 'minecraft:blaze_rod', name: '烈焰棒', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:ghast_tear', name: '恶魂之泪', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:nether_wart', name: '下界疣', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:dragon_breath', name: '龙息', category: '材料', desc: '制作延迟药水' },
        { id: 'minecraft:speckled_melon', name: '闪光的甘蔓', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:spider_eye', name: '蜘蛛眼', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:fermented_spider_eye', name: '发酵蜘蛛眼', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:blaze_powder', name: '烈焰粉', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:magma_cream', name: '岩浆膏', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:sugar', name: '糖', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:glistering_melon_slice', name: '闪炫的甘蔓片', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:rabbit_foot', name: '兔子腿', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:pufferfish', name: '河豚', category: '材料', desc: '炼药材料' },
        { id: 'minecraft:tropical_fish', name: '热带鱼', category: '材料', desc: '炼药材料' }
    ];
    
    // 加载内置数据到数据库
    function loadBuiltinData() {
        // 加载指令
        for (const cmd of BUILTIN_COMMANDS) {
            const key = `${cmd.name}_${cmd.source}`;
            if (!data.commands.has(key)) {
                data.commands.set(key, cmd);
            }
        }
        
        // 加载物品
        if (data.items.length === 0) {
            data.items = [...BUILTIN_ITEMS];
        }
        
        console.log(`已加载内置数据: ${data.commands.size} 个指令, ${data.items.length} 个物品`);
        
        // 更新统计和界面
        updateStats();
        updateFilters();
    }
    
    // 更新统计数据
    function updateStats() {
        document.getElementById('stat-total').textContent = data.commands.size + data.items.length;
        document.getElementById('stat-cmd').textContent = data.commands.size;
        document.getElementById('badge-cmd').textContent = data.commands.size;
        document.getElementById('badge-item').textContent = data.items.length;
    }
    
    let currentTab = 'commands';
    let currentTool = 'home';
    let currentFilter = 'all';
    let i18nInstance = null;
    let skinViewer = null;
    
    // ==================== i18n Translations ====================
    const i18nResources = {
        'zh-CN': {
            translation: {
                title: 'MC指令辅助',
                nav_data: '数据分类',
                commands: '指令',
                all_commands: '全部指令',
                command_blocks: '命令方块',
                redstone: '红石元件',
                items: '物品ID',
                advancements: '准则ID',
                nav_tools: '实用工具',
                tools: '工具箱',
                command_generator: '指令生成器',
                target_selector: '目标选择器',
                nbt_editor: 'NBT编辑器',
                function_editor: '函数编辑器',
                skin_editor: '皮肤编辑器',
                particle_editor: '粒子编辑器',
                material_calculator: '材料计算',
                seed_map: '种子地图',
                slime_finder: '史莱姆查找',
                enchantment: '附魔工具',
                xp_calculator: '经验计算',
                smelting: '熔炼计算',
                coord_convert: '坐标转换',
                structure_extract: '结构提取',
                ai_features: 'AI功能',
                ai_assistant: 'AI指令助手',
                version_compare: '版本对比',
                nav_contribution: '贡献',
                credits: '鸣谢名单',
                supporters: '支持者',
                developers: '开发者',
                favorites: '我的收藏',
                total_data: '总数据',
                search: '搜索...',
                copy: '复制',
                save: '保存',
                download: '下载',
                clear: '清空',
                loading: '加载中...',
                error: '错误',
                success: '成功',
                theme: '主题',
                language: '语言',
                settings: '设置',
                add_favorite: '添加到收藏',
                remove_favorite: '移除收藏',
                no_favorites: '暂无收藏',
                no_favorites_desc: '您还没有收藏任何命令',
                converter: '转换器',
                database: '数据库',
                home: '主页'
            }
        },
        'en': {
            translation: {
                title: 'MC Command Helper',
                nav_data: 'Data Categories',
                commands: 'Commands',
                all_commands: 'All Commands',
                command_blocks: 'Command Blocks',
                redstone: 'Redstone',
                items: 'Item IDs',
                advancements: 'Advancements',
                nav_tools: 'Tools',
                tools: 'Toolbox',
                command_generator: 'Command Generator',
                target_selector: 'Target Selector',
                nbt_editor: 'NBT Editor',
                function_editor: 'Function Editor',
                skin_editor: 'Skin Editor',
                particle_editor: 'Particle Editor',
                material_calculator: 'Material Calculator',
                seed_map: 'Seed Map',
                slime_finder: 'Slime Finder',
                enchantment: 'Enchantment Tool',
                xp_calculator: 'XP Calculator',
                smelting: 'Smelting Calculator',
                coord_convert: 'Coordinate Converter',
                structure_extract: 'Structure Extractor',
                ai_features: 'AI Features',
                ai_assistant: 'AI Assistant',
                version_compare: 'Version Compare',
                nav_contribution: 'Credits',
                credits: 'Credits',
                supporters: 'Supporters',
                developers: 'Developers',
                favorites: 'My Favorites',
                total_data: 'Total Data',
                search: 'Search...',
                copy: 'Copy',
                save: 'Save',
                download: 'Download',
                clear: 'Clear',
                loading: 'Loading...',
                error: 'Error',
                success: 'Success',
                theme: 'Theme',
                language: 'Language',
                settings: 'Settings',
                add_favorite: 'Add to Favorites',
                remove_favorite: 'Remove',
                no_favorites: 'No Favorites',
                no_favorites_desc: 'You have no saved commands yet',
                converter: 'Converter',
                database: 'Database',
                home: 'Home'
            }
        },
        'ja': {
            translation: {
                title: 'MCコマンドアシスタント',
                commands: 'コマンド',
                favorites: 'お気に入り',
                tools: 'ツール',
                settings: '設定',
                search: '検索...',
                copy: 'コピー',
                save: '保存',
                download: 'ダウンロード',
                clear: 'クリア'
            }
        },
        'ko': {
            translation: {
                title: 'MC 명령어 도우미',
                commands: '명령어',
                favorites: '즐겨찾기',
                tools: '도구',
                settings: '설정',
                search: '검색...',
                copy: '복사',
                save: '저장',
                download: '다운로드',
                clear: '지우기'
            }
        }
    };
    
    // ==================== Theme Definitions ====================
    const themes = {
        dark: { 
            '--bg-dark': '#0a0f1c', '--glass-bg': 'rgba(20, 25, 40, 0.95)', '--mc-green': '#5D8C3A',
            '--mc-dark-green': '#3D6E2E', '--mc-light-green': '#7EB356',
            icon: '🌙', name: '暗黑主题'
        },
        light: { 
            '--bg-dark': '#f8fafc', '--glass-bg': 'rgba(255, 255, 255, 0.95)', '--mc-green': '#16a34a',
            '--mc-dark-green': '#15803d', '--mc-light-green': '#22c55e',
            icon: '☀️', name: '亮色主题'
        },
        ocean: { 
            '--bg-dark': '#0c1e2e', '--glass-bg': 'rgba(15, 35, 55, 0.95)', '--mc-green': '#0ea5e9',
            '--mc-dark-green': '#0284c7', '--mc-light-green': '#38bdf8',
            icon: '🌊', name: '海洋主题'
        },
        nether: { 
            '--bg-dark': '#1a0c0c', '--glass-bg': 'rgba(40, 20, 20, 0.95)', '--mc-green': '#dc2626',
            '--mc-dark-green': '#b91c1c', '--mc-light-green': '#ef4444',
            icon: '🔥', name: '下界主题'
        },
        forest: { 
            '--bg-dark': '#0c1f0c', '--glass-bg': 'rgba(20, 45, 20, 0.95)', '--mc-green': '#22c55e',
            '--mc-dark-green': '#16a34a', '--mc-light-green': '#4ade80',
            icon: '🌳', name: '森林主题'
        },
        purple: { 
            '--bg-dark': '#1a0c2e', '--glass-bg': 'rgba(35, 20, 55, 0.95)', '--mc-green': '#9333ea',
            '--mc-dark-green': '#7c3aed', '--mc-light-green': '#a855f7',
            icon: '💜', name: '紫色主题'
        },
        gold: { 
            '--bg-dark': '#1c1505', '--glass-bg': 'rgba(45, 35, 10, 0.95)', '--mc-green': '#eab308',
            '--mc-dark-green': '#ca8a04', '--mc-light-green': '#facc15',
            icon: '🏆', name: '黄金主题'
        },
        midnight: { 
            '--bg-dark': '#020617', '--glass-bg': 'rgba(15, 23, 42, 0.98)', '--mc-green': '#6366f1',
            '--mc-dark-green': '#4f46e5', '--mc-light-green': '#818cf8',
            icon: '🌌', name: '午夜主题'
        }
    };
    
    const languages = {
        'zh-CN': { name: '中文', flag: '🇨🇳' },
        'en': { name: 'English', flag: '🇺🇸' },
        'ja': { name: '日本語', flag: '🇯🇵' },
        'ko': { name: '한국어', flag: '🇰🇷' }
    };
    
    // ==================== Initialization ====================
    function initI18n() {
        if (typeof i18next !== 'undefined') {
            i18next.use(i18nextBrowserLanguageDetector).init({
                resources: i18nResources,
                fallbackLng: 'en',
                lng: appState.language,
                debug: false
            }).then(function(instance) {
                i18nInstance = instance;
                updatePageTranslations();
            });
        }
    }
    
    function t(key) {
        if (i18nInstance && i18nInstance.isInitialized) {
            return i18nInstance.t(key);
        }
        const lang = appState.language || 'zh-CN';
        const resource = i18nResources[lang];
        if (resource?.translation?.[key]) return resource.translation[key];
        return key;
    }
    
    function updatePageTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (key) el.textContent = t(key);
        });
    }
    
    function setLanguage(lang) {
        appState.language = lang;
        document.documentElement.lang = lang;
        localStorage.setItem('mc_language', lang);
        
        if (i18nInstance?.isInitialized) {
            i18next.changeLanguage(lang).then(() => {
                updatePageTranslations();
                renderMainContent();
                showToast('🌐 ' + languages[lang].name);
            });
        } else {
            updatePageTranslations();
            renderMainContent();
            showToast('🌐 ' + languages[lang].name);
        }
        saveSettings();
    }
    
    // ==================== Theme System ====================
    function setTheme(themeName) {
        appState.theme = themeName;
        const theme = themes[themeName];
        if(theme) {
            Object.entries(theme).forEach(([key, value]) => {
                if(key.startsWith('--')) {
                    document.documentElement.style.setProperty(key, value);
                }
            });
        }
        document.body.setAttribute('data-theme', themeName);
        saveSettings();
    }
    
    function loadTheme() {
        const saved = localStorage.getItem(SETTINGS_STORAGE_KEY);
        if(saved) {
            const settings = JSON.parse(saved);
            Object.assign(appState, settings);
            setTheme(appState.theme);
        }
    }
    
    function saveSettings() {
        try { localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(appState)); } catch(e) {}
    }
    
    function showThemeSettings() {
        const modal = document.getElementById('modal');
        const body = document.getElementById('modal-body');
        const isMobile = window.innerWidth <= 1024;
        
        const themeOptions = Object.entries(themes).map(([key, theme]) => `
            <div onclick="setTheme('${key}'); closeModal();" 
                 style="cursor: pointer; padding: ${isMobile ? '16px 12px' : '14px'}; background: linear-gradient(135deg, ${theme['--bg-dark']}, ${theme['--glass-bg']}); 
                        border-radius: 10px; border: 2px solid ${appState.theme === key ? 'var(--mc-green)' : 'transparent'}; 
                        text-align: center; transition: all 0.2s;"
                 onmouseover="this.style.transform='translateY(-2px)';"
                 onmouseout="this.style.transform='translateY(0)';">
                <div style="font-size: ${isMobile ? '2rem' : '1.8rem'}; margin-bottom: 4px;">${theme.icon}</div>
                <div style="color: #e2e8f0; font-weight: 500; font-size: ${isMobile ? '0.8rem' : '0.85rem'};">${theme.name}</div>
            </div>
        `).join('');
        
        const languageOptions = Object.entries(languages).map(([key, lang]) => `
            <div onclick="setLanguage('${key}'); closeModal();" 
                 style="cursor: pointer; padding: ${isMobile ? '14px 16px' : '10px 14px'}; background: ${appState.language === key ? 'rgba(93,140,58,0.3)' : 'rgba(30,41,59,0.6)'}; 
                        border-radius: 8px; border: 1px solid ${appState.language === key ? 'var(--mc-green)' : 'rgba(255,255,255,0.1)'};
                        display: flex; align-items: center; gap: ${isMobile ? '14px' : '10px'}; transition: all 0.2s;">
                <span style="font-size: ${isMobile ? '1.6rem' : '1.3rem'};">${lang.flag}</span>
                <span style="color: #e2e8f0; font-weight: 500; font-size: ${isMobile ? '1rem' : '0.9rem'};">${lang.name}</span>
                ${appState.language === key ? '<i class="fas fa-check" style="color: var(--mc-green); margin-left: auto; font-size: ' + (isMobile ? '1.1rem' : '1rem') + ';"></i>' : ''}
            </div>
        `).join('');
        
        // Mobile additional settings
        const mobileSettings = isMobile ? `
            <div style="background: rgba(30,41,59,0.6); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                <h3 style="color: #94a3b8; margin-bottom: 14px; font-size: 0.9rem;">
                    <i class="fas fa-mobile-alt"></i> 移动端设置
                </h3>
                <div style="display: flex; flex-direction: column; gap: 14px;">
                    <label style="display: flex; align-items: center; justify-content: space-between; color: #e2e8f0; cursor: pointer; font-size: 0.95rem; padding: 8px 0;">
                        <span><i class="fas fa-compress-alt" style="color: var(--mc-orange); margin-right: 8px;"></i>紧凑模式</span>
                        <input type="checkbox" ${appState.compactMode ? 'checked' : ''} 
                               onchange="toggleCompactMode(this.checked)" 
                               style="width: 22px; height: 22px; accent-color: var(--mc-green);">
                    </label>
                    <label style="display: flex; align-items: center; justify-content: space-between; color: #e2e8f0; cursor: pointer; font-size: 0.95rem; padding: 8px 0;">
                        <span><i class="fas fa-hand-pointer" style="color: var(--mc-light-green); margin-right: 8px;"></i>触控优化</span>
                        <input type="checkbox" ${appState.touchOptimized ? 'checked' : ''} 
                               onchange="toggleTouchOptimized(this.checked)" 
                               style="width: 22px; height: 22px; accent-color: var(--mc-green);">
                    </label>
                </div>
            </div>
        ` : '';
        
        body.innerHTML = `
            <h2 style="font-family: VT323, monospace; font-size: ${isMobile ? '2rem' : '1.8rem'}; color: var(--mc-gold); margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-cog"></i> ${t('settings')}
            </h2>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #94a3b8; margin-bottom: 12px; font-size: ${isMobile ? '1rem' : '0.9rem'};">
                    <i class="fas fa-palette" style="margin-right: 6px;"></i> ${t('theme')}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(${isMobile ? '2' : '4'}, 1fr); gap: 10px;">
                    ${themeOptions}
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #94a3b8; margin-bottom: 12px; font-size: ${isMobile ? '1rem' : '0.9rem'};">
                    <i class="fas fa-globe" style="margin-right: 6px;"></i> ${t('language')}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(${isMobile ? '1' : '2'}, 1fr); gap: 10px;">
                    ${languageOptions}
                </div>
            </div>
            
            ${mobileSettings}
            
            <div style="background: rgba(30,41,59,0.6); border-radius: 12px; padding: ${isMobile ? '18px' : '14px'};">
                <h3 style="color: #94a3b8; margin-bottom: 12px; font-size: ${isMobile ? '1rem' : '0.85rem'};">
                    <i class="fas fa-sliders-h" style="margin-right: 6px;"></i> 更多设置
                </h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 12px; color: #e2e8f0; cursor: pointer; font-size: ${isMobile ? '0.95rem' : '0.9rem'};">
                        <input type="checkbox" ${appState.shortcuts ? 'checked' : ''} 
                               onchange="appState.shortcuts = this.checked; saveSettings();" 
                               style="width: ${isMobile ? '22px' : '16px'}; height: ${isMobile ? '22px' : '16px'}; accent-color: var(--mc-green);"> 
                        <span>启用键盘快捷键</span>
                    </label>
                </div>
            </div>
        `;
        
        // Add responsive styles for modal on mobile
        if(isMobile) {
            body.parentElement.style.maxWidth = '95vw';
            body.parentElement.style.margin = '20px auto';
            body.parentElement.style.padding = '24px';
        } else {
            body.parentElement.style.maxWidth = '900px';
            body.parentElement.style.margin = '40px auto';
            body.parentElement.style.padding = '28px';
        }
        
        modal.style.display = 'block';
    }
    
    // ==================== Navigation ====================
    function switchTool(tool, eventObj) {
        currentTool = tool;
        
        // Update toolbar active state
        document.querySelectorAll('.toolbar-item').forEach(el => el.classList.remove('active'));
        if(eventObj && eventObj.currentTarget) eventObj.currentTarget.classList.add('active');
        
        if(tool === 'home') {
            currentTab = 'commands';
            renderMainContent();
        } else if(tool === 'database') {
            currentTab = 'commands';
            renderMainContent();
        } else if(tool === 'favorites') {
            renderFavoritesPage(document.getElementById('main-content'));
        } else if(tool === 'tools') {
            renderToolsOverview(document.getElementById('main-content'));
        } else if(tool === 'converter') {
            renderConverterPage(document.getElementById('main-content'));
        }
    }
    
    function switchTab(tab, element) {
        currentTab = tab;
        currentTool = 'database';
        document.querySelectorAll('.nav-child').forEach(el => el.classList.remove('active'));
        if(element) element.classList.add('active');
        if(window.innerWidth <= 1024) toggleSidebar();
        renderMainContent();
    }
    
    function switchToolPage(page, element) {
        currentTool = page;
        document.querySelectorAll('.nav-child').forEach(el => el.classList.remove('active'));
        if(element) element.classList.add('active');
        if(window.innerWidth <= 1024) toggleSidebar();
        renderToolPage(page);
    }
    
    function renderToolPage(page) {
        const container = document.getElementById('main-content');
        switch(page) {
            case 'generator': renderCommandGenerator(container); break;
            case 'selector': renderSelectorBuilder(container); break;
            case 'nbt': renderNBTEditor(container); break;
            case 'mcfunction': renderMCFunctionEditor(container); break;
            case 'skin': renderSkinEditor(container); break;
            case 'particle': renderParticleEditor(container); break;
            case 'materials': renderMaterialCalculator(container); break;
            case 'seedmap': renderSeedMap(container); break;
            case 'slime': renderSlimeFinder(container); break;
            case 'enchant': renderEnchantmentTool(container); break;
            case 'xp': renderXPCalculator(container); break;
            case 'smelt': renderSmeltingCalculator(container); break;
            case 'coords': renderCoordConverter(container); break;
            case 'structure': renderStructureExtractor(container); break;
            case 'ai': renderAIPage(container); break;
            case 'compare': renderComparePage(container); break;
        }
    }
    
    function toggleMenu(element) {
        element.classList.toggle('expanded');
        const children = element.nextElementSibling;
        if(children) {
            children.style.maxHeight = element.classList.contains('expanded') ? '800px' : '0';
        }
    }
    
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    }
    
    function showCredits(type, element) {
        currentTool = type;
        document.querySelectorAll('.nav-child').forEach(el => el.classList.remove('active'));
        if(element) element.classList.add('active');
        if(window.innerWidth <= 1024) toggleSidebar();
        
        const container = document.getElementById('main-content');
        if(type === 'credits') renderCreditsPage(container);
        else if(type === 'contributors') renderContributorsPage(container);
    }
    
    // ==================== Main Content Renderers ====================
    function renderMainContent() {
        const container = document.getElementById('main-content');
        
        if(currentTool === 'home' || currentTool === 'database') {
            renderDatabasePage(container);
        } else if(currentTool === 'favorites') {
            renderFavoritesPage(container);
        } else if(currentTool === 'converter') {
            renderConverterPage(container);
        } else {
            renderDatabasePage(container);
        }
    }
    
    function renderToolsOverview(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('tools')}</h2>
                    <div class="page-subtitle">选择需要使用的工具</div>
                </div>
            </div>
            <div class="tool-grid">
                <div class="tool-card" onclick="switchToolPage('generator', null)">
                    <i class="fas fa-magic" style="color: var(--mc-purple);"></i>
                    <div class="tool-card-title">${t('command_generator')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('selector', null)">
                    <i class="fas fa-crosshairs" style="color: var(--mc-cyan);"></i>
                    <div class="tool-card-title">${t('target_selector')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('nbt', null)">
                    <i class="fas fa-code" style="color: var(--mc-gold);"></i>
                    <div class="tool-card-title">${t('nbt_editor')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('mcfunction', null)">
                    <i class="fas fa-file-code" style="color: var(--mc-blue);"></i>
                    <div class="tool-card-title">${t('function_editor')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('skin', null)">
                    <i class="fas fa-user" style="color: #f59e0b;"></i>
                    <div class="tool-card-title">${t('skin_editor')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('particle', null)">
                    <i class="fas fa-snowflake" style="color: #22d3ee;"></i>
                    <div class="tool-card-title">${t('particle_editor')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('materials', null)">
                    <i class="fas fa-calculator" style="color: #4ade80;"></i>
                    <div class="tool-card-title">${t('material_calculator')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('enchant', null)">
                    <i class="fas fa-gem" style="color: #60a5fa;"></i>
                    <div class="tool-card-title">${t('enchantment')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('xp', null)">
                    <i class="fas fa-chart-line" style="color: #fbbf24;"></i>
                    <div class="tool-card-title">${t('xp_calculator')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('smelt', null)">
                    <i class="fas fa-fire" style="color: #f97316;"></i>
                    <div class="tool-card-title">${t('smelting')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('coords', null)">
                    <i class="fas fa-compass" style="color: #22d3ee;"></i>
                    <div class="tool-card-title">${t('coord_convert')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('compare', null)">
                    <i class="fas fa-code-branch" style="color: var(--mc-green);"></i>
                    <div class="tool-card-title">${t('version_compare')}</div>
                </div>
            </div>
        `;
    }
    
    // ==================== Database Page ====================
    function renderDatabasePage(container) {
        const titles = {
            commands: t('all_commands'),
            blocks: t('command_blocks'),
            redstone: t('redstone'),
            items: t('items'),
            advancements: t('advancements')
        };
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${titles[currentTab] || t('all_commands')}</h2>
                    <div class="page-subtitle">管理和查询游戏数据</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="selectFiles()" class="btn btn-secondary">
                        <i class="fas fa-folder-open"></i><span class="desktop-only">${t('save')}</span>
                    </button>
                    <button onclick="clearAllData()" class="btn" style="background: rgba(220,38,38,0.2); color: #fca5a5;">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            </div>
            <div class="upload-card" id="dropZone" onclick="selectFiles()" 
                 style="background: linear-gradient(135deg, rgba(30,41,59,0.6), rgba(15,23,42,0.6)); border: 2px dashed rgba(93,140,58,0.3); border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 24px;"
                 onmouseover="this.style.borderColor='var(--mc-green)'" 
                 onmouseout="this.style.borderColor='rgba(93,140,58,0.3)'">
                <div style="font-size: 2.5rem; margin-bottom: 12px;">📦</div>
                <h3 style="font-size: 1.1rem; margin-bottom: 6px; font-weight: 600;">拖拽文件或ZIP到此处</h3>
                <p style="color: #64748b; font-size: 0.85rem;">支持 .txt 或包含多个txt的 .zip 文件</p>
                <input type="file" id="fileInput" multiple accept=".txt,.zip" style="display: none;">
            </div>
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="${t('search')}" oninput="handleSearch()">
            </div>
            <div class="filter-chips" id="filters"></div>
            <div id="mainContent" class="content-grid">
                <div class="empty-state">
                    <div style="font-size: 3rem; margin-bottom: 12px; opacity: 0.5;">📭</div>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 6px; color: #94a3b8;">暂无数据</div>
                    <div style="font-size: 0.85rem; color: #64748b;">请上传文件开始使用</div>
                </div>
            </div>
        `;
        updateFilters();
        renderContent();
        setupDragDrop();
    }
    
    // ==================== Favorites System ====================
    function addToFavorites(item) {
        // 确保 item 有效
        if (!item || !item.id) {
            showToast('收藏失败: 无效的数据');
            return;
        }
        // 检查是否已存在（通过 content 和 name 匹配）
        const exists = data.favorites.some(f => f.content === item.content && f.name === item.name);
        if(exists) { showToast(t('already_in_favorites') || '已在收藏夹中'); return; }
        // 确保 id 是字符串类型
        const favItem = { ...item, id: String(item.id), addedAt: new Date().toISOString() };
        data.favorites.unshift(favItem);
        saveFavorites();
        updateFavoritesBadge();
        showToast('✓ ' + (t('added_to_favorites') || '已添加到收藏夹'));
    }
    
    function removeFromFavorites(id) {
        // 将 id 转换为字符串进行比较
        const idStr = String(id);
        data.favorites = data.favorites.filter(f => String(f.id) !== idStr);
        saveFavorites();
        updateFavoritesBadge();
        showToast(t('removed_from_favorites') || '已从收藏夹移除');
        if(currentTool === 'favorites') renderFavoritesPage(document.getElementById('main-content'));
    }
    
    function saveFavorites() {
        try {
            localStorage.setItem(FAVORITES_STORAGE_KEY, JSON.stringify(data.favorites.slice(0, 100)));
        } catch(e) { console.error('保存收藏夹失败:', e); }
    }
    
    function loadFavorites() {
        try {
            const saved = localStorage.getItem(FAVORITES_STORAGE_KEY);
            if(saved) {
                const parsed = JSON.parse(saved);
                if(Array.isArray(parsed)) {
                    data.favorites = parsed;
                    console.log(`已加载 ${parsed.length} 个收藏项`);
                } else {
                    console.warn('收藏夹数据格式不正确，重置为空数组');
                    data.favorites = [];
                }
            } else {
                data.favorites = [];
            }
        } catch(e) { 
            console.error('加载收藏夹失败:', e);
            data.favorites = [];
        }
        updateFavoritesBadge();
    }
    
    function updateFavoritesBadge() {
        const count = data.favorites ? data.favorites.length : 0;
        
        // Update toolbar badge
        const toolbarBadge = document.getElementById('toolbar-fav-badge');
        if(toolbarBadge) {
            toolbarBadge.textContent = count;
            toolbarBadge.style.display = count > 0 ? 'block' : 'none';
        }
        
        // Find favorites badge in nav
        const navChildren = document.querySelectorAll('.nav-children');
        navChildren.forEach(nav => {
            const favChild = Array.from(nav.children).find(child => 
                child.textContent.includes(t('favorites')) || child.textContent.includes('收藏夹')
            );
            if(favChild) {
                let badge = favChild.querySelector('.tag');
                if(!badge) {
                    badge = document.createElement('span');
                    badge.className = 'tag';
                    favChild.appendChild(badge);
                }
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        });
    }
    
    function renderFavoritesPage(container) {
        // 确保 data.favorites 是数组
        if(!data.favorites) {
            data.favorites = [];
        }
        
        let favoritesHtml = '';
        if(data.favorites.length === 0) {
            favoritesHtml = `
                <div class="empty-state">
                    <div style="font-size: 3rem; margin-bottom: 12px;">⭐</div>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 6px; color: #94a3b8;">${t('no_favorites')}</div>
                    <div style="font-size: 0.85rem; color: #64748b;">${t('no_favorites_desc')}</div>
                </div>
            `;
        } else {
            favoritesHtml = data.favorites.map((fav, index) => {
                const safeContent = (fav.content || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeName = (fav.name || t('unnamed')).replace(/'/g, "\\'");
                return `
                    <div class="card" style="animation: fadeInUp 0.5s ease ${index * 0.05}s both; border-left: 3px solid var(--mc-gold);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; color: #fff;">${safeName}</div>
                                <div style="font-size: 0.75rem; color: #64748b;">${fav.type || t('command')}</div>
                            </div>
                            <i class="fas fa-star" style="color: var(--mc-gold);"></i>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #e2e8f0; margin: 10px 0; word-break: break-all;">
                            ${escapeHtml(fav.content || '')}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="copyText('${safeContent}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem;">
                                <i class="fas fa-copy"></i> ${t('copy')}
                            </button>
                            <button onclick="removeFromFavorites('${fav.id}')" class="btn" style="padding: 6px 12px; font-size: 0.8rem; background: rgba(220,38,38,0.2); color: #fca5a5;">
                                <i class="fas fa-trash"></i> ${t('remove_favorite')}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('favorites')}</h2>
                    <div class="page-subtitle">管理你收藏的常用命令</div>
                </div>
            </div>
            <div class="content-grid">${favoritesHtml}</div>
        `;
    }


    
    // ==================== Command Generator ====================
    // 指令生成器历史记录
    let commandHistory = JSON.parse(localStorage.getItem('mc_cmd_history') || '[]');
    
    function renderCommandGenerator(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('command_generator')}</h2>
                    <div class="page-subtitle">可视化指令生成器 - 支持完整NBT编辑</div>
                </div>
                <button onclick="showCommandHistory()" class="btn btn-secondary">
                    <i class="fas fa-history"></i> 历史记录 (${commandHistory.length})
                </button>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchGeneratorTab('basic', this)">基础指令</button>
                <button class="tab-btn" onclick="switchGeneratorTab('advanced', this)">高级指令</button>
                <button class="tab-btn" onclick="switchGeneratorTab('entity', this)">实体/NPC</button>
                <button class="tab-btn" onclick="switchGeneratorTab('visual', this)">视觉效果</button>
            </div>
            
            <div id="generator-panel-basic" class="generator-panel"></div>
            <div id="generator-panel-advanced" class="generator-panel" style="display:none;"></div>
            <div id="generator-panel-entity" class="generator-panel" style="display:none;"></div>
            <div id="generator-panel-visual" class="generator-panel" style="display:none;"></div>
            
            <div id="generatorForm" style="margin-top: 20px;"></div>
            <div id="generatorQuickPick" style="margin-top: 20px;"></div>
        `;
        
        // 初始化各面板
        renderBasicGeneratorPanel();
        renderAdvancedGeneratorPanel();
        renderEntityGeneratorPanel();
        renderVisualGeneratorPanel();
    }
    
    function switchGeneratorTab(tab, btn) {
        document.querySelectorAll('.generator-panel').forEach(el => el.style.display = 'none');
        document.getElementById(`generator-panel-${tab}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // 清空表单区域
        document.getElementById('generatorForm').innerHTML = '';
        document.getElementById('generatorQuickPick').innerHTML = '';
    }
    
    function renderBasicGeneratorPanel() {
        const templates = [
            { id: 'give', name: 'give - 给予物品', icon: 'fa-gift', color: '#7EB356', desc: '给玩家物品，支持附魔和NBT' },
            { id: 'tp', name: 'tp - 传送', icon: 'fa-location-arrow', color: '#22d3ee', desc: '传送实体到指定位置' },
            { id: 'gamemode', name: 'gamemode - 游戏模式', icon: 'fa-gamepad', color: '#4ade80', desc: '切换生存/创造/冒险模式' },
            { id: 'time', name: 'time - 时间控制', icon: 'fa-clock', color: '#818cf8', desc: '设置游戏时间' },
            { id: 'weather', name: 'weather - 天气控制', icon: 'fa-cloud', color: '#22d3ee', desc: '设置晴雨雷电' },
            { id: 'kill', name: 'kill - 移除实体', icon: 'fa-skull', color: '#ef4444', desc: '移除指定实体' }
        ];
        
        document.getElementById('generator-panel-basic').innerHTML = `
            <div class="content-grid">
                ${templates.map(t => `
                    <div class="card" onclick="showEnhancedGeneratorForm('${t.id}')" style="cursor: pointer; border-left: 4px solid ${t.color};">
                        <div class="card-header">
                            <div class="card-title" style="color: ${t.color}; font-size: 1.1rem;">
                                <i class="fas ${t.icon}" style="margin-right: 8px;"></i>${t.name}
                            </div>
                        </div>
                        <div class="card-desc">${t.desc}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    function renderAdvancedGeneratorPanel() {
        const templates = [
            { id: 'setblock', name: 'setblock - 设置方块', icon: 'fa-cube', color: '#f59e0b', desc: '在指定位置放置方块' },
            { id: 'fill', name: 'fill - 填充区域', icon: 'fa-th', color: '#ef4444', desc: '填充矩形区域' },
            { id: 'clone', name: 'clone - 复制区域', icon: 'fa-copy', color: '#a855f7', desc: '复制结构到其他位置' },
            { id: 'execute', name: 'execute - 条件执行', icon: 'fa-code', color: '#c084fc', desc: '条件判断和子命令' },
            { id: 'scoreboard', name: 'scoreboard - 计分板', icon: 'fa-trophy', color: '#f97316', desc: '计分板管理' },
            { id: 'data', name: 'data - 数据操作', icon: 'fa-database', color: '#3b82f6', desc: '查看修改NBT数据' }
        ];
        
        document.getElementById('generator-panel-advanced').innerHTML = `
            <div class="content-grid">
                ${templates.map(t => `
                    <div class="card" onclick="showEnhancedGeneratorForm('${t.id}')" style="cursor: pointer; border-left: 4px solid ${t.color};">
                        <div class="card-header">
                            <div class="card-title" style="color: ${t.color}; font-size: 1.1rem;">
                                <i class="fas ${t.icon}" style="margin-right: 8px;"></i>${t.name}
                            </div>
                        </div>
                        <div class="card-desc">${t.desc}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    function renderEntityGeneratorPanel() {
        const templates = [
            { id: 'summon', name: 'summon - 召唤实体', icon: 'fa-ghost', color: '#a855f7', desc: '召唤怪物和生物' },
            { id: 'effect', name: 'effect - 给予效果', icon: 'fa-flask', color: '#60a5fa', desc: '添加药水效果' },
            { id: 'enchant', name: 'enchant - 附魔', icon: 'fa-magic', color: '#fbbf24', desc: '给物品附魔' },
            { id: 'attribute', name: 'attribute - 属性修改', icon: 'fa-sliders-h', color: '#ec4899', desc: '修改实体属性' },
            { id: 'tag', name: 'tag - 标签管理', icon: 'fa-tag', color: '#14b8a6', desc: '给实体添加标签' },
            { id: 'team', name: 'team - 队伍管理', icon: 'fa-users', color: '#f472b6', desc: '管理玩家队伍' }
        ];
        
        document.getElementById('generator-panel-entity').innerHTML = `
            <div class="content-grid">
                ${templates.map(t => `
                    <div class="card" onclick="showEnhancedGeneratorForm('${t.id}')" style="cursor: pointer; border-left: 4px solid ${t.color};">
                        <div class="card-header">
                            <div class="card-title" style="color: ${t.color}; font-size: 1.1rem;">
                                <i class="fas ${t.icon}" style="margin-right: 8px;"></i>${t.name}
                            </div>
                        </div>
                        <div class="card-desc">${t.desc}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    function renderVisualGeneratorPanel() {
        const templates = [
            { id: 'title', name: 'title - 标题信息', icon: 'fa-heading', color: '#8b5cf6', desc: '屏幕标题和副标题' },
            { id: 'actionbar', name: 'actionbar - 操作栏', icon: 'fa-bars', color: '#06b6d4', desc: '操作栏信息' },
            { id: 'particle', name: 'particle - 粒子效果', icon: 'fa-snowflake', color: '#22d3ee', desc: '生成粒子特效' },
            { id: 'playsound', name: 'playsound - 播放音效', icon: 'fa-volume-up', color: '#f59e0b', desc: '播放游戏音效' },
            { id: 'bossbar', name: 'bossbar - Boss血条', icon: 'fa-heart', color: '#ef4444', desc: '创建Boss血条' },
            { id: 'tellraw', name: 'tellraw - JSON消息', icon: 'fa-comment-dots', color: '#10b981', desc: '高级式化消息' }
        ];
        
        document.getElementById('generator-panel-visual').innerHTML = `
            <div class="content-grid">
                ${templates.map(t => `
                    <div class="card" onclick="showEnhancedGeneratorForm('${t.id}')" style="cursor: pointer; border-left: 4px solid ${t.color};">
                        <div class="card-header">
                            <div class="card-title" style="color: ${t.color}; font-size: 1.1rem;">
                                <i class="fas ${t.icon}" style="margin-right: 8px;"></i>${t.name}
                            </div>
                        </div>
                        <div class="card-desc">${t.desc}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    // 增强版指令生成器表单
    function showEnhancedGeneratorForm(templateId) {
        const formContainer = document.getElementById('generatorForm');
        const quickPickContainer = document.getElementById('generatorQuickPick');
        
        // 定义所有表单模板
        const formTemplates = getFormTemplates();
        const template = formTemplates[templateId];
        
        if (!template) {
            formContainer.innerHTML = '<p class="empty-state">模板开发中...</p>';
            return;
        }
        
        // 渲染表单
        formContainer.innerHTML = `
            <div class="input-area" style="border: 1px solid rgba(93,140,58,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: ${template.color}; margin: 0;">
                        <i class="fas ${template.icon}"></i> ${template.title}
                    </h3>
                    <button onclick="closeGeneratorForm()" class="btn btn-secondary" style="padding: 6px 12px;">
                        <i class="fas fa-times"></i> 关闭
                    </button>
                </div>
                
                <div id="genFormFields" style="display: grid; gap: 16px;">
                    ${template.fields}
                </div>
                
                ${template.nbtEditor ? `
                <div style="margin-top: 20px; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label style="color: #94a3b8;"><i class="fas fa-code"></i> NBT 数据 (可选)</label>
                        <button onclick="toggleNBTEditor()" class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.8rem;">
                            <i class="fas fa-edit"></i> 编辑NBT
                        </button>
                    </div>
                    <div id="nbtEditorPanel" style="display: none;">
                        <textarea id="gen_nbt" class="command-textarea" placeholder='{display:{Name:"\\"自定义名称\\""},Enchantments:[{id:"sharpness",lvl:5}]}' style="min-height: 100px;"></textarea>
                    </div>
                </div>
                ` : ''}
                
                <div class="action-buttons" style="margin-top: 20px;">
                    <button onclick="generateEnhancedCommand('${templateId}')" class="btn btn-primary" style="background: linear-gradient(135deg, ${template.color}, ${template.darkColor || template.color});">
                        <i class="fas fa-magic"></i> 生成指令
                    </button>
                    <button onclick="previewCommand('${templateId}')" class="btn btn-secondary">
                        <i class="fas fa-eye"></i> 预览
                    </button>
                    <button onclick="clearGeneratorForm()" class="btn btn-secondary">
                        <i class="fas fa-eraser"></i> 清空
                    </button>
                </div>
                
                <div id="genResult" style="margin-top: 20px; display: none;">
                    <div style="background: rgba(0,0,0,0.5); border: 1px solid rgba(93,140,58,0.4); border-radius: 10px; padding: 16px;">
                        <div style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 8px;">生成的指令:</div>
                        <div id="genCommandText" style="font-family: 'JetBrains Mono', monospace; color: var(--mc-green); word-break: break-all; margin-bottom: 12px;"></div>
                        <div class="action-buttons" style="margin-top: 0;">
                            <button onclick="copyGeneratedCommand()" class="btn btn-primary" style="padding: 8px 16px;">
                                <i class="fas fa-copy"></i> 复制
                            </button>
                            <button onclick="saveToHistoryFromGen()" class="btn btn-secondary" style="padding: 8px 16px;">
                                <i class="fas fa-save"></i> 保存到历史
                            </button>
                            <button onclick="addGenToFavorites()" class="btn btn-secondary" style="padding: 8px 16px;">
                                <i class="fas fa-star"></i> 收藏
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 渲染快速选择区域
        if (template.quickPick) {
            quickPickContainer.innerHTML = template.quickPick;
        } else {
            quickPickContainer.innerHTML = '';
        }
        
        // 滚动到表单
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function getFormTemplates() {
        const commonFields = {
            target: `<div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-crosshairs"></i> 目标选择器</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="gen_target" class="search-input" placeholder="@p" value="@p" style="flex: 1;">
                    <select onchange="document.getElementById('gen_target').value=this.value" style="width: 120px; background: rgba(30,41,59,0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; padding: 10px;">
                        <option value="@p">最近玩家</option>
                        <option value="@a">所有玩家</option>
                        <option value="@r">随机玩家</option>
                        <option value="@s">执行者</option>
                        <option value="@e">所有实体</option>
                    </select>
                </div></div>`,
            
            coordinates: `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;">X 坐标</label>
                    <input type="text" id="gen_x" class="search-input" placeholder="~" value="~"></div>
                <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;">Y 坐标</label>
                    <input type="text" id="gen_y" class="search-input" placeholder="~" value="~"></div>
                <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;">Z 坐标</label>
                    <input type="text" id="gen_z" class="search-input" placeholder="~" value="~"></div>
            </div>`
        };
        
        const itemQuickPick = `<div class="input-area" style="margin-top: 16px;">
            <h4 style="color: #94a3b8; margin-bottom: 12px; font-size: 0.9rem;"><i class="fas fa-bolt"></i> 快速选择物品</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${['minecraft:diamond', 'minecraft:iron_ingot', 'minecraft:gold_ingot', 'minecraft:emerald', 'minecraft:redstone', 'minecraft:lapis_lazuli', 'minecraft:diamond_sword', 'minecraft:diamond_pickaxe', 'minecraft:diamond_axe', 'minecraft:bow', 'minecraft:arrow', 'minecraft:golden_apple', 'minecraft:enchanted_golden_apple'].map(item => 
                    `<button onclick="document.getElementById('gen_item').value='${item}'" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">${item.replace('minecraft:', '')}</button>`
                ).join('')}
            </div>
        </div>`;
        
        const entityQuickPick = `<div class="input-area" style="margin-top: 16px;">
            <h4 style="color: #94a3b8; margin-bottom: 12px; font-size: 0.9rem;"><i class="fas fa-bolt"></i> 快速选择实体</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${['minecraft:zombie', 'minecraft:skeleton', 'minecraft:creeper', 'minecraft:spider', 'minecraft:enderman', 'minecraft:zombie_villager', 'minecraft:witch', 'minecraft:blaze', 'minecraft:ghast', 'minecraft:pig', 'minecraft:cow', 'minecraft:sheep', 'minecraft:chicken', 'minecraft:villager', 'minecraft:armor_stand', 'minecraft:item_frame'].map(entity => 
                    `<button onclick="document.getElementById('gen_entity').value='${entity}'" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">${entity.replace('minecraft:', '')}</button>`
                ).join('')}
            </div>
        </div>`;
        
        return {
            give: {
                title: 'give 指令生成器',
                icon: 'fa-gift',
                color: '#7EB356',
                darkColor: '#3D6E2E',
                nbtEditor: true,
                fields: `
                    ${commonFields.target}
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-cube"></i> 物品ID</label>
                        <input type="text" id="gen_item" class="search-input" placeholder="minecraft:diamond" value="minecraft:diamond"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-sort-numeric-up"></i> 数量 (1-64)</label>
                            <input type="number" id="gen_count" class="search-input" placeholder="1" value="1" min="1" max="64"></div>
                    </div>
                    ${itemQuickPick}
                `,
                quickPick: ''
            },
            
            summon: {
                title: 'summon 指令生成器',
                icon: 'fa-ghost',
                color: '#a855f7',
                darkColor: '#7c3aed',
                nbtEditor: true,
                fields: `
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-dragon"></i> 实体ID</label>
                        <input type="text" id="gen_entity" class="search-input" placeholder="minecraft:zombie" value="minecraft:zombie"></div>
                    ${commonFields.coordinates}
                    ${entityQuickPick}
                `,
                quickPick: ''
            },
            
            tp: {
                title: 'tp 指令生成器',
                icon: 'fa-location-arrow',
                color: '#22d3ee',
                darkColor: '#0891b2',
                nbtEditor: false,
                fields: `
                    ${commonFields.target}
                    <div style="margin-top: 12px;">
                        <label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-map-marker-alt"></i> 传送模式</label>
                        <select id="gen_tp_mode" class="search-input" onchange="toggleTPMode()">
                            <option value="player">传送到玩家</option>
                            <option value="coords">传送到坐标</option>
                        </select>
                    </div>
                    <div id="tp_player_input">
                        <label style="color: #94a3b8; display: block; margin-bottom: 6px; margin-top: 12px;">目标玩家</label>
                        <input type="text" id="gen_dest_player" class="search-input" placeholder="Steve">
                    </div>
                    <div id="tp_coords_input" style="display: none;">
                        ${commonFields.coordinates}
                    </div>
                `,
                quickPick: ''
            },
            
            effect: {
                title: 'effect 指令生成器',
                icon: 'fa-flask',
                color: '#60a5fa',
                darkColor: '#3b82f6',
                nbtEditor: false,
                fields: `
                    ${commonFields.target}
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-vial"></i> 效果类型</label>
                        <select id="gen_effect" class="search-input">
                            <option value="minecraft:speed">急迎 (Speed)</option>
                            <option value="minecraft:slowness">缓慢 (Slowness)</option>
                            <option value="minecraft:haste">急迫 (Haste)</option>
                            <option value="minecraft:mining_fatigue">挖掘疲劳 (Mining Fatigue)</option>
                            <option value="minecraft:strength">力量 (Strength)</option>
                            <option value="minecraft:instant_health">瞬间治疗 (Instant Health)</option>
                            <option value="minecraft:instant_damage">瞬间伤害 (Instant Damage)</option>
                            <option value="minecraft:jump_boost">跳跃提升 (Jump Boost)</option>
                            <option value="minecraft:nausea">反胃 (Nausea)</option>
                            <option value="minecraft:regeneration">生命恢复 (Regeneration)</option>
                            <option value="minecraft:resistance">抵抗 (Resistance)</option>
                            <option value="minecraft:fire_resistance">防火 (Fire Resistance)</option>
                            <option value="minecraft:water_breathing">水下呼吸 (Water Breathing)</option>
                            <option value="minecraft:invisibility">隐身 (Invisibility)</option>
                            <option value="minecraft:blindness">失明 (Blindness)</option>
                            <option value="minecraft:night_vision">夜视 (Night Vision)</option>
                            <option value="minecraft:hunger">饥饿 (Hunger)</option>
                            <option value="minecraft:weakness">虚弱 (Weakness)</option>
                            <option value="minecraft:poison">中毒 (Poison)</option>
                            <option value="minecraft:wither">凋零 (Wither)</option>
                            <option value="minecraft:health_boost">生命提升 (Health Boost)</option>
                            <option value="minecraft:absorption">吸收 (Absorption)</option>
                            <option value="minecraft:saturation">饱食度 (Saturation)</option>
                            <option value="minecraft:glowing">发光 (Glowing)</option>
                            <option value="minecraft:levitation">漂浮 (Levitation)</option>
                            <option value="minecraft:luck">幸运 (Luck)</option>
                            <option value="minecraft:unluck">不幸 (Bad Luck)</option>
                            <option value="minecraft:slow_falling">缓慢下落 (Slow Falling)</option>
                            <option value="minecraft:conduit_power">潮汐能量 (Conduit Power)</option>
                            <option value="minecraft:dolphins_grace">海豚的恩惠 (Dolphin\\'s Grace)</option>
                            <option value="minecraft:bad_omen">不祥之兆 (Bad Omen)</option>
                            <option value="minecraft:hero_of_the_village">村庄英雄 (Hero of the Village)</option>
                        </select></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-clock"></i> 持续时间 (秒)</label>
                            <input type="number" id="gen_duration" class="search-input" placeholder="30" value="30" min="0" max="999999"></div>
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-layer-group"></i> 等级 (0开始)</label>
                            <input type="number" id="gen_amplifier" class="search-input" placeholder="0" value="0" min="0" max="255"></div>
                    </div>
                    <div style="margin-top: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; color: #94a3b8; cursor: pointer;">
                            <input type="checkbox" id="gen_hide_particles">
                            <span>隐藏粒子效果</span>
                        </label>
                    </div>
                `,
                quickPick: ''
            },
            
            enchant: {
                title: 'enchant 指令生成器',
                icon: 'fa-magic',
                color: '#fbbf24',
                darkColor: '#d97706',
                nbtEditor: false,
                fields: `
                    ${commonFields.target}
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-sparkles"></i> 附魔类型</label>
                        <select id="gen_enchantment" class="search-input">
                            <optgroup label="剑类">
                                <option value="minecraft:sharpness">锋利 (Sharpness)</option>
                                <option value="minecraft:smite">亡灵杀手 (Smite)</option>
                                <option value="minecraft:bane_of_arthropods">芎支杀手 (Bane of Arthropods)</option>
                                <option value="minecraft:knockback">击退 (Knockback)</option>
                                <option value="minecraft:fire_aspect">火焰附加 (Fire Aspect)</option>
                                <option value="minecraft:looting">抢夺 (Looting)</option>
                                <option value="minecraft:sweeping">横扫之刃 (Sweeping Edge)</option>
                            </optgroup>
                            <optgroup label="工具">
                                <option value="minecraft:efficiency">效率 (Efficiency)</option>
                                <option value="minecraft:silk_touch">精准采集 (Silk Touch)</option>
                                <option value="minecraft:fortune">时运 (Fortune)</option>
                            </optgroup>
                            <optgroup label="防具">
                                <option value="minecraft:protection">保护 (Protection)</option>
                                <option value="minecraft:fire_protection">火焰保护 (Fire Protection)</option>
                                <option value="minecraft:feather_falling">摔落缓减 (Feather Falling)</option>
                                <option value="minecraft:blast_protection">爆炸保护 (Blast Protection)</option>
                                <option value="minecraft:projectile_protection">弹射物保护 (Projectile Protection)</option>
                                <option value="minecraft:respiration">水下呼吸 (Respiration)</option>
                                <option value="minecraft:aqua_affinity">水下速掖 (Aqua Affinity)</option>
                                <option value="minecraft:thorns">荆棘 (Thorns)</option>
                                <option value="minecraft:depth_strider">深海探索者 (Depth Strider)</option>
                                <option value="minecraft:frost_walker">冰霜行者 (Frost Walker)</option>
                                <option value="minecraft:soul_speed">灵魂急行 (Soul Speed)</option>
                            </optgroup>
                            <optgroup label="弓">
                                <option value="minecraft:power">力量 (Power)</option>
                                <option value="minecraft:punch">冲击 (Punch)</option>
                                <option value="minecraft:flame">火矢 (Flame)</option>
                                <option value="minecraft:infinity">无限 (Infinity)</option>
                            </optgroup>
                            <optgroup label="钓鱼">
                                <option value="minecraft:luck_of_the_sea">海之眷顾 (Luck of the Sea)</option>
                                <option value="minecraft:lure">饵钓 (Lure)</option>
                            </optgroup>
                            <optgroup label="通用">
                                <option value="minecraft:unbreaking">耐久 (Unbreaking)</option>
                                <option value="minecraft:mending">经验修补 (Mending)</option>
                                <option value="minecraft:vanishing_curse">消失诅咒 (Curse of Vanishing)</option>
                                <option value="minecraft:binding_curse">约束诅咒 (Curse of Binding)</option>
                            </optgroup>
                        </select></div>
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-layer-group"></i> 等级</label>
                        <input type="number" id="gen_enchant_level" class="search-input" placeholder="1" value="1" min="1" max="10"></div>
                `,
                quickPick: ''
            },
            
            setblock: {
                title: 'setblock 指令生成器',
                icon: 'fa-cube',
                color: '#f59e0b',
                darkColor: '#d97706',
                nbtEditor: true,
                fields: `
                    ${commonFields.coordinates}
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-cube"></i> 方块ID</label>
                        <input type="text" id="gen_block" class="search-input" placeholder="minecraft:stone" value="minecraft:stone"></div>
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-cog"></i> 模式</label>
                        <select id="gen_mode" class="search-input">
                            <option value="replace">替换 (replace) - 默认</option>
                            <option value="destroy">破坏 (destroy) - 破坏并掉落</option>
                            <option value="keep">保留 (keep) - 仅替换空气</option>
                        </select></div>
                `,
                quickPick: `<div class="input-area" style="margin-top: 16px;">
                    <h4 style="color: #94a3b8; margin-bottom: 12px; font-size: 0.9rem;"><i class="fas fa-bolt"></i> 快速选择方块</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${['minecraft:stone', 'minecraft:cobblestone', 'minecraft:dirt', 'minecraft:grass_block', 'minecraft:sand', 'minecraft:glass', 'minecraft:oak_planks', 'minecraft:bricks', 'minecraft:diamond_block', 'minecraft:gold_block', 'minecraft:iron_block', 'minecraft:emerald_block', 'minecraft:redstone_block', 'minecraft:lapis_block', 'minecraft:obsidian', 'minecraft:bedrock'].map(block => 
                            `<button onclick="document.getElementById('gen_block').value='${block}'" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">${block.replace('minecraft:', '')}</button>`
                        ).join('')}
                    </div>
                </div>`
            },
            
            title: {
                title: 'title 指令生成器',
                icon: 'fa-heading',
                color: '#8b5cf6',
                darkColor: '#7c3aed',
                nbtEditor: false,
                fields: `
                    ${commonFields.target}
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-tv"></i> 显示位置</label>
                        <select id="gen_title_type" class="search-input">
                            <option value="title">标题 (title) - 屏幕中央大文字</option>
                            <option value="subtitle">副标题 (subtitle) - 标题下方小字</option>
                            <option value="actionbar">操作栏 (actionbar) - 屏幕上方</option>
                        </select></div>
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-font"></i> 文本内容</label>
                        <input type="text" id="gen_title_text" class="search-input" placeholder="输入显示的文字..." value="Hello World!"></div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px;">
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-palette"></i> 颜色</label>
                            <select id="gen_title_color" class="search-input">
                                <option value="white">白色</option>
                                <option value="red">红色</option>
                                <option value="green">绿色</option>
                                <option value="blue">蓝色</option>
                                <option value="yellow">黄色</option>
                                <option value="gold">金色</option>
                                <option value="aqua">浅蓝</option>
                                <option value="light_purple">粉色</option>
                                <option value="dark_red">深红</option>
                                <option value="dark_green">深绿</option>
                                <option value="dark_blue">深蓝</option>
                                <option value="dark_aqua">深浅蓝</option>
                                <option value="dark_purple">深紫</option>
                                <option value="gray">灰色</option>
                                <option value="dark_gray">深灰</option>
                                <option value="black">黑色</option>
                            </select></div>
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-bold"></i> 样式</label>
                            <select id="gen_title_style" class="search-input">
                                <option value="">无</option>
                                <option value="bold">粗体</option>
                                <option value="italic">斜体</option>
                                <option value="underlined">下划线</option>
                                <option value="strikethrough">删除线</option>
                                <option value="obfuscated">混淆</option>
                            </select></div>
                    </div>
                `,
                quickPick: ''
            },
            
            gamemode: {
                title: 'gamemode 指令生成器',
                icon: 'fa-gamepad',
                color: '#4ade80',
                darkColor: '#16a34a',
                nbtEditor: false,
                fields: `
                    ${commonFields.target}
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-gamepad"></i> 游戏模式</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; border: 2px solid transparent;" onclick="selectGamemode('survival', this)">
                                <input type="radio" name="gen_gamemode" value="survival" checked>
                                <span><i class="fas fa-heart" style="color: #ef4444;"></i> 生存模式</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; border: 2px solid transparent;" onclick="selectGamemode('creative', this)">
                                <input type="radio" name="gen_gamemode" value="creative">
                                <span><i class="fas fa-cube" style="color: #22d3ee;"></i> 创造模式</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; border: 2px solid transparent;" onclick="selectGamemode('adventure', this)">
                                <input type="radio" name="gen_gamemode" value="adventure">
                                <span><i class="fas fa-compass" style="color: #f59e0b;"></i> 冒险模式</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; border: 2px solid transparent;" onclick="selectGamemode('spectator', this)">
                                <input type="radio" name="gen_gamemode" value="spectator">
                                <span><i class="fas fa-eye" style="color: #a855f7;"></i> 旁观模式</span>
                            </label>
                        </div>
                    </div>
                `,
                quickPick: ''
            },
            
            time: {
                title: 'time 指令生成器',
                icon: 'fa-clock',
                color: '#818cf8',
                darkColor: '#4f46e5',
                nbtEditor: false,
                fields: `
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-clock"></i> 时间操作</label>
                        <select id="gen_time_action" class="search-input">
                            <option value="set">设置 (set)</option>
                            <option value="add">增加 (add)</option>
                            <option value="query">查询 (query)</option>
                        </select></div>
                    <div id="time_set_panel">
                        <label style="color: #94a3b8; display: block; margin-bottom: 6px; margin-top: 12px;"><i class="fas fa-sun"></i> 时间设置</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <button onclick="document.getElementById('gen_time_value').value='day'" class="btn btn-secondary" style="padding: 12px;">
                                <i class="fas fa-sun" style="color: #fbbf24;"></i> 白天 (day)
                            </button>
                            <button onclick="document.getElementById('gen_time_value').value='night'" class="btn btn-secondary" style="padding: 12px;">
                                <i class="fas fa-moon" style="color: #818cf8;"></i> 黑夜 (night)
                            </button>
                            <button onclick="document.getElementById('gen_time_value').value='noon'" class="btn btn-secondary" style="padding: 12px;">
                                <i class="fas fa-sun" style="color: #f59e0b;"></i> 正午 (noon)
                            </button>
                            <button onclick="document.getElementById('gen_time_value').value='midnight'" class="btn btn-secondary" style="padding: 12px;">
                                <i class="fas fa-moon" style="color: #4f46e5;"></i> 午夜 (midnight)
                            </button>
                        </div>
                        <div style="margin-top: 12px;">
                            <label style="color: #94a3b8; display: block; margin-bottom: 6px;">或输入具体时间值 (0-24000)</label>
                            <input type="number" id="gen_time_value" class="search-input" placeholder="时间值" min="0" max="24000">
                        </div>
                    </div>
                `,
                quickPick: ''
            },
            
            weather: {
                title: 'weather 指令生成器',
                icon: 'fa-cloud',
                color: '#22d3ee',
                darkColor: '#0891b2',
                nbtEditor: false,
                fields: `
                    <div><label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-cloud"></i> 天气类型</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <label style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; cursor: pointer; border: 2px solid #fbbf24;" onclick="selectWeather('clear', this)">
                                <input type="radio" name="gen_weather" value="clear" checked style="display: none;">
                                <i class="fas fa-sun" style="font-size: 2rem; color: #fbbf24;"></i>
                                <span>晴天</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; cursor: pointer; border: 2px solid transparent;" onclick="selectWeather('rain', this)">
                                <input type="radio" name="gen_weather" value="rain" style="display: none;">
                                <i class="fas fa-cloud-rain" style="font-size: 2rem; color: #60a5fa;"></i>
                                <span>下雨</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; cursor: pointer; border: 2px solid transparent;" onclick="selectWeather('thunder', this)">
                                <input type="radio" name="gen_weather" value="thunder" style="display: none;">
                                <i class="fas fa-bolt" style="font-size: 2rem; color: #fbbf24;"></i>
                                <span>雷暴</span>
                            </label>
                        </div>
                    </div>
                    <div style="margin-top: 16px;">
                        <label style="color: #94a3b8; display: block; margin-bottom: 6px;"><i class="fas fa-hourglass-half"></i> 持续时间 (秒，可留空)</label>
                        <input type="number" id="gen_weather_duration" class="search-input" placeholder="默认随机时间" min="0">
                    </div>
                `,
                quickPick: ''
            }
        };
    }
    
    function toggleNBTEditor() {
        const panel = document.getElementById('nbtEditorPanel');
        if (panel) {
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
    }
    
    function toggleTPMode() {
        const mode = document.getElementById('gen_tp_mode').value;
        document.getElementById('tp_player_input').style.display = mode === 'player' ? 'block' : 'none';
        document.getElementById('tp_coords_input').style.display = mode === 'coords' ? 'block' : 'none';
    }
    
    function selectGamemode(mode, label) {
        document.querySelectorAll('input[name="gen_gamemode"]').forEach(el => {
            el.checked = el.value === mode;
        });
        document.querySelectorAll('#genFormFields label').forEach(l => {
            l.style.borderColor = 'transparent';
        });
        label.style.borderColor = '#4ade80';
    }
    
    function selectWeather(type, label) {
        document.querySelectorAll('input[name="gen_weather"]').forEach(el => {
            el.checked = el.value === type;
        });
        document.querySelectorAll('[onclick^="selectWeather"]').forEach(l => {
            l.style.borderColor = 'transparent';
        });
        const colors = { clear: '#fbbf24', rain: '#60a5fa', thunder: '#fbbf24' };
        label.style.borderColor = colors[type];
    }
    
    function closeGeneratorForm() {
        document.getElementById('generatorForm').innerHTML = '';
        document.getElementById('generatorQuickPick').innerHTML = '';
    }
    
    function clearGeneratorForm() {
        document.querySelectorAll('#genFormFields input, #genFormFields select, #genFormFields textarea').forEach(el => {
            if (el.type === 'checkbox' || el.type === 'radio') {
                el.checked = el.defaultChecked;
            } else if (el.tagName === 'SELECT') {
                el.selectedIndex = 0;
            } else {
                el.value = el.defaultValue || '';
            }
        });
        document.getElementById('genResult').style.display = 'none';
    }
    
    let lastGeneratedCommand = '';
    let lastGeneratedName = '';
    
    function generateEnhancedCommand(type) {
        let command = '';
        let name = type;
        
        try {
            switch(type) {
                case 'give':
                    const gTarget = document.getElementById('gen_target')?.value || '@p';
                    const gItem = document.getElementById('gen_item')?.value || 'minecraft:stone';
                    const gCount = document.getElementById('gen_count')?.value || '1';
                    const gNBT = document.getElementById('gen_nbt')?.value?.trim();
                    command = `/give ${gTarget} ${gItem}${gNBT ? gNBT : ''} ${gCount}`;
                    name = `给予 ${gItem.replace('minecraft:', '')}`;
                    break;
                    
                case 'summon':
                    const sEntity = document.getElementById('gen_entity')?.value || 'minecraft:pig';
                    const sX = document.getElementById('gen_x')?.value || '~';
                    const sY = document.getElementById('gen_y')?.value || '~';
                    const sZ = document.getElementById('gen_z')?.value || '~';
                    const sNBT = document.getElementById('gen_nbt')?.value?.trim();
                    command = `/summon ${sEntity} ${sX} ${sY} ${sZ}${sNBT ? ' ' + sNBT : ''}`;
                    name = `召唤 ${sEntity.replace('minecraft:', '')}`;
                    break;
                    
                case 'tp':
                    const tTarget = document.getElementById('gen_target')?.value || '@p';
                    const tMode = document.getElementById('gen_tp_mode')?.value;
                    if (tMode === 'player') {
                        const tPlayer = document.getElementById('gen_dest_player')?.value;
                        if (!tPlayer) { showToast('请输入目标玩家名称'); return; }
                        command = `/tp ${tTarget} ${tPlayer}`;
                    } else {
                        const tX = document.getElementById('gen_x')?.value || '~';
                        const tY = document.getElementById('gen_y')?.value || '~';
                        const tZ = document.getElementById('gen_z')?.value || '~';
                        command = `/tp ${tTarget} ${tX} ${tY} ${tZ}`;
                    }
                    name = `传送 ${tTarget}`;
                    break;
                    
                case 'effect':
                    const eTarget = document.getElementById('gen_target')?.value || '@p';
                    const eEffect = document.getElementById('gen_effect')?.value || 'minecraft:speed';
                    const eDuration = document.getElementById('gen_duration')?.value || '30';
                    const eAmplifier = document.getElementById('gen_amplifier')?.value || '0';
                    const eHide = document.getElementById('gen_hide_particles')?.checked;
                    command = `/effect give ${eTarget} ${eEffect} ${eDuration} ${eAmplifier}${eHide ? ' true' : ''}`;
                    name = `添加效果 ${eEffect.replace('minecraft:', '')}`;
                    break;
                    
                case 'enchant':
                    const enTarget = document.getElementById('gen_target')?.value || '@p';
                    const enType = document.getElementById('gen_enchantment')?.value || 'minecraft:sharpness';
                    const enLevel = document.getElementById('gen_enchant_level')?.value || '1';
                    command = `/enchant ${enTarget} ${enType} ${enLevel}`;
                    name = `附魔 ${enType.replace('minecraft:', '')}`;
                    break;
                    
                case 'setblock':
                    const sbX = document.getElementById('gen_x')?.value || '~';
                    const sbY = document.getElementById('gen_y')?.value || '~';
                    const sbZ = document.getElementById('gen_z')?.value || '~';
                    const sbBlock = document.getElementById('gen_block')?.value || 'minecraft:stone';
                    const sbMode = document.getElementById('gen_mode')?.value || 'replace';
                    const sbNBT = document.getElementById('gen_nbt')?.value?.trim();
                    command = `/setblock ${sbX} ${sbY} ${sbZ} ${sbBlock}${sbNBT ? sbNBT : ''} ${sbMode}`;
                    name = `设置方块 ${sbBlock.replace('minecraft:', '')}`;
                    break;
                    
                case 'title':
                    const titleTarget = document.getElementById('gen_target')?.value || '@p';
                    const titleType = document.getElementById('gen_title_type')?.value || 'title';
                    const titleText = document.getElementById('gen_title_text')?.value || 'Hello';
                    const titleColor = document.getElementById('gen_title_color')?.value || 'white';
                    const titleStyle = document.getElementById('gen_title_style')?.value || '';
                    
                    let jsonText = `{\\"text\\":\\"${titleText}\\",\\"color\\":\\"${titleColor}\\"${titleStyle ? `,\\"${titleStyle}\\":true` : ''}}`;
                    command = `/title ${titleTarget} ${titleType} ${jsonText}`;
                    name = `显示标题: ${titleText}`;
                    break;
                    
                case 'gamemode':
                    const gmTarget = document.getElementById('gen_target')?.value || '@p';
                    const gmMode = document.querySelector('input[name="gen_gamemode"]:checked')?.value || 'survival';
                    command = `/gamemode ${gmMode} ${gmTarget}`;
                    name = `切换游戏模式: ${gmMode}`;
                    break;
                    
                case 'time':
                    const timeAction = document.getElementById('gen_time_action')?.value || 'set';
                    const timeValue = document.getElementById('gen_time_value')?.value || 'day';
                    command = `/time ${timeAction} ${timeValue}`;
                    name = `设置时间: ${timeValue}`;
                    break;
                    
                case 'weather':
                    const weatherType = document.querySelector('input[name="gen_weather"]:checked')?.value || 'clear';
                    const weatherDuration = document.getElementById('gen_weather_duration')?.value;
                    command = `/weather ${weatherType}${weatherDuration ? ' ' + weatherDuration : ''}`;
                    name = `设置天气: ${weatherType}`;
                    break;
                    
                default:
                    showToast('此指令模板开发中...');
                    return;
            }
            
            lastGeneratedCommand = command;
            lastGeneratedName = name;
            
            // 显示结果
            const resultDiv = document.getElementById('genResult');
            const commandText = document.getElementById('genCommandText');
            
            if (resultDiv && commandText) {
                commandText.textContent = command;
                resultDiv.style.display = 'block';
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            }
            
        } catch (err) {
            showToast('生成指令时出错: ' + err.message);
            console.error(err);
        }
    }
    
    function previewCommand(type) {
        generateEnhancedCommand(type);
    }
    
    function copyGeneratedCommand() {
        if (lastGeneratedCommand) {
            copyText(lastGeneratedCommand);
        }
    }
    
    function addGenToFavorites() {
        if (lastGeneratedCommand && lastGeneratedName) {
            addToFavorites({
                id: Date.now(),
                type: 'generated_command',
                content: lastGeneratedCommand,
                name: lastGeneratedName
            });
        }
    }
    
    function saveToHistoryFromGen() {
        if (lastGeneratedCommand) {
            addToCommandHistory(lastGeneratedCommand, lastGeneratedName);
            showToast('已保存到历史记录');
        }
    }
    
    function addToCommandHistory(command, name) {
        commandHistory.unshift({
            command,
            name: name || '未命名指令',
            timestamp: new Date().toISOString()
        });
        
        // 只保留最近50条
        if (commandHistory.length > 50) {
            commandHistory = commandHistory.slice(0, 50);
        }
        
        localStorage.setItem('mc_cmd_history', JSON.stringify(commandHistory));
    }
    
    function showCommandHistory() {
        const modal = document.getElementById('modal');
        const body = document.getElementById('modal-body');
        
        let historyHtml = '';
        if (commandHistory.length === 0) {
            historyHtml = `
                <div class="empty-state">
                    <div style="font-size: 3rem; margin-bottom: 12px;">📜</div>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 6px;">暂无历史记录</div>
                    <div style="font-size: 0.85rem; color: #64748b;">生成的指令将自动保存在这里</div>
                </div>
            `;
        } else {
            historyHtml = `
                <div style="max-height: 500px; overflow-y: auto;">
                    ${commandHistory.map((item, index) => `
                        <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 14px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <span style="color: #94a3b8; font-size: 0.85rem;">${item.name}</span>
                                <span style="color: #64748b; font-size: 0.75rem;">${new Date(item.timestamp).toLocaleString()}</span>
                            </div>
                            <div style="font-family: 'JetBrains Mono', monospace; color: var(--mc-green); word-break: break-all; margin-bottom: 10px; font-size: 0.9rem;">
                                ${escapeHtml(item.command)}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="copyText('${item.command.replace(/'/g, "\\'")}'); closeModal();" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem;">
                                    <i class="fas fa-copy"></i> 复制
                                </button>
                                <button onclick="deleteCommandHistory(${index})" class="btn" style="padding: 6px 12px; font-size: 0.8rem; background: rgba(220,38,38,0.2); color: #fca5a5;">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        body.innerHTML = `
            <h2 style="font-family: VT323, monospace; font-size: 1.8rem; color: var(--mc-gold); margin-bottom: 20px;">
                <i class="fas fa-history"></i> 指令历史记录
            </h2>
            ${historyHtml}
            ${commandHistory.length > 0 ? `
                <div style="margin-top: 16px; text-align: center;">
                    <button onclick="clearCommandHistory()" class="btn btn-secondary" style="background: rgba(220,38,38,0.2); color: #fca5a5;">
                        <i class="fas fa-trash-alt"></i> 清空所有记录
                    </button>
                </div>
            ` : ''}
        `;
        
        modal.style.display = 'block';
    }
    
    function deleteCommandHistory(index) {
        commandHistory.splice(index, 1);
        localStorage.setItem('mc_cmd_history', JSON.stringify(commandHistory));
        showCommandHistory(); // 刷新
    }
    
    function clearCommandHistory() {
        if (confirm('确定要清空所有历史记录吗？')) {
            commandHistory = [];
            localStorage.removeItem('mc_cmd_history');
            showCommandHistory();
            showToast('历史记录已清空');
        }
    }
    
    // ==================== Target Selector Builder ====================
    function renderSelectorBuilder(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('target_selector')}</h2>
                    <div class="page-subtitle">图形化构建 @e/@a/@p/@r 选择器</div>
                </div>
            </div>
            <div class="input-area">
                <div style="margin-bottom: 16px;">
                    <label style="color: #94a3b8; display: block; margin-bottom: 8px;">目标类型</label>
                    <select id="selType" onchange="updateSelectorPreview()" class="search-input" style="max-width: 300px;">
                        <option value="@p">最近玩家 @p</option>
                        <option value="@a">所有玩家 @a</option>
                        <option value="@r">随机玩家 @r</option>
                        <option value="@e">所有实体 @e</option>
                        <option value="@s">执行者 @s</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="color: #94a3b8; display: block; margin-bottom: 10px;"><i class="fas fa-filter"></i> 过滤条件</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selDistance" onchange="toggleSelectorOption('distance')" style="margin-right: 8px;">
                            <span>距离范围</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selGamemode" onchange="toggleSelectorOption('gamemode')" style="margin-right: 8px;">
                            <span>游戏模式</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selTypeEntity" onchange="toggleSelectorOption('type')" style="margin-right: 8px;">
                            <span>实体类型</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selLimit" onchange="toggleSelectorOption('limit')" style="margin-right: 8px;">
                            <span>限制数量</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selSort" onchange="toggleSelectorOption('sort')" style="margin-right: 8px;">
                            <span>排序方式</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selScores" onchange="toggleSelectorOption('scores')" style="margin-right: 8px;">
                            <span>计分板条件</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selTags" onchange="toggleSelectorOption('tag')" style="margin-right: 8px;">
                            <span>标签</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selTeam" onchange="toggleSelectorOption('team')" style="margin-right: 8px;">
                            <span>队伍</span>
                        </label>
                    </div>
                </div>
                
                <div id="selectorOptions"></div>
                
                <div style="background: rgba(0,0,0,0.4); border-radius: 10px; padding: 16px; margin-top: 20px; border: 1px solid rgba(93,140,58,0.3);">
                    <div style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 8px;">选择器预览</div>
                    <div id="selectorPreview" style="font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; color: var(--mc-green);">@p</div>
                </div>
                
                <div class="action-buttons">
                    <button onclick="copySelector()" class="btn btn-primary"><i class="fas fa-copy"></i> ${t('copy')}</button>
                    <button onclick="addSelectorToFavorites()" class="btn btn-secondary"><i class="fas fa-star"></i> ${t('add_favorite')}</button>
                </div>
            </div>
        `;
    }
    
    function toggleSelectorOption(option) {
        const container = document.getElementById('selectorOptions');
        let optionHtml = '';
        
        const options = {
            distance: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">距离范围</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="distMin" placeholder="最小" class="search-input" style="width: 80px; padding: 8px;" oninput="updateSelectorPreview()">
                        <span style="color: #64748b;">~</span>
                        <input type="number" id="distMax" placeholder="最大" class="search-input" style="width: 80px; padding: 8px;" oninput="updateSelectorPreview()">
                        <span style="color: #64748b; font-size: 0.8rem;">格</span>
                    </div>
                </div>
            `,
            gamemode: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">游戏模式</div>
                    <select id="gamemodeVal" class="search-input" style="max-width: 200px;" onchange="updateSelectorPreview()">
                        <option value="survival">生存模式</option>
                        <option value="creative">创造模式</option>
                        <option value="adventure">冒险模式</option>
                        <option value="spectator">旁观模式</option>
                    </select>
                </div>
            `,
            type: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">实体类型</div>
                    <input type="text" id="typeVal" placeholder="minecraft:zombie" class="search-input" style="max-width: 250px;" oninput="updateSelectorPreview()">
                </div>
            `,
            limit: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">限制数量</div>
                    <input type="number" id="limitVal" placeholder="1" value="1" min="1" class="search-input" style="width: 80px;" oninput="updateSelectorPreview()">
                </div>
            `,
            sort: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">排序方式</div>
                    <select id="sortVal" class="search-input" style="max-width: 200px;" onchange="updateSelectorPreview()">
                        <option value="nearest">最近</option>
                        <option value="furthest">最远</option>
                        <option value="random">随机</option>
                        <option value="arbitrary">任意</option>
                    </select>
                </div>
            `,
            scores: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">计分板条件</div>
                    <input type="text" id="scoresVal" placeholder="kills=1.." class="search-input" style="max-width: 250px;" oninput="updateSelectorPreview()">
                </div>
            `,
            tag: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">标签</div>
                    <input type="text" id="tagVal" placeholder="myTag" class="search-input" style="max-width: 250px;" oninput="updateSelectorPreview()">
                </div>
            `,
            team: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">队伍</div>
                    <input type="text" id="teamVal" placeholder="red" class="search-input" style="max-width: 250px;" oninput="updateSelectorPreview()">
                </div>
            `
        };
        
        // Rebuild options based on checked checkboxes
        let html = '';
        if(document.getElementById('selDistance')?.checked) html += options.distance;
        if(document.getElementById('selGamemode')?.checked) html += options.gamemode;
        if(document.getElementById('selTypeEntity')?.checked) html += options.type;
        if(document.getElementById('selLimit')?.checked) html += options.limit;
        if(document.getElementById('selSort')?.checked) html += options.sort;
        if(document.getElementById('selScores')?.checked) html += options.scores;
        if(document.getElementById('selTags')?.checked) html += options.tag;
        if(document.getElementById('selTeam')?.checked) html += options.team;
        
        container.innerHTML = html;
        updateSelectorPreview();
    }
    
    function updateSelectorPreview() {
        const type = document.getElementById('selType')?.value || '@p';
        const conditions = [];
        
        if(document.getElementById('selDistance')?.checked) {
            const min = document.getElementById('distMin')?.value;
            const max = document.getElementById('distMax')?.value;
            if(min && max) conditions.push(`distance=${min}..${max}`);
            else if(max) conditions.push(`distance=..${max}`);
            else if(min) conditions.push(`distance=${min}..`);
        }
        if(document.getElementById('selGamemode')?.checked) {
            const gm = document.getElementById('gamemodeVal')?.value;
            if(gm) conditions.push(`gamemode=${gm}`);
        }
        if(document.getElementById('selTypeEntity')?.checked) {
            const t = document.getElementById('typeVal')?.value;
            if(t) conditions.push(`type=${t}`);
        }
        if(document.getElementById('selLimit')?.checked) {
            const l = document.getElementById('limitVal')?.value;
            if(l) conditions.push(`limit=${l}`);
        }
        if(document.getElementById('selSort')?.checked) {
            const s = document.getElementById('sortVal')?.value;
            if(s) conditions.push(`sort=${s}`);
        }
        if(document.getElementById('selScores')?.checked) {
            const sc = document.getElementById('scoresVal')?.value;
            if(sc) conditions.push(`scores={${sc}}`);
        }
        if(document.getElementById('selTags')?.checked) {
            const tg = document.getElementById('tagVal')?.value;
            if(tg) conditions.push(`tag=${tg}`);
        }
        if(document.getElementById('selTeam')?.checked) {
            const tm = document.getElementById('teamVal')?.value;
            if(tm) conditions.push(`team=${tm}`);
        }
        
        const preview = document.getElementById('selectorPreview');
        if(preview) {
            preview.textContent = conditions.length > 0 ? `${type}[${conditions.join(',')}]` : type;
        }
    }
    
    function copySelector() {
        const preview = document.getElementById('selectorPreview')?.textContent;
        if(preview) {
            copyText(preview);
            showToast(t('copied') || '已复制');
        }
    }
    
    function addSelectorToFavorites() {
        const preview = document.getElementById('selectorPreview')?.textContent;
        if(preview) {
            addToFavorites({
                id: Date.now(),
                type: 'selector',
                content: preview,
                name: `选择器: ${preview.substring(0, 20)}`
            });
        }
    }


    
    // ==================== NBT Editor ====================
    function renderNBTEditor(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('nbt_editor')}</h2>
                    <div class="page-subtitle">可视化编辑和解析NBT数据</div>
                </div>
            </div>
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchNBTPanel('editor', this)">NBT编辑器</button>
                <button class="tab-btn" onclick="switchNBTPanel('templates', this)">预设模板</button>
                <button class="tab-btn" onclick="switchNBTPanel('parser', this)">SNBT解析</button>
            </div>
            
            <div id="nbt-panel-editor">
                <div class="input-area">
                    <div style="margin-bottom: 12px;">
                        <span style="color: #64748b; font-size: 0.85rem;"><i class="fas fa-code" style="color: var(--mc-gold);"></i> 输入SNBT字符串或使用模板</span>
                    </div>
                    <textarea class="command-textarea" id="nbtInput" placeholder='{id:"minecraft:diamond",Count:1b,tag:{display:{Name:"\"宝石\""}}}'></textarea>
                    <div class="action-buttons">
                        <button onclick="parseNBTWithNBTify()" class="btn btn-primary" style="background: linear-gradient(135deg, var(--mc-gold), #f59e0b); color: #000;">
                            <i class="fas fa-tree"></i> 解析NBT
                        </button>
                        <button onclick="formatNBT()" class="btn btn-secondary">
                            <i class="fas fa-align-left"></i> 格式化
                        </button>
                        <button onclick="clearNBT()" class="btn btn-secondary">
                            <i class="fas fa-trash"></i> ${t('clear')}
                        </button>
                    </div>
                </div>
                <div id="nbtResult" class="result-panel" style="display: none;">
                    <div class="result-header">
                        <div class="result-title"><i class="fas fa-sitemap"></i> NBT树形结构</div>
                    </div>
                    <div id="nbtTree"></div>
                </div>
            </div>
            
            <div id="nbt-panel-templates" style="display: none;">
                <div class="content-grid">
                    <div class="card" onclick="loadNBTTemplate('item_enchanted')">
                        <div class="card-header">
                            <div class="card-title" style="font-size: 1.1rem;"><i class="fas fa-gem" style="color: var(--mc-gold);"></i> 附魔装备</div>
                        </div>
                        <div class="card-desc">带有多种附魔的钻石剑NBT</div>
                    </div>
                    <div class="card" onclick="loadNBTTemplate('entity_boss')">
                        <div class="card-header">
                            <div class="card-title" style="font-size: 1.1rem;"><i class="fas fa-skull" style="color: #ef4444;"></i> Boss实体</div>
                        </div>
                        <div class="card-desc">高血量装备齐全的精英怪物</div>
                    </div>
                    <div class="card" onclick="loadNBTTemplate('chest_loot')">
                        <div class="card-header">
                            <div class="card-title" style="font-size: 1.1rem;"><i class="fas fa-box" style="color: #f59e0b;"></i> 战利品箱子</div>
                        </div>
                        <div class="card-desc">包含多种物品的箱子NBT</div>
                    </div>
                    <div class="card" onclick="loadNBTTemplate('potion_custom')">
                        <div class="card-header">
                            <div class="card-title" style="font-size: 1.1rem;"><i class="fas fa-flask" style="color: #a855f7;"></i> 自定义药水</div>
                        </div>
                        <div class="card-desc">多效果自定义药水</div>
                    </div>
                </div>
            </div>
            
            <div id="nbt-panel-parser" style="display: none;">
                <div class="input-area">
                    <p style="color: #94a3b8; margin-bottom: 12px;">将游戏中的NBT数据粘贴到这里解析</p>
                    <textarea class="command-textarea" id="nbtParseInput" placeholder="从F3+I复制NBT数据..."></textarea>
                    <div class="action-buttons">
                        <button onclick="parseClipboardNBT()" class="btn btn-primary">
                            <i class="fas fa-paste"></i> 解析剪贴板
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchNBTPanel(panel, btn) {
        document.querySelectorAll('[id^="nbt-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`nbt-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    // NBT类型定义
    const NBT_TYPES = {
        END: 0,
        BYTE: 1,
        SHORT: 2,
        INT: 3,
        LONG: 4,
        FLOAT: 5,
        DOUBLE: 6,
        BYTE_ARRAY: 7,
        STRING: 8,
        LIST: 9,
        COMPOUND: 10,
        INT_ARRAY: 11,
        LONG_ARRAY: 12
    };

    // 检查NBTify库是否可用
    function isNBTifyAvailable() {
        return typeof nbtify !== 'undefined' && nbtify.parse && typeof nbtify.parse === 'function';
    }

    // 将数据包装成NBT对象，保留类型信息
    function wrapNBTValue(value, typeHint = null) {
        if (value === null || value === undefined) {
            return { type: NBT_TYPES.END, value: null };
        }
        
        // 如果已经是NBT格式
        if (value && typeof value === 'object' && value._nbtType !== undefined) {
            return value;
        }
        
        if (typeof value === 'boolean') {
            return { type: NBT_TYPES.BYTE, value: value ? 1 : 0, _nbtType: 'byte' };
        }
        
        if (typeof value === 'number') {
            // 根据值范围推断类型
            if (Number.isInteger(value)) {
                if (value >= -128 && value <= 127 && typeHint === 'byte') {
                    return { type: NBT_TYPES.BYTE, value: value, _nbtType: 'byte' };
                } else if (value >= -32768 && value <= 32767 && typeHint === 'short') {
                    return { type: NBT_TYPES.SHORT, value: value, _nbtType: 'short' };
                } else if (Math.abs(value) > 2147483647) {
                    return { type: NBT_TYPES.LONG, value: value, _nbtType: 'long' };
                } else {
                    return { type: NBT_TYPES.INT, value: value, _nbtType: 'int' };
                }
            } else {
                return { type: NBT_TYPES.DOUBLE, value: value, _nbtType: 'double' };
            }
        }
        
        if (typeof value === 'string') {
            return { type: NBT_TYPES.STRING, value: value, _nbtType: 'string' };
        }
        
        if (Array.isArray(value)) {
            // 检查是否是特殊数组类型
            if (value._isByteArray) {
                return { type: NBT_TYPES.BYTE_ARRAY, value: value, _nbtType: 'byte_array' };
            } else if (value._isIntArray) {
                return { type: NBT_TYPES.INT_ARRAY, value: value, _nbtType: 'int_array' };
            } else if (value._isLongArray) {
                return { type: NBT_TYPES.LONG_ARRAY, value: value, _nbtType: 'long_array' };
            }
            return { type: NBT_TYPES.LIST, value: value, _nbtType: 'list' };
        }
        
        if (typeof value === 'object') {
            return { type: NBT_TYPES.COMPOUND, value: value, _nbtType: 'compound' };
        }
        
        return { type: NBT_TYPES.STRING, value: String(value), _nbtType: 'string' };
    }

    // 强大的SNBT解析器
    class SNBTParser {
        constructor(input) {
            this.input = input;
            this.pos = 0;
            this.length = input.length;
        }
        
        skipWhitespace() {
            while (this.pos < this.length && /\s/.test(this.input[this.pos])) {
                this.pos++;
            }
        }
        
        peek() {
            return this.pos < this.length ? this.input[this.pos] : null;
        }
        
        consume() {
            return this.pos < this.length ? this.input[this.pos++] : null;
        }
        
        expect(char) {
            this.skipWhitespace();
            if (this.peek() !== char) {
                throw new Error(`期望 '${char}' 但找到 '${this.peek()}' 在位置 ${this.pos}`);
            }
            this.pos++;
        }
        
        parse() {
            this.skipWhitespace();
            const result = this.parseValue();
            this.skipWhitespace();
            if (this.pos < this.length) {
                throw new Error(`有多余内容在位置 ${this.pos}`);
            }
            return result;
        }
        
        parseValue() {
            this.skipWhitespace();
            const char = this.peek();
            
            if (char === '{') {
                return this.parseCompound();
            } else if (char === '[') {
                return this.parseArrayOrList();
            } else if (char === '"' || char === "'") {
                return this.parseString();
            } else if (/[\d.-]/.test(char)) {
                return this.parseNumber();
            } else if (char === 't' || char === 'f') {
                return this.parseBoolean();
            } else {
                // 尝试解析为字符串（无引号）
                return this.parseUnquotedString();
            }
        }
        
        parseCompound() {
            this.expect('{');
            const result = {};
            
            this.skipWhitespace();
            if (this.peek() === '}') {
                this.pos++;
                return wrapNBTValue(result, 'compound');
            }
            
            while (true) {
                this.skipWhitespace();
                const key = this.parseKey();
                
                this.skipWhitespace();
                if (this.peek() !== ':') {
                    throw new Error(`期望 ':' 在键 '${key}' 之后`);
                }
                this.pos++;
                
                this.skipWhitespace();
                const value = this.parseValue();
                result[key] = value;
                
                this.skipWhitespace();
                const next = this.peek();
                
                if (next === '}') {
                    this.pos++;
                    break;
                } else if (next === ',') {
                    this.pos++;
                    continue;
                } else if (next === null) {
                    throw new Error('未期望的复合类型结尾');
                } else {
                    throw new Error(`期望 ',' 或 '}' 但找到 '${next}'`);
                }
            }
            
            return wrapNBTValue(result, 'compound');
        }
        
        parseKey() {
            const char = this.peek();
            if (char === '"' || char === "'") {
                const str = this.parseString();
                return typeof str === 'object' ? str.value : str;
            } else {
                return this.parseUnquotedKey();
            }
        }
        
        parseUnquotedKey() {
            let key = '';
            while (this.pos < this.length) {
                const char = this.peek();
                if (/[a-zA-Z0-9_\-]/.test(char)) {
                    key += this.consume();
                } else {
                    break;
                }
            }
            if (key === '') {
                throw new Error(`在位置 ${this.pos} 期望有效的键名`);
            }
            return key;
        }
        
        parseArrayOrList() {
            this.expect('[');
            this.skipWhitespace();
            
            // 检查是否是数组类型 [B; [I; [L;
            if (this.peek() === 'B' || this.peek() === 'I' || this.peek() === 'L') {
                const type = this.consume();
                this.skipWhitespace();
                if (this.peek() === ';') {
                    this.pos++;
                    return this.parseTypedArray(type);
                } else {
                    // 不是类型数组，回退并作为列表解析
                    this.pos -= 2;
                }
            }
            
            return this.parseList();
        }
        
        parseTypedArray(type) {
            const values = [];
            this.skipWhitespace();
            
            if (this.peek() === ']') {
                this.pos++;
                if (type === 'B') values._isByteArray = true;
                else if (type === 'I') values._isIntArray = true;
                else if (type === 'L') values._isLongArray = true;
                return wrapNBTValue(values, type === 'B' ? 'byte_array' : type === 'I' ? 'int_array' : 'long_array');
            }
            
            while (true) {
                this.skipWhitespace();
                const num = this.parseNumber();
                values.push(num.value !== undefined ? num.value : num);
                
                this.skipWhitespace();
                const next = this.peek();
                
                if (next === ']') {
                    this.pos++;
                    break;
                } else if (next === ',') {
                    this.pos++;
                    continue;
                } else {
                    throw new Error(`期望 ',' 或 ']' 但找到 '${next}'`);
                }
            }
            
            if (type === 'B') values._isByteArray = true;
            else if (type === 'I') values._isIntArray = true;
            else if (type === 'L') values._isLongArray = true;
            
            return wrapNBTValue(values, type === 'B' ? 'byte_array' : type === 'I' ? 'int_array' : 'long_array');
        }
        
        parseList() {
            const values = [];
            this.skipWhitespace();
            
            if (this.peek() === ']') {
                this.pos++;
                return wrapNBTValue(values, 'list');
            }
            
            while (true) {
                this.skipWhitespace();
                const value = this.parseValue();
                values.push(value);
                
                this.skipWhitespace();
                const next = this.peek();
                
                if (next === ']') {
                    this.pos++;
                    break;
                } else if (next === ',') {
                    this.pos++;
                    continue;
                } else {
                    throw new Error(`期望 ',' 或 ']' 但找到 '${next}'`);
                }
            }
            
            return wrapNBTValue(values, 'list');
        }
        
        parseString() {
            const quote = this.consume();
            let str = '';
            
            while (this.pos < this.length) {
                const char = this.consume();
                
                if (char === quote) {
                    return wrapNBTValue(str, 'string');
                } else if (char === '\\') {
                    const next = this.consume();
                    switch (next) {
                        case '"': str += '"'; break;
                        case "'": str += "'"; break;
                        case '\\': str += '\\'; break;
                        case 'n': str += '\n'; break;
                        case 't': str += '\t'; break;
                        case 'b': str += '\b'; break;
                        case 'r': str += '\r'; break;
                        case 'f': str += '\f'; break;
                        case 'u':
                            const hex = this.input.substr(this.pos, 4);
                            if (/^[0-9a-fA-F]{4}$/.test(hex)) {
                                str += String.fromCharCode(parseInt(hex, 16));
                                this.pos += 4;
                            } else {
                                str += '\\u' + hex;
                            }
                            break;
                        default:
                            str += next;
                    }
                } else {
                    str += char;
                }
            }
            
            throw new Error('未关闭的字符串');
        }
        
        parseUnquotedString() {
            let str = '';
            while (this.pos < this.length) {
                const char = this.peek();
                if (/[,}\]:;\s]/.test(char)) {
                    break;
                }
                str += this.consume();
            }
            return wrapNBTValue(str, 'string');
        }
        
        parseNumber() {
            const start = this.pos;
            let numStr = '';
            
            if (this.peek() === '-') {
                numStr += this.consume();
            }
            
            while (this.pos < this.length && /\d/.test(this.peek())) {
                numStr += this.consume();
            }
            
            if (this.peek() === '.') {
                numStr += this.consume();
                while (this.pos < this.length && /\d/.test(this.peek())) {
                    numStr += this.consume();
                }
                
                // 检查float/double后缀
                const suffix = this.peek();
                if (suffix === 'f' || suffix === 'F') {
                    this.pos++;
                    return wrapNBTValue(parseFloat(numStr), 'float');
                } else if (suffix === 'd' || suffix === 'D') {
                    this.pos++;
                    return wrapNBTValue(parseFloat(numStr), 'double');
                }
                
                return wrapNBTValue(parseFloat(numStr), 'double');
            } else {
                // 整数，检查类型后缀
                const suffix = this.peek();
                const value = parseInt(numStr, 10);
                
                if (suffix === 'b' || suffix === 'B') {
                    this.pos++;
                    return wrapNBTValue(value, 'byte');
                } else if (suffix === 's' || suffix === 'S') {
                    this.pos++;
                    return wrapNBTValue(value, 'short');
                } else if (suffix === 'l' || suffix === 'L') {
                    this.pos++;
                    return wrapNBTValue(value, 'long');
                } else {
                    return wrapNBTValue(value, 'int');
                }
            }
        }
        
        parseBoolean() {
            if (this.input.substr(this.pos, 4) === 'true') {
                this.pos += 4;
                return wrapNBTValue(true, 'byte');
            } else if (this.input.substr(this.pos, 5) === 'false') {
                this.pos += 5;
                return wrapNBTValue(false, 'byte');
            }
            throw new Error(`期望布尔值在位置 ${this.pos}`);
        }
    }

    // 解析SNBT
    function parseSNBT(input) {
        try {
            const parser = new SNBTParser(input);
            return parser.parse();
        } catch (e) {
            // 尝试后退到JSON解析
            try {
                const normalized = input.replace(/(\w+):/g, '"$1":')
                                       .replace(/'(.*?)'/g, '"$1"')
                                       .replace(/([0-9]+)[bBsSlLfFdD]/g, '$1');
                const parsed = JSON.parse(normalized);
                return wrapNBTValue(parsed);
            } catch (jsonError) {
                throw new Error(`SNBT解析失败: ${e.message}`);
            }
        }
    }

    // 主解析函数
    let currentNBTData = null;

    function parseNBTWithNBTify() {
        const input = document.getElementById('nbtInput').value.trim();
        const treeContainer = document.getElementById('nbtTree');
        const resultPanel = document.getElementById('nbtResult');
        
        if(!input) {
            showToast('请输入NBT数据');
            return;
        }
        
        try {
            let parsed;
            
            // 优先使用内置解析器
            parsed = parseSNBT(input);
            currentNBTData = parsed;
            
            // 添加导出按钮
            const exportBtn = `<button onclick="exportNBT()" class="btn btn-secondary" style="margin-left: 10px;">
                <i class="fas fa-download"></i> 导出.nbt
            </button>`;
            
            treeContainer.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <span class="tag tag-green"><i class="fas fa-check"></i> 解析成功</span>
                    <span class="tag" style="margin-left: 8px;">${getNBTTypeLabel(parsed.type)}</span>
                    ${exportBtn}
                </div>
                ${renderNBTTree(parsed, 0, null, true)}
            `;
            
            resultPanel.style.display = 'block';
            showToast('NBT解析成功');
        } catch(e) {
            treeContainer.innerHTML = `
                <div style="color: #ef4444; padding: 16px; background: rgba(239,68,68,0.1); border-radius: 8px;">
                    <i class="fas fa-times-circle"></i> <strong>解析错误</strong>
                    <div style="margin-top: 8px; font-family: monospace; font-size: 0.85rem;">${escapeHtml(e.message)}</div>
                    <div style="margin-top: 12px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                        <div style="color: #94a3b8; font-size: 0.8rem;">提示: 检查SNBT语法，确保所有引号和括号正确匹配</div>
                    </div>
                </div>
            `;
            resultPanel.style.display = 'block';
            currentNBTData = null;
        }
    }

    // 获取NBT类型标签
    function getNBTTypeLabel(type) {
        const labels = {
            [NBT_TYPES.BYTE]: 'byte',
            [NBT_TYPES.SHORT]: 'short',
            [NBT_TYPES.INT]: 'int',
            [NBT_TYPES.LONG]: 'long',
            [NBT_TYPES.FLOAT]: 'float',
            [NBT_TYPES.DOUBLE]: 'double',
            [NBT_TYPES.BYTE_ARRAY]: 'byte[]',
            [NBT_TYPES.STRING]: 'string',
            [NBT_TYPES.LIST]: 'list',
            [NBT_TYPES.COMPOUND]: 'compound',
            [NBT_TYPES.INT_ARRAY]: 'int[]',
            [NBT_TYPES.LONG_ARRAY]: 'long[]'
        };
        return labels[type] || 'unknown';
    }

    // 获取类型颜色
    function getNBTTypeColor(type) {
        const colors = {
            [NBT_TYPES.BYTE]: '#569cd6',
            [NBT_TYPES.SHORT]: '#569cd6',
            [NBT_TYPES.INT]: '#b5cea8',
            [NBT_TYPES.LONG]: '#b5cea8',
            [NBT_TYPES.FLOAT]: '#b5cea8',
            [NBT_TYPES.DOUBLE]: '#b5cea8',
            [NBT_TYPES.BYTE_ARRAY]: '#ce9178',
            [NBT_TYPES.STRING]: '#ce9178',
            [NBT_TYPES.LIST]: '#9cdcfe',
            [NBT_TYPES.COMPOUND]: '#dcdcaa',
            [NBT_TYPES.INT_ARRAY]: '#ce9178',
            [NBT_TYPES.LONG_ARRAY]: '#ce9178'
        };
        return colors[type] || '#e2e8f0';
    }

    // 渲染NBT树
    function renderNBTTree(data, depth, key = null, isRoot = false) {
        const indent = depth * 16;
        
        // 解包NBT对象
        let value, type, nbtType;
        if (data && typeof data === 'object' && data.type !== undefined) {
            value = data.value;
            type = data.type;
            nbtType = data._nbtType;
        } else {
            value = data;
            type = NBT_TYPES.STRING;
        }
        
        const nodeId = `nbt-node-${Math.random().toString(36).substr(2, 9)}`;
        
        // 空值
        if (value === null || value === undefined) {
            return `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${escapeHtml(key)}:</span> ` : ''}<span style="color: #64748b;">null</span></div>`;
        }
        
        // 布尔值
        if (type === NBT_TYPES.BYTE && (value === 0 || value === 1 || value === true || value === false)) {
            const boolStr = value === 1 || value === true ? 'true' : 'false';
            return `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${escapeHtml(key)}:</span> ` : ''}<span class="nbt-boolean">${boolStr}</span><span style="color: #64748b; font-size: 0.8rem;"> (byte)</span></div>`;
        }
        
        // 数字值
        if ([NBT_TYPES.BYTE, NBT_TYPES.SHORT, NBT_TYPES.INT, NBT_TYPES.LONG, NBT_TYPES.FLOAT, NBT_TYPES.DOUBLE].includes(type)) {
            const suffixes = { [NBT_TYPES.BYTE]: 'b', [NBT_TYPES.SHORT]: 's', [NBT_TYPES.LONG]: 'L', [NBT_TYPES.FLOAT]: 'f', [NBT_TYPES.DOUBLE]: 'd' };
            const suffix = suffixes[type] || '';
            const color = getNBTTypeColor(type);
            return `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${escapeHtml(key)}:</span> ` : ''}<span style="color: ${color};">${value}${suffix}</span></div>`;
        }
        
        // 字符串
        if (type === NBT_TYPES.STRING) {
            return `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${escapeHtml(key)}:</span> ` : ''}<span class="nbt-string">"${escapeHtml(String(value))}"</span></div>`;
        }
        
        // 数组类型
        if (type === NBT_TYPES.BYTE_ARRAY || type === NBT_TYPES.INT_ARRAY || type === NBT_TYPES.LONG_ARRAY) {
            const arrayType = type === NBT_TYPES.BYTE_ARRAY ? 'B' : type === NBT_TYPES.INT_ARRAY ? 'I' : 'L';
            const itemCount = Array.isArray(value) ? value.length : 0;
            
            let html = `<div class="nbt-node collapsible" data-target="${nodeId}" style="margin-left: ${indent}px; cursor: pointer;">`;
            html += `<i class="fas fa-chevron-down" style="font-size: 0.7rem; margin-right: 4px; color: #64748b;"></i>`;
            html += `${key ? `<span class="nbt-key">${escapeHtml(key)}:</span> ` : ''}`;
            html += `<span style="color: #9cdcfe;">[${arrayType}; ${itemCount} items]</span>`;
            html += `</div>`;
            html += `<div id="${nodeId}" class="nbt-list collapsible-content">`;
            
            if (Array.isArray(value)) {
                value.forEach((item, i) => {
                    const itemVal = item && typeof item === 'object' ? item.value : item;
                    html += `<div class="nbt-node" style="margin-left: ${indent + 16}px;"><span style="color: #64748b;">[${i}]</span> <span style="color: ${getNBTTypeColor(type)};">${itemVal}</span></div>`;
                });
            }
            html += `</div>`;
            return html;
        }
        
        // 列表
        if (type === NBT_TYPES.LIST || (Array.isArray(value) && typeof value === 'object')) {
            const items = Array.isArray(value) ? value : [];
            const itemCount = items.length;
            
            if (itemCount === 0) {
                return `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${escapeHtml(key)}:</span> ` : ''}<span style="color: #9cdcfe;">[]</span></div>`;
            }
            
            let html = `<div class="nbt-node collapsible" data-target="${nodeId}" style="margin-left: ${indent}px; cursor: pointer;">`;
            html += `<i class="fas fa-chevron-down" style="font-size: 0.7rem; margin-right: 4px; color: #64748b;"></i>`;
            html += `${key ? `<span class="nbt-key">${escapeHtml(key)}:</span> ` : ''}`;
            html += `<span style="color: #9cdcfe;">[${itemCount} items]</span>`;
            html += `</div>`;
            html += `<div id="${nodeId}" class="nbt-list collapsible-content">`;
            items.forEach((item, i) => {
                html += renderNBTTree(item, depth + 1, `[${i}]`);
            });
            html += `</div>`;
            return html;
        }
        
        // 复合类型
        if (type === NBT_TYPES.COMPOUND || (typeof value === 'object' && !Array.isArray(value))) {
            const entries = Object.entries(value || {});
            const entryCount = entries.length;
            
            if (entryCount === 0) {
                return `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${escapeHtml(key)}:</span> ` : ''}<span style="color: #dcdcaa;">{}</span></div>`;
            }
            
            let html = `<div class="nbt-node collapsible" data-target="${nodeId}" style="margin-left: ${indent}px; cursor: pointer;">`;
            html += `<i class="fas fa-chevron-down" style="font-size: 0.7rem; margin-right: 4px; color: #64748b;"></i>`;
            html += `${key ? `<span class="nbt-key">${escapeHtml(key)}:</span> ` : ''}`;
            html += `<span style="color: #dcdcaa;">{${entryCount} entries}</span>`;
            html += `</div>`;
            html += `<div id="${nodeId}" class="nbt-list collapsible-content">`;
            entries.forEach(([k, v]) => {
                html += renderNBTTree(v, depth + 1, k);
            });
            html += `</div>`;
            return html;
        }
        
        return '';
    }

    // 导出NBT为文件
    function exportNBT() {
        if (!currentNBTData) {
            showToast('没有可导出的NBT数据');
            return;
        }
        
        try {
            const input = document.getElementById('nbtInput').value.trim();
            const blob = new Blob([input], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data.nbt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('NBT已导出');
        } catch (e) {
            showToast('导出失败: ' + e.message);
        }
    }

    // 初始化可折叠功能
    document.addEventListener('click', function(e) {
        const target = e.target.closest('.collapsible');
        if (target) {
            const contentId = target.getAttribute('data-target');
            const content = document.getElementById(contentId);
            const icon = target.querySelector('.fa-chevron-down, .fa-chevron-right');
            
            if (content) {
                const isCollapsed = content.style.display === 'none';
                content.style.display = isCollapsed ? 'block' : 'none';
                if (icon) {
                    icon.className = isCollapsed ? 'fas fa-chevron-down' : 'fas fa-chevron-right';
                }
            }
        }
    });
    
    function formatNBT() {
        const input = document.getElementById('nbtInput');
        const value = input.value.trim();
        
        if (!value) {
            showToast('请先输入NBT数据');
            return;
        }
        
        try {
            const parsed = parseSNBT(value);
            const formatted = formatNBTValue(parsed, 0);
            input.value = formatted;
            showToast('已格式化');
        } catch(e) {
            showToast('格式化失败: ' + e.message);
        }
    }
    
    // 格式化NBT值为字符串
    function formatNBTValue(data, indent = 0) {
        const spaces = '  '.repeat(indent);
        
        // 解包NBT对象
        let value, type;
        if (data && typeof data === 'object' && data.type !== undefined) {
            value = data.value;
            type = data.type;
        } else {
            value = data;
            type = typeof value === 'number' ? NBT_TYPES.INT : 
                   typeof value === 'boolean' ? NBT_TYPES.BYTE :
                   typeof value === 'string' ? NBT_TYPES.STRING :
                   Array.isArray(value) ? NBT_TYPES.LIST :
                   value === null ? NBT_TYPES.END : NBT_TYPES.COMPOUND;
        }
        
        // 处理各种类型
        switch (type) {
            case NBT_TYPES.BYTE:
                return value + 'b';
            case NBT_TYPES.SHORT:
                return value + 's';
            case NBT_TYPES.INT:
                return String(value);
            case NBT_TYPES.LONG:
                return value + 'L';
            case NBT_TYPES.FLOAT:
                return value + 'f';
            case NBT_TYPES.DOUBLE:
                return value + 'd';
            case NBT_TYPES.STRING:
                return `"${escapeNBTString(String(value))}"`;
            case NBT_TYPES.BYTE_ARRAY:
                const byteItems = Array.isArray(value) ? value : [];
                return '[B;' + (byteItems.length > 0 ? ' ' : '') + byteItems.map(b => (b.value !== undefined ? b.value : b) + 'b').join(', ') + ']';
            case NBT_TYPES.INT_ARRAY:
                const intItems = Array.isArray(value) ? value : [];
                return '[I;' + (intItems.length > 0 ? ' ' : '') + intItems.map(i => i.value !== undefined ? i.value : i).join(', ') + ']';
            case NBT_TYPES.LONG_ARRAY:
                const longItems = Array.isArray(value) ? value : [];
                return '[L;' + (longItems.length > 0 ? ' ' : '') + longItems.map(l => (l.value !== undefined ? l.value : l) + 'L').join(', ') + ']';
            case NBT_TYPES.LIST:
                const listItems = Array.isArray(value) ? value : [];
                if (listItems.length === 0) return '[]';
                const formattedItems = listItems.map(item => formatNBTValue(item, indent + 1)).join(', ');
                return listItems.length > 3 ? `[\n${spaces}  ${formattedItems.replace(/, /g, `,\n${spaces}  `)}\n${spaces}]` : `[${formattedItems}]`;
            case NBT_TYPES.COMPOUND:
                const obj = value || {};
                const entries = Object.entries(obj);
                if (entries.length === 0) return '{}';
                const formattedEntries = entries.map(([k, v]) => {
                    const needsQuote = /[^a-zA-Z0-9_\-]/.test(k);
                    const keyStr = needsQuote ? `"${escapeNBTString(k)}"` : k;
                    return `${keyStr}: ${formatNBTValue(v, indent + 1)}`;
                }).join(',\n  ' + spaces);
                return `{\n  ${spaces}${formattedEntries}\n${spaces}}`;
            default:
                return String(value);
        }
    }
    
    // 转义NBT字符串
    function escapeNBTString(str) {
        return str
            .replace(/\\/g, '\\\\')
            .replace(/"/g, '\\"')
            .replace(/\n/g, '\\n')
            .replace(/\t/g, '\\t');
    }
    
    function clearNBT() {
        document.getElementById('nbtInput').value = '';
        document.getElementById('nbtResult').style.display = 'none';
    }
    
    function loadNBTTemplate(type) {
        const templates = {
            item_enchanted: '{id:"minecraft:diamond_sword",Count:1b,tag:{display:{Name:\'{"text":"Excalibur","italic":false}\',Lore:[\'{"text":"Legendary Blade","color":"gold"}\']},Enchantments:[{id:"minecraft:sharpness",lvl:5s},{id:"minecraft:unbreaking",lvl:3s},{id:"minecraft:mending",lvl:1s}],AttributeModifiers:[{AttributeName:"generic.attack_damage",Name:"generic.attack_damage",Amount:10,Operation:0,UUID:[I;1,2,3,4],Slot:"mainhand"}]}}',
            entity_boss: '{id:"minecraft:zombie",Health:100f,CustomName:\'{"text":"Zombie King","color":"red"}\',CustomNameVisible:1b,ArmorItems:[{id:"minecraft:diamond_boots",Count:1b,tag:{Enchantments:[{id:"minecraft:protection",lvl:4s}]}},{id:"minecraft:diamond_leggings",Count:1b},{id:"minecraft:diamond_chestplate",Count:1b},{id:"minecraft:diamond_helmet",Count:1b}],HandItems:[{id:"minecraft:diamond_sword",Count:1b,tag:{Enchantments:[{id:"minecraft:sharpness",lvl:5s}]}},{}],Attributes:[{Name:"generic.max_health",Base:100},{Name:"generic.attack_damage",Base:15}]}',
            chest_loot: '{Items:[{Slot:0b,id:"minecraft:diamond",Count:16b},{Slot:1b,id:"minecraft:golden_apple",Count:2b},{Slot:2b,id:"minecraft:enchanted_book",Count:1b,tag:{StoredEnchantments:[{id:"minecraft:fortune",lvl:3s}]}},{Slot:13b,id:"minecraft:diamond_sword",Count:1b,tag:{Damage:0}}]}',
            potion_custom: '{Potion:"minecraft:water",CustomPotionEffects:[{Id:1,Amplifier:1,Duration:3600},{Id:5,Amplifier:0,Duration:3600},{Id:8,Amplifier:0,Duration:1200}],CustomPotionColor:16711680}'
        };
        
        document.getElementById('nbtInput').value = templates[type] || '';
        switchNBTPanel('editor', document.querySelectorAll('.tab-btn')[0]);
        parseNBTWithNBTify();
    }
    
    async function parseClipboardNBT() {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('nbtParseInput').value = text;
            document.getElementById('nbtInput').value = text;
            parseNBTWithNBTify();
            showToast('已从剪贴板读取');
        } catch(e) {
            showToast('无法读取剪贴板');
        }
    }
    
    // ==================== MCFunction Editor ====================
    function renderMCFunctionEditor(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('function_editor')}</h2>
                    <div class="page-subtitle">编辑.mcfunction文件，支持语法高亮和验证</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadMCFunction()" class="btn btn-gold">
                        <i class="fas fa-download"></i> ${t('download')}
                    </button>
                    <button onclick="clearMCFunction()" class="btn btn-secondary">
                        <i class="fas fa-trash"></i> ${t('clear')}
                    </button>
                </div>
            </div>
            
            <div class="input-area">
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                    <span class="tag"><i class="fas fa-code"></i> 语法高亮</span>
                    <span class="tag tag-blue"><i class="fas fa-list-ol"></i> 行号显示</span>
                    <span class="tag tag-cyan"><i class="fas fa-check-circle"></i> 实时检查</span>
                </div>
                
                <div class="mcfunction-editor" id="mcfunctionContainer" style="position: relative; min-height: 400px;">
                    <div id="mcfunctionLines" style="background: #252526; padding: 10px; border-radius: 10px 0 0 10px; min-width: 45px; overflow: hidden;">
                        <div style="color: #858585; text-align: right; font-size: 0.85rem; line-height: 1.6;">1</div>
                    </div>
                    <div class="mcfunction-code-wrapper" style="flex: 1; position: relative; min-height: 400px; overflow: auto;" id="codeWrapper">
                        <!-- 语法高亮层 -->
                        <pre id="mcfunctionHighlight" aria-hidden="true" style="
                            margin: 0;
                            padding: 10px;
                            font-family: 'JetBrains Mono', monospace;
                            font-size: 0.85rem;
                            line-height: 1.6;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            color: #d4d4d4;
                            min-height: 400px;
                            pointer-events: none;
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            z-index: 1;
                        "><code id="highlightCode" style="background: transparent;"></code></pre>
                        <!-- 编辑层 -->
                        <textarea id="mcfunctionInput" 
                            style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                width: 100%;
                                height: 100%;
                                background: transparent;
                                border: none;
                                color: transparent;
                                caret-color: #d4d4d4;
                                font-family: 'JetBrains Mono', monospace;
                                font-size: 0.85rem;
                                line-height: 1.6;
                                padding: 10px;
                                resize: none;
                                outline: none;
                                z-index: 2;
                                min-height: 400px;
                            "
                            placeholder=""
                            spellcheck="false"
                            oninput="updateMCFunctionEditor()" 
                            onscroll="syncMCFunctionScroll()"
                            onkeydown="handleMCFunctionKey(event)"># 在此输入函数文件内容
# 示例:
say 欢迎使用函数编辑器
give @a minecraft:diamond 1
execute as @p at @s run setblock ~ ~ ~ minecraft:stone</textarea>
                    </div>
                </div>
                
                <!-- 语法错误详情面板 -->
                <div id="syntaxErrorsPanel" style="margin-top: 12px; display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px;">
                    <div style="color: #ef4444; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem;">
                        <i class="fas fa-exclamation-circle"></i> 发现语法错误
                    </div>
                    <div id="syntaxErrorsList" style="font-size: 0.85rem; color: #fca5a5; max-height: 150px; overflow-y: auto;"></div>
                </div>
                
                <div id="mcfunctionStats" style="margin-top: 12px; display: flex; gap: 16px; font-size: 0.85rem; color: #94a3b8;">
                    <span><i class="fas fa-file-code"></i> 行数: <span id="lineCount">1</span></span>
                    <span><i class="fas fa-font"></i> 字符: <span id="charCount">0</span></span>
                    <span id="syntaxStatus"><i class="fas fa-check-circle" style="color: var(--mc-green);"></i> 语法正常</span>
                </div>
            </div>
        `;
    }
    
    // MCFunction 语法高亮和检查
    const MCFUNCTION_KEYWORDS = [
        'advancement', 'attribute', 'ban', 'ban-ip', 'banlist', 'bossbar', 'clear', 'clone',
        'data', 'datapack', 'debug', 'defaultgamemode', 'deop', 'difficulty', 'effect',
        'enchant', 'execute', 'experience', 'fill', 'forceload', 'function', 'gamemode',
        'gamerule', 'give', 'help', 'item', 'kick', 'kill', 'list', 'locate', 'loot',
        'me', 'msg', 'op', 'pardon', 'pardon-ip', 'particle', 'place', 'playsound',
        'publish', 'recipe', 'reload', 'return', 'ride', 'save-all', 'save-off', 'save-on',
        'say', 'schedule', 'scoreboard', 'seed', 'setblock', 'setworldspawn', 'spawnpoint',
        'spectate', 'spreadplayers', 'stop', 'stopsound', 'summon', 'tag', 'team', 'teammsg',
        'teleport', 'tell', 'tellraw', 'time', 'title', 'tm', 'tp', 'trigger', 'w',
        'weather', 'whitelist', 'worldborder', 'xp'
    ];
    
    const MCFUNCTION_SUBCOMMANDS = [
        'as', 'at', 'if', 'unless', 'run', 'in', 'positioned', 'rotated', 'facing',
        'align', 'anchored', 'store', 'result', 'success', 'entity', 'block', 'score',
        'bossbar', 'storage', 'matches', 'add', 'remove', 'set', 'get', 'operation',
        'players', 'objectives', 'display', 'setdisplay', 'enable', 'random'
    ];
    
    const SELECTORS = ['@p', '@a', '@r', '@e', '@s', '@n'];
    
    function highlightMCFunction(code) {
        if (!code) return '';
        
        // 转义HTML特殊字符
        let highlighted = code
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        
        // 高亮注释 (# 开头) - 灰色
        highlighted = highlighted.replace(/^(#[^\n]*)/gm, '<span style="color: #6a737d; font-style: italic;">$1</span>');
        
        // 高亮字符串 (双引号和单引号) - 橙色
        highlighted = highlighted.replace(/("(?:[^"\\]|\\.)*")/g, '<span style="color: #ffa657;">$1</span>');
        highlighted = highlighted.replace(/('(?:[^'\\]|\\.)*')/g, '<span style="color: #ffa657;">$1</span>');
        
        // 高亮选择器 - 青色
        SELECTORS.forEach(selector => {
            const regex = new RegExp(`(${selector.replace('@', '@')}\\b(?:\\[[^\]]*\\])?)`, 'g');
            highlighted = highlighted.replace(regex, '<span style="color: #79c0ff;">$1</span>');
        });
        
        // 高亮数字 (包括整数、小数、坐标) - 紫色
        highlighted = highlighted.replace(/\b(\d+\.?\d*[bsdfL]?)\b/g, '<span style="color: #d2a8ff;">$1</span>');
        highlighted = highlighted.replace(/(~?~|\^?\^)\b/g, '<span style="color: #d2a8ff;">$1</span>');
        
        // 高亮关键字 (排除注释行) - 绿色
        const lines = highlighted.split('\n');
        highlighted = lines.map((line, index) => {
            // 如果行已经被标记为注释，跳过关键字高亮
            if (line.includes('color: #6a737d')) {
                return line;
            }
            
            let processedLine = line;
            
            // 高亮主命令关键字
            MCFUNCTION_KEYWORDS.forEach(keyword => {
                const regex = new RegExp(`^\\s*(${keyword})\\b`, 'gm');
                if (index === 0 || line.startsWith('\n')) {
                    processedLine = processedLine.replace(regex, `<span style="color: #7ee787; font-weight: 600;">$1</span>`);
                } else {
                    // 在行中替换，但需要确保是命令开头或run之后
                    const cmdRegex = new RegExp(`(^|run\\s+)(${keyword})\\b`, 'g');
                    processedLine = processedLine.replace(cmdRegex, `$1<span style="color: #7ee787; font-weight: 600;">$2</span>`);
                }
            });
            
            // 高亮子命令
            MCFUNCTION_SUBCOMMANDS.forEach(subcmd => {
                const regex = new RegExp(`\\b(${subcmd})\\b`, 'g');
                processedLine = processedLine.replace(regex, '<span style="color: #56d364;">$1</span>');
            });
            
            // 高亮资源ID (minecraft:xxx) - 黄色
            processedLine = processedLine.replace(/\b(minecraft:[a-z_0-9\/]+)\b/g, '<span style="color: #ffca28;">$1</span>');
            
            // 高亮NBT标签 - 浅蓝色
            processedLine = processedLine.replace(/(\{[^}]*\})/g, '<span style="color: #a5d6ff;">$1</span>');
            
            return processedLine;
        }).join('\n');
        
        return highlighted;
    }
    
    function checkMCFunctionSyntax(code) {
        const errors = [];
        const warnings = [];
        const lines = code.split('\n');
        
        lines.forEach((line, idx) => {
            const trimmed = line.trim();
            const lineNum = idx + 1;
            
            // 跳过空行和注释
            if (!trimmed || trimmed.startsWith('#')) return;
            
            // 检查是否以/开头 (不推荐)
            if (trimmed.startsWith('/')) {
                warnings.push({
                    line: lineNum,
                    message: '命令不需要以 / 开头',
                    type: 'warning'
                });
            }
            
            // 检查是否有 $ 开头的宏命令
            if (trimmed.startsWith('$')) {
                // 宏命令，检查参数
                const macroMatch = trimmed.match(/^\$\$(\w+)\s+(.*)$/);
                if (macroMatch) {
                    // 检查宏参数是否完整
                    const params = trimmed.match(/\$\([^)]+\)/g);
                    if (!params && trimmed.includes('$(')) {
                        errors.push({
                            line: lineNum,
                            message: '宏参数语法错误，应为 $(参数名)',
                            type: 'error'
                        });
                    }
                }
                return;
            }
            
            // 提取命令名
            const cmdMatch = trimmed.match(/^\s*(\w+)/);
            if (cmdMatch) {
                const cmd = cmdMatch[1].toLowerCase();
                
                // 检查是否为有效的Minecraft命令
                const validCommands = [...MCFUNCTION_KEYWORDS, 'return'];
                if (!validCommands.includes(cmd)) {
                    warnings.push({
                        line: lineNum,
                        message: `未知命令: "${cmd}"`,
                        type: 'warning'
                    });
                }
                
                // 特定命令的语法检查
                switch (cmd) {
                    case 'execute':
                        // 检查 execute 是否以 run 结尾
                        if (!trimmed.includes(' run ')) {
                            errors.push({
                                line: lineNum,
                                message: 'execute 命令必须以 "run" 子命令结尾',
                                type: 'error'
                            });
                        }
                        // 检查是否有连续的 as/at 等子命令
                        const selectorMatches = trimmed.match(/@[pares]/gi);
                        if (selectorMatches) {
                            selectorMatches.forEach(sel => {
                                // 检查选择器参数语法
                                const selRegex = new RegExp(`${sel}\\[([^\\]]*)\\]`, 'g');
                                let match;
                                while ((match = selRegex.exec(trimmed)) !== null) {
                                    const params = match[1];
                                    // 检查参数格式
                                    if (params) {
                                        const paramPairs = params.split(',');
                                        paramPairs.forEach(pair => {
                                            if (pair && !pair.includes('=')) {
                                                warnings.push({
                                                    line: lineNum,
                                                    message: `选择器参数格式错误: "${pair.trim()}" (应为 键=值)`,
                                                    type: 'warning'
                                                });
                                            }
                                        });
                                    }
                                }
                            });
                        }
                        break;
                        
                    case 'give':
                        // 检查 give 命令参数数量
                        const giveParts = trimmed.split(/\s+/);
                        if (giveParts.length < 3) {
                            errors.push({
                                line: lineNum,
                                message: 'give 命令需要至少 2 个参数: give <目标> <物品>',
                                type: 'error'
                            });
                        }
                        break;
                        
                    case 'summon':
                        // 检查 summon 命令
                        const summonParts = trimmed.split(/\s+/);
                        if (summonParts.length < 2) {
                            errors.push({
                                line: lineNum,
                                message: 'summon 命令需要实体类型参数',
                                type: 'error'
                            });
                        }
                        break;
                        
                    case 'setblock':
                    case 'fill':
                        // 检查坐标是否为整数或 ~
                        const blockParts = trimmed.split(/\s+/);
                        if (blockParts.length < 5 && cmd === 'setblock') {
                            errors.push({
                                line: lineNum,
                                message: 'setblock 命令需要 x y z 坐标和方块类型',
                                type: 'error'
                            });
                        }
                        break;
                        
                    case 'scoreboard':
                        // 检查 scoreboard 子命令
                        if (!/scoreboard\s+(objectives|players|display)/.test(trimmed)) {
                            warnings.push({
                                line: lineNum,
                                message: 'scoreboard 命令建议使用 objectives/players/display 子命令',
                                type: 'warning'
                            });
                        }
                        break;
                        
                    case 'data':
                        // 检查 data 子命令
                        if (!/data\s+(get|merge|remove|modify)/.test(trimmed)) {
                            errors.push({
                                line: lineNum,
                                message: 'data 命令需要 get/merge/remove/modify 子命令',
                                type: 'error'
                            });
                        }
                        break;
                        
                    case 'tp':
                    case 'teleport':
                        // 检查 teleport 参数
                        const tpParts = trimmed.split(/\s+/);
                        if (tpParts.length < 2) {
                            errors.push({
                                line: lineNum,
                                message: 'teleport 命令需要目标参数',
                                type: 'error'
                            });
                        }
                        break;
                }
                
                // 检查括号匹配
                const openBrackets = (line.match(/\[/g) || []).length;
                const closeBrackets = (line.match(/\]/g) || []).length;
                if (openBrackets !== closeBrackets) {
                    errors.push({
                        line: lineNum,
                        message: `方括号不匹配: 开了 ${openBrackets} 个，关了 ${closeBrackets} 个`,
                        type: 'error'
                    });
                }
                
                const openCurly = (line.match(/\{/g) || []).length;
                const closeCurly = (line.match(/\}/g) || []).length;
                if (openCurly !== closeCurly) {
                    errors.push({
                        line: lineNum,
                        message: `花括号不匹配: 开了 ${openCurly} 个，关了 ${closeCurly} 个`,
                        type: 'error'
                    });
                }
                
                // 检查引号匹配
                const doubleQuotes = (line.match(/"/g) || []).length;
                if (doubleQuotes % 2 !== 0) {
                    errors.push({
                        line: lineNum,
                        message: '双引号不匹配 (字符串未闭合)',
                        type: 'error'
                    });
                }
            }
        });
        
        return { errors, warnings };
    }
    
    function updateMCFunctionEditor() {
        const input = document.getElementById('mcfunctionInput');
        const highlightCode = document.getElementById('highlightCode');
        const linesContainer = document.getElementById('mcfunctionLines');
        const lines = input.value.split('\n');
        
        // 更新语法高亮
        if (highlightCode) {
            highlightCode.innerHTML = highlightMCFunction(input.value) || '<br>';
        }
        
        // 更新行号
        linesContainer.innerHTML = lines.map((_, i) => 
            `<div style="color: #858585; text-align: right; font-size: 0.85rem; line-height: 1.6;">${i + 1}</div>`
        ).join('');
        
        // 更新统计
        document.getElementById('lineCount').textContent = lines.length;
        document.getElementById('charCount').textContent = input.value.length;
        
        // 语法检查
        const { errors, warnings } = checkMCFunctionSyntax(input.value);
        const totalIssues = errors.length + warnings.length;
        
        const statusEl = document.getElementById('syntaxStatus');
        const errorsPanel = document.getElementById('syntaxErrorsPanel');
        const errorsList = document.getElementById('syntaxErrorsList');
        
        if (errors.length > 0) {
            statusEl.innerHTML = `<i class="fas fa-times-circle" style="color: #ef4444;"></i> ${errors.length}个错误, ${warnings.length}个警告`;
        } else if (warnings.length > 0) {
            statusEl.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> ${warnings.length}个警告`;
        } else {
            statusEl.innerHTML = `<i class="fas fa-check-circle" style="color: var(--mc-green);"></i> 语法正常`;
        }
        
        // 显示错误详情
        if (errors.length > 0 || warnings.length > 0) {
            errorsPanel.style.display = 'block';
            const allIssues = [
                ...errors.map(e => `<div style="margin: 4px 0; padding: 4px 8px; background: rgba(239, 68, 68, 0.2); border-radius: 4px;"><strong style="color: #ef4444;">第${e.line}行:</strong> ${e.message}</div>`),
                ...warnings.map(w => `<div style="margin: 4px 0; padding: 4px 8px; background: rgba(245, 158, 11, 0.2); border-radius: 4px;"><strong style="color: #f59e0b;">第${w.line}行:</strong> ${w.message}</div>`)
            ];
            errorsList.innerHTML = allIssues.join('');
        } else {
            errorsPanel.style.display = 'none';
        }
    }
    
    function handleMCFunctionKey(e) {
        const input = document.getElementById('mcfunctionInput');
        
        // Tab 键支持
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = input.selectionStart;
            const end = input.selectionEnd;
            input.value = input.value.substring(0, start) + '    ' + input.value.substring(end);
            input.selectionStart = input.selectionEnd = start + 4;
            updateMCFunctionEditor();
        }
    }
    
    function syncMCFunctionScroll() {
        const input = document.getElementById('mcfunctionInput');
        const lines = document.getElementById('mcfunctionLines');
        const highlight = document.getElementById('mcfunctionHighlight');
        const wrapper = document.getElementById('codeWrapper');
        
        if (wrapper && highlight) {
            wrapper.scrollTop = input.scrollTop;
            wrapper.scrollLeft = input.scrollLeft;
        }
        if (lines) {
            lines.scrollTop = input.scrollTop;
        }
    }
    
    function downloadMCFunction() {
        const input = document.getElementById('mcfunctionInput');
        if (!input) { 
            showToast('编辑器未初始化'); 
            return; 
        }
        
        const content = input.value;
        if (!content || !content.trim()) { 
            showToast('没有内容可下载'); 
            return; 
        }
        
        // 创建 Blob 对象，使用正确的 MIME 类型
        const blob = new Blob([content], { 
            type: 'text/plain;charset=utf-8' 
        });
        
        // 生成文件名
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        const filename = `function_${timestamp}.mcfunction`;
        
        // 检查 saveAs 函数是否可用
        if (typeof saveAs === 'function') {
            saveAs(blob, filename);
        } else {
            // 备用下载方法
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        showToast(`✓ 已下载: ${filename}`);
    }
    
    function clearMCFunction() {
        if(confirm('确定要清空所有内容吗？')) {
            document.getElementById('mcfunctionInput').value = '';
            updateMCFunctionEditor();
        }
    }
    
    // ==================== Skin Editor ====================
    let currentAnimationType = 'none';
    let isAnimationPaused = true;
    
    // ==================== Skin Editor Enhanced ====================
    let skinHistory = JSON.parse(localStorage.getItem('mc_skin_history') || '[]');
    let currentSkinUrl = '';
    let capeViewer = null;
    
    function renderSkinEditor(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('skin_editor')}</h2>
                    <div class="page-subtitle">增强版3D皮肤编辑器 - 支持披风、动画、截图</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="showSkinHistory()" class="btn btn-secondary">
                        <i class="fas fa-history"></i> 历史
                    </button>
                    <button onclick="takeSkinScreenshot()" class="btn btn-gold">
                        <i class="fas fa-camera"></i> 截图
                    </button>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchSkinTab('viewer', this)">皮肤预览</button>
                <button class="tab-btn" onclick="switchSkinTab('cape', this)">披风管理</button>
                <button class="tab-btn" onclick="switchSkinTab('tools', this)">工具箱</button>
            </div>
            
            <div id="skin-panel-viewer" class="skin-panel">
                <div class="content-grid" style="grid-template-columns: 2fr 1fr;">
                    <div>
                        <div class="skin-viewer-container" id="skinViewer" style="position: relative; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
                            <div id="skinLoadingMsg" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #64748b;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>正在加载3D皮肤查看器...</p>
                            </div>
                            <div id="skinErrorMsg" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #ef4444;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>3D查看器加载失败</p>
                                <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 8px;">正在切换到简易模式...</p>
                            </div>
                            <!-- 备用皮肤查看器（当3D库不可用时） -->
                            <div id="skinFallbackViewer" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
                                <img id="fallbackSkinImg" style="max-width: 200px; max-height: 300px; image-rendering: pixelated; border: 4px solid rgba(255,255,255,0.1); border-radius: 8px;" alt="皮肤预览">
                                <p style="color: #64748b; margin-top: 16px; font-size: 0.85rem;">简易模式 - 仅显示皮肤平铺图</p>
                                <div style="display: flex; gap: 8px; margin-top: 12px;">
                                    <button onclick="loadSkinFromFile()" class="btn btn-secondary" style="font-size: 0.75rem; padding: 6px 12px;">
                                        <i class="fas fa-upload"></i> 上传皮肤
                                    </button>
                                    <button onclick="loadSkinFromUsername()" class="btn btn-secondary" style="font-size: 0.75rem; padding: 6px 12px;">
                                        <i class="fas fa-user"></i> 用户名
                                    </button>
                                </div>
                            </div>
                            <div id="skinWatermark" style="position: absolute; bottom: 10px; right: 10px; color: rgba(255,255,255,0.3); font-size: 0.75rem; pointer-events: none;">
                                MC指令辅助
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap;">
                            <button onclick="loadSkinFromFile()" class="btn btn-primary">
                                <i class="fas fa-upload"></i> 上传皮肤
                            </button>
                            <button onclick="loadSkinFromUsername()" class="btn btn-secondary">
                                <i class="fas fa-user"></i> 用户名加载
                            </button>
                            <button onclick="loadSkinFromURL()" class="btn btn-secondary">
                                <i class="fas fa-link"></i> URL加载
                            </button>
                            <button onclick="toggleSkinAnimationPause()" class="btn btn-secondary" id="animPauseBtn">
                                <i class="fas fa-play"></i> 播放
                            </button>
                        </div>
                        <input type="file" id="skinFileInput" accept="image/png" style="display: none;" onchange="handleSkinFile(event)">
                    </div>
                    
                    <div>
                        <div class="input-area">
                            <h3 style="color: var(--mc-gold); margin-bottom: 16px; font-size: 1rem;"><i class="fas fa-sliders-h"></i> 控制面板</h3>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="color: #94a3b8; display: block; margin-bottom: 8px; font-size: 0.85rem;"><i class="fas fa-running"></i> 动画类型</label>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                    <button onclick="setSkinAnimation('none')" class="btn btn-secondary" id="anim-none" style="padding: 8px; font-size: 0.75rem;">
                                        <i class="fas fa-pause"></i> 静止
                                    </button>
                                    <button onclick="setSkinAnimation('walk')" class="btn btn-secondary" id="anim-walk" style="padding: 8px; font-size: 0.75rem;">
                                        <i class="fas fa-walking"></i> 行走
                                    </button>
                                    <button onclick="setSkinAnimation('run')" class="btn btn-secondary" id="anim-run" style="padding: 8px; font-size: 0.75rem;">
                                        <i class="fas fa-running"></i> 跑步
                                    </button>
                                    <button onclick="setSkinAnimation('fly')" class="btn btn-secondary" id="anim-fly" style="padding: 8px; font-size: 0.75rem;">
                                        <i class="fas fa-dove"></i> 飞行
                                    </button>
                                    <button onclick="setSkinAnimation('crouch')" class="btn btn-secondary" id="anim-crouch" style="padding: 8px; font-size: 0.75rem;">
                                        <i class="fas fa-chevron-down"></i> 潜行
                                    </button>
                                    <button onclick="setSkinAnimation('swing')" class="btn btn-secondary" id="anim-swing" style="padding: 8px; font-size: 0.75rem;">
                                        <i class="fas fa-hand-rock"></i> 挥动
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="color: #94a3b8; display: block; margin-bottom: 8px; font-size: 0.85rem;"><i class="fas fa-eye"></i> 显示选项</label>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #e2e8f0;">
                                        <input type="checkbox" id="showOuterLayer" checked onchange="toggleSkinLayer()">
                                        <span>显示外层皮肤</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #e2e8f0;">
                                        <input type="checkbox" id="showCape" checked onchange="toggleCapeVisibility()">
                                        <span>显示披风</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #e2e8f0;">
                                        <input type="checkbox" id="enableControl" checked onchange="toggleOrbitControl()">
                                        <span>启用鼠标控制</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="color: #94a3b8; display: block; margin-bottom: 8px; font-size: 0.85rem;"><i class="fas fa-sync-alt"></i> 旋转控制</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                    <div>
                                        <span style="color: #64748b; font-size: 0.75rem;">水平 (Y轴)</span>
                                        <input type="range" id="skinRotY" min="-180" max="180" value="0" class="search-input" oninput="updateSkinRotation()" style="margin-top: 4px;">
                                    </div>
                                    <div>
                                        <span style="color: #64748b; font-size: 0.75rem;">垂直 (X轴)</span>
                                        <input type="range" id="skinRotX" min="-180" max="180" value="0" class="search-input" oninput="updateSkinRotation()" style="margin-top: 4px;">
                                    </div>
                                </div>
                                <button onclick="resetSkinRotation()" class="btn btn-secondary" style="width: 100%; padding: 8px; font-size: 0.8rem;">
                                    <i class="fas fa-undo"></i> 重置视角
                                </button>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="color: #94a3b8; display: block; margin-bottom: 8px; font-size: 0.85rem;"><i class="fas fa-search-plus"></i> 缩放: <span id="zoomValue">100%</span></label>
                                <input type="range" id="skinZoom" min="0.5" max="2.5" step="0.1" value="1" class="search-input" oninput="updateSkinZoom()">
                            </div>
                            
                            <div>
                                <label style="color: #94a3b8; display: block; margin-bottom: 8px; font-size: 0.85rem;"><i class="fas fa-palette"></i> 背景样式</label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                    <button onclick="setSkinBg('gradient')" class="skin-bg-btn active" data-bg="gradient" style="height: 40px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #fff; border-radius: 8px; cursor: pointer;"></button>
                                    <button onclick="setSkinBg('#1e1e1e')" class="skin-bg-btn" data-bg="#1e1e1e" style="height: 40px; background: #1e1e1e; border: 2px solid transparent; border-radius: 8px; cursor: pointer;"></button>
                                    <button onclick="setSkinBg('#87CEEB')" class="skin-bg-btn" data-bg="#87CEEB" style="height: 40px; background: #87CEEB; border: 2px solid transparent; border-radius: 8px; cursor: pointer;"></button>
                                    <button onclick="setSkinBg('transparent')" class="skin-bg-btn" data-bg="transparent" style="height: 40px; background: repeating-conic-gradient(#333 0% 25%, transparent 0% 50%) 50% / 20px 20px; border: 2px solid transparent; border-radius: 8px; cursor: pointer;"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="skin-panel-cape" class="skin-panel" style="display: none;">
                <div class="input-area" style="max-width: 800px;">
                    <h3 style="color: var(--mc-gold); margin-bottom: 16px;"><i class="fas fa-ribbon"></i> 披风管理</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">披风是Minecraft中的装饰性道具，可以在角色背后显示。请上传64x32像素的PNG格式披风图片。</p>
                    
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button onclick="loadCapeFromFile()" class="btn btn-primary">
                            <i class="fas fa-upload"></i> 上传披风
                        </button>
                        <button onclick="loadDefaultCape('mojang')" class="btn btn-secondary">
                            <i class="fas fa-star"></i> 正版披风
                        </button>
                        <button onclick="loadDefaultCape('mojang-classic')" class="btn btn-secondary">
                            <i class="fas fa-history"></i> 经典披风
                        </button>
                        <button onclick="removeCape()" class="btn" style="background: rgba(220,38,38,0.2); color: #fca5a5;">
                            <i class="fas fa-trash"></i> 移除披风
                        </button>
                    </div>
                    <input type="file" id="capeFileInput" accept="image/png" style="display: none;" onchange="handleCapeFile(event)">
                    
                    <div style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 16px;">
                        <h4 style="color: #94a3b8; margin-bottom: 12px; font-size: 0.9rem;">披风预览</h4>
                        <div id="capePreview" style="width: 128px; height: 64px; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #64748b; font-size: 0.85rem;">
                            暂无披风
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="skin-panel-tools" class="skin-panel" style="display: none;">
                <div class="content-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
                    <div class="input-area">
                        <h4 style="color: #22d3ee; margin-bottom: 12px;"><i class="fas fa-image"></i> 皮肤工具</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="validateSkinFile()" class="btn btn-secondary" style="justify-content: flex-start;">
                                <i class="fas fa-check-circle" style="color: #22d3ee;"></i> 验证皮肤格式
                            </button>
                            <button onclick="showSkinInfo()" class="btn btn-secondary" style="justify-content: flex-start;">
                                <i class="fas fa-info-circle" style="color: #22d3ee;"></i> 皮肤信息
                            </button>
                            <button onclick="convertSkinType()" class="btn btn-secondary" style="justify-content: flex-start;">
                                <i class="fas fa-exchange-alt" style="color: #22d3ee;"></i> Steve ↔ Alex 转换
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <h4 style="color: #a855f7; margin-bottom: 12px;"><i class="fas fa-download"></i> 导出功能</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="downloadCurrentSkin()" class="btn btn-secondary" style="justify-content: flex-start;">
                                <i class="fas fa-download" style="color: #a855f7;"></i> 下载皮肤文件
                            </button>
                            <button onclick="takeSkinScreenshot()" class="btn btn-secondary" style="justify-content: flex-start;">
                                <i class="fas fa-camera" style="color: #a855f7;"></i> 截图保存
                            </button>
                            <button onclick="exportSkinAsCommand()" class="btn btn-secondary" style="justify-content: flex-start;">
                                <i class="fas fa-terminal" style="color: #a855f7;"></i> 导出为give命令
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <h4 style="color: #f59e0b; margin-bottom: 12px;"><i class="fas fa-bolt"></i> 快速操作</h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="quickLoadSkin('herobrine')" class="btn btn-secondary" style="justify-content: flex-start;">
                                <i class="fas fa-eye" style="color: #f59e0b;"></i> Herobrine
                            </button>
                            <button onclick="quickLoadSkin('notch')" class="btn btn-secondary" style="justify-content: flex-start;">
                                <i class="fas fa-crown" style="color: #f59e0b;"></i> Notch
                            </button>
                            <button onclick="quickLoadSkin('jeb')" class="btn btn-secondary" style="justify-content: flex-start;">
                                <i class="fas fa-rainbow" style="color: #f59e0b;"></i> jeb_ (变色羊)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-area" style="margin-top: 20px;">
                <h3 style="color: #94a3b8; margin-bottom: 12px; font-size: 1rem;"><i class="fas fa-star"></i> 预设皮肤库</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px;">
                    ${[
                        { id: 'steve', name: 'Steve', icon: '👦' },
                        { id: 'alex', name: 'Alex', icon: '👧' },
                        { id: 'creeper', name: '苦力怕', icon: '🐉' },
                        { id: 'zombie', name: '僵尸', icon: '🧟' },
                        { id: 'skeleton', name: '骷髅', icon: '💀' },
                        { id: 'enderman', name: '末影人', icon: '👿' },
                        { id: 'pig', name: '小猪', icon: '🐷' },
                        { id: 'chicken', name: '小鸡', icon: '🐔' },
                        { id: 'villager', name: '村民', icon: '👳' },
                        { id: 'herobrine', name: 'Herobrine', icon: '👁️' },
                        { id: 'dinnerbone', name: 'Dinnerbone', icon: '🍽️' },
                        { id: 'notch', name: 'Notch', icon: '👑' }
                    ].map(skin => `
                        <button onclick="loadDefaultSkin('${skin.id}')" class="btn btn-secondary" style="padding: 12px 8px; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                            <span style="font-size: 1.5rem;">${skin.icon}</span>
                            <span style="font-size: 0.75rem;">${skin.name}</span>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
        
        setTimeout(initSkinViewer, 500);
    }
    
    function switchSkinTab(tab, btn) {
        document.querySelectorAll('.skin-panel').forEach(el => el.style.display = 'none');
        document.getElementById(`skin-panel-${tab}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function loadSkinFromURL() {
        const url = prompt('请输入皮肤图片URL:');
        if (!url) return;
        
        if (skinViewer) {
            try {
                skinViewer.loadSkin(url);
                currentSkinUrl = url;
                addToSkinHistory(url, 'URL皮肤');
                showToast('皮肤已加载');
            } catch(err) {
                showToast('皮肤加载失败', 'error');
            }
        }
    }
    
    function toggleSkinLayer() {
        if (!skinViewer || !skinViewer.player) return;
        const showOuter = document.getElementById('showOuterLayer')?.checked ?? true;
        skinViewer.player.skin.outerLayerVisible = showOuter;
    }
    
    function toggleCapeVisibility() {
        if (!skinViewer) return;
        const showCape = document.getElementById('showCape')?.checked ?? true;
        if (skinViewer.cape) {
            skinViewer.cape.visible = showCape;
        }
    }
    
    let orbitControlEnabled = true;
    function toggleOrbitControl() {
        if (!skinViewer) return;
        orbitControlEnabled = document.getElementById('enableControl')?.checked ?? true;
        if (skinViewer.controls) {
            skinViewer.controls.enabled = orbitControlEnabled;
        }
    }
    
    function resetSkinRotation() {
        document.getElementById('skinRotX').value = 0;
        document.getElementById('skinRotY').value = 0;
        updateSkinRotation();
    }
    
    function loadCapeFromFile() {
        document.getElementById('capeFileInput')?.click();
    }
    
    function handleCapeFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            if (skinViewer) {
                try {
                    skinViewer.loadCape(e.target.result);
                    document.getElementById('capePreview').innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 100%; image-rendering: pixelated;">`;
                    showToast('披风已加载');
                } catch(err) {
                    showToast('披风加载失败', 'error');
                }
            }
        };
        reader.readAsDataURL(file);
    }
    
    function loadDefaultCape(type) {
        const capes = {
            'mojang': 'https://crafatar.com/capes/8667ba71b85a4004af54457a9734eed7',
            'mojang-classic': 'https://textures.minecraft.net/texture/5786fe99be377dfb6858859f926c4dbc995751e91cee3734681735bf9bf5b5e'
        };
        
        if (skinViewer && capes[type]) {
            skinViewer.loadCape(capes[type]);
            document.getElementById('capePreview').innerHTML = `<img src="${capes[type]}" style="max-width: 100%; max-height: 100%; image-rendering: pixelated;">`;
            showToast('披风已加载');
        }
    }
    
    function removeCape() {
        if (skinViewer) {
            skinViewer.cape = null;
            document.getElementById('capePreview').innerHTML = '暂无披风';
            showToast('披风已移除');
        }
    }
    
    function takeSkinScreenshot() {
        if (!skinViewer || !skinViewer.canvas) {
            showToast('3D查看器未就绪', 'error');
            return;
        }
        
        try {
            const link = document.createElement('a');
            link.download = `minecraft-skin-${Date.now()}.png`;
            link.href = skinViewer.canvas.toDataURL('image/png');
            link.click();
            showToast('截图已保存');
        } catch(err) {
            showToast('截图失败: ' + err.message, 'error');
        }
    }
    
    function addToSkinHistory(entry) {
        let historyItem;
        
        if (typeof entry === 'string') {
            // 兼容旧格式：url, name
            const name = arguments[1] || 'URL皮肤';
            historyItem = { type: 'url', url: entry, name: name, timestamp: new Date().toISOString() };
        } else if (entry && typeof entry === 'object') {
            // 新格式：对象
            historyItem = { 
                ...entry, 
                timestamp: new Date().toISOString(),
                name: entry.username || entry.name || '未命名皮肤'
            };
        } else {
            return;
        }
        
        skinHistory.unshift(historyItem);
        if (skinHistory.length > 20) skinHistory = skinHistory.slice(0, 20);
        localStorage.setItem('mc_skin_history', JSON.stringify(skinHistory));
    }
    
    function showSkinHistory() {
        const modal = document.getElementById('modal');
        const body = document.getElementById('modal-body');
        
        let historyHtml = skinHistory.length === 0 ? `
            <div class="empty-state">
                <div style="font-size: 3rem; margin-bottom: 12px;">🖼️</div>
                <div style="font-size: 1.1rem; font-weight: 600;">暂无历史记录</div>
            </div>
        ` : `
            <div style="max-height: 500px; overflow-y: auto;">
                ${skinHistory.map((item, i) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 10px; margin-bottom: 10px;">
                        <div>
                            <div style="color: #e2e8f0;">${item.name}</div>
                            <div style="color: #64748b; font-size: 0.75rem;">${new Date(item.timestamp).toLocaleString()}</div>
                        </div>
                        <button onclick="loadSkinFromHistory(${i}); closeModal();" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem;">
                            <i class="fas fa-load"></i> 加载
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
        
        body.innerHTML = `
            <h2 style="font-family: VT323, monospace; font-size: 1.8rem; color: var(--mc-gold); margin-bottom: 20px;">
                <i class="fas fa-history"></i> 皮肤浏览历史
            </h2>
            ${historyHtml}
        `;
        modal.style.display = 'block';
    }
    
    function loadSkinFromHistory(index) {
        const item = skinHistory[index];
        if (item && skinViewer) {
            skinViewer.loadSkin(item.url);
            currentSkinUrl = item.url;
            showToast('皮肤已加载');
        }
    }
    
    function quickLoadSkin(type) {
        const skins = {
            'herobrine': 'https://crafatar.com/skins/8667ba71b85a4004af54457a9734eed7',
            'notch': 'https://crafatar.com/skins/069a79f444e94726a5befca90e38aaf5',
            'jeb': 'https://crafatar.com/skins/7d30bc8d51d24766b3031d8bd4044580'
        };
        
        if (skins[type] && skinViewer) {
            skinViewer.loadSkin(skins[type]);
            addToSkinHistory(skins[type], type);
            showToast(`${type} 皮肤已加载`);
        }
    }
    
    function validateSkinFile() {
        showToast('皮肤验证功能开发中...');
    }
    
    function showSkinInfo() {
        if (!currentSkinUrl) {
            showToast('请先加载皮肤');
            return;
        }
        
        const modal = document.getElementById('modal');
        const body = document.getElementById('modal-body');
        body.innerHTML = `
            <h3 style="color: var(--mc-gold); margin-bottom: 16px;">皮肤信息</h3>
            <div style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 10px;">
                <div style="margin-bottom: 8px;"><strong style="color: #94a3b8;">来源:</strong> <span style="color: #e2e8f0;">${currentSkinUrl.substring(0, 50)}...</span></div>
                <div style="margin-bottom: 8px;"><strong style="color: #94a3b8;">类型:</strong> <span style="color: #e2e8f0;">64x64 PNG</span></div>
            </div>
        `;
        modal.style.display = 'block';
    }
    
    function convertSkinType() {
        showToast('皮肤转换功能开发中...');
    }
    
    function downloadCurrentSkin() {
        if (!currentSkinUrl) {
            showToast('请先加载皮肤');
            return;
        }
        
        const link = document.createElement('a');
        link.href = currentSkinUrl;
        link.download = `skin-${Date.now()}.png`;
        link.click();
        showToast('开始下载皮肤');
    }
    
    function exportSkinAsCommand() {
        showToast('导出命令功能开发中...');
    }
    
    function initSkinViewer() {
        const container = document.getElementById('skinViewer');
        const loadingMsg = document.getElementById('skinLoadingMsg');
        const errorMsg = document.getElementById('skinErrorMsg');
        const fallbackViewer = document.getElementById('skinFallbackViewer');
        
        if(!container) {
            console.error('Skin viewer container not found');
            return;
        }
        
        // 检查 skinview3d 库是否加载
        if(typeof skinview3d === 'undefined') {
            console.warn('SkinView3D library not loaded, using fallback viewer');
            if(loadingMsg) loadingMsg.style.display = 'none';
            if(errorMsg) errorMsg.style.display = 'none';
            if(fallbackViewer) fallbackViewer.style.display = 'flex';
            
            // 启用备用查看器
            skinViewer = null;
            initFallbackSkinViewer();
            showToast('已切换到简易皮肤查看器（3D库未加载）', 'warning');
            return;
        }
        
        try {
            // 隐藏备用查看器
            if(fallbackViewer) fallbackViewer.style.display = 'none';
            if(loadingMsg) loadingMsg.style.display = 'none';
            if(errorMsg) errorMsg.style.display = 'none';
            
            // 清除旧的canvas
            const oldCanvas = container.querySelector('canvas');
            if(oldCanvas) oldCanvas.remove();
            
            // 创建 canvas 元素
            const canvas = document.createElement('canvas');
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.borderRadius = '12px';
            container.appendChild(canvas);
            
            skinViewer = new skinview3d.SkinViewer({
                canvas: canvas,
                width: container.clientWidth,
                height: 400,
                skin: 'https://crafatar.com/skins/8667ba71b85a4004af54457a9734eed7' // Default Steve
            });
            
            // Add controls
            const control = new skinview3d.OrbitControls(skinViewer);
            control.enableZoom = true;
            control.enablePan = false;
            
            // 初始化动画为静止状态
            skinViewer.animation = null;
            currentAnimationType = 'none';
            isAnimationPaused = true;
            updateAnimationButtons();
            
            showToast('3D皮肤查看器已加载');
            
        } catch(e) {
            console.error('Skin viewer initialization failed:', e);
            if(loadingMsg) loadingMsg.style.display = 'none';
            if(errorMsg) errorMsg.style.display = 'none';
            if(fallbackViewer) fallbackViewer.style.display = 'flex';
            
            skinViewer = null;
            initFallbackSkinViewer();
            showToast('已切换到简易皮肤查看器', 'warning');
        }
    }
    
    // 备用皮肤查看器（当3D库加载失败时使用）
    function initFallbackSkinViewer() {
        const fallbackImg = document.getElementById('fallbackSkinImg');
        if(fallbackImg) {
            // 加载默认Steve皮肤
            fallbackImg.src = 'https://crafatar.com/skins/8667ba71b85a4004af54457a9734eed7';
            fallbackImg.onerror = function() {
                // 如果在线皮肤加载失败，显示占位图
                this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect fill="%2300aaaa" width="64" height="64"/><text fill="white" font-size="24" x="50%25" y="50%25" text-anchor="middle" dominant-baseline="middle">?</text></svg>';
            };
        }
    }
    
    // 在备用查看器中加载皮肤
    function loadSkinToFallback(skinUrl) {
        const fallbackImg = document.getElementById('fallbackSkinImg');
        if(fallbackImg && skinUrl) {
            fallbackImg.src = skinUrl;
        }
    }
    
    function loadSkinFromFile() {
        document.getElementById('skinFileInput')?.click();
    }
    
    function handleSkinFile(event) {
        const file = event.target.files[0];
        if(!file) return;
        
        if(!file.type.match('image.*')) {
            showToast('请选择有效的图片文件', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const skinDataUrl = e.target.result;
            
            if(skinViewer && typeof skinview3d !== 'undefined') {
                // 3D查看器可用
                try {
                    skinViewer.loadSkin(skinDataUrl);
                    showToast('皮肤已加载到3D查看器');
                } catch(err) {
                    console.error('Failed to load skin to 3D viewer:', err);
                    // 回退到备用查看器
                    loadSkinToFallback(skinDataUrl);
                    showToast('皮肤已加载到简易查看器');
                }
            } else {
                // 使用备用查看器
                loadSkinToFallback(skinDataUrl);
                showToast('皮肤已加载到简易查看器');
            }
            
            // 保存到历史
            addToSkinHistory({ type: 'file', data: skinDataUrl, time: Date.now() });
        };
        reader.onerror = () => {
            showToast('文件读取失败', 'error');
        };
        reader.readAsDataURL(file);
    }
    
    async function loadSkinFromUsername() {
        const username = prompt('输入Minecraft用户名:');
        if(!username || !username.trim()) return;
        
        const trimmedUsername = username.trim();
        
        showToast(`正在查找 ${trimmedUsername} 的皮肤...`);
        
        try {
            // 使用 Mojang API 获取UUID
            const uuidResponse = await fetch(`https://api.mojang.com/users/profiles/minecraft/${trimmedUsername}`);
            
            if(!uuidResponse.ok) {
                if(uuidResponse.status === 404) {
                    showToast(`未找到用户 "${trimmedUsername}"`, 'error');
                } else {
                    showToast('获取用户信息失败', 'error');
                }
                return;
            }
            
            const data = await uuidResponse.json();
            const uuid = data.id;
            const skinUrl = `https://crafatar.com/skins/${uuid}?timestamp=${Date.now()}`;
            
            // 根据查看器类型加载
            if(skinViewer && typeof skinview3d !== 'undefined') {
                try {
                    skinViewer.loadSkin(skinUrl);
                    showToast(`已加载 ${data.name || trimmedUsername} 的皮肤到3D查看器`);
                } catch(err) {
                    console.error('Failed to load skin to 3D viewer:', err);
                    loadSkinToFallback(skinUrl);
                    showToast(`已加载 ${data.name || trimmedUsername} 的皮肤到简易查看器`);
                }
            } else {
                loadSkinToFallback(skinUrl);
                showToast(`已加载 ${data.name || trimmedUsername} 的皮肤到简易查看器`);
            }
            
            // 保存到历史
            addToSkinHistory({ type: 'username', username: data.name || trimmedUsername, uuid: uuid, time: Date.now() });
            
        } catch(error) {
            console.error('Failed to load skin by username:', error);
            showToast('加载皮肤失败: ' + (error.message || '网络错误'), 'error');
        }
    }
    
    function loadDefaultSkin(type) {
        const skins = {
            steve: '8667ba71b85a4004af54457a9734eed7',
            alex: '6d85bfd515e8496ba8d5dc78573b5f1c',
            creeper: 'be18bd008a1c4c1aa5190b5b8c0a21fb'
        };
        
        if(!skinViewer) {
            showToast('3D查看器未初始化，请刷新页面重试', 'error');
            return;
        }
        
        if(skins[type]) {
            try {
                const skinUrl = `https://crafatar.com/skins/${skins[type]}?timestamp=${Date.now()}`;
                skinViewer.loadSkin(skinUrl);
                showToast(`已加载 ${type} 皮肤`);
            } catch(err) {
                console.error('Failed to load default skin:', err);
                showToast('预设皮肤加载失败', 'error');
            }
        } else {
            showToast('未知的预设皮肤类型', 'error');
        }
    }
    
    function setSkinAnimation(type) {
        if(!skinViewer) {
            showToast('3D查看器未初始化', 'error');
            return;
        }
        
        currentAnimationType = type;
        
        try {
            switch(type) {
                case 'walk':
                    skinViewer.animation = new skinview3d.WalkingAnimation();
                    isAnimationPaused = false;
                    break;
                case 'run':
                    skinViewer.animation = new skinview3d.RunningAnimation();
                    isAnimationPaused = false;
                    break;
                case 'fly':
                    skinViewer.animation = new skinview3d.FlyingAnimation();
                    isAnimationPaused = false;
                    break;
                case 'crouch':
                    // 模拟潜行状态
                    if (skinViewer.player) {
                        skinViewer.player.rotation.x = -0.3;
                        skinViewer.animation = null;
                    }
                    isAnimationPaused = true;
                    break;
                case 'swing':
                    // 辅助手臂挥动动画
                    skinViewer.animation = new skinview3d.WalkingAnimation();
                    if (skinViewer.player) {
                        skinViewer.player.skin.rightArm.rotation.x = Math.PI / 2;
                    }
                    isAnimationPaused = false;
                    break;
                case 'none':
                default:
                    skinViewer.animation = null;
                    if (skinViewer.player) {
                        skinViewer.player.rotation.x = 0;
                    }
                    isAnimationPaused = true;
                    break;
            }
            
            updateAnimationButtons();
            showToast(`动画已切换: ${getAnimationName(type)}`);
            
        } catch(e) {
            console.error('Animation switch failed:', e);
            showToast('动画切换失败', 'error');
        }
    }
    
    function getAnimationName(type) {
        const names = {
            'none': '静止',
            'walk': '行走',
            'run': '跑步',
            'fly': '飞行',
            'crouch': '潜行',
            'swing': '挥动'
        };
        return names[type] || type;
    }
    
    function toggleSkinAnimationPause() {
        if(!skinViewer) {
            showToast('3D查看器未初始化', 'error');
            return;
        }
        
        // 如果当前没有动画且点击播放，默认切换到行走动画
        if(currentAnimationType === 'none' && isAnimationPaused) {
            setSkinAnimation('walk');
            return;
        }
        
        if(skinViewer.animation) {
            isAnimationPaused = !isAnimationPaused;
            skinViewer.animation.paused = isAnimationPaused;
            updatePauseButton();
            showToast(isAnimationPaused ? '动画已暂停' : '动画已播放');
        } else {
            showToast('请先选择一种动画类型', 'warning');
        }
    }
    
    function updateAnimationButtons() {
        // 更新动画类型按钮样式
        ['none', 'walk', 'run', 'fly'].forEach(type => {
            const btn = document.getElementById(`anim-${type}`);
            if(btn) {
                if(type === currentAnimationType) {
                    btn.style.background = 'var(--mc-green)';
                    btn.style.color = '#fff';
                    btn.style.borderColor = 'var(--mc-green)';
                } else {
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.style.borderColor = '';
                }
            }
        });
        
        updatePauseButton();
    }
    
    function updatePauseButton() {
        const btn = document.getElementById('animPauseBtn');
        if(btn) {
            const icon = isAnimationPaused ? 'fa-play' : 'fa-pause';
            const text = isAnimationPaused ? '播放' : '暂停';
            btn.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
        }
    }
    
    function updateSkinRotation() {
        if(!skinViewer) return;
        const x = document.getElementById('skinRotX')?.value || 0;
        const y = document.getElementById('skinRotY')?.value || 0;
        if(skinViewer.player) {
            skinViewer.player.rotation.x = x * Math.PI / 180;
            skinViewer.player.rotation.y = y * Math.PI / 180;
        }
    }
    
    function updateSkinZoom() {
        if(!skinViewer) return;
        const zoom = document.getElementById('skinZoom')?.value || 1;
        skinViewer.zoom = parseFloat(zoom);
    }
    
    function setSkinBg(color) {
        const viewer = document.getElementById('skinViewer');
        if(viewer) {
            viewer.style.background = color;
        }
    }


    
    // ==================== Particle Editor ====================
    function renderParticleEditor(container) {
        const particles = [
            { id: 'minecraft:flame', name: '火焰', color: '#ff6b35' },
            { id: 'minecraft:smoke', name: '烟雾', color: '#808080' },
            { id: 'minecraft:lava', name: '岩浆', color: '#ff4500' },
            { id: 'minecraft:heart', name: '爱心', color: '#ff69b4' },
            { id: 'minecraft:note', name: '音符', color: '#9370db' },
            { id: 'minecraft:crit', name: '暴击', color: '#00ffff' },
            { id: 'minecraft:magic_crit', name: '魔法暴击', color: '#ff00ff' },
            { id: 'minecraft:enchantmenttable', name: '附魔', color: '#9400d3' },
            { id: 'minecraft:portal', name: '传送门', color: '#9932cc' },
            { id: 'minecraft:redstone', name: '红石', color: '#ff0000' },
            { id: 'minecraft:slime', name: '史莱姆', color: '#00ff00' },
            { id: 'minecraft:snowballpoof', name: '雪球', color: '#ffffff' },
            { id: 'minecraft:largeexplode', name: '大爆炸', color: '#ffa500' },
            { id: 'minecraft:hugeexplosion', name: '巨大爆炸', color: '#ff4500' },
            { id: 'minecraft:splash', name: '水花', color: '#4169e1' },
            { id: 'minecraft:witchmagic', name: '女巫魔法', color: '#800080' }
        ];
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('particle_editor')}</h2>
                    <div class="page-subtitle">基岩版粒子效果生成器</div>
                </div>
            </div>
            
            <div class="content-grid" style="grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));">
                ${particles.map(p => `
                    <div class="card" onclick="selectParticle('${p.id}')" style="text-align: center; cursor: pointer; border-top: 3px solid ${p.color};">
                        <div style="width: 40px; height: 40px; margin: 0 auto 8px; border-radius: 50%; background: ${p.color}; box-shadow: 0 0 10px ${p.color};"></div>
                        <div class="card-title" style="font-size: 0.9rem;">${p.name}</div>
                        <div style="font-size: 0.7rem; color: #64748b; margin-top: 4px;">${p.id.replace('minecraft:', '')}</div>
                    </div>
                `).join('')}
            </div>
            
            <div id="particleConfig" class="input-area" style="margin-top: 20px; display: none;">
                <h3 style="color: #22d3ee; margin-bottom: 16px;"><i class="fas fa-cog"></i> 粒子配置</h3>
                <div style="display: grid; gap: 12px;">
                    <div><label style="color: #94a3b8;">粒子ID</label>
                        <input type="text" id="particleId" class="search-input" readonly></div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div><label style="color: #94a3b8;">X坐标</label>
                            <input type="text" id="particleX" class="search-input" value="~" placeholder="~"></div>
                        <div><label style="color: #94a3b8;">Y坐标</label>
                            <input type="text" id="particleY" class="search-input" value="~" placeholder="~"></div>
                        <div><label style="color: #94a3b8;">Z坐标</label>
                            <input type="text" id="particleZ" class="search-input" value="~" placeholder="~"></div>
                    </div>
                    <div><label style="color: #94a3b8;">粒子数据 (可选)</label>
                        <input type="text" id="particleData" class="search-input" placeholder="如: 1"></div>
                </div>
                <div class="action-buttons">
                    <button onclick="generateParticleCommand()" class="btn btn-primary" style="background: linear-gradient(135deg, #22d3ee, #0891b2);">
                        <i class="fas fa-magic"></i> 生成指令
                    </button>
                </div>
                <div id="particleResult" style="margin-top: 12px; padding: 12px; background: rgba(6,182,212,0.1); border-radius: 8px; font-family: 'JetBrains Mono', monospace; display: none;"></div>
            </div>
        `;
    }
    
    function selectParticle(id) {
        document.getElementById('particleConfig').style.display = 'block';
        document.getElementById('particleId').value = id;
        document.getElementById('particleResult').style.display = 'none';
        document.getElementById('particleConfig').scrollIntoView({ behavior: 'smooth' });
    }
    
    function generateParticleCommand() {
        const id = document.getElementById('particleId').value;
        const x = document.getElementById('particleX').value || '~';
        const y = document.getElementById('particleY').value || '~';
        const z = document.getElementById('particleZ').value || '~';
        const data = document.getElementById('particleData').value;
        
        // Bedrock format
        let command = `/particle ${id.replace('minecraft:', '')} ${x} ${y} ${z}`;
        if(data) command += ` ${data}`;
        
        const resultDiv = document.getElementById('particleResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="color: #22d3ee; margin-bottom: 8px;">${escapeHtml(command)}</div>
            <button onclick="copyText('${command.replace(/'/g, "\\'")}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">
                <i class="fas fa-copy"></i> ${t('copy')}
            </button>
        `;
    }
    
    // ==================== Material Calculator ====================
    function renderMaterialCalculator(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('material_calculator')}</h2>
                    <div class="page-subtitle">计算建筑所需材料</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchMaterialPanel('blocks', this)">方块计算</button>
                <button class="tab-btn" onclick="switchMaterialPanel('items', this)">物品合成</button>
                <button class="tab-btn" onclick="switchMaterialPanel('beacon', this)">信标金字塔</button>
            </div>
            
            <div id="material-panel-blocks">
                <div class="input-area">
                    <h3 style="color: #4ade80; margin-bottom: 16px;"><i class="fas fa-cube"></i> 方块数量计算</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div><label style="color: #94a3b8;">长度</label>
                            <input type="number" id="blockLength" class="search-input" placeholder="0" min="0" oninput="calculateBlocks()"></div>
                        <div><label style="color: #94a3b8;">宽度</label>
                            <input type="number" id="blockWidth" class="search-input" placeholder="0" min="0" oninput="calculateBlocks()"></div>
                        <div><label style="color: #94a3b8;">高度</label>
                            <input type="number" id="blockHeight" class="search-input" placeholder="1" value="1" min="1" oninput="calculateBlocks()"></div>
                    </div>
                    <div style="margin-top: 16px; padding: 16px; background: rgba(74,222,128,0.1); border-radius: 10px; border: 1px solid rgba(74,222,128,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #94a3b8;">所需方块总数:</span>
                            <span id="blockTotal" style="font-family: 'VT323', monospace; font-size: 2rem; color: #4ade80;">0</span>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.85rem; color: #64748b;">
                            等于 <span id="blockStacks">0</span> 组 + <span id="blockRemainder">0</span> 个
                        </div>
                    </div>
                </div>
                
                <div class="content-grid">
                    <div class="card">
                        <div class="card-title" style="color: #4ade80;">常用材料</div>
                        <div class="card-desc" style="margin-top: 8px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                                <span class="tag">石头</span>
                                <span class="tag">木头</span>
                                <span class="tag">圆石</span>
                                <span class="tag">泥土</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title" style="color: #fbbf24;">装饰方块</div>
                        <div class="card-desc" style="margin-top: 8px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                                <span class="tag tag-gold">羊毛</span>
                                <span class="tag tag-gold">玻璃</span>
                                <span class="tag tag-gold">混凝土</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="material-panel-items" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #fbbf24; margin-bottom: 16px;"><i class="fas fa-crafting"></i> 合成计算器</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div><label style="color: #94a3b8;">目标物品</label>
                            <select id="craftItem" class="search-input" onchange="calculateCrafting()">
                                <option value="">选择物品...</option>
                                <option value="planks:4">橡木木板 (1原木→4)</option>
                                <option value="sticks:4">木棍 (2木板→4)</option>
                                <option value="crafting_table:1">工作台 (4木板→1)</option>
                                <option value="chest:1">箱子 (8木板→1)</option>
                                <option value="torch:4">火把 (1煤+1木棍→4)</option>
                                <option value="ladder:3">梯子 (7木棍→3)</option>
                                <option value="fence:3">栅栏 (4木板+2木棍→3)</option>
                                <option value="door:3">门 (6木板→3)</option>
                                <option value="glass_pane:16">玻璃板 (6玻璃→16)</option>
                                <option value="iron_block:1">铁块 (9铁锭→1)</option>
                                <option value="gold_block:1">金块 (9金锭→1)</option>
                                <option value="diamond_block:1">钻石块 (9钻石→1)</option>
                            </select></div>
                        <div><label style="color: #94a3b8;">需要数量</label>
                            <input type="number" id="craftAmount" class="search-input" placeholder="1" value="1" min="1" oninput="calculateCrafting()"></div>
                    </div>
                    <div id="craftResult" style="margin-top: 16px; display: none;"></div>
                </div>
            </div>
            
            <div id="material-panel-beacon" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #fbbf24; margin-bottom: 16px;"><i class="fas fa-star"></i> 信标金字塔计算器</h3>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; display: block; margin-bottom: 8px;">金字塔层数</label>
                        <select id="beaconLayers" class="search-input" onchange="calculateBeacon()" style="max-width: 200px;">
                            <option value="1">1层 (3×3)</option>
                            <option value="2">2层 (5×5)</option>
                            <option value="3">3层 (7×7)</option>
                            <option value="4">4层 (9×9)</option>
                        </select>
                    </div>
                    <div style="padding: 16px; background: rgba(251,191,36,0.1); border-radius: 10px; border: 1px solid rgba(251,191,36,0.3);">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div><span style="color: #94a3b8;">所需矿物块:</span>
                                <div id="beaconBlocks" style="font-family: 'VT323', monospace; font-size: 1.8rem; color: #fbbf24;">9</div></div>
                            <div><span style="color: #94a3b8;">所需矿物锭:</span>
                                <div id="beaconIngots" style="font-family: 'VT323', monospace; font-size: 1.8rem; color: #fbbf24;">81</div></div>
                        </div>
                        <div style="margin-top: 12px; font-size: 0.85rem; color: #64748b;">
                            效果范围: <span id="beaconRange">20</span> 格 | 效果时长: <span id="beaconDuration">11</span> 秒
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchMaterialPanel(panel, btn) {
        document.querySelectorAll('[id^="material-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`material-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function calculateBlocks() {
        const l = parseInt(document.getElementById('blockLength')?.value) || 0;
        const w = parseInt(document.getElementById('blockWidth')?.value) || 0;
        const h = parseInt(document.getElementById('blockHeight')?.value) || 1;
        
        const total = l * w * h;
        const stacks = Math.floor(total / 64);
        const remainder = total % 64;
        
        document.getElementById('blockTotal').textContent = total.toLocaleString();
        document.getElementById('blockStacks').textContent = stacks;
        document.getElementById('blockRemainder').textContent = remainder;
    }
    
    function calculateCrafting() {
        const itemVal = document.getElementById('craftItem')?.value;
        const amount = parseInt(document.getElementById('craftAmount')?.value) || 1;
        const resultDiv = document.getElementById('craftResult');
        
        if(!itemVal) {
            resultDiv.style.display = 'none';
            return;
        }
        
        const [item, ratio] = itemVal.split(':');
        const ratioNum = parseInt(ratio);
        const batches = Math.ceil(amount / ratioNum);
        
        const recipes = {
            planks: { '原木': 1 },
            sticks: { '木板': 2 },
            crafting_table: { '木板': 4 },
            chest: { '木板': 8 },
            torch: { '煤/木炭': 1, '木棍': 1 },
            ladder: { '木棍': 7 },
            fence: { '木板': 4, '木棍': 2 },
            door: { '木板': 6 },
            glass_pane: { '玻璃': 6 },
            iron_block: { '铁锭': 9 },
            gold_block: { '金锭': 9 },
            diamond_block: { '钻石': 9 }
        };
        
        let html = '<div style="color: #fbbf24; margin-bottom: 8px;">所需材料:</div>';
        const recipe = recipes[item];
        if(recipe) {
            for(const [mat, count] of Object.entries(recipe)) {
                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 6px;">
                    <span>${mat}</span>
                    <span style="color: #fbbf24; font-weight: 600;">${count * batches}</span>
                </div>`;
            }
        }
        
        resultDiv.innerHTML = html;
        resultDiv.style.display = 'block';
    }
    
    function calculateBeacon() {
        const layers = parseInt(document.getElementById('beaconLayers')?.value) || 1;
        
        const layerBlocks = [9, 25, 49, 81];
        const ranges = [20, 30, 40, 50];
        const durations = [11, 13, 15, 17];
        
        const totalBlocks = layerBlocks.slice(0, layers).reduce((a, b) => a + b, 0);
        
        document.getElementById('beaconBlocks').textContent = totalBlocks;
        document.getElementById('beaconIngots').textContent = totalBlocks * 9;
        document.getElementById('beaconRange').textContent = ranges[layers - 1];
        document.getElementById('beaconDuration').textContent = durations[layers - 1];
    }
    
    // ==================== Enchantment Tool ====================
    function renderEnchantmentTool(container) {
        const enchantments = [
            { id: 'protection', name: '保护', max: 4 },
            { id: 'fire_protection', name: '火焰保护', max: 4 },
            { id: 'feather_falling', name: '摔落保护', max: 4 },
            { id: 'blast_protection', name: '爆炸保护', max: 4 },
            { id: 'projectile_protection', name: '弹射物保护', max: 4 },
            { id: 'respiration', name: '水下呼吸', max: 3 },
            { id: 'aqua_affinity', name: '水下速掘', max: 1 },
            { id: 'thorns', name: '荆棘', max: 3 },
            { id: 'depth_strider', name: '深海探索者', max: 3 },
            { id: 'frost_walker', name: '冰霜行者', max: 2 },
            { id: 'soul_speed', name: '灵魂疾行', max: 3 },
            { id: 'sharpness', name: '锋利', max: 5 },
            { id: 'smite', name: '亡灵杀手', max: 5 },
            { id: 'bane_of_arthropods', name: '节肢杀手', max: 5 },
            { id: 'knockback', name: '击退', max: 2 },
            { id: 'fire_aspect', name: '火焰附加', max: 2 },
            { id: 'looting', name: '抢夺', max: 3 },
            { id: 'sweeping', name: '横扫之刃', max: 3 },
            { id: 'efficiency', name: '效率', max: 5 },
            { id: 'silk_touch', name: '精准采集', max: 1 },
            { id: 'unbreaking', name: '耐久', max: 3 },
            { id: 'fortune', name: '时运', max: 3 },
            { id: 'power', name: '力量', max: 5 },
            { id: 'punch', name: '冲击', max: 2 },
            { id: 'flame', name: '火矢', max: 1 },
            { id: 'infinity', name: '无限', max: 1 },
            { id: 'luck_of_the_sea', name: '海之眷顾', max: 3 },
            { id: 'lure', name: '饵钓', max: 3 },
            { id: 'loyalty', name: '忠诚', max: 3 },
            { id: 'impaling', name: '穿刺', max: 5 },
            { id: 'riptide', name: '激流', max: 3 },
            { id: 'channeling', name: '引雷', max: 1 },
            { id: 'multishot', name: '多重射击', max: 1 },
            { id: 'quick_charge', name: '快速装填', max: 3 },
            { id: 'piercing', name: '穿透', max: 4 },
            { id: 'mending', name: '经验修补', max: 1 },
            { id: 'vanishing_curse', name: '消失诅咒', max: 1 },
            { id: 'binding_curse', name: '绑定诅咒', max: 1 }
        ];
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('enchantment')}</h2>
                    <div class="page-subtitle">附魔成本计算器 & 最优顺序推荐</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchEnchantPanel('calculator', this)">附魔计算器</button>
                <button class="tab-btn" onclick="switchEnchantPanel('optimal', this)">最优顺序</button>
                <button class="tab-btn" onclick="switchEnchantPanel('probability', this)">附魔概率</button>
            </div>
            
            <div id="enchant-panel-calculator">
                <div class="input-area">
                    <h3 style="color: #60a5fa; margin-bottom: 16px;"><i class="fas fa-calculator"></i> 铁砧成本计算</h3>
                    <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 12px;">选择要添加的附魔，计算所需经验等级</p>
                    
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                        ${enchantments.map(e => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" class="enchant-check" data-id="${e.id}" data-max="${e.max}" onchange="calculateEnchantCost()">
                                    <span style="margin-left: 8px;">${e.name}</span>
                                </label>
                                <select class="enchant-level" data-id="${e.id}" onchange="calculateEnchantCost()" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 4px 8px; color: #fff; width: 70px;">
                                    ${Array.from({length: e.max}, (_, i) => `<option value="${i+1}">${i+1}级</option>`).join('')}
                                </select>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 16px; padding: 16px; background: rgba(96,165,250,0.1); border-radius: 10px; border: 1px solid rgba(96,165,250,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #94a3b8;">预计总成本:</span>
                            <span id="enchantTotalCost" style="font-family: 'VT323', monospace; font-size: 2rem; color: #60a5fa;">0</span>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.85rem; color: #64748b;">
                            经验等级 (可能需要多次铁砧操作)
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="generateEnchantCommand()" class="btn btn-primary" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);">
                            <i class="fas fa-magic"></i> 生成give指令
                        </button>
                        <button onclick="clearEnchantSelection()" class="btn btn-secondary">清除选择</button>
                    </div>
                    
                    <div id="enchantCommandResult" style="margin-top: 12px; display: none;"></div>
                </div>
            </div>
            
            <div id="enchant-panel-optimal" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #fbbf24; margin-bottom: 16px;"><i class="fas fa-sort-amount-down"></i> 最优附魔顺序</h3>
                    <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 12px;">根据贪心算法，按以下顺序附魔可以最小化经验成本</p>
                    <ol style="color: #e2e8f0; line-height: 2;">
                        <li>从高等级到低等级依次附魔</li>
                        <li>先附魔成本高的附魔</li>
                        <li>将两件已附魔物品合并时，成本是两者之和+合并惩罚</li>
                        <li>建议顺序: 耐久→经验修补→主要附魔(锋利/保护等)→次要附魔</li>
                    </ol>
                    <div style="margin-top: 16px; padding: 12px; background: rgba(251,191,36,0.1); border-radius: 8px;">
                        <div style="color: #fbbf24; font-size: 0.85rem;">💡 提示: 使用附魔书在铁砧上附魔时，书籍的获取顺序也会影响最终成本</div>
                    </div>
                </div>
            </div>
            
            <div id="enchant-panel-probability" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #a855f7; margin-bottom: 16px;"><i class="fas fa-dice"></i> 附魔台概率</h3>
                    <p style="color: #94a3b8; font-size: 0.85rem;">附魔台提供的附魔等级取决于书架数量(0-15个)</p>
                    <div style="margin-top: 16px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <tr style="background: rgba(255,255,255,0.05);">
                                <th style="padding: 10px; text-align: left; color: #94a3b8;">书架数</th>
                                <th style="padding: 10px; text-align: center; color: #94a3b8;">最低等级</th>
                                <th style="padding: 10px; text-align: center; color: #94a3b8;">最高等级</th>
                            </tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">0</td><td style="text-align: center;">1</td><td style="text-align: center;">5</td></tr>
                            <tr style="background: rgba(255,255,255,0.03);"><td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">1-8</td><td style="text-align: center;">1-5</td><td style="text-align: center;">8-13</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">9-14</td><td style="text-align: center;">1-11</td><td style="text-align: center;">14-24</td></tr>
                            <tr style="background: rgba(255,255,255,0.03);"><td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">15</td><td style="text-align: center;">1-17</td><td style="text-align: center;">17-30</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchEnchantPanel(panel, btn) {
        document.querySelectorAll('[id^="enchant-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`enchant-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function calculateEnchantCost() {
        const checks = document.querySelectorAll('.enchant-check:checked');
        let totalCost = 0;
        
        checks.forEach(check => {
            const id = check.dataset.id;
            const level = document.querySelector(`.enchant-level[data-id="${id}"]`)?.value || 1;
            // Simple cost calculation (actual formula is more complex)
            const baseCost = { protection: 1, sharpness: 1, efficiency: 1, power: 1 };
            const cost = (baseCost[id] || 2) * parseInt(level);
            totalCost += cost;
        });
        
        // Add penalty for multiple enchantments
        if(checks.length > 1) {
            totalCost += (checks.length - 1) * 2;
        }
        
        document.getElementById('enchantTotalCost').textContent = totalCost;
    }
    
    function generateEnchantCommand() {
        const checks = document.querySelectorAll('.enchant-check:checked');
        if(checks.length === 0) {
            showToast('请先选择附魔');
            return;
        }
        
        const enchantments = [];
        checks.forEach(check => {
            const id = check.dataset.id;
            const level = document.querySelector(`.enchant-level[data-id="${id}"]`)?.value || 1;
            enchantments.push(`{id:"minecraft:${id}",lvl:${level}s}`);
        });
        
        const command = `/give @p minecraft:diamond_sword{Enchantments:[${enchantments.join(',')}]} 1`;
        
        const resultDiv = document.getElementById('enchantCommandResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; margin-bottom: 10px;">
                ${escapeHtml(command)}
            </div>
            <button onclick="copyText('${command.replace(/'/g, "\\'")}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">
                <i class="fas fa-copy"></i> ${t('copy')}
            </button>
        `;
    }
    
    function clearEnchantSelection() {
        document.querySelectorAll('.enchant-check').forEach(c => c.checked = false);
        document.getElementById('enchantTotalCost').textContent = '0';
        document.getElementById('enchantCommandResult').style.display = 'none';
    }


    
    // ==================== XP Calculator ====================
    function renderXPCalculator(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('xp_calculator')}</h2>
                    <div class="page-subtitle">经验等级与点数转换计算</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchXPPanel('level', this)">等级计算器</button>
                <button class="tab-btn" onclick="switchXPPanel('points', this)">点数计算器</button>
                <button class="tab-btn" onclick="switchXPPanel('anvil', this)">铁砧惩罚</button>
            </div>
            
            <div id="xp-panel-level">
                <div class="input-area">
                    <h3 style="color: #fbbf24; margin-bottom: 16px;"><i class="fas fa-chart-line"></i> 等级与点数转换</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="color: #94a3b8; display: block; margin-bottom: 8px;">目标等级</label>
                            <input type="number" id="targetLevel" class="search-input" placeholder="30" min="0" max="1000" oninput="calculateXPFromLevel()">
                            <div style="margin-top: 12px; padding: 12px; background: rgba(251,191,36,0.1); border-radius: 8px;">
                                <span style="color: #94a3b8;">所需总经验:</span>
                                <div id="xpFromLevelResult" style="font-family: 'VT323', monospace; font-size: 1.8rem; color: #fbbf24;">0</div>
                            </div>
                        </div>
                        <div>
                            <label style="color: #94a3b8; display: block; margin-bottom: 8px;">经验点数</label>
                            <input type="number" id="xpPoints" class="search-input" placeholder="1000" min="0" oninput="calculateLevelFromXP()">
                            <div style="margin-top: 12px; padding: 12px; background: rgba(251,191,36,0.1); border-radius: 8px;">
                                <span style="color: #94a3b8;">可达等级:</span>
                                <div id="levelFromXPResult" style="font-family: 'VT323', monospace; font-size: 1.8rem; color: #fbbf24;">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: #94a3b8; margin-bottom: 10px;">经验来源参考</h4>
                        <div class="content-grid" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));">
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">1-3</div><div style="font-size: 0.8rem; color: #94a3b8;">击杀怪物</div></div>
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">0.2</div><div style="font-size: 0.8rem; color: #94a3b8;">挖掘 coal</div></div>
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">1-7</div><div style="font-size: 0.8rem; color: #94a3b8;">挖掘钻石</div></div>
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">2-4</div><div style="font-size: 0.8rem; color: #94a3b8;">钓鱼/繁殖</div></div>
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">0.35</div><div style="font-size: 0.8rem; color: #94a3b8;">烧炼物品</div></div>
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">50+</div><div style="font-size: 0.8rem; color: #94a3b8;">击杀末影龙</div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="xp-panel-points" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #4ade80; margin-bottom: 16px;"><i class="fas fa-calculator"></i> 经验点数计算器</h3>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; display: block; margin-bottom: 8px;">当前等级</label>
                        <input type="number" id="currentLvl" class="search-input" placeholder="0" min="0" oninput="calculateXPPoints()">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; display: block; margin-bottom: 8px;">当前经验条进度 (%)</label>
                        <input type="number" id="currentProgress" class="search-input" placeholder="0" min="0" max="100" oninput="calculateXPPoints()">
                    </div>
                    <div style="padding: 16px; background: rgba(74,222,128,0.1); border-radius: 10px; border: 1px solid rgba(74,222,128,0.3);">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">当前总经验:</span>
                                <div id="currentTotalXP" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #4ade80;">0</div>
                            </div>
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">升到下一级需要:</span>
                                <div id="xpToNext" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #4ade80;">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="xp-panel-anvil" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #f97316; margin-bottom: 16px;"><i class="fas fa-hammer"></i> 铁砧操作惩罚</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">每次在铁砧上操作都会增加"操作惩罚"，导致后续操作更昂贵</p>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; display: block; margin-bottom: 8px;">物品已操作次数</label>
                        <input type="number" id="anvilCount" class="search-input" placeholder="0" min="0" max="6" oninput="calculateAnvilPenalty()">
                    </div>
                    
                    <div style="padding: 16px; background: rgba(249,115,22,0.1); border-radius: 10px; border: 1px solid rgba(249,115,22,0.3);">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">额外经验惩罚:</span>
                                <div id="anvilPenalty" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #f97316;">0</div>
                            </div>
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">操作后惩罚等级:</span>
                                <div id="nextPenalty" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #f97316;">1</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 0.85rem; color: #64748b;">
                            公式: 惩罚 = 2^n - 1 (n为操作次数)
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchXPPanel(panel, btn) {
        document.querySelectorAll('[id^="xp-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`xp-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function getXPForLevel(level) {
        if(level <= 16) return level * level + 6 * level;
        if(level <= 31) return 2.5 * level * level - 40.5 * level + 360;
        return 4.5 * level * level - 162.5 * level + 2220;
    }
    
    function getLevelFromXP(xp) {
        let level = 0;
        while(getXPForLevel(level + 1) <= xp) level++;
        return level;
    }
    
    function calculateXPFromLevel() {
        const level = parseInt(document.getElementById('targetLevel')?.value) || 0;
        const xp = getXPForLevel(level);
        document.getElementById('xpFromLevelResult').textContent = Math.floor(xp).toLocaleString();
    }
    
    function calculateLevelFromXP() {
        const xp = parseInt(document.getElementById('xpPoints')?.value) || 0;
        const level = getLevelFromXP(xp);
        document.getElementById('levelFromXPResult').textContent = level;
    }
    
    function calculateXPPoints() {
        const level = parseInt(document.getElementById('currentLvl')?.value) || 0;
        const progress = parseInt(document.getElementById('currentProgress')?.value) || 0;
        
        const totalXP = getXPForLevel(level);
        const nextLevelXP = getXPForLevel(level + 1);
        const currentLevelXP = totalXP + (nextLevelXP - totalXP) * (progress / 100);
        
        document.getElementById('currentTotalXP').textContent = Math.floor(currentLevelXP).toLocaleString();
        document.getElementById('xpToNext').textContent = Math.ceil(nextLevelXP - currentLevelXP).toLocaleString();
    }
    
    function calculateAnvilPenalty() {
        const count = parseInt(document.getElementById('anvilCount')?.value) || 0;
        const penalty = Math.pow(2, count) - 1;
        document.getElementById('anvilPenalty').textContent = penalty;
        document.getElementById('nextPenalty').textContent = count + 1;
    }
    
    // ==================== Smelting Calculator ====================
    function renderSmeltingCalculator(container) {
        const fuels = [
            { name: '煤炭', time: 80, items: 8 },
            { name: '木炭', time: 80, items: 8 },
            { name: '煤炭块', time: 800, items: 80 },
            { name: '原木', time: 15, items: 1.5 },
            { name: '木板', time: 15, items: 1.5 },
            { name: '木棍', time: 1, items: 0.1 },
            { name: '岩浆桶', time: 1000, items: 100 },
            { name: '烈焰棒', time: 120, items: 12 },
            { name: '干海带块', time: 200, items: 20 },
            { name: '脚手架', time: 2, items: 0.2 }
        ];
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('smelting')}</h2>
                    <div class="page-subtitle">熔炼燃料计算与时间管理</div>
                </div>
            </div>
            
            <div class="content-grid" style="grid-template-columns: 2fr 1fr;">
                <div class="input-area">
                    <h3 style="color: #f97316; margin-bottom: 16px;"><i class="fas fa-fire"></i> 燃料计算器</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="color: #94a3b8; display: block; margin-bottom: 8px;">要熔炼的物品数量</label>
                            <input type="number" id="smeltItems" class="search-input" placeholder="64" min="1" oninput="calculateFuelNeeded()">
                        </div>
                        <div>
                            <label style="color: #94a3b8; display: block; margin-bottom: 8px;">选择燃料类型</label>
                            <select id="fuelType" class="search-input" onchange="calculateFuelNeeded()">
                                ${fuels.map(f => `<option value="${f.items}">${f.name} (${f.items}个物品)</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div style="padding: 16px; background: rgba(249,115,22,0.1); border-radius: 10px; border: 1px solid rgba(249,115,22,0.3);">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">需要燃料:</span>
                                <div id="fuelNeeded" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #f97316;">0</div>
                            </div>
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">熔炼时间:</span>
                                <div id="smeltTime" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #f97316;">0s</div>
                            </div>
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">获得经验:</span>
                                <div id="smeltXP" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #f97316;">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <h3 style="color: #fbbf24; margin-bottom: 12px; font-size: 1rem;"><i class="fas fa-list"></i> 燃料列表</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${fuels.map(f => `
                            <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span style="font-size: 0.85rem;">${f.name}</span>
                                <span style="color: #f97316; font-size: 0.85rem;">${f.items} 物品</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <div class="content-grid" style="margin-top: 20px;">
                <div class="card">
                    <div class="card-title" style="color: #f97316;">熔炼技巧</div>
                    <ul style="color: #94a3b8; font-size: 0.85rem; margin-top: 10px; padding-left: 16px; line-height: 1.8;">
                        <li>使用漏斗自动输入/输出提高效率</li>
                        <li>煤炭块是性价比最高的燃料</li>
                        <li>岩浆桶可以熔炼100个物品</li>
                    </ul>
                </div>
                <div class="card">
                    <div class="card-title" style="color: #4ade80;">经验农场</div>
                    <ul style="color: #94a3b8; font-size: 0.85rem; margin-top: 10px; padding-left: 16px; line-height: 1.8;">
                        <li>烧炼圆石→石头获得经验</li>
                        <li>仙人掌农场可以无限获取燃料</li>
                        <li>海带干块是海洋农场的好选择</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    function calculateFuelNeeded() {
        const items = parseInt(document.getElementById('smeltItems')?.value) || 0;
        const fuelPower = parseFloat(document.getElementById('fuelType')?.value) || 8;
        
        const fuelNeeded = Math.ceil(items / fuelPower);
        const smeltTime = items * 10; // 10 seconds per item
        const xpGained = items * 0.1; // approx 0.1 xp per smelt
        
        document.getElementById('fuelNeeded').textContent = fuelNeeded;
        document.getElementById('smeltTime').textContent = smeltTime >= 60 
            ? Math.floor(smeltTime / 60) + '分' + (smeltTime % 60) + '秒' 
            : smeltTime + '秒';
        document.getElementById('smeltXP').textContent = xpGained.toFixed(1);
    }
    
    // ==================== Coordinate Converter ====================
    function renderCoordConverter(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('coord_convert')}</h2>
                    <div class="page-subtitle">不同坐标系之间的转换</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchCoordPanel('overworld', this)">主世界↔下界</button>
                <button class="tab-btn" onclick="switchCoordPanel('spherical', this)">球面坐标</button>
                <button class="tab-btn" onclick="switchCoordPanel('chunk', this)">区块坐标</button>
            </div>
            
            <div id="coord-panel-overworld">
                <div class="input-area">
                    <h3 style="color: #22d3ee; margin-bottom: 16px;"><i class="fas fa-exchange-alt"></i> 主世界与下界坐标转换</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">下界坐标 = 主世界坐标 ÷ 8 (X和Z轴)</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="padding: 16px; background: rgba(34,211,238,0.1); border-radius: 10px; border: 1px solid rgba(34,211,238,0.3);">
                            <h4 style="color: #22d3ee; margin-bottom: 12px;"><i class="fas fa-globe"></i> 主世界</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                                <input type="number" id="overworldX" class="search-input" placeholder="X" oninput="convertToNether()">
                                <input type="number" id="overworldY" class="search-input" placeholder="Y">
                                <input type="number" id="overworldZ" class="search-input" placeholder="Z" oninput="convertToNether()">
                            </div>
                        </div>
                        
                        <div style="padding: 16px; background: rgba(220,38,38,0.1); border-radius: 10px; border: 1px solid rgba(220,38,38,0.3);">
                            <h4 style="color: #ef4444; margin-bottom: 12px;"><i class="fas fa-fire"></i> 下界</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                                <input type="number" id="netherX" class="search-input" placeholder="X" oninput="convertToOverworld()">
                                <input type="number" id="netherY" class="search-input" placeholder="Y">
                                <input type="number" id="netherZ" class="search-input" placeholder="Z" oninput="convertToOverworld()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="copyCoords('overworld')" class="btn btn-secondary" style="padding: 8px 14px; font-size: 0.85rem;">
                            <i class="fas fa-copy"></i> 复制主世界
                        </button>
                        <button onclick="copyCoords('nether')" class="btn btn-secondary" style="padding: 8px 14px; font-size: 0.85rem;">
                            <i class="fas fa-copy"></i> 复制下界
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="coord-panel-spherical" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #a855f7; margin-bottom: 16px;"><i class="fas fa-globe-americas"></i> 球面坐标转换</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">用于计算两点之间的距离和方向</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 16px;">
                        <div>
                            <h4 style="color: #94a3b8; margin-bottom: 10px;">起点坐标</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <input type="number" id="sphereX1" class="search-input" placeholder="X">
                                <input type="number" id="sphereZ1" class="search-input" placeholder="Z">
                            </div>
                        </div>
                        <div>
                            <h4 style="color: #94a3b8; margin-bottom: 10px;">终点坐标</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <input type="number" id="sphereX2" class="search-input" placeholder="X">
                                <input type="number" id="sphereZ2" class="search-input" placeholder="Z">
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="calculateSphericalCoords()" class="btn btn-primary" style="background: linear-gradient(135deg, #a855f7, #7c3aed);">
                        <i class="fas fa-calculator"></i> 计算
                    </button>
                    
                    <div id="sphericalResult" style="margin-top: 16px; display: none;"></div>
                </div>
            </div>
            
            <div id="coord-panel-chunk" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #4ade80; margin-bottom: 16px;"><i class="fas fa-th"></i> 区块坐标转换</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">世界坐标与区块坐标的转换</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="color: #94a3b8;">世界坐标</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                                <input type="number" id="worldChunkX" class="search-input" placeholder="X" oninput="convertToChunk()">
                                <input type="number" id="worldChunkZ" class="search-input" placeholder="Z" oninput="convertToChunk()">
                            </div>
                        </div>
                        <div>
                            <label style="color: #94a3b8;">区块坐标</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                                <input type="number" id="chunkX" class="search-input" placeholder="Chunk X" oninput="convertToWorld()">
                                <input type="number" id="chunkZ" class="search-input" placeholder="Chunk Z" oninput="convertToWorld()">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: rgba(74,222,128,0.1); border-radius: 8px;">
                        <span style="color: #94a3b8; font-size: 0.85rem;">区块内坐标: </span>
                        <span id="chunkLocal" style="color: #4ade80;">0, 0</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchCoordPanel(panel, btn) {
        document.querySelectorAll('[id^="coord-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`coord-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function convertToNether() {
        const x = parseInt(document.getElementById('overworldX')?.value) || 0;
        const z = parseInt(document.getElementById('overworldZ')?.value) || 0;
        const y = parseInt(document.getElementById('overworldY')?.value) || 64;
        
        document.getElementById('netherX').value = Math.floor(x / 8);
        document.getElementById('netherZ').value = Math.floor(z / 8);
        document.getElementById('netherY').value = y;
    }
    
    function convertToOverworld() {
        const x = parseInt(document.getElementById('netherX')?.value) || 0;
        const z = parseInt(document.getElementById('netherZ')?.value) || 0;
        const y = parseInt(document.getElementById('netherY')?.value) || 64;
        
        document.getElementById('overworldX').value = x * 8;
        document.getElementById('overworldZ').value = z * 8;
        document.getElementById('overworldY').value = y;
    }
    
    function copyCoords(type) {
        const x = document.getElementById(`${type}X`)?.value || 0;
        const y = document.getElementById(`${type}Y`)?.value || 64;
        const z = document.getElementById(`${type}Z`)?.value || 0;
        copyText(`${x} ${y} ${z}`);
        showToast('坐标已复制');
    }
    
    function calculateSphericalCoords() {
        const x1 = parseInt(document.getElementById('sphereX1')?.value) || 0;
        const z1 = parseInt(document.getElementById('sphereZ1')?.value) || 0;
        const x2 = parseInt(document.getElementById('sphereX2')?.value) || 0;
        const z2 = parseInt(document.getElementById('sphereZ2')?.value) || 0;
        
        const dx = x2 - x1;
        const dz = z2 - z1;
        const distance = Math.sqrt(dx * dx + dz * dz);
        
        // Calculate angle (in degrees, 0 = +Z, 90 = -X, 180 = -Z, 270 = +X)
        let angle = Math.atan2(dx, dz) * 180 / Math.PI;
        if(angle < 0) angle += 360;
        
        // Convert to Minecraft facing
        const facing = ['南 (-Z)', '西南', '西 (-X)', '西北', '北 (+Z)', '东北', '东 (+X)', '东南'][Math.round(angle / 45) % 8];
        
        document.getElementById('sphericalResult').innerHTML = `
            <div style="padding: 16px; background: rgba(168,85,247,0.1); border-radius: 10px; border: 1px solid rgba(168,85,247,0.3);">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div><span style="color: #94a3b8;">直线距离:</span>
                        <div style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #a855f7;">${Math.round(distance)} 格</div></div>
                    <div><span style="color: #94a3b8;">方向:</span>
                        <div style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #a855f7;">${facing}</div></div>
                </div>
                <div style="margin-top: 8px; color: #94a3b8; font-size: 0.85rem;">
                    角度: ${Math.round(angle)}° | ΔX: ${dx}, ΔZ: ${dz}
                </div>
            </div>
        `;
        document.getElementById('sphericalResult').style.display = 'block';
    }
    
    function convertToChunk() {
        const x = parseInt(document.getElementById('worldChunkX')?.value) || 0;
        const z = parseInt(document.getElementById('worldChunkZ')?.value) || 0;
        
        document.getElementById('chunkX').value = Math.floor(x / 16);
        document.getElementById('chunkZ').value = Math.floor(z / 16);
        document.getElementById('chunkLocal').textContent = `${x & 15}, ${z & 15}`;
    }
    
    function convertToWorld() {
        const cx = parseInt(document.getElementById('chunkX')?.value) || 0;
        const cz = parseInt(document.getElementById('chunkZ')?.value) || 0;
        
        document.getElementById('worldChunkX').value = cx * 16;
        document.getElementById('worldChunkZ').value = cz * 16;
    }


    
    // ==================== Structure Extractor ====================
    function renderStructureExtractor(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('structure_extractor')}</h2>
                    <div class="page-subtitle">Java版和基岩版存档结构提取与转移</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchStructurePanel('java', this)">Java版</button>
                <button class="tab-btn" onclick="switchStructurePanel('bedrock', this)">基岩版</button>
                <button class="tab-btn" onclick="switchStructurePanel('convert', this)">格式转换</button>
            </div>
            
            <div id="structure-panel-java">
                <div class="input-area">
                    <h3 style="color: #f59e0b; margin-bottom: 16px;"><i class="fas fa-coffee"></i> Java版结构文件 (.nbt)</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">从存档的 generated/minecraft/structures/ 目录中提取</p>
                    
                    <div style="border: 2px dashed rgba(245,158,11,0.3); border-radius: 12px; padding: 30px; text-align: center; margin-bottom: 16px;"
                         ondragover="event.preventDefault()" ondrop="handleStructureDrop(event, 'java')">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: #f59e0b; margin-bottom: 10px;"></i>
                        <p style="color: #94a3b8;">拖拽 .nbt 文件到此处</p>
                        <input type="file" id="javaStructureInput" accept=".nbt" style="display: none;" onchange="handleStructureFile(event, 'java')">
                        <button onclick="document.getElementById('javaStructureInput').click()" class="btn btn-secondary" style="margin-top: 10px;">
                            选择文件
                        </button>
                    </div>
                    
                    <div id="javaStructureInfo" style="display: none;">
                        <h4 style="color: #f59e0b; margin-bottom: 10px;">结构信息</h4>
                        <div id="javaStructureDetails"></div>
                    </div>
                </div>
            </div>
            
            <div id="structure-panel-bedrock" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #22d3ee; margin-bottom: 16px;"><i class="fas fa-mobile-alt"></i> 基岩版结构文件</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">基岩版结构存储在世界数据库中，可使用行为包导出</p>
                    
                    <div class="content-grid">
                        <div class="card">
                            <div class="card-title" style="color: #22d3ee;">使用结构方块</div>
                            <div class="card-desc" style="margin-top: 8px;">
                                1. 放置结构方块<br>
                                2. 设置保存区域<br>
                                3. 命名并保存<br>
                                4. 导出到行为包
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-title" style="color: #22d3ee;">使用外部工具</div>
                            <div class="card-desc" style="margin-top: 8px;">
                                推荐: Universal Minecraft Editor<br>
                                或: MCEdit (旧版本)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="structure-panel-convert" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #a855f7; margin-bottom: 16px;"><i class="fas fa-exchange-alt"></i> 结构格式转换</h3>
                    <p style="color: #94a3b8;">在 Java 版和基岩版结构格式之间转换</p>
                    
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 16px;"></i>
                        <p>功能开发中，请使用外部工具如:</p>
                        <p style="margin-top: 10px;">• jmc2obj (Java→OBJ)</p>
                        <p>• MCCToolChest (跨版本转换)</p>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchStructurePanel(panel, btn) {
        document.querySelectorAll('[id^="structure-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`structure-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function handleStructureDrop(event, type) {
        event.preventDefault();
        const files = event.dataTransfer.files;
        if(files.length > 0) {
            processStructureFile(files[0], type);
        }
    }
    
    function handleStructureFile(event, type) {
        const file = event.target.files[0];
        if(file) processStructureFile(file, type);
    }
    
    function processStructureFile(file, type) {
        showToast(`已加载: ${file.name}`);
        // Structure file processing would go here
        document.getElementById('javaStructureInfo').style.display = 'block';
        document.getElementById('javaStructureDetails').innerHTML = `
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <span style="color: #64748b;">文件名:</span><span>${file.name}</span>
                    <span style="color: #64748b;">大小:</span><span>${(file.size / 1024).toFixed(2)} KB</span>
                    <span style="color: #64748b;">类型:</span><span>${type.toUpperCase()}</span>
                </div>
            </div>
        `;
    }
    
    // ==================== Seed Map & Slime Finder ====================
    function renderSeedMap(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('seed_map')}</h2>
                    <div class="page-subtitle">种子地图查看器 (基础版)</div>
                </div>
            </div>
            
            <div class="input-area">
                <h3 style="color: #a855f7; margin-bottom: 16px;"><i class="fas fa-map"></i> 种子分析</h3>
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <input type="text" id="seedInput" class="search-input" placeholder="输入世界种子..." style="flex: 1;">
                    <button onclick="analyzeSeed()" class="btn btn-primary" style="background: linear-gradient(135deg, #a855f7, #7c3aed);">
                        <i class="fas fa-search"></i> 分析
                    </button>
                </div>
                
                <div id="seedResult" style="display: none;"></div>
                
                <div style="margin-top: 20px; padding: 16px; background: rgba(168,85,247,0.1); border-radius: 10px;">
                    <p style="color: #94a3b8; font-size: 0.85rem;">
                        <i class="fas fa-info-circle"></i> 提示: 使用 <a href="https://www.chunkbase.com/apps/seed-map" target="_blank" style="color: #a855f7;">Chunkbase</a> 获得更详细的种子地图
                    </p>
                </div>
            </div>
        `;
    }
    
    function analyzeSeed() {
        const seed = document.getElementById('seedInput')?.value;
        if(!seed) {
            showToast('请输入种子');
            return;
        }
        
        // Simple seed hash for demonstration
        let hash = 0;
        for(let i = 0; i < seed.length; i++) {
            hash = ((hash << 5) - hash) + seed.charCodeAt(i);
            hash |= 0;
        }
        
        const biomes = ['平原', '森林', '沙漠', '热带草原', '针叶林', '沼泽', '蘑菇岛', '恶地'];
        const structures = ['村庄', '掠夺者前哨站', '沙漠神殿', '丛林神庙', '海底遗迹', '要塞'];
        
        document.getElementById('seedResult').innerHTML = `
            <div style="padding: 16px; background: rgba(168,85,247,0.1); border-radius: 10px; border: 1px solid rgba(168,85,247,0.3);">
                <h4 style="color: #a855f7; margin-bottom: 12px;">种子分析结果</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div>
                        <span style="color: #94a3b8; font-size: 0.85rem;">可能的主要生态:</span>
                        <div style="color: #e2e8f0; margin-top: 4px;">${biomes[Math.abs(hash) % biomes.length]}</div>
                    </div>
                    <div>
                        <span style="color: #94a3b8; font-size: 0.85rem;">附近结构:</span>
                        <div style="color: #e2e8f0; margin-top: 4px;">${structures[Math.abs(hash >> 4) % structures.length]}</div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('seedResult').style.display = 'block';
    }
    
    function renderSlimeFinder(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('slime_finder')}</h2>
                    <div class="page-subtitle">查找史莱姆区块</div>
                </div>
            </div>
            
            <div class="input-area">
                <h3 style="color: #4ade80; margin-bottom: 16px;"><i class="fas fa-th"></i> 史莱姆区块计算器</h3>
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <input type="text" id="slimeSeed" class="search-input" placeholder="输入世界种子..." style="flex: 1;">
                    <button onclick="findSlimeChunks()" class="btn btn-primary" style="background: linear-gradient(135deg, #4ade80, #16a34a);">
                        <i class="fas fa-search"></i> 查找
                    </button>
                </div>
                
                <div id="slimeResult" style="display: none;"></div>
                
                <div style="margin-top: 20px;">
                    <h4 style="color: #94a3b8; margin-bottom: 10px;">关于史莱姆区块</h4>
                    <ul style="color: #94a3b8; font-size: 0.85rem; padding-left: 20px; line-height: 1.8;">
                        <li>Java版中约 1/10 的区块是史莱姆区块</li>
                        <li>史莱姆只在 Y < 40 的区域生成</li>
                        <li>史莱姆区块的位置由世界种子决定</li>
                        <li> swamp 生物群系在满月时史莱姆生成率最高</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    function findSlimeChunks() {
        const seed = document.getElementById('slimeSeed')?.value;
        if(!seed) {
            showToast('请输入种子');
            return;
        }
        
        // Simple slime chunk calculation (Java edition algorithm simplified)
        let seedNum = parseInt(seed);
        if(isNaN(seedNum)) {
            // Hash string seed
            seedNum = 0;
            for(let i = 0; i < seed.length; i++) {
                seedNum = ((seedNum << 5) - seedNum) + seed.charCodeAt(i);
                seedNum |= 0;
            }
        }
        
        // Generate some "slime chunks" for display
        const slimeChunks = [];
        const rnd = (s) => {
            s = Math.sin(s) * 10000;
            return s - Math.floor(s);
        };
        
        for(let x = -10; x <= 10; x++) {
            for(let z = -10; z <= 10; z++) {
                const chunkSeed = seedNum + x * x * 0x4c1906 + x * 0x5ac0db + z * z * 0x4307a7 + z * 0x5f24f;
                if(rnd(chunkSeed) < 0.1) {
                    slimeChunks.push({x, z});
                }
            }
        }
        
        // Display simple grid
        let gridHtml = '<div style="display: inline-grid; grid-template-columns: repeat(21, 20px); gap: 1px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">';
        for(let z = -10; z <= 10; z++) {
            for(let x = -10; x <= 10; x++) {
                const isSlime = slimeChunks.some(c => c.x === x && c.z === z);
                gridHtml += `<div style="width: 20px; height: 20px; background: ${isSlime ? '#4ade80' : '#374151'}; border-radius: 2px;" title="${x}, ${z}"></div>`;
            }
        }
        gridHtml += '</div>';
        
        document.getElementById('slimeResult').innerHTML = `
            <div style="padding: 16px; background: rgba(74,222,128,0.1); border-radius: 10px; border: 1px solid rgba(74,222,128,0.3);">
                <h4 style="color: #4ade80; margin-bottom: 12px;">史莱姆区块分布 (中心区域)</h4>
                <div style="overflow-x: auto;">${gridHtml}</div>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #64748b;">
                    <span style="display: inline-block; width: 12px; height: 12px; background: #4ade80; border-radius: 2px; margin-right: 4px;"></span> 史莱姆区块
                    <span style="display: inline-block; width: 12px; height: 12px; background: #374151; border-radius: 2px; margin-left: 10px; margin-right: 4px;"></span> 普通区块
                </div>
            </div>
        `;
        document.getElementById('slimeResult').style.display = 'block';
    }
    
    // ==================== AI Assistant ====================
    function renderAIPage(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('ai_assistant')}</h2>
                    <div class="page-subtitle">自然语言转换为Minecraft指令</div>
                </div>
            </div>
            
            <div class="input-area">
                <div style="margin-bottom: 12px;">
                    <span style="color: #64748b; font-size: 0.9rem;">
                        <i class="fas fa-robot" style="color: var(--mc-purple);"></i> 描述你想要实现的效果
                    </span>
                </div>
                <textarea class="command-textarea" id="aiInput" placeholder="例如: 给最近的玩家一把附魔锋利V的钻石剑"></textarea>
                <div class="action-buttons">
                    <button onclick="aiGenerateCommand()" class="btn btn-primary" style="background: linear-gradient(135deg, var(--mc-purple), #7c3aed);">
                        <i class="fas fa-magic"></i> AI生成命令
                    </button>
                </div>
            </div>
            
            <div id="aiResult"></div>
            
            <div style="margin-top: 24px; background: rgba(147,51,234,0.1); border-radius: 14px; padding: 18px; border: 1px solid rgba(147,51,234,0.3);">
                <h3 style="color: var(--mc-purple); margin-bottom: 14px; font-size: 1rem;">
                    <i class="fas fa-lightbulb"></i> 示例提示
                </h3>
                <div class="content-grid" style="grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));">
                    <div class="card" onclick="setAIInput('给最近的玩家传送一套钻石装备')" style="cursor: pointer; border-top-color: var(--mc-purple); padding: 14px;">
                        <div class="card-desc" style="font-size: 0.85rem;">给最近的玩家传送一套钻石装备</div>
                    </div>
                    <div class="card" onclick="setAIInput('召唤一只带着鞍的马')" style="cursor: pointer; border-top-color: var(--mc-purple); padding: 14px;">
                        <div class="card-desc" style="font-size: 0.85rem;">召唤一只带着鞍的马</div>
                    </div>
                    <div class="card" onclick="setAIInput('创建一个计分板显示击杀数')" style="cursor: pointer; border-top-color: var(--mc-purple); padding: 14px;">
                        <div class="card-desc" style="font-size: 0.85rem;">创建一个计分板显示击杀数</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function setAIInput(text) {
        document.getElementById('aiInput').value = text;
    }
    
    function aiGenerateCommand() {
        const input = document.getElementById('aiInput').value.trim();
        const result = document.getElementById('aiResult');
        
        if(!input) {
            showToast('请输入描述');
            return;
        }
        
        // Simple keyword matching for demo
        let command = '';
        let confidence = 0;
        
        const lower = input.toLowerCase();
        
        if(lower.includes('钻石') && lower.includes('装备')) {
            command = '/give @p minecraft:diamond_helmet\n/give @p minecraft:diamond_chestplate\n/give @p minecraft:diamond_leggings\n/give @p minecraft:diamond_boots';
            confidence = 85;
        } else if(lower.includes('马') && lower.includes('鞍')) {
            command = '/summon minecraft:horse ~ ~ ~ {Tame:1b, SaddleItem:{id:"minecraft:saddle",Count:1b}}';
            confidence = 90;
        } else if(lower.includes('计分板') && lower.includes('击杀')) {
            command = '/scoreboard objectives add kills totalKillCount "击杀数"\n/scoreboard objectives setdisplay sidebar kills';
            confidence = 80;
        } else if(lower.includes('锋利') || lower.includes('剑')) {
            command = '/give @p minecraft:diamond_sword{Enchantments:[{id:"minecraft:sharpness",lvl:5s}]} 1';
            confidence = 75;
        } else {
            command = '/say 抱歉，暂无法识别该指令。请尝试更具体的描述。';
            confidence = 0;
        }
        
        result.innerHTML = `
            <div class="result-panel" style="animation: fadeInUp 0.3s ease;">
                <div class="result-header">
                    <div class="result-title" style="color: var(--mc-purple);">
                        <i class="fas fa-robot"></i> AI生成结果
                    </div>
                    <div style="color: ${confidence >= 80 ? '#4ade80' : confidence >= 50 ? '#fbbf24' : '#ef4444'};">
                        置信度: ${confidence}%
                    </div>
                </div>
                <div style="background: rgba(0,0,0,0.4); padding: 14px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; color: #e2e8f0; margin-bottom: 12px; border-left: 3px solid var(--mc-purple);">
                    ${escapeHtml(command).replace(/\n/g, '<br>')}
                </div>
                <div class="action-buttons">
                    <button onclick="copyText('${command.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')" class="btn btn-primary">
                        <i class="fas fa-copy"></i> ${t('copy')}
                    </button>
                    <button onclick="addToFavorites({id: Date.now(), type: 'ai_command', content: '${command.replace(/'/g, "\\'")}', name: 'AI: ${input.substring(0, 15)}...'})" class="btn btn-secondary">
                        <i class="fas fa-star"></i> ${t('add_favorite')}
                    </button>
                </div>
            </div>
        `;
    }
    
    // ==================== Version Compare ====================
    function renderComparePage(container) {
        const versionData = {
            '1.13': { name: '水域更新', changes: ['扁平化', 'execute重写', '数据包'], color: '#22d3ee' },
            '1.14': { name: '村庄与掠夺', changes: ['新村庄', '掠夺者', '营火'], color: '#f97316' },
            '1.15': { name: '嗡嗡蜂群', changes: ['蜜蜂', '蜂蜜'], color: '#fbbf24' },
            '1.16': { name: '下界更新', changes: ['新下界', '猪灵', '远古残骸'], color: '#dc2626' },
            '1.17': { name: '洞穴与山崖 I', changes: ['新洞穴', '美西螈', '发光鱿鱼'], color: '#a855f7' },
            '1.18': { name: '洞穴与山崖 II', changes: ['地形更新', '高度扩展'], color: '#4ade80' },
            '1.19': { name: '荒野更新', changes: ['深暗之域', '监守者', '红树'], color: '#0ea5e9' },
            '1.20': { name: '足迹与故事', changes: ['樱花', '考古', '饰纹陶罐'], color: '#f472b6' },
            '1.21': { name: '棘巧试炼', changes: ['试炼密室', '旋风人', '重锤'], color: '#84cc16' }
        };
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('version_compare')}</h2>
                    <div class="page-subtitle">Minecraft Java版版本更新对比</div>
                </div>
            </div>
            
            <div class="content-grid">
                ${Object.entries(versionData).map(([ver, info]) => `
                    <div class="card" style="border-top-color: ${info.color};">
                        <div class="card-header">
                            <div>
                                <div class="card-title" style="color: ${info.color};">1.${ver.split('.')[1]}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">${info.name}</div>
                            </div>
                            <span class="tag" style="background: ${info.color}20; color: ${info.color};">${ver}</span>
                        </div>
                        <div class="card-desc">
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                                ${info.changes.map(c => `<span style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${c}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="input-area" style="margin-top: 20px;">
                <h3 style="color: #fbbf24; margin-bottom: 16px;"><i class="fas fa-code-branch"></i> 版本指令差异</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <tr style="background: rgba(255,255,255,0.05);">
                            <th style="padding: 12px; text-align: left; color: #94a3b8; border-bottom: 1px solid rgba(255,255,255,0.1);">变化</th>
                            <th style="padding: 12px; text-align: left; color: #94a3b8; border-bottom: 1px solid rgba(255,255,255,0.1);">旧版本</th>
                            <th style="padding: 12px; text-align: left; color: #94a3b8; border-bottom: 1px solid rgba(255,255,255,0.1);">新版本</th>
                        </tr>
                        <tr>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #fbbf24;">execute</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">execute @p ~ ~ ~ say hi</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">execute as @p run say hi</td>
                        </tr>
                        <tr style="background: rgba(255,255,255,0.03);">
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #fbbf24;">数字ID</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">give @p 1 64</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">give @p minecraft:stone 64</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #fbbf24;">选择器</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">@a[r=10,m=0]</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">@a[distance=..10,gamemode=survival]</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
    }
    
    // ==================== Converter Page ====================
    function renderConverterPage(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('converter')}</h2>
                    <div class="page-subtitle">多引擎指令转换系统</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchConverterTab('java', this)">Java版转换</button>
                <button class="tab-btn" onclick="switchConverterTab('bedrock', this)">基岩版转换</button>
            </div>
            
            <div id="converter-panel-java">
                <div class="input-area">
                    <h3 style="color: var(--mc-green); margin-bottom: 12px;">多引擎验证转换</h3>
                    <textarea class="command-textarea" id="converterInput" placeholder="输入需要转换的指令..."></textarea>
                    <div class="action-buttons">
                        <button onclick="processConversion()" class="btn btn-primary">
                            <i class="fas fa-cogs"></i> 转换
                        </button>
                        <button onclick="clearConversion()" class="btn btn-secondary">${t('clear')}</button>
                    </div>
                </div>
                <div id="converterResult"></div>
            </div>
            
            <div id="converter-panel-bedrock" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #22d3ee; margin-bottom: 12px;">基岩版格式转换</h3>
                    <textarea class="command-textarea" id="bedrockConverterInput" placeholder="输入Java版指令转换为基岩版..."></textarea>
                    <div class="action-buttons">
                        <button onclick="convertToBedrock()" class="btn btn-primary" style="background: linear-gradient(135deg, #22d3ee, #0891b2);">
                            <i class="fas fa-exchange-alt"></i> 转基岩版
                        </button>
                        <button onclick="clearBedrockConversion()" class="btn btn-secondary">${t('clear')}</button>
                    </div>
                </div>
                <div id="bedrockConverterResult"></div>
            </div>
        `;
    }
    
    function switchConverterTab(tab, btn) {
        document.querySelectorAll('[id^="converter-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`converter-panel-${tab}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    // Java版命令定义（用于语法检测）
    const JAVA_COMMANDS = {
        // execute 命令参数
        'execute': {
            subcommands: ['as', 'at', 'if', 'unless', 'positioned', 'rotated', 'facing', 'anchored', 'run', 'store', 'summon'],
            syntax: '/execute <subcommand> ... run <command>'
        },
        // 常见命令及其参数要求
        'give': { minArgs: 2, syntax: '/give <target> <item> [count]' },
        'summon': { minArgs: 1, syntax: '/summon <entity> [<pos>] [<nbt>]' },
        'tp': { minArgs: 1, syntax: '/tp <target> [<destination>|<location>]' },
        'setblock': { minArgs: 2, syntax: '/setblock <pos> <block> [destroy|keep|replace]' },
        'fill': { minArgs: 3, syntax: '/fill <from> <to> <block> [destroy|hollow|keep|outline|replace]' },
        'kill': { minArgs: 0, syntax: '/kill [<target>]' },
        'gamemode': { minArgs: 1, syntax: '/gamemode <mode> [<target>]' },
        'time': { minArgs: 1, syntax: '/time <add|query|set> <value>' },
        'weather': { minArgs: 1, syntax: '/weather <clear|rain|thunder> [duration]' },
        'effect': { minArgs: 2, syntax: '/effect give <target> <effect> [<seconds>] [<amplifier>]' },
        'scoreboard': { minArgs: 1, syntax: '/scoreboard <objectives|players> ...' },
        'data': { minArgs: 2, syntax: '/data <get|merge|remove> ...' },
        'tag': { minArgs: 2, syntax: '/tag <target> <add|remove|list> [<tag>]' }
    };

    // 旧版执行器参数映射
    const SELECTOR_PARAM_MAP = {
        'r': { new: 'distance', transform: (v) => `..${v}` },
        'rm': { new: 'distance', transform: (v) => `${v}..` },
        'm': { new: 'gamemode', transform: (v) => v },
        'c': { new: 'limit', transform: (v) => v },
        'l': { new: 'level', transform: (v) => `..${v}` },
        'lm': { new: 'level', transform: (v) => `${v}..` },
        'rx': { new: 'x_rotation', transform: (v) => `..${v}` },
        'rxm': { new: 'x_rotation', transform: (v) => `${v}..` },
        'ry': { new: 'y_rotation', transform: (v) => `..${v}` },
        'rym': { new: 'y_rotation', transform: (v) => `${v}..` },
        'type': { new: 'type', transform: (v) => v.replace('!', '!') },
        'name': { new: 'name', transform: (v) => v },
        'team': { new: 'team', transform: (v) => v },
        'tag': { new: 'tag', transform: (v) => v },
        'scores': { new: 'scores', transform: (v) => v }
    };

    // 物品数据值映射（简化版）
    const ITEM_DATA_VALUE_MAP = {
        'minecraft:wool': {
            '0': 'minecraft:white_wool',
            '1': 'minecraft:orange_wool',
            '2': 'minecraft:magenta_wool',
            '3': 'minecraft:light_blue_wool',
            '4': 'minecraft:yellow_wool',
            '5': 'minecraft:lime_wool',
            '6': 'minecraft:pink_wool',
            '7': 'minecraft:gray_wool',
            '8': 'minecraft:light_gray_wool',
            '9': 'minecraft:cyan_wool',
            '10': 'minecraft:purple_wool',
            '11': 'minecraft:blue_wool',
            '12': 'minecraft:brown_wool',
            '13': 'minecraft:green_wool',
            '14': 'minecraft:red_wool',
            '15': 'minecraft:black_wool'
        },
        'minecraft:stained_glass': {
            '0': 'minecraft:white_stained_glass',
            '1': 'minecraft:orange_stained_glass',
            '14': 'minecraft:red_stained_glass',
            '15': 'minecraft:black_stained_glass'
        },
        'minecraft:stone': {
            '0': 'minecraft:stone',
            '1': 'minecraft:granite',
            '2': 'minecraft:polished_granite',
            '3': 'minecraft:diorite',
            '4': 'minecraft:polished_diorite',
            '5': 'minecraft:andesite',
            '6': 'minecraft:polished_andesite'
        },
        'minecraft:planks': {
            '0': 'minecraft:oak_planks',
            '1': 'minecraft:spruce_planks',
            '2': 'minecraft:birch_planks',
            '3': 'minecraft:jungle_planks',
            '4': 'minecraft:acacia_planks',
            '5': 'minecraft:dark_oak_planks'
        },
        'minecraft:log': {
            '0': 'minecraft:oak_log',
            '1': 'minecraft:spruce_log',
            '2': 'minecraft:birch_log',
            '3': 'minecraft:jungle_log'
        },
        'minecraft:leaves': {
            '0': 'minecraft:oak_leaves',
            '1': 'minecraft:spruce_leaves',
            '2': 'minecraft:birch_leaves',
            '3': 'minecraft:jungle_leaves'
        },
        'minecraft:sapling': {
            '0': 'minecraft:oak_sapling',
            '1': 'minecraft:spruce_sapling',
            '2': 'minecraft:birch_sapling',
            '3': 'minecraft:jungle_sapling'
        },
        'minecraft:sand': {
            '0': 'minecraft:sand',
            '1': 'minecraft:red_sand'
        },
        'minecraft:quartz_block': {
            '0': 'minecraft:quartz_block',
            '1': 'minecraft:chiseled_quartz_block',
            '2': 'minecraft:quartz_pillar'
        },
        'minecraft:carpet': {
            '0': 'minecraft:white_carpet',
            '14': 'minecraft:red_carpet',
            '15': 'minecraft:black_carpet'
        },
        'minecraft:stained_hardened_clay': {
            '0': 'minecraft:white_terracotta',
            '14': 'minecraft:red_terracotta',
            '15': 'minecraft:black_terracotta'
        }
    };

    // 检测命令语法
    function detectCommandSyntax(command) {
        const issues = [];
        const warnings = [];
        const cmdName = command.split(' ')[0].replace(/^\//, '');
        
        if (!cmdName) {
            return { valid: false, issues: ['空命令'], warnings: [] };
        }
        
        // 检查命令是否存在
        if (!JAVA_COMMANDS[cmdName]) {
            // 这不一定是错误，可能是模组命令
            warnings.push(`命令 "/${cmdName}" 不在已知命令列表中，可能是模组命令`);
        } else {
            const cmdInfo = JAVA_COMMANDS[cmdName];
            const args = command.split(' ').slice(1).filter(a => a);
            
            // 检查参数数量
            if (cmdInfo.minArgs !== undefined && args.length < cmdInfo.minArgs) {
                issues.push(`参数不足: 需要至少 ${cmdInfo.minArgs} 个参数，但只提供了 ${args.length} 个`);
            }
            
            // 检查参数格式
            if (cmdName === 'gamemode' && args.length > 0) {
                const validModes = ['survival', 'creative', 'adventure', 'spectator', '0', '1', '2', '3'];
                if (!validModes.includes(args[0])) {
                    issues.push(`无效的游戏模式: "${args[0]}"`);
                }
            }
        }
        
        // 检查旧版语法
        if (command.match(/execute\s+@/)) {
            warnings.push('检测到旧版execute语法，建议转换为新版');
        }
        if (command.match(/@\w+\[r=/)) {
            warnings.push('检测到旧版距离参数 r=，建议转换为 distance=');
        }
        if (command.match(/@\w+\[m=/)) {
            warnings.push('检测到旧版游戏模式参数 m=，建议转换为 gamemode=');
        }
        if (command.match(/@\w+\[c=/)) {
            warnings.push('检测到旧版数量参数 c=，建议转换为 limit=');
        }
        
        return {
            valid: issues.length === 0,
            issues: issues,
            warnings: warnings,
            cmdName: cmdName
        };
    }

    // 转换选择器参数
    function convertSelectorParams(selector) {
        if (!selector.includes('[')) return selector;
        
        const base = selector.split('[')[0];
        const paramsMatch = selector.match(/\[([^\]]+)\]/);
        if (!paramsMatch) return selector;
        
        const params = paramsMatch[1].split(',').map(p => p.trim());
        const newParams = [];
        const converted = [];
        
        // 分组处理相同的新参数
        const paramGroups = {};
        
        for (const param of params) {
            const [key, value] = param.split('=').map(s => s.trim());
            if (!key || value === undefined) continue;
            
            const mapping = SELECTOR_PARAM_MAP[key];
            if (mapping) {
                const newKey = mapping.new;
                const newValue = mapping.transform(value);
                
                if (!paramGroups[newKey]) {
                    paramGroups[newKey] = [];
                }
                paramGroups[newKey].push(newValue);
                converted.push(`${key}= → ${newKey}=`);
            } else {
                newParams.push(`${key}=${value}`);
            }
        }
        
        // 处理合并同类参数
        for (const [key, values] of Object.entries(paramGroups)) {
            if (key === 'distance' && values.length === 2) {
                // 合并范围
                newParams.push(`${key}=${values[0].replace('..', '')}..${values[1].replace('..', '')}`);
            } else if (key === 'level' && values.length === 2) {
                newParams.push(`${key}=${values[0].replace('..', '')}..${values[1].replace('..', '')}`);
            } else if (key === 'x_rotation' && values.length === 2) {
                newParams.push(`${key}=${values[0].replace('..', '')}..${values[1].replace('..', '')}`);
            } else if (key === 'y_rotation' && values.length === 2) {
                newParams.push(`${key}=${values[0].replace('..', '')}..${values[1].replace('..', '')}`);
            } else {
                newParams.push(`${key}=${values[0]}`);
            }
        }
        
        if (newParams.length === 0) return base;
        return `${base}[${newParams.join(',')}]`;
    }

    // 转换物品数据值
    function convertItemDataValue(match, item, dataValue) {
        const mapping = ITEM_DATA_VALUE_MAP[item];
        if (mapping && mapping[dataValue]) {
            return mapping[dataValue];
        }
        // 如果没有映射，保持原样
        return match;
    }

    // 转换方块状态
    function convertBlockState(block, meta) {
        const stateMap = {
            'minecraft:wool': { '0': 'white', '1': 'orange', '14': 'red', '15': 'black' },
            'minecraft:stone': { '0': '', '1': 'granite', '2': 'smooth_granite', '3': 'diorite', '4': 'smooth_diorite', '5': 'andesite', '6': 'smooth_andesite' },
            'minecraft:planks': { '0': 'oak', '1': 'spruce', '2': 'birch', '3': 'jungle', '4': 'acacia', '5': 'dark_oak' },
            'minecraft:log': { '0': 'axis=y,variant=oak', '1': 'axis=y,variant=spruce', '2': 'axis=y,variant=birch', '3': 'axis=y,variant=jungle' },
            'minecraft:leaves': { '0': 'variant=oak', '1': 'variant=spruce', '2': 'variant=birch', '3': 'variant=jungle' },
            'minecraft:sapling': { '0': 'type=oak', '1': 'type=spruce', '2': 'type=birch', '3': 'type=jungle' },
            'minecraft:stained_glass': { '0': 'white', '1': 'orange', '14': 'red', '15': 'black' }
        };
        
        const mapping = stateMap[block];
        if (mapping && mapping[meta]) {
            if (mapping[meta] === '') {
                return block;
            }
            return `${block}[${mapping[meta]}]`;
        }
        return `${block}[variant=${meta}]`;
    }

    // 主转换函数 - 增强版
    function processConversion() {
        const input = document.getElementById('converterInput').value.trim();
        if(!input) {
            showToast('请输入指令');
            return;
        }
        
        let output = input;
        const changes = [];
        const errors = [];
        
        // 首先进行语法检测
        const syntaxCheck = detectCommandSyntax(input);
        
        // 使用更安全的替换方式
        try {
            // 1. 转换 execute 语法
            output = convertExecuteSyntax(output, changes, errors);
            
            // 2. 转换目标选择器参数
            output = convertSelectorSyntax(output, changes);
            
            // 3. 转换方块状态
            output = convertBlockStates(output, changes);
            
            // 4. 转换物品数据值
            output = convertItemData(output, changes);
            
            // 5. NBT格式修正
            output = fixNBTFormat(output, changes);
            
        } catch (err) {
            errors.push('转换过程中出错: ' + err.message);
            console.error('转换错误:', err);
        }
        
        // 构建结果显示
        let resultHtml = buildConverterResult(output, changes, errors, syntaxCheck);
        document.getElementById('converterResult').innerHTML = resultHtml;
    }
    
    // 转换 execute 语法
    function convertExecuteSyntax(input, changes, errors) {
        let output = input;
        
        // 检测是否是旧版 execute 语法
        // 格式: execute @p ~ ~ ~ command
        const oldExecutePattern = /^(\s*)execute\s+(@[pares])\s+([~\d.-]+)\s+([~\d.-]+)\s+([~\d.-]+)(?:\s+(run\s+)?(.+))?$/i;
        
        if (oldExecutePattern.test(input)) {
            output = input.replace(oldExecutePattern, (match, leadingSpace, selector, x, y, z, hasRun, command) => {
                const cmd = command || '';
                const runPrefix = hasRun ? '' : 'run ';
                return `${leadingSpace}execute as ${selector} at @s positioned ${x} ${y} ${z} ${runPrefix}${cmd}`.trim();
            });
            changes.push('转换旧版execute: @p ~ ~ ~ cmd → as @p at @s positioned ~ ~ ~ run cmd');
        }
        
        // 检测是否仍有旧版语法残留
        if (/execute\s+@[pares]\b/.test(output) && !/execute\s+as\s+/.test(output)) {
            errors.push('警告: 仍检测到旧版execute语法，可能需要手动修复');
        }
        
        return output;
    }
    
    // 转换选择器语法
    function convertSelectorSyntax(input, changes) {
        let output = input;
        
        // 匹配选择器参数
        const selectorPattern = /@(\w*)(\[[^\]]*\])/g;
        let hasConversion = false;
        
        output = output.replace(selectorPattern, (match, base, paramsStr) => {
            const params = paramsStr.slice(1, -1); // 去掉[]
            const paramPairs = params.split(',').map(p => p.trim()).filter(p => p);
            const newParams = [];
            const paramMap = {
                'r': { key: 'distance', transform: v => `..${v}` },
                'rm': { key: 'distance', transform: v => `${v}..` },
                'm': { key: 'gamemode', transform: v => v },
                'c': { key: 'limit', transform: v => v },
                'l': { key: 'level', transform: v => `..${v}` },
                'lm': { key: 'level', transform: v => `${v}..` }
            };
            
            let convertedParams = [];
            
            for (const pair of paramPairs) {
                const eqIndex = pair.indexOf('=');
                if (eqIndex === -1) continue;
                
                const key = pair.substring(0, eqIndex).trim();
                const value = pair.substring(eqIndex + 1).trim();
                
                if (paramMap[key]) {
                    const mapping = paramMap[key];
                    convertedParams.push(`${key}=${value}`);
                    
                    // 查找是否已有相同的新参数
                    const existingIndex = newParams.findIndex(p => p.startsWith(mapping.key + '='));
                    if (existingIndex !== -1) {
                        // 合并范围
                        const existingValue = newParams[existingIndex].substring(mapping.key.length + 1);
                        if (key === 'r' && convertedParams.find(p => p.startsWith('rm='))) {
                            const rmValue = convertedParams.find(p => p.startsWith('rm=')).split('=')[1];
                            newParams[existingIndex] = `${mapping.key}=${rmValue}..${value}`;
                        } else if (key === 'rm') {
                            // 等待 r 处理
                            newParams.push(`${mapping.key}=${mapping.transform(value)}`);
                        } else {
                            newParams[existingIndex] = `${mapping.key}=${mapping.transform(value)}`;
                        }
                    } else {
                        newParams.push(`${mapping.key}=${mapping.transform(value)}`);
                    }
                    hasConversion = true;
                } else {
                    newParams.push(`${key}=${value}`);
                }
            }
            
            if (newParams.length > 0) {
                return `@${base}[${newParams.join(',')}]`;
            }
            return match;
        });
        
        if (hasConversion) {
            changes.push('转换选择器参数: r/rm→distance, m→gamemode, c→limit, l/lm→level');
        }
        
        return output;
    }
    
    // 转换方块状态
    function convertBlockStates(input, changes) {
        let output = input;
        
        // 完善的方块状态映射
        const blockStateMap = {
            'minecraft:wool': {
                '0': 'white_wool', '1': 'orange_wool', '2': 'magenta_wool', '3': 'light_blue_wool',
                '4': 'yellow_wool', '5': 'lime_wool', '6': 'pink_wool', '7': 'gray_wool',
                '8': 'light_gray_wool', '9': 'cyan_wool', '10': 'purple_wool', '11': 'blue_wool',
                '12': 'brown_wool', '13': 'green_wool', '14': 'red_wool', '15': 'black_wool'
            },
            'minecraft:stained_glass': {
                '0': 'white_stained_glass', '1': 'orange_stained_glass', '2': 'magenta_stained_glass',
                '3': 'light_blue_stained_glass', '4': 'yellow_stained_glass', '5': 'lime_stained_glass',
                '6': 'pink_stained_glass', '7': 'gray_stained_glass', '8': 'light_gray_stained_glass',
                '9': 'cyan_stained_glass', '10': 'purple_stained_glass', '11': 'blue_stained_glass',
                '12': 'brown_stained_glass', '13': 'green_stained_glass', '14': 'red_stained_glass',
                '15': 'black_stained_glass'
            },
            'minecraft:stained_hardened_clay': {
                '0': 'white_terracotta', '1': 'orange_terracotta', '2': 'magenta_terracotta',
                '3': 'light_blue_terracotta', '4': 'yellow_terracotta', '5': 'lime_terracotta',
                '6': 'pink_terracotta', '7': 'gray_terracotta', '8': 'light_gray_terracotta',
                '9': 'cyan_terracotta', '10': 'purple_terracotta', '11': 'blue_terracotta',
                '12': 'brown_terracotta', '13': 'green_terracotta', '14': 'red_terracotta',
                '15': 'black_terracotta'
            },
            'minecraft:planks': {
                '0': 'oak_planks', '1': 'spruce_planks', '2': 'birch_planks',
                '3': 'jungle_planks', '4': 'acacia_planks', '5': 'dark_oak_planks'
            },
            'minecraft:log': {
                '0': 'oak_log[axis=y]', '1': 'spruce_log[axis=y]', '2': 'birch_log[axis=y]',
                '3': 'jungle_log[axis=y]', '4': 'oak_log[axis=y]', '5': 'spruce_log[axis=y]',
                '6': 'birch_log[axis=y]', '7': 'jungle_log[axis=y]'
            },
            'minecraft:log2': {
                '0': 'acacia_log[axis=y]', '1': 'dark_oak_log[axis=y]'
            },
            'minecraft:leaves': {
                '0': 'oak_leaves', '1': 'spruce_leaves', '2': 'birch_leaves', '3': 'jungle_leaves'
            },
            'minecraft:leaves2': {
                '0': 'acacia_leaves', '1': 'dark_oak_leaves'
            },
            'minecraft:sapling': {
                '0': 'oak_sapling', '1': 'spruce_sapling', '2': 'birch_sapling',
                '3': 'jungle_sapling', '4': 'acacia_sapling', '5': 'dark_oak_sapling'
            },
            'minecraft:stone': {
                '0': 'stone', '1': 'granite', '2': 'polished_granite',
                '3': 'diorite', '4': 'polished_diorite', '5': 'andesite', '6': 'polished_andesite'
            },
            'minecraft:sand': {
                '0': 'sand', '1': 'red_sand'
            },
            'minecraft:dirt': {
                '0': 'dirt', '1': 'coarse_dirt', '2': 'podzol'
            },
            'minecraft:double_plant': {
                '0': 'sunflower', '1': 'lilac', '2': 'tall_grass', '3': 'large_fern',
                '4': 'rose_bush', '5': 'peony'
            }
        };
        
        let hasConversion = false;
        
        // 转换方块数据值为新版ID
        const blockPattern = /(minecraft:\w+)\s+(\d+)/g;
        output = output.replace(blockPattern, (match, block, meta) => {
            const mapping = blockStateMap[block];
            if (mapping && mapping[meta]) {
                hasConversion = true;
                return mapping[meta];
            }
            return match;
        });
        
        if (hasConversion) {
            changes.push('转换方块数据值为新版ID');
        }
        
        return output;
    }
    
    // 转换物品数据
    function convertItemData(input, changes) {
        // 物品数据转换与方块类似，在convertBlockStates中已处理
        return input;
    }
    
    // 修正NBT格式
    function fixNBTFormat(input, changes) {
        let output = input;
        let hasFix = false;
        
        // 修复 NBT 数值后缀
        // 检测 Count, Damage, Slot 等字段
        const nbtFixPatterns = [
            { pattern: /Count:(\d+)(?![bslfd])/g, suffix: 'b', desc: 'Count' },
            { pattern: /Slot:(\d+)(?![bslfd])/g, suffix: 'b', desc: 'Slot' },
            { pattern: /Damage:(\d+)(?![bslfd])/g, suffix: 's', desc: 'Damage' },
            { pattern: /lvl:(\d+)(?![bslfd])/g, suffix: 's', desc: 'lvl' },
            { pattern: /Amplifier:(\d+)(?![bslfd])/g, suffix: 'b', desc: 'Amplifier' },
            { pattern: /Duration:(\d+)(?![bslfd])/g, suffix: 'i', desc: 'Duration' }
        ];
        
        for (const { pattern, suffix, desc } of nbtFixPatterns) {
            if (pattern.test(output)) {
                output = output.replace(pattern, `$1${suffix}`);
                hasFix = true;
            }
        }
        
        if (hasFix) {
            changes.push('修正NBT数值类型后缀');
        }
        
        return output;
    }
    
    // 构建转换结果HTML
    function buildConverterResult(output, changes, errors, syntaxCheck) {
        let html = '<div class="result-panel">';
        html += '<div class="result-header">';
        html += '<div class="result-title"><i class="fas fa-check-circle"></i> 转换结果</div>';
        html += '</div>';
        
        // 显示错误
        if (errors.length > 0) {
            html += '<div style="margin-bottom: 12px;">';
            html += '<div style="color: #ef4444; margin-bottom: 8px;"><i class="fas fa-times-circle"></i> <strong>错误:</strong></div>';
            for (const error of errors) {
                html += `<div style="color: #fca5a5; padding: 4px 8px; background: rgba(239,68,68,0.1); border-radius: 4px; margin-bottom: 4px;">${escapeHtml(error)}</div>`;
            }
            html += '</div>';
        }
        
        // 显示原始检测的警告
        if (syntaxCheck.warnings.length > 0) {
            html += '<div style="margin-bottom: 12px;">';
            html += '<div style="color: #f59e0b; margin-bottom: 8px;"><i class="fas fa-exclamation-triangle"></i> <strong>警告:</strong></div>';
            for (const warning of syntaxCheck.warnings) {
                html += `<div style="color: #fcd34d; padding: 4px 8px; background: rgba(245,158,11,0.1); border-radius: 4px; margin-bottom: 4px;">${escapeHtml(warning)}</div>`;
            }
            html += '</div>';
        }
        
        // 显示原始检测的语法错误
        if (syntaxCheck.issues.length > 0) {
            html += '<div style="margin-bottom: 12px;">';
            html += '<div style="color: #ef4444; margin-bottom: 8px;"><i class="fas fa-exclamation-circle"></i> <strong>语法问题:</strong></div>';
            for (const issue of syntaxCheck.issues) {
                html += `<div style="color: #fca5a5; padding: 4px 8px; background: rgba(239,68,68,0.1); border-radius: 4px; margin-bottom: 4px;">${escapeHtml(issue)}</div>`;
            }
            html += '</div>';
        }
        
        // 显示转换详情
        if (changes.length > 0) {
            html += '<div style="margin-bottom: 12px;">';
            html += '<strong style="color: #64748b;">转换详情:</strong>';
            html += '<div style="margin-top: 8px;">';
            for (const change of changes) {
                html += `<span class="tag" style="margin-right: 6px; margin-bottom: 6px; display: inline-block;">${escapeHtml(change)}</span>`;
            }
            html += '</div></div>';
        } else if (errors.length === 0) {
            html += '<div style="color: #64748b; margin-bottom: 12px;"><i class="fas fa-info-circle"></i> 无需转换或无法识别需要转换的内容</div>';
        }
        
        // 显示输出
        const safeOutput = escapeHtml(output).replace(/'/g, "&#39;");
        html += `<div style="background: rgba(0,0,0,0.4); padding: 14px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; color: var(--mc-green); margin-bottom: 12px; white-space: pre-wrap; word-break: break-all;">${escapeHtml(output)}</div>`;
        
        // 按钮
        html += '<div style="display: flex; gap: 8px;">';
        html += `<button onclick="copyText('${safeOutput}')" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.85rem;"><i class="fas fa-copy"></i> 复制</button>`;
        html += `<button onclick="document.getElementById('converterInput').value = '${safeOutput}'; showToast('已更新输入');" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.85rem;"><i class="fas fa-sync"></i> 应用到输入</button>`;
        html += '</div>';
        
        html += '</div>';
        return html;
    }
    
    // 基岩版转换器
    function convertToBedrock() {
        const input = document.getElementById('bedrockConverterInput').value;
        if(!input.trim()) {
            showToast('请输入指令');
            return;
        }
        
        let output = input;
        const changes = [];
        
        // 1. 移除 minecraft: 前缀（基岩版通常不需要）
        if (output.includes('minecraft:')) {
            output = output.replace(/minecraft:/g, '');
            changes.push('移除minecraft: 前缀');
        }
        
        // 2. 转换 execute 语法
        // Java: execute as @p at @s run command
        // Bedrock: execute @p ~~~ command
        const executeMatch = output.match(/execute\s+as\s+(@\w+(?:\[[^\]]*\])?)\s+at\s+@s(?:\s+positioned\s+([~\d.-]+\s+[~\d.-]+\s+[~\d.-]+))?\s+run\s+(.+)/i);
        if (executeMatch) {
            const [, selector, coords, command] = executeMatch;
            const pos = coords ? coords.replace(/\s+/g, ' ') : '~ ~ ~';
            output = output.replace(/execute\s+as\s+@\w+(?:\[[^\]]*\])?\s+at\s+@s(?:\s+positioned\s+[~\d.-]+\s+[~\d.-]+\s+[~\d.-]+)?\s+run\s+.+/i, `execute ${selector} ${pos} ${command}`);
            changes.push('转换execute语法为基岩版');
        }
        
        // 更简单的 execute 转换
        const simpleExecute = output.match(/execute\s+as\s+(@\w+(?:\[[^\]]*\])?)\s+at\s+@s\s+run\s+(.+)/i);
        if (simpleExecute && !output.match(/execute\s+@/)) {
            const [, selector, command] = simpleExecute;
            output = output.replace(/execute\s+as\s+@\w+(?:\[[^\]]*\])?\s+at\s+@s\s+run\s+(.+)/i, `execute ${selector} ~ ~ ~ ${command}`);
            if (!changes.some(c => c.includes('execute'))) {
                changes.push('转换execute语法为基岩版');
            }
        }
        
        // 3. 简化目标选择器
        // 基岩版不支持复杂的选择器参数，保留基础选择器但移除方括号内容
        const selectorMatch = output.match(/@(\w+)\[([^\]]*)\]/g);
        if (selectorMatch) {
            // 分析并转换可能的参数
            selectorMatch.forEach(match => {
                const base = match.split('[')[0];
                const paramsStr = match.match(/\[([^\]]*)\]/)?.[1] || '';
                const params = paramsStr.split(',').map(p => p.trim()).filter(p => p);
                
                // 基岩版支持的参数
                const bedrockParams = [];
                params.forEach(param => {
                    const [key, value] = param.split('=').map(s => s.trim());
                    if (!key || value === undefined) return;
                    
                    // 基岩版支持的参数
                    const supported = ['name', 'type', 'family', 'tag', 'r', 'rm', 'c', 'l', 'lm', 'm', 'x', 'y', 'z', 'dx', 'dy', 'dz'];
                    if (supported.includes(key)) {
                        // 转换某些参数
                        if (key === 'distance') {
                            // 基岩版使用 r 而不是 distance
                            const range = value.split('..');
                            if (range.length === 2) {
                                if (range[0]) bedrockParams.push(`rm=${range[0]}`);
                                if (range[1]) bedrockParams.push(`r=${range[1]}`);
                            } else if (value.startsWith('..')) {
                                bedrockParams.push(`r=${value.substring(2)}`);
                            } else if (value.endsWith('..')) {
                                bedrockParams.push(`rm=${value.substring(0, value.length - 2)}`);
                            }
                        } else if (key === 'gamemode') {
                            bedrockParams.push(`m=${value}`);
                        } else if (key === 'limit') {
                            bedrockParams.push(`c=${value}`);
                        } else if (key === 'level') {
                            const range = value.split('..');
                            if (range.length === 2) {
                                if (range[0]) bedrockParams.push(`lm=${range[0]}`);
                                if (range[1]) bedrockParams.push(`l=${range[1]}`);
                            }
                        } else {
                            bedrockParams.push(`${key}=${value}`);
                        }
                    }
                });
                
                if (bedrockParams.length > 0) {
                    const newSelector = `${base}[${bedrockParams.join(',')}]`;
                    output = output.replace(match, newSelector);
                } else {
                    output = output.replace(match, base);
                }
            });
            changes.push('转换目标选择器参数为基岩版兼容格式');
        }
        
        // 4. 移除方块状态
        // 基岩版使用数据值而不是状态字符串
        const blockStateMatch = output.match(/(\w+)\[([^\]]*)\]/g);
        if (blockStateMatch) {
            blockStateMatch.forEach(match => {
                // 简单处理：移除状态（真正的转捡需要完整的状态到数据值映射）
                const base = match.split('[')[0];
                output = output.replace(match, base);
            });
            if (!changes.some(c => c.includes('方块状态'))) {
                changes.push('移除方块状态（基岩版使用数据值）');
            }
        }
        
        // 5. 移除NBT数据
        // 基岩版支持的NBT有限，大部分情况下需要移除
        const nbtMatch = output.match(/\{[^}]*\}/g);
        if (nbtMatch) {
            // 保留给予命令的NBT，移除其他的
            // 这是一个简化处理，实际上需要更复杂的逻辑
            output = output.replace(/(\w+)\s+\{[^}]*\}/g, (match, cmd) => {
                // 如果是给予或召唤命令，保留NBT但转换格式
                if (['give', 'summon', 'replaceitem'].includes(cmd)) {
                    // 保留但可能需要格式转换
                    return match;
                }
                return cmd;
            });
            if (!changes.some(c => c.includes('NBT'))) {
                changes.push('移除不支持的NBT数据');
            }
        }
        
        // 6. 转换某些命令
        // /data → 基岩版无法直接转换，需要提示
        if (output.match(/^\/?data\s/)) {
            changes.push('警告: /data 命令在基岩版中无法直接转换');
        }
        
        // 7. 移除 run 关键字
        output = output.replace(/\s+run\s+/g, ' ');
        
        document.getElementById('bedrockConverterResult').innerHTML = `
            <div class="result-panel">
                <div class="result-header">
                    <div class="result-title" style="color: #22d3ee;"><i class="fas fa-check-circle"></i> 基岩版结果</div>
                </div>
                ${changes.length > 0 ? `<div style="margin-bottom: 12px;"><strong style="color: #64748b;">转换详情:</strong></div><div style="margin-bottom: 12px;">${changes.map(c => `<span class="tag" style="margin-right: 6px; margin-bottom: 6px; display: inline-block; background: linear-gradient(135deg, #22d3ee, #0891b2);">${escapeHtml(c)}</span>`).join('')}</div>` : '<div style="color: #64748b; margin-bottom: 12px;"><i class="fas fa-info-circle"></i> 无需转换</div>'}
                <div style="background: rgba(6,182,212,0.1); padding: 14px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; color: #22d3ee; margin-bottom: 12px; white-space: pre-wrap; word-break: break-all;">
                    ${escapeHtml(output)}
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="copyText('${output.replace(/'/g, "\\'")}')" class="btn btn-primary" style="background: linear-gradient(135deg, #22d3ee, #0891b2); padding: 8px 16px; font-size: 0.85rem;">
                        <i class="fas fa-copy"></i> ${t('copy')}
                    </button>
                    <button onclick="document.getElementById('bedrockConverterInput').value = '${output.replace(/'/g, "\\'")}'; showToast('已更新输入');" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.85rem;">
                        <i class="fas fa-sync"></i> 应用到输入
                    </button>
                </div>
            </div>
        `;
    }
    
    function clearConversion() {
        document.getElementById('converterInput').value = '';
        document.getElementById('converterResult').innerHTML = '';
    }
    
    function clearBedrockConversion() {
        document.getElementById('bedrockConverterInput').value = '';
        document.getElementById('bedrockConverterResult').innerHTML = '';
    }


    
    // ==================== Credits & Contributors ====================
    const DEFAULT_CREDITS = [
        { name: "轮回道尘", role: "项目创始人", desc: "创建并维护本项目", date: "2025-09", link: "https://afdian.com/a/daoze1" },
        { name: "Minecraft Wiki", role: "资料参考", desc: "提供完整的指令文档", link: "https://minecraft.wiki/" },
        { name: "Tailwind CSS", role: "UI框架", desc: "提供优雅的样式工具", link: "https://tailwindcss.com/" }
    ];
    
    const DEFAULT_CONTRIBUTORS = [
        { name: "轮回道尘", role: "主要开发者", contributions: ["架构设计", "功能开发", "UI设计"], date: "2025-09" }
    ];
    
    function renderCreditsPage(container) {
        let creditsHtml = '';
        if(data.credits.length === 0) data.credits = DEFAULT_CREDITS;
        
        creditsHtml = data.credits.map((credit, index) => `
            <div class="card" style="animation: fadeInUp 0.5s ease ${index * 0.05}s both;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                    <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--mc-gold), #f59e0b); display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #fff;">${credit.name}</div>
                        <div style="font-size: 0.8rem; color: var(--mc-gold);">${credit.role}</div>
                    </div>
                </div>
                <div style="color: #94a3b8; font-size: 0.85rem;">${credit.desc || ''}</div>
                ${credit.link ? `<a href="${credit.link}" target="_blank" style="color: #64748b; font-size: 0.8rem; margin-top: 8px; display: inline-block;"><i class="fas fa-external-link-alt"></i> 访问链接</a>` : ''}
            </div>
        `).join('');
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('supporters')}</h2>
                    <div class="page-subtitle">感谢所有支持者</div>
                </div>
            </div>
            <div class="content-grid">${creditsHtml}</div>
        `;
    }
    
    function renderContributorsPage(container) {
        if(data.contributors.length === 0) data.contributors = DEFAULT_CONTRIBUTORS;
        
        const contributorsHtml = data.contributors.map((c, index) => `
            <div class="card" style="animation: fadeInUp 0.5s ease ${index * 0.05}s both; border-left: 3px solid var(--mc-gold);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                    <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #a855f7, #7c3aed); display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                        <i class="fas fa-code"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #fff;">${c.name}</div>
                        <div style="font-size: 0.8rem; color: #a855f7;">${c.role}</div>
                    </div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                    ${c.contributions.map(con => `<span class="tag tag-purple" style="font-size: 0.75rem;">${con}</span>`).join('')}
                </div>
            </div>
        `).join('');
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('developers')}</h2>
                    <div class="page-subtitle">项目贡献开发者</div>
                </div>
            </div>
            <div class="content-grid">${contributorsHtml}</div>
        `;
    }
    
    // ==================== Data Parsing ====================
    function processContent(text, filename) {
        const lower = filename.toLowerCase();
        
        if(lower.includes('item')) {
            data.items.push(...parseItems(text));
        } else if(lower.includes('redstone')) {
            data.redstone.push(...parseRedstone(text));
        } else if(lower.includes('block')) {
            data.blocks.push(...parseBlocks(text));
        } else if(lower.includes('advancement')) {
            data.advancements.push(...parseAdvancements(text));
        } else {
            let source = 'unknown';
            if(lower.includes('java')) source = 'java';
            else if(lower.includes('bedrock')) source = 'bedrock';
            else if(lower.includes('edu')) source = 'education';
            parseCommands(text, source);
        }
        
        updateStats();
        updateFilters();
        renderContent();
        saveToStorage();
    }
    
    function parseItems(text) {
        const items = [];
        const entries = text.split(/(?=【)/);
        for(const entry of entries) {
            if(!entry.includes('【')) continue;
            const lines = entry.trim().split('\n');
            let item = {};
            for(const line of lines) {
                if(line.includes('【') && line.includes('】')) item.name = cleanText(line);
                else if(line.includes('ID')) item.id = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('分类')) item.category = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('简介')) item.desc = cleanText(line.split(/[：:]/)[1] || '');
            }
            if(item.name) items.push(item);
        }
        return items;
    }
    
    function parseRedstone(text) {
        const items = [];
        const entries = text.split(/(?=【)/);
        for(const entry of entries) {
            if(!entry.includes('【')) continue;
            const lines = entry.trim().split('\n');
            let item = { features: [] };
            for(const line of lines) {
                if(line.includes('【') && line.includes('】')) item.name = cleanText(line);
                else if(line.includes('类型')) item.type = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('功能')) item.desc = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('特性')) item.features.push(cleanText(line.split(/[：:]/)[1] || ''));
            }
            if(item.name) items.push(item);
        }
        return items;
    }
    
    function parseBlocks(text) {
        const blocks = [];
        const entries = text.split(/(?=【)/);
        for(const entry of entries) {
            if(!entry.includes('【')) continue;
            const lines = entry.trim().split('\n');
            let block = { tips: [] };
            for(const line of lines) {
                if(line.includes('【') && line.includes('】')) block.name = cleanText(line);
                else if(line.includes('类型')) block.type = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('功能')) block.desc = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('技巧')) block.tips.push(cleanText(line.split(/[：:]/)[1] || ''));
            }
            if(block.name) blocks.push(block);
        }
        return blocks;
    }
    
    function parseAdvancements(text) {
        const advs = [];
        const lines = text.split('\n');
        let current = null;
        for(const line of lines) {
            const trimmed = line.trim();
            if(trimmed.startsWith('【') && trimmed.includes('】')) {
                if(current && current.id) advs.push(current);
                current = { name: cleanText(trimmed), category: '', id: '', desc: '' };
            } else if(current && trimmed.includes('ID')) {
                current.id = cleanText(trimmed.split(/[：:]/)[1] || '');
            } else if(current && trimmed.includes('分类')) {
                current.category = cleanText(trimmed.split(/[：:]/)[1] || '');
            } else if(current && trimmed.includes('简介')) {
                current.desc = cleanText(trimmed.split(/[：:]/)[1] || '');
            }
        }
        if(current && current.id) advs.push(current);
        return advs;
    }
    
    function parseCommands(text, source) {
        const lines = text.split('\n');
        let current = null;
        for(let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const trimmed = line.trim();
            if(!trimmed || trimmed.startsWith('—')) continue;
            if(trimmed.startsWith('/') && !trimmed.includes('：') && !line.includes(':')) {
                if(current && current.name) {
                    data.commands.set(`${current.name}_${source}`, current);
                }
                current = { name: cleanText(trimmed.split(/\s+/)[0]), desc: '', syntax: cleanText(trimmed), source: source, examples: [] };
            } else if(current) {
                if(trimmed.startsWith('简介')) current.desc = cleanText(trimmed.substring(3));
                else if(trimmed.startsWith('语法')) current.syntax = cleanText(trimmed.substring(3));
                else if(trimmed.startsWith('>')) current.examples.push(cleanText(trimmed.substring(1)));
            }
        }
        if(current && current.name) {
            data.commands.set(`${current.name}_${source}`, current);
        }
    }
    
    function cleanText(text) {
        if(!text) return '';
        return text.replace(/【|】/g, '').replace(/[（(].*?[)）]/g, '').replace(/^\s*[-–—]\s*/g, '').trim();
    }
    
    // ==================== UI Helpers ====================
    function updateStats() {
        const total = data.commands.size + data.blocks.length + data.redstone.length + data.items.length + data.advancements.length;
        
        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-cmd').textContent = data.commands.size;
        document.getElementById('badge-cmd').textContent = data.commands.size;
        document.getElementById('badge-block').textContent = data.blocks.length;
        document.getElementById('badge-redstone').textContent = data.redstone.length;
        document.getElementById('badge-item').textContent = data.items.length;
        document.getElementById('badge-adv').textContent = data.advancements.length;
    }
    
    function updateFilters() {
        const container = document.getElementById('filters');
        if(!container) return;
        
        let html = '<div class="chip active" onclick="setFilter(\'all\', event)">全部</div>';
        
        if(currentTab === 'commands') {
            const versions = {};
            data.commands.forEach(c => { versions[c.source] = (versions[c.source] || 0) + 1; });
            Object.entries(versions).forEach(([v, n]) => {
                const name = { java: 'Java版', bedrock: '基岩版', education: '教育版', unknown: '未知' }[v] || v;
                html += `<div class="chip" onclick="setFilter('${v}', event)">${name} (${n})</div>`;
            });
        }
        else if(currentTab === 'redstone') {
            const types = {};
            data.redstone.forEach(r => { 
                const type = r.type || '未分类';
                types[type] = (types[type] || 0) + 1; 
            });
            Object.entries(types).sort().forEach(([t, n]) => {
                html += `<div class="chip" onclick="setFilter('${t}', event)">${t} (${n})</div>`;
            });
        }
        else if(currentTab === 'items') {
            const cats = {};
            data.items.forEach(i => { 
                const cat = i.category || '未分类';
                cats[cat] = (cats[cat] || 0) + 1; 
            });
            Object.entries(cats).sort().forEach(([c, n]) => {
                html += `<div class="chip" onclick="setFilter('${c}', event)">${c} (${n})</div>`;
            });
        }
        else if(currentTab === 'advancements') {
            const cats = {};
            data.advancements.forEach(a => { 
                const cat = a.category || '未分类';
                cats[cat] = (cats[cat] || 0) + 1; 
            });
            Object.entries(cats).sort().forEach(([c, n]) => {
                html += `<div class="chip" onclick="setFilter('${c}', event)">${c} (${n})</div>`;
            });
        }
        
        container.innerHTML = html;
    }
    
    function setFilter(filter, eventObj) {
        currentFilter = filter;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        if(eventObj && eventObj.target) eventObj.target.classList.add('active');
        renderContent();
    }
    
    function handleSearch() { renderContent(); }
    
    function renderContent() {
        const keyword = (document.getElementById('searchInput')?.value || '').toLowerCase();
        const container = document.getElementById('mainContent');
        if(!container) return;
        
        let html = '';
        
        switch(currentTab) {
            case 'commands':
                const cmds = Array.from(data.commands.values()).filter(c => {
                    if(currentFilter !== 'all' && c.source !== currentFilter) return false;
                    return !keyword || c.name.toLowerCase().includes(keyword) || (c.desc && c.desc.toLowerCase().includes(keyword));
                });
                html = cmds.map(c => `
                    <div class="card card-cmd" onclick="showCommandDetail('${c.name}', '${c.source}')">
                        <div class="card-header">
                            <div class="card-title" style="color: var(--mc-green);">${c.name}</div>
                            <span class="tag">${{java: 'Java', bedrock: 'BE', education: 'Edu', unknown: '?' }[c.source] || c.source}</span>
                        </div>
                        <div class="card-desc">${c.desc || '暂无简介'}</div>
                    </div>
                `).join('');
                break;
                
            case 'blocks':
                const blocks = data.blocks.filter(b => !keyword || b.name.toLowerCase().includes(keyword));
                html = blocks.map(b => `
                    <div class="card card-block">
                        <div class="card-header">
                            <div class="card-title" style="color: var(--mc-orange);">${b.name}</div>
                            ${b.type ? `<span class="tag tag-orange">${b.type}</span>` : ''}
                        </div>
                        <div class="card-desc">${b.desc || ''}</div>
                    </div>
                `).join('');
                break;
                
            case 'redstone':
                const reds = data.redstone.filter(r => {
                    if(currentFilter !== 'all' && (r.type || '未分类') !== currentFilter) return false;
                    return !keyword || r.name.toLowerCase().includes(keyword);
                });
                html = reds.map(r => `
                    <div class="card card-redstone">
                        <div class="card-header">
                            <div class="card-title" style="color: var(--mc-red);">${r.name}</div>
                            ${r.type ? `<span class="tag tag-red">${r.type}</span>` : ''}
                        </div>
                        <div class="card-desc">${r.desc || ''}</div>
                    </div>
                `).join('');
                break;
                
            case 'items':
                const items = data.items.filter(i => {
                    if(currentFilter !== 'all' && (i.category || '未分类') !== currentFilter) return false;
                    return !keyword || i.name.toLowerCase().includes(keyword) || (i.id && i.id.toLowerCase().includes(keyword));
                });
                html = items.map(i => `
                    <div class="card card-item">
                        <div class="card-header">
                            <div class="card-title" style="color: var(--mc-blue);">${i.name}</div>
                            ${i.category ? `<span class="tag tag-blue">${i.category}</span>` : ''}
                        </div>
                        <div class="id-block" onclick="event.stopPropagation(); copyText('${(i.id || '').replace(/'/g, "\\'")}')">${i.id}</div>
                        <div class="card-desc" style="margin-top: 8px;">${i.desc || ''}</div>
                    </div>
                `).join('');
                break;
                
            case 'advancements':
                const advs = data.advancements.filter(a => {
                    if(currentFilter !== 'all' && (a.category || '未分类') !== currentFilter) return false;
                    return !keyword || (a.id && a.id.toLowerCase().includes(keyword)) || a.name.toLowerCase().includes(keyword);
                });
                html = advs.map(a => `
                    <div class="card card-adv">
                        <div class="card-header">
                            <div>
                                ${a.category ? `<span class="tag tag-cyan" style="font-size: 0.7rem;">${a.category}</span>` : ''}
                                <div class="card-title" style="color: var(--mc-cyan); margin-top: 4px;">${a.name}</div>
                            </div>
                        </div>
                        <div class="id-block" onclick="event.stopPropagation(); copyText('${(a.id || '').replace(/'/g, "\\'")}')">${a.id}</div>
                        <div class="card-desc" style="margin-top: 8px;">${a.desc || ''}</div>
                    </div>
                `).join('');
                break;
        }
        
        if(html === '') {
            html = `<div class="empty-state">
                <div style="font-size: 3rem; margin-bottom: 12px;">🔍</div>
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 6px;">未找到数据</div>
                <div style="font-size: 0.85rem; color: #64748b;">请上传文件或更改搜索条件</div>
            </div>`;
        }
        
        container.innerHTML = html;
    }
    
    function showCommandDetail(name, source) {
        const cmd = data.commands.get(`${name}_${source}`);
        if(!cmd) return;
        
        const modal = document.getElementById('modal');
        const body = document.getElementById('modal-body');
        
        body.innerHTML = `
            <h2 style="font-family: VT323, monospace; font-size: 2rem; color: var(--mc-green); margin-bottom: 16px;">${cmd.name}</h2>
            <div style="margin-bottom: 16px;">
                <span class="tag">${{java: 'Java版', bedrock: '基岩版', education: '教育版'}[cmd.source] || cmd.source}</span>
            </div>
            <div style="margin-bottom: 16px;">
                <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 6px;">简介</div>
                <div>${cmd.desc || '暂无'}</div>
            </div>
            <div style="margin-bottom: 16px;">
                <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 6px;">语法</div>
                <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; color: var(--mc-gold);">${escapeHtml(cmd.syntax)}</div>
            </div>
            ${cmd.examples.length ? `
            <div>
                <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 6px;">示例</div>
                ${cmd.examples.map(e => `<div style="background: rgba(93,140,58,0.1); padding: 10px; border-radius: 6px; margin-bottom: 6px; font-family: 'JetBrains Mono', monospace; cursor: pointer;" onclick="copyText('${e.replace(/'/g, "\\'")}')">${e}</div>`).join('')}
            </div>` : ''}
            <div class="action-buttons" style="margin-top: 16px;">
                <button onclick="addToFavorites({id: Date.now(), type: 'command', content: '${cmd.syntax.replace(/'/g, "\\'")}', name: '${cmd.name}'})" class="btn btn-secondary">
                    <i class="fas fa-star"></i> ${t('add_favorite')}
                </button>
            </div>
        `;
        
        modal.style.display = 'block';
    }
    
    // ==================== File Handling ====================
    function selectFiles() {
        document.getElementById('fileInput')?.click();
    }
    
    function setupDragDrop() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        if(!dropZone || !fileInput) return;
        
        fileInput.onchange = async (e) => {
            let importedCount = 0;
            for(const file of e.target.files) {
                try {
                    if(file.name.endsWith('.zip')) {
                        importedCount += await processZIPFile(file);
                    } else if(file.name.endsWith('.txt')) {
                        const text = await file.text();
                        processContent(text, file.name);
                        importedCount++;
                    }
                } catch(err) {
                    console.error('处理文件失败:', file.name, err);
                    showToast(`处理文件失败: ${file.name}`);
                }
            }
            if(importedCount > 0) {
                showToast(`成功导入 ${importedCount} 个文件`);
            }
            // 重置 input 以便可以再次选择同一文件
            fileInput.value = '';
        };
        
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--mc-green)'; };
        dropZone.ondragleave = () => { dropZone.style.borderColor = 'rgba(93,140,58,0.3)'; };
        dropZone.ondrop = async (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'rgba(93,140,58,0.3)';
            let importedCount = 0;
            
            for(const file of e.dataTransfer.files) {
                try {
                    if(file.name.endsWith('.zip')) {
                        importedCount += await processZIPFile(file);
                    } else if(file.name.endsWith('.txt')) {
                        const text = await file.text();
                        processContent(text, file.name);
                        importedCount++;
                    } else {
                        showToast(`不支持的文件类型: ${file.name}`);
                    }
                } catch(err) {
                    console.error('处理文件失败:', file.name, err);
                    showToast(`处理文件失败: ${file.name}`);
                }
            }
            if(importedCount > 0) {
                showToast(`成功导入 ${importedCount} 个文件`);
            }
        };
    }
    
    async function processZIPFile(file) {
        let processedCount = 0;
        try {
            // 检查 JSZip 是否可用
            if(typeof JSZip === 'undefined') {
                showToast('错误: JSZip 库未加载，无法解析 ZIP 文件');
                return 0;
            }
            
            const zip = await JSZip.loadAsync(file);
            const txtFiles = [];
            
            // 收集所有 txt 文件
            zip.forEach((relativePath, zipEntry) => {
                if(!zipEntry.dir && relativePath.endsWith('.txt')) {
                    txtFiles.push(zipEntry);
                }
            });
            
            if(txtFiles.length === 0) {
                showToast('ZIP 文件中未找到 .txt 文件');
                return 0;
            }
            
            // 处理每个 txt 文件
            for(const zipEntry of txtFiles) {
                try {
                    const content = await zipEntry.async('text');
                    processContent(content, zipEntry.name);
                    processedCount++;
                } catch(err) {
                    console.error('读取 ZIP 内文件失败:', zipEntry.name, err);
                }
            }
        } catch(err) {
            console.error('解析 ZIP 文件失败:', err);
            showToast('ZIP 文件解析失败: ' + err.message);
        }
        return processedCount;
    }
    
    function clearAllData() {
        if(!confirm('确定要清空所有数据吗？')) return;
        data.commands.clear();
        data.blocks = [];
        data.redstone = [];
        data.items = [];
        data.advancements = [];
        localStorage.removeItem(STORAGE_KEY);
        updateStats();
        updateFilters();
        renderContent();
        showToast('数据已清空');
    }
    
    function saveToStorage() {
        try {
            const saveData = {
                commands: Array.from(data.commands.entries()),
                blocks: data.blocks,
                redstone: data.redstone,
                items: data.items,
                advancements: data.advancements
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
        } catch(e) { console.error('保存失败:', e); }
    }
    
    function loadFromStorage() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                const parsed = JSON.parse(saved);
                if(parsed.commands) parsed.commands.forEach(([k,v]) => data.commands.set(k,v));
                if(parsed.blocks) data.blocks = parsed.blocks;
                if(parsed.redstone) data.redstone = parsed.redstone;
                if(parsed.items) data.items = parsed.items;
                if(parsed.advancements) data.advancements = parsed.advancements;
                updateStats();
            }
        } catch(e) { console.error('加载失败:', e); }
    }
    
    // ==================== Utilities ====================
    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => showToast(t('copied') || '已复制'));
    }
    
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2500);
    }
    
    function closeModal(e) {
        if(!e || e.target.id === 'modal') {
            document.getElementById('modal').style.display = 'none';
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function initParticles() {
        const container = document.getElementById('particles');
        if(!container) return;
        
        for(let i = 0; i < 30; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + '%';
            p.style.animationDelay = Math.random() * 15 + 's';
            p.style.animationDuration = (12 + Math.random() * 15) + 's';
            container.appendChild(p);
        }
    }
    
    // ==================== Mobile Navigation ====================
    function switchMobileTab(tab, element) {
        // Update mobile nav active state
        document.querySelectorAll('.mobile-nav-item').forEach(el => el.classList.remove('active'));
        if(element) element.classList.add('active');
        
        // Update current tool
        currentTool = tab;
        
        // Switch to corresponding page
        switch(tab) {
            case 'home':
                currentTab = 'commands';
                renderMainContent();
                break;
            case 'database':
                currentTab = 'commands';
                currentTool = 'database';
                renderMainContent();
                break;
            case 'tools':
                renderToolsOverview(document.getElementById('main-content'));
                break;
            case 'favorites':
                renderFavoritesPage(document.getElementById('main-content'));
                break;
            case 'settings':
                renderMobileSettings();
                break;
        }
        
        // Scroll to top
        window.scrollTo(0, 0);
    }
    
    // ==================== Mobile Settings ====================
    function renderMobileSettings() {
        const container = document.getElementById('main-content');
        
        // Theme options
        const themeOptions = Object.entries(themes).map(([key, theme]) => `
            <div onclick="setTheme('${key}'); showToast('🎨 ' + '${theme.name}'); renderMobileSettings();" 
                 style="cursor: pointer; padding: 16px; background: linear-gradient(135deg, ${theme['--bg-dark']}, ${theme['--glass-bg']}); 
                        border-radius: 12px; border: 2px solid ${appState.theme === key ? 'var(--mc-green)' : 'transparent'}; 
                        text-align: center; transition: all 0.2s; flex: 1; min-width: 70px;">
                <div style="font-size: 2rem; margin-bottom: 6px;">${theme.icon}</div>
                <div style="color: #e2e8f0; font-weight: 500; font-size: 0.8rem;">${theme.name}</div>
            </div>
        `).join('');
        
        // Language options
        const languageOptions = Object.entries(languages).map(([key, lang]) => `
            <div onclick="setLanguage('${key}'); renderMobileSettings();" 
                 style="cursor: pointer; padding: 14px; background: ${appState.language === key ? 'rgba(93,140,58,0.3)' : 'rgba(30,41,59,0.6)'}; 
                        border-radius: 10px; border: 1px solid ${appState.language === key ? 'var(--mc-green)' : 'rgba(255,255,255,0.1)'};
                        display: flex; align-items: center; gap: 12px; transition: all 0.2s;">
                <span style="font-size: 1.5rem;">${lang.flag}</span>
                <span style="color: #e2e8f0; font-weight: 500; flex: 1;">${lang.name}</span>
                ${appState.language === key ? '<i class="fas fa-check" style="color: var(--mc-green);"></i>' : ''}
            </div>
        `).join('');
        
        // Font size options
        const fontSizeOptions = ['small', 'medium', 'large'].map(size => {
            const labels = { small: '小', medium: '中', large: '大' };
            const icons = { small: 'fa-font', medium: 'fa-font', large: 'fa-font' };
            const currentSize = localStorage.getItem('mc_font_size') || 'medium';
            const isActive = currentSize === size;
            return `
                <div onclick="setMobileFontSize('${size}');" 
                     style="cursor: pointer; padding: 14px; background: ${isActive ? 'rgba(93,140,58,0.3)' : 'rgba(30,41,59,0.6)'}; 
                            border-radius: 10px; border: 1px solid ${isActive ? 'var(--mc-green)' : 'rgba(255,255,255,0.1)'};
                            text-align: center; transition: all 0.2s; flex: 1;">
                    <i class="fas ${icons[size]}" style="font-size: ${size === 'small' ? '0.9rem' : size === 'large' ? '1.3rem' : '1.1rem'}; color: ${isActive ? 'var(--mc-green)' : '#94a3b8'}; margin-bottom: 6px;"></i>
                    <div style="color: ${isActive ? '#fff' : '#94a3b8'}; font-size: 0.85rem;">${labels[size]}</div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = `
            <div class="page-header" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                <h2 class="page-title"><i class="fas fa-cog" style="margin-right: 10px; color: var(--mc-gold);"></i>${t('settings')}</h2>
                <div class="page-subtitle">个性化您的使用体验</div>
            </div>
            
            <!-- Theme Section -->
            <div style="background: rgba(30,41,59,0.6); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
                <h3 style="color: #94a3b8; margin-bottom: 16px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-palette" style="color: var(--mc-purple);"></i> ${t('theme')}
                </h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${themeOptions}
                </div>
            </div>
            
            <!-- Language Section -->
            <div style="background: rgba(30,41,59,0.6); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
                <h3 style="color: #94a3b8; margin-bottom: 16px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-globe" style="color: var(--mc-blue);"></i> ${t('language')}
                </h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    ${languageOptions}
                </div>
            </div>
            
            <!-- Display Settings -->
            <div style="background: rgba(30,41,59,0.6); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
                <h3 style="color: #94a3b8; margin-bottom: 16px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-mobile-alt" style="color: var(--mc-cyan);"></i> 显示设置
                </h3>
                
                <!-- Font Size -->
                <div style="margin-bottom: 20px;">
                    <div style="color: #e2e8f0; font-size: 0.9rem; margin-bottom: 12px;">字体大小</div>
                    <div style="display: flex; gap: 10px;">
                        ${fontSizeOptions}
                    </div>
                </div>
                
                <!-- Compact Mode Toggle -->
                <label style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 12px; cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-compress-alt" style="color: var(--mc-orange); font-size: 1.1rem;"></i>
                        <div>
                            <div style="color: #e2e8f0; font-size: 0.95rem; font-weight: 500;">紧凑模式</div>
                            <div style="color: #64748b; font-size: 0.75rem;">减小间距，显示更多内容</div>
                        </div>
                    </div>
                    <div style="position: relative;">
                        <input type="checkbox" ${appState.compactMode ? 'checked' : ''} 
                               onchange="toggleCompactMode(this.checked)" 
                               style="width: 50px; height: 28px; -webkit-appearance: none; appearance: none; background: ${appState.compactMode ? 'var(--mc-green)' : 'rgba(255,255,255,0.2)'}; border-radius: 14px; position: relative; cursor: pointer; transition: all 0.3s;">
                        <span style="position: absolute; top: 3px; ${appState.compactMode ? 'right: 3px' : 'left: 3px'}; width: 22px; height: 22px; background: #fff; border-radius: 50%; transition: all 0.3s; pointer-events: none;"></span>
                    </div>
                </label>
                
                <!-- Touch Optimization Toggle -->
                <label style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 12px; cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-hand-pointer" style="color: var(--mc-light-green); font-size: 1.1rem;"></i>
                        <div>
                            <div style="color: #e2e8f0; font-size: 0.95rem; font-weight: 500;">触控优化</div>
                            <div style="color: #64748b; font-size: 0.75rem;">增大触控区域，优化触摸体验</div>
                        </div>
                    </div>
                    <div style="position: relative;">
                        <input type="checkbox" ${appState.touchOptimized ? 'checked' : ''} 
                               onchange="toggleTouchOptimized(this.checked)" 
                               style="width: 50px; height: 28px; -webkit-appearance: none; appearance: none; background: ${appState.touchOptimized ? 'var(--mc-green)' : 'rgba(255,255,255,0.2)'}; border-radius: 14px; position: relative; cursor: pointer; transition: all 0.3s;">
                        <span style="position: absolute; top: 3px; ${appState.touchOptimized ? 'right: 3px' : 'left: 3px'}; width: 22px; height: 22px; background: #fff; border-radius: 50%; transition: all 0.3s; pointer-events: none;"></span>
                    </div>
                </label>
            </div>
            
            <!-- Data Management -->
            <div style="background: rgba(30,41,59,0.6); border-radius: 16px; padding: 20px; margin-bottom: 16px;">
                <h3 style="color: #94a3b8; margin-bottom: 16px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-database" style="color: var(--mc-red);"></i> 数据管理
                </h3>
                <button onclick="showClearDataConfirm()" 
                        style="width: 100%; padding: 16px; background: rgba(220,38,38,0.15); border: 1px solid rgba(220,38,38,0.3); border-radius: 12px; color: #fca5a5; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s;">
                    <i class="fas fa-trash-alt"></i> 清除所有数据
                </button>
            </div>
            
            <!-- App Info -->
            <div style="text-align: center; padding: 20px; color: #64748b; font-size: 0.8rem;">
                <div>MC指令辅助 v1.16.9</div>
                <div style="margin-top: 4px;">轮回道尘制作</div>
            </div>
        `;
    }
    
    // ==================== Mobile Settings Helpers ====================
    function setMobileFontSize(size) {
        localStorage.setItem('mc_font_size', size);
        document.body.classList.remove('font-size-small', 'font-size-medium', 'font-size-large');
        document.body.classList.add(`font-size-${size}`);
        showToast(`📝 字体大小: ${size === 'small' ? '小' : size === 'large' ? '大' : '中'}`);
        renderMobileSettings();
    }
    
    function toggleCompactMode(enabled) {
        appState.compactMode = enabled;
        if(enabled) {
            document.body.classList.add('compact-mode');
        } else {
            document.body.classList.remove('compact-mode');
        }
        saveSettings();
        showToast(enabled ? '✓ 紧凑模式已开启' : '✓ 紧凑模式已关闭');
        renderMobileSettings();
    }
    
    function toggleTouchOptimized(enabled) {
        appState.touchOptimized = enabled;
        if(enabled) {
            document.body.classList.add('touch-optimized');
        } else {
            document.body.classList.remove('touch-optimized');
        }
        saveSettings();
        showToast(enabled ? '✓ 触控优化已开启' : '✓ 触控优化已关闭');
        renderMobileSettings();
    }
    
    function showClearDataConfirm() {
        if(confirm('确定要清除所有本地数据吗？\n\n这将删除：\n- 所有收藏的命令\n- 设置偏好\n- 缓存数据\n\n此操作不可恢复！')) {
            clearAllData();
            showToast('🗑️ 所有数据已清除');
            renderMobileSettings();
        }
    }
    
    // ==================== Library Check ====================
    function checkLibraries() {
        const requiredLibs = [
            { name: 'JSZip', global: 'JSZip', critical: true, usage: 'ZIP文件解析' },
            { name: 'i18next', global: 'i18next', critical: false, usage: '多语言支持' },
            { name: 'skinview3d', global: 'skinview3d', critical: false, usage: '3D皮肤预览' },
            { name: 'nbtify', global: 'nbtify', critical: false, usage: 'NBT编辑器' }
        ];
        
        const missingLibs = [];
        const failedLibs = [];
        
        for (const lib of requiredLibs) {
            if (typeof window[lib.global] === 'undefined') {
                if (lib.critical) {
                    missingLibs.push(lib);
                } else {
                    failedLibs.push(lib);
                }
                console.warn(`库未加载: ${lib.name} (${lib.usage})`);
            }
        }
        
        // 如果有关键库丢失，显示警告
        if (missingLibs.length > 0) {
            showLibraryWarning(missingLibs, true);
        }
        
        // 记录非关键库失败（只在控制台记录）
        if (failedLibs.length > 0) {
            console.log('非关键库未加载:', failedLibs.map(l => l.name).join(', '));
        }
        
        return { missingLibs, failedLibs };
    }
    
    function showLibraryWarning(libs, isCritical) {
        const warningDiv = document.createElement('div');
        warningDiv.id = 'library-warning';
        warningDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            background: ${isCritical ? 'rgba(220,38,38,0.95)' : 'rgba(245,158,11,0.95)'};
            color: #fff;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease;
        `;
        
        const libList = libs.map(l => `<li><strong>${l.name}</strong>: ${l.usage}</li>`).join('');
        
        warningDiv.innerHTML = `
            <div style="display: flex; align-items: start; gap: 12px;">
                <i class="fas ${isCritical ? 'fa-exclamation-triangle' : 'fa-info-circle'}" style="font-size: 1.5rem; margin-top: 2px;"></i>
                <div>
                    <div style="font-weight: 600; margin-bottom: 8px;">
                        ${isCritical ? '部分功能可能无法正常使用' : '一些功能可能受限'}
                    </div>
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 12px;">
                        以下库加载失败，可能是网络连接问题：
                    </div>
                    <ul style="margin: 0 0 12px 16px; font-size: 0.85rem; opacity: 0.9;">
                        ${libList}
                    </ul>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="location.reload()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.85rem;">
                            <i class="fas fa-sync"></i> 刷新页面
                        </button>
                        <button onclick="document.getElementById('library-warning').remove()" style="padding: 8px 16px; background: transparent; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.85rem;">
                            忽略
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        
        // 延迟显示，确保DOM已就绪
        setTimeout(() => {
            document.body.appendChild(warningDiv);
        }, 1000);
    }
    
    // ==================== Initialization ====================
    window.onload = function() {
        // 检查库加载状态
        checkLibraries();
        
        initI18n();
        initParticles();
        loadTheme();
        loadBuiltinData(); // 加载内置数据
        loadFavorites();
        loadFromStorage();
        
        // Init sidebar toggle for mobile
        if(window.innerWidth <= 1024) {
            document.querySelector('.sidebar')?.classList.remove('open');
        }
        
        // Load mobile settings
        const savedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
        if(savedSettings) {
            const settings = JSON.parse(savedSettings);
            
            // Apply compact mode
            if(settings.compactMode) {
                document.body.classList.add('compact-mode');
            }
            
            // Apply touch optimization
            if(settings.touchOptimized) {
                document.body.classList.add('touch-optimized');
            }
        }
        
        // Load font size preference
        const fontSize = localStorage.getItem('mc_font_size') || 'medium';
        document.body.classList.add(`font-size-${fontSize}`);
        
        renderMainContent();
    };
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') {
            closeModal();
            if(window.innerWidth <= 1024) {
                document.getElementById('sidebar')?.classList.remove('open');
                document.getElementById('overlay')?.classList.remove('show');
            }
        }
    });
    </script>
</body>
</html>
