<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的世界全版本指令辅助 | 轮回道尘</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- JSZip & FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- i18next 多语言支持 -->
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.16/dist/umd/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
    
    <!-- Highlight.js 语法高亮 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    
    <!-- Three.js for 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- SkinView3D -->
    <script src="https://cdn.jsdelivr.net/npm/skinview3d@3.0.1/dist/skinview3d.min.js"></script>
    
    <!-- NBTify -->
    <script src="https://cdn.jsdelivr.net/npm/nbtify@2.2.0/dist/index.umd.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+SC:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --mc-green: #5D8C3A;
            --mc-dark-green: #3D6E2E;
            --mc-light-green: #7EB356;
            --mc-orange: #d97706;
            --mc-red: #dc2626;
            --mc-blue: #2563eb;
            --mc-cyan: #06b6d4;
            --mc-gold: #fbbf24;
            --mc-purple: #9333ea;
            --sidebar-width: 280px;
            --toolbar-width: 60px;
            --bg-dark: #0a0f1c;
            --glass-bg: rgba(20, 25, 40, 0.95);
            --hover-bg: rgba(93, 140, 58, 0.15);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Noto Sans SC', sans-serif; 
            background: var(--bg-dark); 
            color: #e2e8f0; 
            margin: 0; 
            min-height: 100vh; 
            overflow-x: hidden;
        }
        
        .pixel-font { font-family: 'VT323', monospace; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }
        
        /* Minecraft Block Background Pattern */
        .mc-block-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3;
            background-color: var(--bg-dark);
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 31px, rgba(93,140,58,0.03) 31px, rgba(93,140,58,0.03) 32px),
                repeating-linear-gradient(90deg, transparent, transparent 31px, rgba(93,140,58,0.03) 31px, rgba(93,140,58,0.03) 32px);
        }
        
        /* Animated particles */
        .particles { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -2; 
            overflow: hidden; 
            pointer-events: none; 
        }
        .particle { 
            position: absolute; 
            width: 4px; 
            height: 4px; 
            background: var(--mc-green); 
            border-radius: 0;
            opacity: 0.6; 
            animation: float-up linear infinite;
            box-shadow: 0 0 6px var(--mc-green);
        }
        @keyframes float-up { 
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 
            10% { opacity: 0.8; } 
            90% { opacity: 0.8; } 
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; } 
        }
        
        /* Toolbar */
        .toolbar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: var(--toolbar-width);
            background: linear-gradient(180deg, rgba(15,20,30,0.98), rgba(10,15,25,0.98));
            border-right: 2px solid rgba(93,140,58,0.3);
            z-index: 101;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            transition: width 0.3s ease;
        }
        
        .toolbar.expanded {
            width: 200px;
        }
        
        .toolbar-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid var(--mc-green);
        }
        .toolbar-logo:hover { transform: scale(1.1); }
        
        .toolbar-item {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            margin: 4px 0;
            transition: all 0.2s;
            color: #94a3b8;
            position: relative;
        }
        .toolbar-item:hover {
            background: rgba(93,140,58,0.2);
            color: var(--mc-light-green);
        }
        .toolbar-item.active {
            background: linear-gradient(135deg, var(--mc-green), var(--mc-dark-green));
            color: #fff;
        }
        .toolbar-item i { font-size: 1.3rem; }
        
        .toolbar-tooltip {
            position: absolute;
            left: 60px;
            background: rgba(0,0,0,0.9);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 102;
        }
        .toolbar-item:hover .toolbar-tooltip { opacity: 1; }
        
        /* Sidebar */
        .sidebar { 
            position: fixed; 
            left: var(--toolbar-width);
            top: 0; 
            height: 100vh; 
            width: var(--sidebar-width); 
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); 
            border-right: 1px solid rgba(255,255,255,0.08); 
            z-index: 100; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
            overflow-x: hidden; 
            transition: transform 0.3s ease; 
        }
        
        .logo-area { 
            padding: 20px 16px; 
            border-bottom: 1px solid rgba(255,255,255,0.08); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        .logo-img { 
            width: 40px; 
            height: 40px; 
            border-radius: 8px; 
            object-fit: cover; 
            border: 2px solid var(--mc-green);
            box-shadow: 0 0 15px rgba(93,140,58,0.3);
        }
        .logo-text h1 { 
            font-size: 1.1rem; 
            font-weight: 700; 
            background: linear-gradient(90deg, #fff, var(--mc-light-green)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin: 0; 
            line-height: 1.2; 
        }
        .logo-text span { 
            font-size: 0.7rem; 
            color: #64748b; 
        }
        
        .nav-container { flex: 1; padding: 12px 10px; }
        .nav-section { margin-bottom: 4px; }
        .nav-parent { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 10px 14px; 
            border-radius: 10px; 
            cursor: pointer; 
            color: #94a3b8; 
            transition: all 0.2s; 
            margin-bottom: 4px; 
            font-weight: 500; 
            font-size: 0.9rem;
        }
        .nav-parent:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-parent.active { background: var(--hover-bg); color: var(--mc-light-green); }
        .nav-parent-left { display: flex; align-items: center; gap: 10px; }
        .nav-icon { width: 20px; text-align: center; font-size: 1rem; }
        .expand-icon { font-size: 0.75rem; transition: transform 0.3s; }
        .nav-parent.expanded .expand-icon { transform: rotate(180deg); }
        .nav-children { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding-left: 6px; }
        .nav-parent.expanded + .nav-children { max-height: 800px; }
        .nav-child { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 8px 14px 8px 36px; 
            margin: 2px 0; 
            border-radius: 8px; 
            cursor: pointer; 
            color: #94a3b8; 
            font-size: 0.85rem; 
            transition: all 0.2s; 
            position: relative; 
        }
        .nav-child::before { 
            content: ''; 
            position: absolute; 
            left: 22px; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 4px; 
            height: 4px; 
            background: currentColor; 
            border-radius: 50%; 
            opacity: 0.5; 
        }
        .nav-child:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-child.active { background: rgba(93,140,58,0.2); color: var(--mc-light-green); }
        .nav-child.active::before { background: var(--mc-light-green); opacity: 1; }
        
        .nav-divider { 
            font-size: 0.65rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
            color: #64748b; 
            padding: 14px 14px 6px; 
            font-weight: 600; 
        }
        
        .sidebar-footer { 
            padding: 14px; 
            border-top: 1px solid rgba(255,255,255,0.08); 
            background: rgba(0,0,0,0.2); 
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
        }
        .stat-box { 
            background: rgba(255,255,255,0.05); 
            border-radius: 8px; 
            padding: 10px; 
            text-align: center; 
        }
        .stat-value { 
            font-family: 'VT323', monospace; 
            font-size: 1.6rem; 
            color: var(--mc-light-green); 
            line-height: 1; 
        }
        .stat-label { 
            font-size: 0.65rem; 
            color: #64748b; 
            margin-top: 2px; 
        }
        
        /* Main Content */
        .main-content { 
            margin-left: calc(var(--toolbar-width) + var(--sidebar-width)); 
            min-height: 100vh; 
            padding: 24px; 
            transition: margin-left 0.3s; 
        }
        
        .page-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            padding-bottom: 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.08); 
            flex-wrap: wrap; 
            gap: 16px; 
        }
        .page-title { 
            font-size: 1.6rem; 
            font-weight: 700; 
            background: linear-gradient(90deg, #fff, var(--mc-light-green)); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        .page-subtitle { 
            font-size: 0.85rem; 
            color: #64748b; 
            margin-top: 4px; 
        }
        
        /* Cards */
        .content-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 16px; 
        }
        .card { 
            background: linear-gradient(135deg, rgba(30,41,59,0.8), rgba(15,23,42,0.9)); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 14px; 
            padding: 18px; 
            cursor: pointer; 
            transition: all 0.3s; 
            position: relative; 
            overflow: hidden; 
        }
        .card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 3px; 
            background: linear-gradient(90deg, var(--mc-green), var(--mc-gold)); 
            opacity: 0; 
            transition: opacity 0.3s; 
        }
        .card:hover { 
            transform: translateY(-4px); 
            border-color: rgba(93,140,58,0.4); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
        }
        .card:hover::before { opacity: 1; }
        .card-cmd { border-top: 3px solid var(--mc-green); }
        .card-block { border-top: 3px solid var(--mc-orange); }
        .card-redstone { border-top: 3px solid var(--mc-red); }
        .card-item { border-top: 3px solid var(--mc-blue); }
        .card-adv { border-top: 3px solid var(--mc-cyan); }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: start; 
            margin-bottom: 10px; 
        }
        .card-title { 
            font-family: 'VT323', monospace; 
            font-size: 1.4rem; 
            color: #fff; 
            margin: 0; 
            line-height: 1.2; 
        }
        .card-version { 
            font-size: 0.7rem; 
            color: #64748b; 
            background: rgba(0,0,0,0.3); 
            padding: 3px 6px; 
            border-radius: 4px; 
            font-family: 'JetBrains Mono', monospace; 
        }
        .card-desc { 
            color: #94a3b8; 
            font-size: 0.85rem; 
            line-height: 1.5; 
            display: -webkit-box; 
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
        }
        
        .tag { 
            padding: 3px 8px; 
            background: rgba(93,140,58,0.2); 
            color: var(--mc-light-green); 
            border-radius: 5px; 
            font-size: 0.75rem; 
            font-weight: 500; 
        }
        .tag-red { background: rgba(220,38,38,0.2); color: #fca5a5; }
        .tag-blue { background: rgba(37,99,235,0.2); color: #60a5fa; }
        .tag-cyan { background: rgba(6,182,212,0.2); color: #22d3ee; }
        .tag-orange { background: rgba(217,119,6,0.2); color: #fbbf24; }
        .tag-purple { background: rgba(147,51,234,0.2); color: #c084fc; }
        .tag-gold { background: rgba(251,191,36,0.2); color: #fbbf24; }
        
        .id-block { 
            background: rgba(0,0,0,0.4); 
            padding: 8px 12px; 
            border-radius: 6px; 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.85rem; 
            color: var(--mc-gold); 
            border: 1px solid rgba(251,191,36,0.3); 
            margin-top: 10px; 
            cursor: pointer; 
            transition: all 0.2s; 
            word-break: break-all; 
        }
        .id-block:hover { border-color: var(--mc-gold); background: rgba(251,191,36,0.1); }
        
        /* Input Areas */
        .input-area { 
            background: rgba(30,41,59,0.6); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 14px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        
        .command-textarea { 
            width: 100%; 
            min-height: 180px; 
            background: rgba(0,0,0,0.4); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; 
            padding: 14px; 
            color: #e2e8f0; 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.85rem; 
            line-height: 1.6; 
            resize: vertical; 
            transition: all 0.3s; 
        }
        .command-textarea:focus { 
            outline: none; 
            border-color: var(--mc-green); 
            box-shadow: 0 0 0 3px rgba(93,140,58,0.1); 
        }
        
        .search-box { position: relative; margin-bottom: 20px; }
        .search-input { 
            width: 100%; 
            padding: 12px 18px; 
            background: rgba(30,41,59,0.6); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; 
            color: #fff; 
            font-size: 0.9rem; 
            transition: all 0.3s; 
        }
        .search-input:focus { 
            outline: none; 
            border-color: var(--mc-green); 
            box-shadow: 0 0 0 3px rgba(93,140,58,0.1); 
        }
        
        .filter-chips { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin-bottom: 20px; 
        }
        .chip { 
            padding: 6px 14px; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 50px; 
            font-size: 0.8rem; 
            cursor: pointer; 
            transition: all 0.2s; 
            color: #cbd5e1; 
        }
        .chip:hover { background: rgba(93,140,58,0.1); border-color: rgba(93,140,58,0.3); }
        .chip.active { 
            background: linear-gradient(135deg, var(--mc-green), var(--mc-dark-green)); 
            border-color: transparent; 
            color: #fff; 
        }
        
        /* Buttons */
        .btn { 
            padding: 10px 20px; 
            border-radius: 10px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
            border: none; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.9rem; 
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--mc-green), var(--mc-dark-green)); 
            color: #fff; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(93,140,58,0.3); 
        }
        .btn-secondary { 
            background: rgba(255,255,255,0.1); 
            color: #e2e8f0; 
            border: 1px solid rgba(255,255,255,0.2); 
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.15); }
        .btn-gold { 
            background: linear-gradient(135deg, var(--mc-gold), #f59e0b); 
            color: #000; 
        }
        .btn-gold:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(251,191,36,0.3); 
        }
        .btn-purple { 
            background: linear-gradient(135deg, var(--mc-purple), #7c3aed); 
            color: #fff; 
        }
        .btn-purple:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(147,51,234,0.3); 
        }
        
        .action-buttons { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap; 
            margin-top: 14px; 
        }
        
        /* Tab Group */
        .tab-group { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding-bottom: 14px; 
            flex-wrap: wrap; 
        }
        .tab-btn { 
            padding: 8px 16px; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; 
            color: #94a3b8; 
            cursor: pointer; 
            transition: all 0.2s; 
            font-weight: 500; 
            font-size: 0.85rem;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .tab-btn.active { 
            background: linear-gradient(135deg, var(--mc-green), var(--mc-dark-green)); 
            border-color: transparent; 
            color: #fff; 
        }
        
        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(10px); 
            z-index: 200; 
            overflow-y: auto; 
            padding: 20px; 
        }
        .modal-content { 
            background: linear-gradient(135deg, rgba(30,41,59,0.98), rgba(15,23,42,0.98)); 
            border: 1px solid rgba(93,140,58,0.3); 
            border-radius: 20px; 
            max-width: 900px; 
            margin: 40px auto; 
            padding: 28px; 
            position: relative; 
            max-height: 90vh; 
            overflow-y: auto; 
        }
        .modal-close { 
            position: absolute; 
            top: 16px; 
            right: 16px; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: #94a3b8; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s; 
        }
        .modal-close:hover { 
            background: rgba(220,38,38,0.2); 
            color: #fff; 
            transform: rotate(90deg); 
        }
        
        /* Toast */
        .toast { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%) translateY(100px); 
            background: linear-gradient(135deg, var(--mc-green), var(--mc-dark-green)); 
            color: #fff; 
            padding: 14px 28px; 
            border-radius: 50px; 
            font-weight: 500; 
            z-index: 3000; 
            opacity: 0; 
            transition: all 0.3s; 
            border: 1px solid rgba(255,255,255,0.2); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            max-width: 90vw; 
            text-align: center; 
            font-size: 0.9rem;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Result Panel */
        .result-panel { 
            background: rgba(0,0,0,0.4); 
            border-radius: 12px; 
            padding: 18px; 
            margin-top: 18px; 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .result-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 14px; 
            padding-bottom: 14px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            flex-wrap: wrap; 
            gap: 12px; 
        }
        .result-title { 
            font-weight: 600; 
            color: var(--mc-light-green); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        /* MCFunction Editor */
        .mcfunction-editor {
            background: #1e1e1e;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .mcfunction-line {
            display: flex;
            padding: 2px 0;
        }
        .mcfunction-line:hover { background: rgba(255,255,255,0.05); }
        .mcfunction-lineno {
            color: #858585;
            text-align: right;
            padding: 0 12px;
            min-width: 40px;
            user-select: none;
            font-size: 0.8rem;
        }
        .mcfunction-code {
            flex: 1;
            padding: 0 8px;
            white-space: pre;
            font-size: 0.85rem;
        }
        
        /* Syntax Highlighting */
        .token-command { color: #4ec9b0; font-weight: bold; }
        .token-selector { color: #9cdcfe; }
        .token-string { color: #ce9178; }
        .token-number { color: #b5cea8; }
        .token-comment { color: #6a9955; font-style: italic; }
        .token-keyword { color: #c586c0; }
        .token-operator { color: #d4d4d4; }
        
        /* NBT Tree */
        .nbt-tree { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }
        .nbt-node { padding: 3px 0; }
        .nbt-key { color: var(--mc-gold); }
        .nbt-string { color: #ce9178; }
        .nbt-number { color: #b5cea8; }
        .nbt-boolean { color: #569cd6; }
        .nbt-list { margin-left: 16px; border-left: 1px solid rgba(255,255,255,0.1); padding-left: 8px; }
        
        /* Tool Panel */
        .tool-panel {
            background: rgba(30,41,59,0.6);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .tool-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .tool-card:hover {
            background: rgba(93,140,58,0.1);
            border-color: var(--mc-green);
            transform: translateY(-2px);
        }
        .tool-card i {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: var(--mc-light-green);
        }
        .tool-card-title {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* Skin Viewer */
        .skin-viewer-container {
            width: 100%;
            height: 400px;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        /* Enchantment Calculator */
        .enchantment-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        .enchantment-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .enchantment-item input {
            width: 50px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            padding: 4px 8px;
            color: #fff;
        }
        
        /* Progress Bar */
        .progress-bar { 
            width: 100%; 
            height: 4px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 2px; 
            overflow: hidden; 
            margin: 14px 0; 
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--mc-green), var(--mc-gold)); 
            border-radius: 2px; 
            transition: width 0.3s; 
        }
        
        /* Empty State */
        .empty-state { 
            grid-column: 1 / -1; 
            text-align: center; 
            padding: 60px 20px; 
            color: #64748b; 
            background: rgba(30,41,59,0.3); 
            border-radius: 16px; 
            border: 2px dashed rgba(255,255,255,0.1); 
        }
        
        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px var(--mc-green), 0 0 10px var(--mc-green); }
            50% { box-shadow: 0 0 10px var(--mc-green), 0 0 20px var(--mc-green); }
        }
        @keyframes block-break {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        .card { animation: fadeInUp 0.5s ease backwards; }
        .card:nth-child(1) { animation-delay: 0.05s; }
        .card:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3) { animation-delay: 0.15s; }
        .card:nth-child(4) { animation-delay: 0.2s; }
        
        /* Mobile Toggle */
        .mobile-toggle { 
            display: none; 
            position: fixed; 
            top: 16px; 
            left: 70px; 
            z-index: 99; 
            width: 40px; 
            height: 40px; 
            background: var(--glass-bg); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; 
            color: #fff; 
            cursor: pointer; 
            backdrop-filter: blur(10px); 
        }
        
        .overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 90; 
            backdrop-filter: blur(4px); 
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: var(--mc-green); border-radius: 3px; }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .toolbar { display: none; }
            .sidebar { 
                left: 0; 
                transform: translateX(-100%); 
            }
            .sidebar.open { transform: translateX(0); }
            .main-content { 
                margin-left: 0; 
                padding: 70px 16px 20px; 
            }
            .mobile-toggle { 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                left: 16px;
            }
            .overlay.show { display: block; }
            .content-grid { grid-template-columns: 1fr; }
            .page-title { font-size: 1.3rem; }
        }
        
        @media (max-width: 640px) {
            .main-content { padding: 65px 12px 16px; }
            .modal-content { padding: 20px; margin: 20px auto; }
            .action-buttons { flex-direction: column; }
            .action-buttons .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- Minecraft Block Background -->
    <div class="mc-block-bg"></div>
    
    <!-- Animated Particles -->
    <div class="particles" id="particles"></div>
    
    <!-- Mobile Toggle -->
    <button class="mobile-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    
    <!-- Toolbar -->
    <aside class="toolbar" id="toolbar">
        <img src="image.png" alt="Logo" class="toolbar-logo" onclick="switchTool('home', event)" 
             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%235D8C3A%22 width=%22100%22 height=%22100%22 rx=%2210%22/%3E%3Ctext x=%2250%22 y=%2265%22 font-size=%2250%22 text-anchor=%22middle%22 fill=%22white%22%3EMC%3C/text%3E%3C/svg%3E'">
        
        <div class="toolbar-item active" onclick="switchTool('home', event)" title="主页">
            <i class="fas fa-home"></i>
            <span class="toolbar-tooltip">主页</span>
        </div>
        
        <div class="toolbar-item" onclick="switchTool('database', event)" title="数据库">
            <i class="fas fa-database"></i>
            <span class="toolbar-tooltip">数据库</span>
        </div>
        
        <div class="toolbar-item" onclick="switchTool('tools', event)" title="工具箱">
            <i class="fas fa-toolbox"></i>
            <span class="toolbar-tooltip">工具箱</span>
        </div>
        
        <div class="toolbar-item" onclick="switchTool('favorites', event)" title="收藏夹">
            <i class="fas fa-star"></i>
            <span class="toolbar-tooltip">收藏夹</span>
        </div>
        
        <div class="toolbar-item" onclick="switchTool('converter', event)" title="转换器">
            <i class="fas fa-exchange-alt"></i>
            <span class="toolbar-tooltip">转换器</span>
        </div>
        
        <div style="flex: 1;"></div>
        
        <div class="toolbar-item" onclick="showThemeSettings()" title="设置">
            <i class="fas fa-cog"></i>
            <span class="toolbar-tooltip">设置</span>
        </div>
    </aside>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="logo-area">
            <img src="image.png" alt="" class="logo-img" 
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%235D8C3A%22 width=%22100%22 height=%22100%22 rx=%2210%22/%3E%3Ctext x=%2250%22 y=%2265%22 font-size=%2250%22 text-anchor=%22middle%22 fill=%22white%22%3EMC%3C/text%3E%3C/svg%3E'">
            <div class="logo-text">
                <h1 data-i18n="title">MC游戏辅助</h1>
                <span>v1.16.8 data版</span><br>
                <span>轮回道尘制作</span>
            </div>
        </div>
        
        <nav class="nav-container">
            <div class="nav-divider" data-i18n="nav_data">数据分类</div>
            <div class="nav-section">
                <div class="nav-parent expanded" onclick="toggleMenu(this)">
                    <div class="nav-parent-left">
                        <span class="nav-icon"><i class="fas fa-terminal"></i></span>
                        <span data-i18n="commands">指令</span>
                    </div>
                    <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="nav-children" style="max-height: 500px;">
                    <div class="nav-child active" onclick="switchTab('commands', this)">
                        <span data-i18n="all_commands">全部指令</span>
                        <span class="tag" id="badge-cmd">0</span>
                    </div>
                    <div class="nav-child" onclick="switchTab('blocks', this)">
                        <span data-i18n="command_blocks">命令方块</span>
                        <span class="tag" id="badge-block">0</span>
                    </div>
                    <div class="nav-child" onclick="switchTab('redstone', this)">
                        <span data-i18n="redstone">红石元件</span>
                        <span class="tag" id="badge-redstone">0</span>
                    </div>
                    <div class="nav-child" onclick="switchTab('items', this)">
                        <span data-i18n="items">物品ID</span>
                        <span class="tag" id="badge-item">0</span>
                    </div>
                    <div class="nav-child" onclick="switchTab('advancements', this)">
                        <span data-i18n="advancements">准则ID</span>
                        <span class="tag" id="badge-adv">0</span>
                    </div>
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-parent" onclick="toggleMenu(this)">
                    <div class="nav-parent-left">
                        <span class="nav-icon"><i class="fas fa-wrench"></i></span>
                        <span data-i18n="tools">实用工具</span>
                    </div>
                    <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="nav-children">
                    <div class="nav-child" onclick="switchToolPage('generator', this)">
                        <i class="fas fa-magic" style="margin-right: 8px; color: var(--mc-purple);"></i>
                        <span data-i18n="command_generator">指令生成器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('selector', this)">
                        <i class="fas fa-crosshairs" style="margin-right: 8px; color: var(--mc-cyan);"></i>
                        <span data-i18n="target_selector">目标选择器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('nbt', this)">
                        <i class="fas fa-code" style="margin-right: 8px; color: var(--mc-gold);"></i>
                        <span data-i18n="nbt_editor">NBT编辑器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('mcfunction', this)">
                        <i class="fas fa-file-code" style="margin-right: 8px; color: var(--mc-blue);"></i>
                        <span data-i18n="function_editor">函数编辑器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('skin', this)">
                        <i class="fas fa-user" style="margin-right: 8px; color: #f59e0b;"></i>
                        <span data-i18n="skin_editor">皮肤编辑器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('particle', this)">
                        <i class="fas fa-snowflake" style="margin-right: 8px; color: #22d3ee;"></i>
                        <span data-i18n="particle_editor">粒子编辑器</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('materials', this)">
                        <i class="fas fa-calculator" style="margin-right: 8px; color: #4ade80;"></i>
                        <span data-i18n="material_calculator">材料计算</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('seedmap', this)">
                        <i class="fas fa-map" style="margin-right: 8px; color: #a78bfa;"></i>
                        <span data-i18n="seed_map">种子地图</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('slime', this)">
                        <i class="fas fa-th" style="margin-right: 8px; color: #4ade80;"></i>
                        <span data-i18n="slime_finder">史莱姆查找</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('enchant', this)">
                        <i class="fas fa-gem" style="margin-right: 8px; color: #60a5fa;"></i>
                        <span data-i18n="enchantment">附魔工具</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('xp', this)">
                        <i class="fas fa-chart-line" style="margin-right: 8px; color: #fbbf24;"></i>
                        <span data-i18n="xp_calculator">经验计算</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('smelt', this)">
                        <i class="fas fa-fire" style="margin-right: 8px; color: #f97316;"></i>
                        <span data-i18n="smelting">熔炼计算</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('coords', this)">
                        <i class="fas fa-compass" style="margin-right: 8px; color: #22d3ee;"></i>
                        <span data-i18n="coord_convert">坐标转换</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('structure', this)">
                        <i class="fas fa-cubes" style="margin-right: 8px; color: #a8a29e;"></i>
                        <span data-i18n="structure_extract">结构提取</span>
                    </div>
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-parent" onclick="toggleMenu(this)">
                    <div class="nav-parent-left">
                        <span class="nav-icon"><i class="fas fa-robot"></i></span>
                        <span data-i18n="ai_features">AI功能</span>
                    </div>
                    <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="nav-children">
                    <div class="nav-child" onclick="switchToolPage('ai', this)">
                        <i class="fas fa-brain" style="margin-right: 8px; color: var(--mc-purple);"></i>
                        <span data-i18n="ai_assistant">AI指令助手</span>
                        <span class="tag tag-purple">NEW</span>
                    </div>
                    <div class="nav-child" onclick="switchToolPage('compare', this)">
                        <i class="fas fa-code-branch" style="margin-right: 8px; color: var(--mc-green);"></i>
                        <span data-i18n="version_compare">版本对比</span>
                    </div>
                </div>
            </div>
            
            <div class="nav-divider" data-i18n="nav_contribution">贡献</div>
            <div class="nav-section">
                <div class="nav-parent" onclick="toggleMenu(this)">
                    <div class="nav-parent-left">
                        <span class="nav-icon"><i class="fas fa-award"></i></span>
                        <span data-i18n="credits">鸣谢名单</span>
                    </div>
                    <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="nav-children">
                    <div class="nav-child" onclick="showCredits('credits', this)">
                        <span data-i18n="supporters">支持者</span>
                        <span class="tag" id="badge-credits">0</span>
                    </div>
                    <div class="nav-child" onclick="showCredits('contributors', this)">
                        <span data-i18n="developers">开发者</span>
                        <span class="tag" id="badge-contributors">0</span>
                    </div>
                </div>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label" data-i18n="total_data">总数据</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-cmd">0</div>
                    <div class="stat-label" data-i18n="commands">指令</div>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content" id="main-content"></main>
    
    <!-- Modal -->
    <div class="modal" id="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>


    <script>
    // ==================== Global Variables & Constants ====================
    const STORAGE_KEY = 'mc_command_helper_data_v3';
    const FAVORITES_STORAGE_KEY = 'mc_helper_favorites_v3';
    const SETTINGS_STORAGE_KEY = 'mc_helper_settings_v3';
    
    // App State
    const appState = {
        theme: 'dark',
        language: 'zh-CN',
        shortcuts: true,
        autoSave: true,
        errorReporting: true
    };
    
    // Data Storage
    const data = {
        commands: new Map(),
        blocks: [],
        redstone: [],
        items: [],
        advancements: [],
        favorites: [],
        credits: [],
        contributors: []
    };
    
    let currentTab = 'commands';
    let currentTool = 'home';
    let currentFilter = 'all';
    let i18nInstance = null;
    let skinViewer = null;
    
    // ==================== i18n Translations ====================
    const i18nResources = {
        'zh-CN': {
            translation: {
                title: 'MC指令辅助',
                nav_data: '数据分类',
                commands: '指令',
                all_commands: '全部指令',
                command_blocks: '命令方块',
                redstone: '红石元件',
                items: '物品ID',
                advancements: '准则ID',
                nav_tools: '实用工具',
                tools: '工具箱',
                command_generator: '指令生成器',
                target_selector: '目标选择器',
                nbt_editor: 'NBT编辑器',
                function_editor: '函数编辑器',
                skin_editor: '皮肤编辑器',
                particle_editor: '粒子编辑器',
                material_calculator: '材料计算',
                seed_map: '种子地图',
                slime_finder: '史莱姆查找',
                enchantment: '附魔工具',
                xp_calculator: '经验计算',
                smelting: '熔炼计算',
                coord_convert: '坐标转换',
                structure_extract: '结构提取',
                ai_features: 'AI功能',
                ai_assistant: 'AI指令助手',
                version_compare: '版本对比',
                nav_contribution: '贡献',
                credits: '鸣谢名单',
                supporters: '支持者',
                developers: '开发者',
                favorites: '我的收藏',
                total_data: '总数据',
                search: '搜索...',
                copy: '复制',
                save: '保存',
                download: '下载',
                clear: '清空',
                loading: '加载中...',
                error: '错误',
                success: '成功',
                theme: '主题',
                language: '语言',
                settings: '设置',
                add_favorite: '添加到收藏',
                remove_favorite: '移除收藏',
                no_favorites: '暂无收藏',
                no_favorites_desc: '您还没有收藏任何命令',
                converter: '转换器',
                database: '数据库',
                home: '主页'
            }
        },
        'en': {
            translation: {
                title: 'MC Command Helper',
                nav_data: 'Data Categories',
                commands: 'Commands',
                all_commands: 'All Commands',
                command_blocks: 'Command Blocks',
                redstone: 'Redstone',
                items: 'Item IDs',
                advancements: 'Advancements',
                nav_tools: 'Tools',
                tools: 'Toolbox',
                command_generator: 'Command Generator',
                target_selector: 'Target Selector',
                nbt_editor: 'NBT Editor',
                function_editor: 'Function Editor',
                skin_editor: 'Skin Editor',
                particle_editor: 'Particle Editor',
                material_calculator: 'Material Calculator',
                seed_map: 'Seed Map',
                slime_finder: 'Slime Finder',
                enchantment: 'Enchantment Tool',
                xp_calculator: 'XP Calculator',
                smelting: 'Smelting Calculator',
                coord_convert: 'Coordinate Converter',
                structure_extract: 'Structure Extractor',
                ai_features: 'AI Features',
                ai_assistant: 'AI Assistant',
                version_compare: 'Version Compare',
                nav_contribution: 'Credits',
                credits: 'Credits',
                supporters: 'Supporters',
                developers: 'Developers',
                favorites: 'My Favorites',
                total_data: 'Total Data',
                search: 'Search...',
                copy: 'Copy',
                save: 'Save',
                download: 'Download',
                clear: 'Clear',
                loading: 'Loading...',
                error: 'Error',
                success: 'Success',
                theme: 'Theme',
                language: 'Language',
                settings: 'Settings',
                add_favorite: 'Add to Favorites',
                remove_favorite: 'Remove',
                no_favorites: 'No Favorites',
                no_favorites_desc: 'You have no saved commands yet',
                converter: 'Converter',
                database: 'Database',
                home: 'Home'
            }
        },
        'ja': {
            translation: {
                title: 'MCコマンドアシスタント',
                commands: 'コマンド',
                favorites: 'お気に入り',
                tools: 'ツール',
                settings: '設定',
                search: '検索...',
                copy: 'コピー',
                save: '保存',
                download: 'ダウンロード',
                clear: 'クリア'
            }
        },
        'ko': {
            translation: {
                title: 'MC 명령어 도우미',
                commands: '명령어',
                favorites: '즐겨찾기',
                tools: '도구',
                settings: '설정',
                search: '검색...',
                copy: '복사',
                save: '저장',
                download: '다운로드',
                clear: '지우기'
            }
        }
    };
    
    // ==================== Theme Definitions ====================
    const themes = {
        dark: { 
            '--bg-dark': '#0a0f1c', '--glass-bg': 'rgba(20, 25, 40, 0.95)', '--mc-green': '#5D8C3A',
            '--mc-dark-green': '#3D6E2E', '--mc-light-green': '#7EB356',
            icon: '🌙', name: '暗黑主题'
        },
        light: { 
            '--bg-dark': '#f8fafc', '--glass-bg': 'rgba(255, 255, 255, 0.95)', '--mc-green': '#16a34a',
            '--mc-dark-green': '#15803d', '--mc-light-green': '#22c55e',
            icon: '☀️', name: '亮色主题'
        },
        ocean: { 
            '--bg-dark': '#0c1e2e', '--glass-bg': 'rgba(15, 35, 55, 0.95)', '--mc-green': '#0ea5e9',
            '--mc-dark-green': '#0284c7', '--mc-light-green': '#38bdf8',
            icon: '🌊', name: '海洋主题'
        },
        nether: { 
            '--bg-dark': '#1a0c0c', '--glass-bg': 'rgba(40, 20, 20, 0.95)', '--mc-green': '#dc2626',
            '--mc-dark-green': '#b91c1c', '--mc-light-green': '#ef4444',
            icon: '🔥', name: '下界主题'
        },
        forest: { 
            '--bg-dark': '#0c1f0c', '--glass-bg': 'rgba(20, 45, 20, 0.95)', '--mc-green': '#22c55e',
            '--mc-dark-green': '#16a34a', '--mc-light-green': '#4ade80',
            icon: '🌳', name: '森林主题'
        },
        purple: { 
            '--bg-dark': '#1a0c2e', '--glass-bg': 'rgba(35, 20, 55, 0.95)', '--mc-green': '#9333ea',
            '--mc-dark-green': '#7c3aed', '--mc-light-green': '#a855f7',
            icon: '💜', name: '紫色主题'
        },
        gold: { 
            '--bg-dark': '#1c1505', '--glass-bg': 'rgba(45, 35, 10, 0.95)', '--mc-green': '#eab308',
            '--mc-dark-green': '#ca8a04', '--mc-light-green': '#facc15',
            icon: '🏆', name: '黄金主题'
        },
        midnight: { 
            '--bg-dark': '#020617', '--glass-bg': 'rgba(15, 23, 42, 0.98)', '--mc-green': '#6366f1',
            '--mc-dark-green': '#4f46e5', '--mc-light-green': '#818cf8',
            icon: '🌌', name: '午夜主题'
        }
    };
    
    const languages = {
        'zh-CN': { name: '中文', flag: '🇨🇳' },
        'en': { name: 'English', flag: '🇺🇸' },
        'ja': { name: '日本語', flag: '🇯🇵' },
        'ko': { name: '한국어', flag: '🇰🇷' }
    };
    
    // ==================== Initialization ====================
    function initI18n() {
        if (typeof i18next !== 'undefined') {
            i18next.use(i18nextBrowserLanguageDetector).init({
                resources: i18nResources,
                fallbackLng: 'en',
                lng: appState.language,
                debug: false
            }).then(function(instance) {
                i18nInstance = instance;
                updatePageTranslations();
            });
        }
    }
    
    function t(key) {
        if (i18nInstance && i18nInstance.isInitialized) {
            return i18nInstance.t(key);
        }
        const lang = appState.language || 'zh-CN';
        const resource = i18nResources[lang];
        if (resource?.translation?.[key]) return resource.translation[key];
        return key;
    }
    
    function updatePageTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (key) el.textContent = t(key);
        });
    }
    
    function setLanguage(lang) {
        appState.language = lang;
        document.documentElement.lang = lang;
        localStorage.setItem('mc_language', lang);
        
        if (i18nInstance?.isInitialized) {
            i18next.changeLanguage(lang).then(() => {
                updatePageTranslations();
                renderMainContent();
                showToast('🌐 ' + languages[lang].name);
            });
        } else {
            updatePageTranslations();
            renderMainContent();
            showToast('🌐 ' + languages[lang].name);
        }
        saveSettings();
    }
    
    // ==================== Theme System ====================
    function setTheme(themeName) {
        appState.theme = themeName;
        const theme = themes[themeName];
        if(theme) {
            Object.entries(theme).forEach(([key, value]) => {
                if(key.startsWith('--')) {
                    document.documentElement.style.setProperty(key, value);
                }
            });
        }
        document.body.setAttribute('data-theme', themeName);
        saveSettings();
    }
    
    function loadTheme() {
        const saved = localStorage.getItem(SETTINGS_STORAGE_KEY);
        if(saved) {
            const settings = JSON.parse(saved);
            Object.assign(appState, settings);
            setTheme(appState.theme);
        }
    }
    
    function saveSettings() {
        try { localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(appState)); } catch(e) {}
    }
    
    function showThemeSettings() {
        const modal = document.getElementById('modal');
        const body = document.getElementById('modal-body');
        
        const themeOptions = Object.entries(themes).map(([key, theme]) => `
            <div onclick="setTheme('${key}'); closeModal();" 
                 style="cursor: pointer; padding: 14px; background: linear-gradient(135deg, ${theme['--bg-dark']}, ${theme['--glass-bg']}); 
                        border-radius: 10px; border: 2px solid ${appState.theme === key ? 'var(--mc-green)' : 'transparent'}; 
                        text-align: center; transition: all 0.2s;"
                 onmouseover="this.style.transform='translateY(-2px)';"
                 onmouseout="this.style.transform='translateY(0)';">
                <div style="font-size: 1.8rem; margin-bottom: 4px;">${theme.icon}</div>
                <div style="color: #e2e8f0; font-weight: 500; font-size: 0.85rem;">${theme.name}</div>
            </div>
        `).join('');
        
        const languageOptions = Object.entries(languages).map(([key, lang]) => `
            <div onclick="setLanguage('${key}'); closeModal();" 
                 style="cursor: pointer; padding: 10px 14px; background: ${appState.language === key ? 'rgba(93,140,58,0.3)' : 'rgba(30,41,59,0.6)'}; 
                        border-radius: 8px; border: 1px solid ${appState.language === key ? 'var(--mc-green)' : 'rgba(255,255,255,0.1)'};
                        display: flex; align-items: center; gap: 10px; transition: all 0.2s;">
                <span style="font-size: 1.3rem;">${lang.flag}</span>
                <span style="color: #e2e8f0; font-weight: 500;">${lang.name}</span>
                ${appState.language === key ? '<i class="fas fa-check" style="color: var(--mc-green); margin-left: auto;"></i>' : ''}
            </div>
        `).join('');
        
        body.innerHTML = `
            <h2 style="font-family: VT323, monospace; font-size: 1.8rem; color: var(--mc-gold); margin-bottom: 20px;">
                <i class="fas fa-cog"></i> ${t('settings')}
            </h2>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #94a3b8; margin-bottom: 10px; font-size: 0.9rem;">
                    <i class="fas fa-palette"></i> ${t('theme')}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    ${themeOptions}
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3 style="color: #94a3b8; margin-bottom: 10px; font-size: 0.9rem;">
                    <i class="fas fa-globe"></i> ${t('language')}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    ${languageOptions}
                </div>
            </div>
            
            <div style="background: rgba(30,41,59,0.6); border-radius: 10px; padding: 14px;">
                <h3 style="color: #94a3b8; margin-bottom: 10px; font-size: 0.85rem;">
                    <i class="fas fa-sliders-h"></i> 更多设置
                </h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; color: #e2e8f0; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" ${appState.shortcuts ? 'checked' : ''} 
                               onchange="appState.shortcuts = this.checked; saveSettings();" 
                               style="width: 16px; height: 16px; accent-color: var(--mc-green);"> 
                        <span>启用键盘快捷键</span>
                    </label>
                </div>
            </div>
        `;
        modal.style.display = 'block';
    }
    
    // ==================== Navigation ====================
    function switchTool(tool, eventObj) {
        currentTool = tool;
        
        // Update toolbar active state
        document.querySelectorAll('.toolbar-item').forEach(el => el.classList.remove('active'));
        if(eventObj && eventObj.currentTarget) eventObj.currentTarget.classList.add('active');
        
        if(tool === 'home') {
            currentTab = 'commands';
            renderMainContent();
        } else if(tool === 'database') {
            currentTab = 'commands';
            renderMainContent();
        } else if(tool === 'favorites') {
            renderFavoritesPage(document.getElementById('main-content'));
        } else if(tool === 'tools') {
            renderToolsOverview(document.getElementById('main-content'));
        } else if(tool === 'converter') {
            renderConverterPage(document.getElementById('main-content'));
        }
    }
    
    function switchTab(tab, element) {
        currentTab = tab;
        currentTool = 'database';
        document.querySelectorAll('.nav-child').forEach(el => el.classList.remove('active'));
        if(element) element.classList.add('active');
        if(window.innerWidth <= 1024) toggleSidebar();
        renderMainContent();
    }
    
    function switchToolPage(page, element) {
        currentTool = page;
        document.querySelectorAll('.nav-child').forEach(el => el.classList.remove('active'));
        if(element) element.classList.add('active');
        if(window.innerWidth <= 1024) toggleSidebar();
        renderToolPage(page);
    }
    
    function renderToolPage(page) {
        const container = document.getElementById('main-content');
        switch(page) {
            case 'generator': renderCommandGenerator(container); break;
            case 'selector': renderSelectorBuilder(container); break;
            case 'nbt': renderNBTEditor(container); break;
            case 'mcfunction': renderMCFunctionEditor(container); break;
            case 'skin': renderSkinEditor(container); break;
            case 'particle': renderParticleEditor(container); break;
            case 'materials': renderMaterialCalculator(container); break;
            case 'seedmap': renderSeedMap(container); break;
            case 'slime': renderSlimeFinder(container); break;
            case 'enchant': renderEnchantmentTool(container); break;
            case 'xp': renderXPCalculator(container); break;
            case 'smelt': renderSmeltingCalculator(container); break;
            case 'coords': renderCoordConverter(container); break;
            case 'structure': renderStructureExtractor(container); break;
            case 'ai': renderAIPage(container); break;
            case 'compare': renderComparePage(container); break;
        }
    }
    
    function toggleMenu(element) {
        element.classList.toggle('expanded');
        const children = element.nextElementSibling;
        if(children) {
            children.style.maxHeight = element.classList.contains('expanded') ? '800px' : '0';
        }
    }
    
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    }
    
    function showCredits(type, element) {
        currentTool = type;
        document.querySelectorAll('.nav-child').forEach(el => el.classList.remove('active'));
        if(element) element.classList.add('active');
        if(window.innerWidth <= 1024) toggleSidebar();
        
        const container = document.getElementById('main-content');
        if(type === 'credits') renderCreditsPage(container);
        else if(type === 'contributors') renderContributorsPage(container);
    }
    
    // ==================== Main Content Renderers ====================
    function renderMainContent() {
        const container = document.getElementById('main-content');
        
        if(currentTool === 'home' || currentTool === 'database') {
            renderDatabasePage(container);
        } else if(currentTool === 'favorites') {
            renderFavoritesPage(container);
        } else if(currentTool === 'converter') {
            renderConverterPage(container);
        } else {
            renderDatabasePage(container);
        }
    }
    
    function renderToolsOverview(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('tools')}</h2>
                    <div class="page-subtitle">选择需要使用的工具</div>
                </div>
            </div>
            <div class="tool-grid">
                <div class="tool-card" onclick="switchToolPage('generator', null)">
                    <i class="fas fa-magic" style="color: var(--mc-purple);"></i>
                    <div class="tool-card-title">${t('command_generator')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('selector', null)">
                    <i class="fas fa-crosshairs" style="color: var(--mc-cyan);"></i>
                    <div class="tool-card-title">${t('target_selector')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('nbt', null)">
                    <i class="fas fa-code" style="color: var(--mc-gold);"></i>
                    <div class="tool-card-title">${t('nbt_editor')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('mcfunction', null)">
                    <i class="fas fa-file-code" style="color: var(--mc-blue);"></i>
                    <div class="tool-card-title">${t('function_editor')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('skin', null)">
                    <i class="fas fa-user" style="color: #f59e0b;"></i>
                    <div class="tool-card-title">${t('skin_editor')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('particle', null)">
                    <i class="fas fa-snowflake" style="color: #22d3ee;"></i>
                    <div class="tool-card-title">${t('particle_editor')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('materials', null)">
                    <i class="fas fa-calculator" style="color: #4ade80;"></i>
                    <div class="tool-card-title">${t('material_calculator')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('enchant', null)">
                    <i class="fas fa-gem" style="color: #60a5fa;"></i>
                    <div class="tool-card-title">${t('enchantment')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('xp', null)">
                    <i class="fas fa-chart-line" style="color: #fbbf24;"></i>
                    <div class="tool-card-title">${t('xp_calculator')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('smelt', null)">
                    <i class="fas fa-fire" style="color: #f97316;"></i>
                    <div class="tool-card-title">${t('smelting')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('coords', null)">
                    <i class="fas fa-compass" style="color: #22d3ee;"></i>
                    <div class="tool-card-title">${t('coord_convert')}</div>
                </div>
                <div class="tool-card" onclick="switchToolPage('compare', null)">
                    <i class="fas fa-code-branch" style="color: var(--mc-green);"></i>
                    <div class="tool-card-title">${t('version_compare')}</div>
                </div>
            </div>
        `;
    }
    
    // ==================== Database Page ====================
    function renderDatabasePage(container) {
        const titles = {
            commands: t('all_commands'),
            blocks: t('command_blocks'),
            redstone: t('redstone'),
            items: t('items'),
            advancements: t('advancements')
        };
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${titles[currentTab] || t('all_commands')}</h2>
                    <div class="page-subtitle">管理和查询游戏数据</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="selectFiles()" class="btn btn-secondary">
                        <i class="fas fa-folder-open"></i><span class="desktop-only">${t('save')}</span>
                    </button>
                    <button onclick="clearAllData()" class="btn" style="background: rgba(220,38,38,0.2); color: #fca5a5;">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            </div>
            <div class="upload-card" id="dropZone" onclick="selectFiles()" 
                 style="background: linear-gradient(135deg, rgba(30,41,59,0.6), rgba(15,23,42,0.6)); border: 2px dashed rgba(93,140,58,0.3); border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 24px;"
                 onmouseover="this.style.borderColor='var(--mc-green)'" 
                 onmouseout="this.style.borderColor='rgba(93,140,58,0.3)'">
                <div style="font-size: 2.5rem; margin-bottom: 12px;">📦</div>
                <h3 style="font-size: 1.1rem; margin-bottom: 6px; font-weight: 600;">拖拽文件或ZIP到此处</h3>
                <p style="color: #64748b; font-size: 0.85rem;">支持 .txt 或包含多个txt的 .zip 文件</p>
                <input type="file" id="fileInput" multiple accept=".txt,.zip" style="display: none;">
            </div>
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="${t('search')}" oninput="handleSearch()">
            </div>
            <div class="filter-chips" id="filters"></div>
            <div id="mainContent" class="content-grid">
                <div class="empty-state">
                    <div style="font-size: 3rem; margin-bottom: 12px; opacity: 0.5;">📭</div>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 6px; color: #94a3b8;">暂无数据</div>
                    <div style="font-size: 0.85rem; color: #64748b;">请上传文件开始使用</div>
                </div>
            </div>
        `;
        updateFilters();
        renderContent();
        setupDragDrop();
    }
    
    // ==================== Favorites System ====================
    function addToFavorites(item) {
        const exists = data.favorites.some(f => f.id === item.id);
        if(exists) { showToast(t('already_in_favorites') || '已在收藏夹中'); return; }
        data.favorites.unshift({ ...item, addedAt: new Date().toISOString() });
        saveFavorites();
        updateFavoritesBadge();
        showToast('✓ ' + (t('added_to_favorites') || '已添加到收藏夹'));
    }
    
    function removeFromFavorites(id) {
        data.favorites = data.favorites.filter(f => f.id !== id);
        saveFavorites();
        updateFavoritesBadge();
        showToast(t('removed_from_favorites') || '已从收藏夹移除');
        if(currentTool === 'favorites') renderFavoritesPage(document.getElementById('main-content'));
    }
    
    function saveFavorites() {
        try {
            localStorage.setItem(FAVORITES_STORAGE_KEY, JSON.stringify(data.favorites.slice(0, 100)));
        } catch(e) { console.error('保存收藏夹失败:', e); }
    }
    
    function loadFavorites() {
        try {
            const saved = localStorage.getItem(FAVORITES_STORAGE_KEY);
            if(saved) data.favorites = JSON.parse(saved);
        } catch(e) { console.error('加载收藏夹失败:', e); }
    }
    
    function updateFavoritesBadge() {
        // Find favorites badge in nav
        const navChildren = document.querySelectorAll('.nav-children');
        navChildren.forEach(nav => {
            const favChild = Array.from(nav.children).find(child => 
                child.textContent.includes(t('favorites'))
            );
            if(favChild) {
                let badge = favChild.querySelector('.tag');
                if(!badge) {
                    badge = document.createElement('span');
                    badge.className = 'tag';
                    favChild.appendChild(badge);
                }
                badge.textContent = data.favorites.length;
            }
        });
    }
    
    function renderFavoritesPage(container) {
        let favoritesHtml = '';
        if(!data.favorites || data.favorites.length === 0) {
            favoritesHtml = `
                <div class="empty-state">
                    <div style="font-size: 3rem; margin-bottom: 12px;">⭐</div>
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 6px; color: #94a3b8;">${t('no_favorites')}</div>
                    <div style="font-size: 0.85rem; color: #64748b;">${t('no_favorites_desc')}</div>
                </div>
            `;
        } else {
            favoritesHtml = data.favorites.map((fav, index) => {
                const safeContent = (fav.content || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const safeName = (fav.name || t('unnamed')).replace(/'/g, "\\'");
                return `
                    <div class="card" style="animation: fadeInUp 0.5s ease ${index * 0.05}s both; border-left: 3px solid var(--mc-gold);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; color: #fff;">${safeName}</div>
                                <div style="font-size: 0.75rem; color: #64748b;">${fav.type || t('command')}</div>
                            </div>
                            <i class="fas fa-star" style="color: var(--mc-gold);"></i>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #e2e8f0; margin: 10px 0; word-break: break-all;">
                            ${escapeHtml(fav.content || '')}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="copyText('${safeContent}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem;">
                                <i class="fas fa-copy"></i> ${t('copy')}
                            </button>
                            <button onclick="removeFromFavorites(${fav.id})" class="btn" style="padding: 6px 12px; font-size: 0.8rem; background: rgba(220,38,38,0.2); color: #fca5a5;">
                                <i class="fas fa-trash"></i> ${t('remove_favorite')}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('favorites')}</h2>
                    <div class="page-subtitle">管理你收藏的常用命令</div>
                </div>
            </div>
            <div class="content-grid">${favoritesHtml}</div>
        `;
    }


    
    // ==================== Command Generator ====================
    function renderCommandGenerator(container) {
        const templates = [
            { id: 'give', name: 'give - 给予物品', icon: 'fa-gift', color: '#7EB356' },
            { id: 'summon', name: 'summon - 召唤实体', icon: 'fa-ghost', color: '#a855f7' },
            { id: 'tp', name: 'tp - 传送', icon: 'fa-location-arrow', color: '#22d3ee' },
            { id: 'setblock', name: 'setblock - 设置方块', icon: 'fa-cube', color: '#f59e0b' },
            { id: 'fill', name: 'fill - 填充区域', icon: 'fa-th', color: '#ef4444' },
            { id: 'effect', name: 'effect - 给予效果', icon: 'fa-flask', color: '#60a5fa' },
            { id: 'enchant', name: 'enchant - 附魔', icon: 'fa-magic', color: '#fbbf24' },
            { id: 'gamemode', name: 'gamemode - 游戏模式', icon: 'fa-gamepad', color: '#4ade80' },
            { id: 'time', name: 'time - 时间控制', icon: 'fa-clock', color: '#818cf8' },
            { id: 'weather', name: 'weather - 天气控制', icon: 'fa-cloud', color: '#22d3ee' },
            { id: 'execute', name: 'execute - 条件执行', icon: 'fa-code', color: '#c084fc' },
            { id: 'scoreboard', name: 'scoreboard - 计分板', icon: 'fa-trophy', color: '#f97316' }
        ];
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('command_generator')}</h2>
                    <div class="page-subtitle">选择模板填入参数生成指令</div>
                </div>
            </div>
            <div class="content-grid">
                ${templates.map(t => `
                    <div class="card" onclick="showGeneratorForm('${t.id}')" style="cursor: pointer;">
                        <div class="card-header">
                            <div class="card-title" style="color: ${t.color};">
                                <i class="fas ${t.icon}" style="margin-right: 8px;"></i>${t.name}
                            </div>
                        </div>
                        <div class="card-desc">点击生成${t.name.split(' - ')[1]}指令</div>
                    </div>
                `).join('')}
            </div>
            <div id="generatorForm" style="margin-top: 20px;"></div>
        `;
    }
    
    function showGeneratorForm(templateId) {
        const formContainer = document.getElementById('generatorForm');
        const forms = {
            give: `
                <div class="input-area">
                    <h3 style="color: var(--mc-green); margin-bottom: 16px;"><i class="fas fa-gift"></i> give 指令生成器</h3>
                    <div style="display: grid; gap: 12px;">
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">目标</label>
                            <input type="text" id="gen_target" class="search-input" placeholder="@p" value="@p"></div>
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">物品ID</label>
                            <input type="text" id="gen_item" class="search-input" placeholder="minecraft:diamond"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">数量</label>
                                <input type="number" id="gen_count" class="search-input" placeholder="1" value="1" min="1" max="64"></div>
                            <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">数据值 (可选)</label>
                                <input type="number" id="gen_data" class="search-input" placeholder="0" value="0"></div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="generateCommand('give')" class="btn btn-primary"><i class="fas fa-magic"></i> 生成指令</button>
                        <button onclick="clearGenerator()" class="btn btn-secondary">${t('clear')}</button>
                    </div>
                    <div id="genResult" style="margin-top: 16px; padding: 14px; background: rgba(0,0,0,0.4); border-radius: 8px; font-family: 'JetBrains Mono', monospace; display: none;"></div>
                </div>
            `,
            summon: `
                <div class="input-area">
                    <h3 style="color: #a855f7; margin-bottom: 16px;"><i class="fas fa-ghost"></i> summon 指令生成器</h3>
                    <div style="display: grid; gap: 12px;">
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">实体ID</label>
                            <input type="text" id="gen_entity" class="search-input" placeholder="minecraft:zombie"></div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">X坐标</label>
                                <input type="text" id="gen_x" class="search-input" placeholder="~" value="~"></div>
                            <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">Y坐标</label>
                                <input type="text" id="gen_y" class="search-input" placeholder="~" value="~"></div>
                            <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">Z坐标</label>
                                <input type="text" id="gen_z" class="search-input" placeholder="~" value="~"></div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="generateCommand('summon')" class="btn btn-primary" style="background: linear-gradient(135deg, #a855f7, #7c3aed);"><i class="fas fa-magic"></i> 生成指令</button>
                        <button onclick="clearGenerator()" class="btn btn-secondary">${t('clear')}</button>
                    </div>
                    <div id="genResult" style="margin-top: 16px; padding: 14px; background: rgba(0,0,0,0.4); border-radius: 8px; font-family: 'JetBrains Mono', monospace; display: none;"></div>
                </div>
            `,
            tp: `
                <div class="input-area">
                    <h3 style="color: #22d3ee; margin-bottom: 16px;"><i class="fas fa-location-arrow"></i> tp 指令生成器</h3>
                    <div style="display: grid; gap: 12px;">
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">目标</label>
                            <input type="text" id="gen_target" class="search-input" placeholder="@p" value="@p"></div>
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">目的地 (玩家名或坐标)</label>
                            <input type="text" id="gen_dest" class="search-input" placeholder="@s 或 x y z"></div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="generateCommand('tp')" class="btn btn-primary" style="background: linear-gradient(135deg, #22d3ee, #0891b2);"><i class="fas fa-magic"></i> 生成指令</button>
                        <button onclick="clearGenerator()" class="btn btn-secondary">${t('clear')}</button>
                    </div>
                    <div id="genResult" style="margin-top: 16px; padding: 14px; background: rgba(0,0,0,0.4); border-radius: 8px; font-family: 'JetBrains Mono', monospace; display: none;"></div>
                </div>
            `,
            setblock: `
                <div class="input-area">
                    <h3 style="color: #f59e0b; margin-bottom: 16px;"><i class="fas fa-cube"></i> setblock 指令生成器</h3>
                    <div style="display: grid; gap: 12px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">X坐标</label>
                                <input type="text" id="gen_x" class="search-input" placeholder="~" value="~"></div>
                            <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">Y坐标</label>
                                <input type="text" id="gen_y" class="search-input" placeholder="~" value="~"></div>
                            <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">Z坐标</label>
                                <input type="text" id="gen_z" class="search-input" placeholder="~" value="~"></div>
                        </div>
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">方块ID</label>
                            <input type="text" id="gen_block" class="search-input" placeholder="minecraft:stone"></div>
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">模式</label>
                            <select id="gen_mode" class="search-input">
                                <option value="replace">replace - 替换</option>
                                <option value="destroy">destroy - 破坏并掉落</option>
                                <option value="keep">keep - 仅替换空气</option>
                            </select></div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="generateCommand('setblock')" class="btn btn-primary" style="background: linear-gradient(135deg, #f59e0b, #d97706);"><i class="fas fa-magic"></i> 生成指令</button>
                        <button onclick="clearGenerator()" class="btn btn-secondary">${t('clear')}</button>
                    </div>
                    <div id="genResult" style="margin-top: 16px; padding: 14px; background: rgba(0,0,0,0.4); border-radius: 8px; font-family: 'JetBrains Mono', monospace; display: none;"></div>
                </div>
            `,
            effect: `
                <div class="input-area">
                    <h3 style="color: #60a5fa; margin-bottom: 16px;"><i class="fas fa-flask"></i> effect 指令生成器</h3>
                    <div style="display: grid; gap: 12px;">
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">目标</label>
                            <input type="text" id="gen_target" class="search-input" placeholder="@p" value="@p"></div>
                        <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">效果ID</label>
                            <input type="text" id="gen_effect" class="search-input" placeholder="minecraft:speed"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">持续时间(秒)</label>
                                <input type="number" id="gen_duration" class="search-input" placeholder="30" value="30" min="0"></div>
                            <div><label style="color: #94a3b8; display: block; margin-bottom: 4px;">等级(0开始)</label>
                                <input type="number" id="gen_amplifier" class="search-input" placeholder="0" value="0" min="0"></div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="generateCommand('effect')" class="btn btn-primary" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);"><i class="fas fa-magic"></i> 生成指令</button>
                        <button onclick="clearGenerator()" class="btn btn-secondary">${t('clear')}</button>
                    </div>
                    <div id="genResult" style="margin-top: 16px; padding: 14px; background: rgba(0,0,0,0.4); border-radius: 8px; font-family: 'JetBrains Mono', monospace; display: none;"></div>
                </div>
            `
        };
        
        formContainer.innerHTML = forms[templateId] || '<p>模板加载中...</p>';
        formContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    function generateCommand(type) {
        let command = '';
        let resultDiv = document.getElementById('genResult');
        
        switch(type) {
            case 'give':
                const gTarget = document.getElementById('gen_target')?.value || '@p';
                const gItem = document.getElementById('gen_item')?.value || 'minecraft:stone';
                const gCount = document.getElementById('gen_count')?.value || '1';
                command = `/give ${gTarget} ${gItem} ${gCount}`;
                break;
            case 'summon':
                const sEntity = document.getElementById('gen_entity')?.value || 'minecraft:pig';
                const sX = document.getElementById('gen_x')?.value || '~';
                const sY = document.getElementById('gen_y')?.value || '~';
                const sZ = document.getElementById('gen_z')?.value || '~';
                command = `/summon ${sEntity} ${sX} ${sY} ${sZ}`;
                break;
            case 'tp':
                const tTarget = document.getElementById('gen_target')?.value || '@p';
                const tDest = document.getElementById('gen_dest')?.value || '@s';
                command = `/tp ${tTarget} ${tDest}`;
                break;
            case 'setblock':
                const sbX = document.getElementById('gen_x')?.value || '~';
                const sbY = document.getElementById('gen_y')?.value || '~';
                const sbZ = document.getElementById('gen_z')?.value || '~';
                const sbBlock = document.getElementById('gen_block')?.value || 'minecraft:stone';
                const sbMode = document.getElementById('gen_mode')?.value || 'replace';
                command = `/setblock ${sbX} ${sbY} ${sbZ} ${sbBlock} ${sbMode}`;
                break;
            case 'effect':
                const eTarget = document.getElementById('gen_target')?.value || '@p';
                const eEffect = document.getElementById('gen_effect')?.value || 'minecraft:speed';
                const eDuration = document.getElementById('gen_duration')?.value || '30';
                const eAmplifier = document.getElementById('gen_amplifier')?.value || '0';
                command = `/effect give ${eTarget} ${eEffect} ${eDuration} ${eAmplifier}`;
                break;
        }
        
        if(resultDiv) {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div style="color: var(--mc-green); margin-bottom: 12px;">${escapeHtml(command)}</div>
                <div class="action-buttons" style="margin-top: 0;">
                    <button onclick="copyText('${command.replace(/'/g, "\\'")}')" class="btn btn-primary" style="padding: 6px 14px; font-size: 0.85rem;">
                        <i class="fas fa-copy"></i> ${t('copy')}
                    </button>
                    <button onclick="addToFavorites({id: Date.now(), type: 'command', content: '${command.replace(/'/g, "\\'")}', name: '${type} 指令'})" class="btn btn-secondary" style="padding: 6px 14px; font-size: 0.85rem;">
                        <i class="fas fa-star"></i> ${t('add_favorite')}
                    </button>
                </div>
            `;
        }
    }
    
    function clearGenerator() {
        document.getElementById('genResult').style.display = 'none';
        document.querySelectorAll('#generatorForm input').forEach(input => input.value = '');
    }
    
    // ==================== Target Selector Builder ====================
    function renderSelectorBuilder(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('target_selector')}</h2>
                    <div class="page-subtitle">图形化构建 @e/@a/@p/@r 选择器</div>
                </div>
            </div>
            <div class="input-area">
                <div style="margin-bottom: 16px;">
                    <label style="color: #94a3b8; display: block; margin-bottom: 8px;">目标类型</label>
                    <select id="selType" onchange="updateSelectorPreview()" class="search-input" style="max-width: 300px;">
                        <option value="@p">最近玩家 @p</option>
                        <option value="@a">所有玩家 @a</option>
                        <option value="@r">随机玩家 @r</option>
                        <option value="@e">所有实体 @e</option>
                        <option value="@s">执行者 @s</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="color: #94a3b8; display: block; margin-bottom: 10px;"><i class="fas fa-filter"></i> 过滤条件</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selDistance" onchange="toggleSelectorOption('distance')" style="margin-right: 8px;">
                            <span>距离范围</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selGamemode" onchange="toggleSelectorOption('gamemode')" style="margin-right: 8px;">
                            <span>游戏模式</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selTypeEntity" onchange="toggleSelectorOption('type')" style="margin-right: 8px;">
                            <span>实体类型</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selLimit" onchange="toggleSelectorOption('limit')" style="margin-right: 8px;">
                            <span>限制数量</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selSort" onchange="toggleSelectorOption('sort')" style="margin-right: 8px;">
                            <span>排序方式</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selScores" onchange="toggleSelectorOption('scores')" style="margin-right: 8px;">
                            <span>计分板条件</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selTags" onchange="toggleSelectorOption('tag')" style="margin-right: 8px;">
                            <span>标签</span>
                        </label>
                        <label class="card" style="padding: 12px; cursor: pointer;">
                            <input type="checkbox" id="selTeam" onchange="toggleSelectorOption('team')" style="margin-right: 8px;">
                            <span>队伍</span>
                        </label>
                    </div>
                </div>
                
                <div id="selectorOptions"></div>
                
                <div style="background: rgba(0,0,0,0.4); border-radius: 10px; padding: 16px; margin-top: 20px; border: 1px solid rgba(93,140,58,0.3);">
                    <div style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 8px;">选择器预览</div>
                    <div id="selectorPreview" style="font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; color: var(--mc-green);">@p</div>
                </div>
                
                <div class="action-buttons">
                    <button onclick="copySelector()" class="btn btn-primary"><i class="fas fa-copy"></i> ${t('copy')}</button>
                    <button onclick="addSelectorToFavorites()" class="btn btn-secondary"><i class="fas fa-star"></i> ${t('add_favorite')}</button>
                </div>
            </div>
        `;
    }
    
    function toggleSelectorOption(option) {
        const container = document.getElementById('selectorOptions');
        let optionHtml = '';
        
        const options = {
            distance: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">距离范围</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="distMin" placeholder="最小" class="search-input" style="width: 80px; padding: 8px;" oninput="updateSelectorPreview()">
                        <span style="color: #64748b;">~</span>
                        <input type="number" id="distMax" placeholder="最大" class="search-input" style="width: 80px; padding: 8px;" oninput="updateSelectorPreview()">
                        <span style="color: #64748b; font-size: 0.8rem;">格</span>
                    </div>
                </div>
            `,
            gamemode: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">游戏模式</div>
                    <select id="gamemodeVal" class="search-input" style="max-width: 200px;" onchange="updateSelectorPreview()">
                        <option value="survival">生存模式</option>
                        <option value="creative">创造模式</option>
                        <option value="adventure">冒险模式</option>
                        <option value="spectator">旁观模式</option>
                    </select>
                </div>
            `,
            type: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">实体类型</div>
                    <input type="text" id="typeVal" placeholder="minecraft:zombie" class="search-input" style="max-width: 250px;" oninput="updateSelectorPreview()">
                </div>
            `,
            limit: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">限制数量</div>
                    <input type="number" id="limitVal" placeholder="1" value="1" min="1" class="search-input" style="width: 80px;" oninput="updateSelectorPreview()">
                </div>
            `,
            sort: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">排序方式</div>
                    <select id="sortVal" class="search-input" style="max-width: 200px;" onchange="updateSelectorPreview()">
                        <option value="nearest">最近</option>
                        <option value="furthest">最远</option>
                        <option value="random">随机</option>
                        <option value="arbitrary">任意</option>
                    </select>
                </div>
            `,
            scores: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">计分板条件</div>
                    <input type="text" id="scoresVal" placeholder="kills=1.." class="search-input" style="max-width: 250px;" oninput="updateSelectorPreview()">
                </div>
            `,
            tag: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">标签</div>
                    <input type="text" id="tagVal" placeholder="myTag" class="search-input" style="max-width: 250px;" oninput="updateSelectorPreview()">
                </div>
            `,
            team: `
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="color: #94a3b8; margin-bottom: 8px; font-size: 0.85rem;">队伍</div>
                    <input type="text" id="teamVal" placeholder="red" class="search-input" style="max-width: 250px;" oninput="updateSelectorPreview()">
                </div>
            `
        };
        
        // Rebuild options based on checked checkboxes
        let html = '';
        if(document.getElementById('selDistance')?.checked) html += options.distance;
        if(document.getElementById('selGamemode')?.checked) html += options.gamemode;
        if(document.getElementById('selTypeEntity')?.checked) html += options.type;
        if(document.getElementById('selLimit')?.checked) html += options.limit;
        if(document.getElementById('selSort')?.checked) html += options.sort;
        if(document.getElementById('selScores')?.checked) html += options.scores;
        if(document.getElementById('selTags')?.checked) html += options.tag;
        if(document.getElementById('selTeam')?.checked) html += options.team;
        
        container.innerHTML = html;
        updateSelectorPreview();
    }
    
    function updateSelectorPreview() {
        const type = document.getElementById('selType')?.value || '@p';
        const conditions = [];
        
        if(document.getElementById('selDistance')?.checked) {
            const min = document.getElementById('distMin')?.value;
            const max = document.getElementById('distMax')?.value;
            if(min && max) conditions.push(`distance=${min}..${max}`);
            else if(max) conditions.push(`distance=..${max}`);
            else if(min) conditions.push(`distance=${min}..`);
        }
        if(document.getElementById('selGamemode')?.checked) {
            const gm = document.getElementById('gamemodeVal')?.value;
            if(gm) conditions.push(`gamemode=${gm}`);
        }
        if(document.getElementById('selTypeEntity')?.checked) {
            const t = document.getElementById('typeVal')?.value;
            if(t) conditions.push(`type=${t}`);
        }
        if(document.getElementById('selLimit')?.checked) {
            const l = document.getElementById('limitVal')?.value;
            if(l) conditions.push(`limit=${l}`);
        }
        if(document.getElementById('selSort')?.checked) {
            const s = document.getElementById('sortVal')?.value;
            if(s) conditions.push(`sort=${s}`);
        }
        if(document.getElementById('selScores')?.checked) {
            const sc = document.getElementById('scoresVal')?.value;
            if(sc) conditions.push(`scores={${sc}}`);
        }
        if(document.getElementById('selTags')?.checked) {
            const tg = document.getElementById('tagVal')?.value;
            if(tg) conditions.push(`tag=${tg}`);
        }
        if(document.getElementById('selTeam')?.checked) {
            const tm = document.getElementById('teamVal')?.value;
            if(tm) conditions.push(`team=${tm}`);
        }
        
        const preview = document.getElementById('selectorPreview');
        if(preview) {
            preview.textContent = conditions.length > 0 ? `${type}[${conditions.join(',')}]` : type;
        }
    }
    
    function copySelector() {
        const preview = document.getElementById('selectorPreview')?.textContent;
        if(preview) {
            copyText(preview);
            showToast(t('copied') || '已复制');
        }
    }
    
    function addSelectorToFavorites() {
        const preview = document.getElementById('selectorPreview')?.textContent;
        if(preview) {
            addToFavorites({
                id: Date.now(),
                type: 'selector',
                content: preview,
                name: `选择器: ${preview.substring(0, 20)}`
            });
        }
    }


    
    // ==================== NBT Editor ====================
    function renderNBTEditor(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('nbt_editor')}</h2>
                    <div class="page-subtitle">可视化编辑和解析NBT数据</div>
                </div>
            </div>
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchNBTPanel('editor', this)">NBT编辑器</button>
                <button class="tab-btn" onclick="switchNBTPanel('templates', this)">预设模板</button>
                <button class="tab-btn" onclick="switchNBTPanel('parser', this)">SNBT解析</button>
            </div>
            
            <div id="nbt-panel-editor">
                <div class="input-area">
                    <div style="margin-bottom: 12px;">
                        <span style="color: #64748b; font-size: 0.85rem;"><i class="fas fa-code" style="color: var(--mc-gold);"></i> 输入SNBT字符串或使用模板</span>
                    </div>
                    <textarea class="command-textarea" id="nbtInput" placeholder='{id:"minecraft:diamond",Count:1b,tag:{display:{Name:"\"宝石\""}}}'></textarea>
                    <div class="action-buttons">
                        <button onclick="parseNBTWithNBTify()" class="btn btn-primary" style="background: linear-gradient(135deg, var(--mc-gold), #f59e0b); color: #000;">
                            <i class="fas fa-tree"></i> 解析NBT
                        </button>
                        <button onclick="formatNBT()" class="btn btn-secondary">
                            <i class="fas fa-align-left"></i> 格式化
                        </button>
                        <button onclick="clearNBT()" class="btn btn-secondary">
                            <i class="fas fa-trash"></i> ${t('clear')}
                        </button>
                    </div>
                </div>
                <div id="nbtResult" class="result-panel" style="display: none;">
                    <div class="result-header">
                        <div class="result-title"><i class="fas fa-sitemap"></i> NBT树形结构</div>
                    </div>
                    <div id="nbtTree"></div>
                </div>
            </div>
            
            <div id="nbt-panel-templates" style="display: none;">
                <div class="content-grid">
                    <div class="card" onclick="loadNBTTemplate('item_enchanted')">
                        <div class="card-header">
                            <div class="card-title" style="font-size: 1.1rem;"><i class="fas fa-gem" style="color: var(--mc-gold);"></i> 附魔装备</div>
                        </div>
                        <div class="card-desc">带有多种附魔的钻石剑NBT</div>
                    </div>
                    <div class="card" onclick="loadNBTTemplate('entity_boss')">
                        <div class="card-header">
                            <div class="card-title" style="font-size: 1.1rem;"><i class="fas fa-skull" style="color: #ef4444;"></i> Boss实体</div>
                        </div>
                        <div class="card-desc">高血量装备齐全的精英怪物</div>
                    </div>
                    <div class="card" onclick="loadNBTTemplate('chest_loot')">
                        <div class="card-header">
                            <div class="card-title" style="font-size: 1.1rem;"><i class="fas fa-box" style="color: #f59e0b;"></i> 战利品箱子</div>
                        </div>
                        <div class="card-desc">包含多种物品的箱子NBT</div>
                    </div>
                    <div class="card" onclick="loadNBTTemplate('potion_custom')">
                        <div class="card-header">
                            <div class="card-title" style="font-size: 1.1rem;"><i class="fas fa-flask" style="color: #a855f7;"></i> 自定义药水</div>
                        </div>
                        <div class="card-desc">多效果自定义药水</div>
                    </div>
                </div>
            </div>
            
            <div id="nbt-panel-parser" style="display: none;">
                <div class="input-area">
                    <p style="color: #94a3b8; margin-bottom: 12px;">将游戏中的NBT数据粘贴到这里解析</p>
                    <textarea class="command-textarea" id="nbtParseInput" placeholder="从F3+I复制NBT数据..."></textarea>
                    <div class="action-buttons">
                        <button onclick="parseClipboardNBT()" class="btn btn-primary">
                            <i class="fas fa-paste"></i> 解析剪贴板
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchNBTPanel(panel, btn) {
        document.querySelectorAll('[id^="nbt-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`nbt-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function parseNBTWithNBTify() {
        const input = document.getElementById('nbtInput').value.trim();
        const treeContainer = document.getElementById('nbtTree');
        const resultPanel = document.getElementById('nbtResult');
        
        if(!input) {
            showToast('请输入NBT数据');
            return;
        }
        
        try {
            // Try to use NBTify if available
            if(typeof nbtify !== 'undefined') {
                const parsed = nbtify.parse(input);
                treeContainer.innerHTML = renderNBTTree(parsed, 0);
            } else {
                // Fallback to JSON-like parsing
                const normalized = input.replace(/(\w+):/g, '"$1":')
                                       .replace(/'(.*?)'/g, '"$1"')
                                       .replace(/([0-9]+)[bBsSlLfFdD]/g, '$1');
                const parsed = JSON.parse(normalized);
                treeContainer.innerHTML = renderNBTTree(parsed, 0);
            }
            resultPanel.style.display = 'block';
        } catch(e) {
            treeContainer.innerHTML = `<div style="color: #ef4444;"><i class="fas fa-times-circle"></i> 解析错误: ${e.message}</div>`;
            resultPanel.style.display = 'block';
        }
    }
    
    function renderNBTTree(data, depth, key = null) {
        const indent = depth * 16;
        
        if(data === null) {
            return `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${key}:</span> ` : ''}<span style="color: #64748b;">null</span></div>`;
        }
        
        if(typeof data === 'boolean') {
            return `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${key}:</span> ` : ''}<span class="nbt-boolean">${data}</span></div>`;
        }
        
        if(typeof data === 'number') {
            return `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${key}:</span> ` : ''}<span class="nbt-number">${data}</span></div>`;
        }
        
        if(typeof data === 'string') {
            return `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${key}:</span> ` : ''}<span class="nbt-string">"${escapeHtml(data)}"</span></div>`;
        }
        
        if(Array.isArray(data)) {
            let html = `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${key}:</span> ` : ''}<span style="color: #94a3b8;">[${data.length} items]</span></div>`;
            html += `<div class="nbt-list">`;
            data.forEach((item, i) => {
                html += renderNBTTree(item, depth + 1, `[${i}]`);
            });
            html += `</div>`;
            return html;
        }
        
        if(typeof data === 'object') {
            const entries = Object.entries(data);
            let html = `<div class="nbt-node" style="margin-left: ${indent}px;">${key ? `<span class="nbt-key">${key}:</span> ` : ''}<span style="color: #94a3b8;">{${entries.length} entries}</span></div>`;
            html += `<div class="nbt-list">`;
            entries.forEach(([k, v]) => {
                html += renderNBTTree(v, depth + 1, k);
            });
            html += `</div>`;
            return html;
        }
        
        return '';
    }
    
    function formatNBT() {
        const input = document.getElementById('nbtInput');
        try {
            let normalized = input.value.replace(/(\w+):/g, '"$1":')
                                       .replace(/'(.*?)'/g, '"$1')
                                       .replace(/([0-9]+)[bBsSlLfFdD]/g, '$1');
            const parsed = JSON.parse(normalized);
            input.value = JSON.stringify(parsed, null, 2).replace(/"(\w+)":/g, '$1:');
            showToast('已格式化');
        } catch(e) {
            showToast('格式化失败: ' + e.message);
        }
    }
    
    function clearNBT() {
        document.getElementById('nbtInput').value = '';
        document.getElementById('nbtResult').style.display = 'none';
    }
    
    function loadNBTTemplate(type) {
        const templates = {
            item_enchanted: '{id:"minecraft:diamond_sword",Count:1b,tag:{display:{Name:\'{"text":"Excalibur","italic":false}\',Lore:[\'{"text":"Legendary Blade","color":"gold"}\']},Enchantments:[{id:"minecraft:sharpness",lvl:5s},{id:"minecraft:unbreaking",lvl:3s},{id:"minecraft:mending",lvl:1s}],AttributeModifiers:[{AttributeName:"generic.attack_damage",Name:"generic.attack_damage",Amount:10,Operation:0,UUID:[I;1,2,3,4],Slot:"mainhand"}]}}',
            entity_boss: '{id:"minecraft:zombie",Health:100f,CustomName:\'{"text":"Zombie King","color":"red"}\',CustomNameVisible:1b,ArmorItems:[{id:"minecraft:diamond_boots",Count:1b,tag:{Enchantments:[{id:"minecraft:protection",lvl:4s}]}},{id:"minecraft:diamond_leggings",Count:1b},{id:"minecraft:diamond_chestplate",Count:1b},{id:"minecraft:diamond_helmet",Count:1b}],HandItems:[{id:"minecraft:diamond_sword",Count:1b,tag:{Enchantments:[{id:"minecraft:sharpness",lvl:5s}]}},{}],Attributes:[{Name:"generic.max_health",Base:100},{Name:"generic.attack_damage",Base:15}]}',
            chest_loot: '{Items:[{Slot:0b,id:"minecraft:diamond",Count:16b},{Slot:1b,id:"minecraft:golden_apple",Count:2b},{Slot:2b,id:"minecraft:enchanted_book",Count:1b,tag:{StoredEnchantments:[{id:"minecraft:fortune",lvl:3s}]}},{Slot:13b,id:"minecraft:diamond_sword",Count:1b,tag:{Damage:0}}]}',
            potion_custom: '{Potion:"minecraft:water",CustomPotionEffects:[{Id:1,Amplifier:1,Duration:3600},{Id:5,Amplifier:0,Duration:3600},{Id:8,Amplifier:0,Duration:1200}],CustomPotionColor:16711680}'
        };
        
        document.getElementById('nbtInput').value = templates[type] || '';
        switchNBTPanel('editor', document.querySelectorAll('.tab-btn')[0]);
        parseNBTWithNBTify();
    }
    
    async function parseClipboardNBT() {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('nbtParseInput').value = text;
            document.getElementById('nbtInput').value = text;
            parseNBTWithNBTify();
            showToast('已从剪贴板读取');
        } catch(e) {
            showToast('无法读取剪贴板');
        }
    }
    
    // ==================== MCFunction Editor ====================
    function renderMCFunctionEditor(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('function_editor')}</h2>
                    <div class="page-subtitle">编辑.mcfunction文件，支持语法高亮和验证</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="downloadMCFunction()" class="btn btn-gold">
                        <i class="fas fa-download"></i> ${t('download')}
                    </button>
                    <button onclick="clearMCFunction()" class="btn btn-secondary">
                        <i class="fas fa-trash"></i> ${t('clear')}
                    </button>
                </div>
            </div>
            
            <div class="input-area">
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                    <span class="tag"><i class="fas fa-code"></i> 语法高亮</span>
                    <span class="tag tag-blue"><i class="fas fa-list-ol"></i> 行号显示</span>
                    <span class="tag tag-cyan"><i class="fas fa-check-circle"></i> 实时检查</span>
                </div>
                
                <div class="mcfunction-editor" id="mcfunctionContainer">
                    <div id="mcfunctionLines" style="background: #252526; padding: 10px; border-radius: 10px 0 0 10px; min-width: 45px;">
                        <div style="color: #858585; text-align: right; font-size: 0.8rem; line-height: 1.6;">1</div>
                    </div>
                    <textarea id="mcfunctionInput" 
                        style="flex: 1; background: #1e1e1e; border: none; color: #d4d4d4; font-family: 'JetBrains Mono', monospace; 
                               font-size: 0.85rem; line-height: 1.6; padding: 10px; resize: none; outline: none; min-height: 400px;"
                        placeholder="# 在此输入函数文件内容
# 示例:
say 欢迎使用函数编辑器
give @a minecraft:diamond 1
execute as @p at @s run setblock ~ ~ ~ minecraft:stone"
                        oninput="updateMCFunctionEditor()" onscroll="syncMCFunctionScroll()"></textarea>
                </div>
                
                <div id="mcfunctionStats" style="margin-top: 12px; display: flex; gap: 16px; font-size: 0.85rem; color: #94a3b8;">
                    <span><i class="fas fa-file-code"></i> 行数: <span id="lineCount">1</span></span>
                    <span><i class="fas fa-font"></i> 字符: <span id="charCount">0</span></span>
                    <span id="syntaxStatus"><i class="fas fa-check-circle" style="color: var(--mc-green);"></i> 语法正常</span>
                </div>
            </div>
        `;
    }
    
    function updateMCFunctionEditor() {
        const input = document.getElementById('mcfunctionInput');
        const lines = input.value.split('\n');
        
        // Update line numbers
        const linesContainer = document.getElementById('mcfunctionLines');
        linesContainer.innerHTML = lines.map((_, i) => 
            `<div style="color: #858585; text-align: right; font-size: 0.8rem; line-height: 1.6;">${i + 1}</div>`
        ).join('');
        
        // Update stats
        document.getElementById('lineCount').textContent = lines.length;
        document.getElementById('charCount').textContent = input.value.length;
        
        // Syntax check
        let errors = 0;
        lines.forEach((line, idx) => {
            const trimmed = line.trim();
            if(trimmed && !trimmed.startsWith('#') && !trimmed.startsWith('/') && !trimmed.startsWith('$')) {
                errors++;
            }
        });
        
        const statusEl = document.getElementById('syntaxStatus');
        if(errors > 0) {
            statusEl.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--mc-orange);"></i> ${errors}个警告`;
        } else {
            statusEl.innerHTML = `<i class="fas fa-check-circle" style="color: var(--mc-green);"></i> 语法正常`;
        }
    }
    
    function syncMCFunctionScroll() {
        const input = document.getElementById('mcfunctionInput');
        const lines = document.getElementById('mcfunctionLines');
        lines.scrollTop = input.scrollTop;
    }
    
    function downloadMCFunction() {
        const content = document.getElementById('mcfunctionInput')?.value;
        if(!content) { showToast('没有内容可下载'); return; }
        const blob = new Blob([content], { type: 'text/plain' });
        const filename = `function_${Date.now()}.mcfunction`;
        saveAs(blob, filename);
        showToast('✓ 下载已开始');
    }
    
    function clearMCFunction() {
        if(confirm('确定要清空所有内容吗？')) {
            document.getElementById('mcfunctionInput').value = '';
            updateMCFunctionEditor();
        }
    }
    
    // ==================== Skin Editor ====================
    function renderSkinEditor(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('skin_editor')}</h2>
                    <div class="page-subtitle">3D皮肤预览和编辑 - 使用 SkinView3D</div>
                </div>
            </div>
            
            <div class="content-grid" style="grid-template-columns: 2fr 1fr;">
                <div>
                    <div class="skin-viewer-container" id="skinViewer">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #64748b;">
                            <i class="fas fa-user" style="font-size: 3rem; margin-bottom: 10px;"></i>
                            <p>3D预览区域</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap;">
                        <button onclick="loadSkinFromFile()" class="btn btn-primary">
                            <i class="fas fa-upload"></i> 上传皮肤
                        </button>
                        <button onclick="loadSkinFromUsername()" class="btn btn-secondary">
                            <i class="fas fa-user"></i> 通过用户名加载
                        </button>
                        <button onclick="toggleSkinAnimation()" class="btn btn-secondary">
                            <i class="fas fa-play"></i> 动画
                        </button>
                    </div>
                    <input type="file" id="skinFileInput" accept="image/png" style="display: none;" onchange="handleSkinFile(event)">
                </div>
                
                <div>
                    <div class="input-area">
                        <h3 style="color: var(--mc-gold); margin-bottom: 12px; font-size: 1rem;"><i class="fas fa-sliders-h"></i> 控制面板</h3>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="color: #94a3b8; display: block; margin-bottom: 6px; font-size: 0.85rem;">旋转 X</label>
                            <input type="range" id="skinRotX" min="-180" max="180" value="0" class="search-input" oninput="updateSkinRotation()">
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="color: #94a3b8; display: block; margin-bottom: 6px; font-size: 0.85rem;">旋转 Y</label>
                            <input type="range" id="skinRotY" min="-180" max="180" value="0" class="search-input" oninput="updateSkinRotation()">
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="color: #94a3b8; display: block; margin-bottom: 6px; font-size: 0.85rem;">缩放</label>
                            <input type="range" id="skinZoom" min="0.5" max="2" step="0.1" value="1" class="search-input" oninput="updateSkinZoom()">
                        </div>
                        
                        <div style="margin-bottom: 12px;">
                            <label style="color: #94a3b8; display: block; margin-bottom: 6px; font-size: 0.85rem;">背景颜色</label>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="setSkinBg('#1e1e1e')" style="width: 30px; height: 30px; background: #1e1e1e; border: 2px solid #fff; border-radius: 6px; cursor: pointer;"></button>
                                <button onclick="setSkinBg('#87CEEB')" style="width: 30px; height: 30px; background: #87CEEB; border: 2px solid transparent; border-radius: 6px; cursor: pointer;"></button>
                                <button onclick="setSkinBg('#90EE90')" style="width: 30px; height: 30px; background: #90EE90; border: 2px solid transparent; border-radius: 6px; cursor: pointer;"></button>
                                <button onclick="setSkinBg('#FFB6C1')" style="width: 30px; height: 30px; background: #FFB6C1; border: 2px solid transparent; border-radius: 6px; cursor: pointer;"></button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-area" style="margin-top: 12px;">
                        <h3 style="color: #94a3b8; margin-bottom: 10px; font-size: 0.9rem;">预设皮肤</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <button onclick="loadDefaultSkin('steve')" class="btn btn-secondary" style="padding: 8px; font-size: 0.75rem;">Steve</button>
                            <button onclick="loadDefaultSkin('alex')" class="btn btn-secondary" style="padding: 8px; font-size: 0.75rem;">Alex</button>
                            <button onclick="loadDefaultSkin('creeper')" class="btn btn-secondary" style="padding: 8px; font-size: 0.75rem;">Creeper</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Initialize skin viewer after render
        setTimeout(initSkinViewer, 100);
    }
    
    function initSkinViewer() {
        const container = document.getElementById('skinViewer');
        if(!container || typeof skinview3d === 'undefined') return;
        
        try {
            skinViewer = new skinview3d.SkinViewer({
                canvas: container,
                width: container.clientWidth,
                height: 400,
                skin: 'https://crafatar.com/skins/8667ba71b85a4004af54457a9734eed7' // Default Steve
            });
            
            // Add controls
            const control = new skinview3d.OrbitControls(skinViewer);
            control.enableZoom = true;
            control.enablePan = false;
            
            skinViewer.animation = new skinview3d.WalkingAnimation();
            skinViewer.animation.paused = true;
            
        } catch(e) {
            console.log('Skin viewer initialization failed:', e);
        }
    }
    
    function loadSkinFromFile() {
        document.getElementById('skinFileInput')?.click();
    }
    
    function handleSkinFile(event) {
        const file = event.target.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            if(skinViewer) {
                skinViewer.loadSkin(e.target.result);
                showToast('皮肤已加载');
            }
        };
        reader.readAsDataURL(file);
    }
    
    function loadSkinFromUsername() {
        const username = prompt('输入Minecraft用户名:');
        if(!username) return;
        
        if(skinViewer) {
            skinViewer.loadSkin(`https://crafatar.com/skins/${username}`);
            showToast(`已加载 ${username} 的皮肤`);
        }
    }
    
    function loadDefaultSkin(type) {
        const skins = {
            steve: '8667ba71b85a4004af54457a9734eed7',
            alex: '6d85bfd515e8496ba8d5dc78573b5f1c',
            creeper: 'be18bd008a1c4c1aa5190b5b8c0a21fb'
        };
        
        if(skinViewer && skins[type]) {
            skinViewer.loadSkin(`https://crafatar.com/skins/${skins[type]}`);
            showToast(`已加载 ${type} 皮肤`);
        }
    }
    
    function toggleSkinAnimation() {
        if(skinViewer?.animation) {
            skinViewer.animation.paused = !skinViewer.animation.paused;
            showToast(skinViewer.animation.paused ? '动画已暂停' : '动画已播放');
        }
    }
    
    function updateSkinRotation() {
        if(!skinViewer) return;
        const x = document.getElementById('skinRotX')?.value || 0;
        const y = document.getElementById('skinRotY')?.value || 0;
        skinViewer.player.rotation.x = x * Math.PI / 180;
        skinViewer.player.rotation.y = y * Math.PI / 180;
    }
    
    function updateSkinZoom() {
        if(!skinViewer) return;
        const zoom = document.getElementById('skinZoom')?.value || 1;
        skinViewer.zoom = zoom;
    }
    
    function setSkinBg(color) {
        document.getElementById('skinViewer').style.background = color;
    }


    
    // ==================== Particle Editor ====================
    function renderParticleEditor(container) {
        const particles = [
            { id: 'minecraft:flame', name: '火焰', color: '#ff6b35' },
            { id: 'minecraft:smoke', name: '烟雾', color: '#808080' },
            { id: 'minecraft:lava', name: '岩浆', color: '#ff4500' },
            { id: 'minecraft:heart', name: '爱心', color: '#ff69b4' },
            { id: 'minecraft:note', name: '音符', color: '#9370db' },
            { id: 'minecraft:crit', name: '暴击', color: '#00ffff' },
            { id: 'minecraft:magic_crit', name: '魔法暴击', color: '#ff00ff' },
            { id: 'minecraft:enchantmenttable', name: '附魔', color: '#9400d3' },
            { id: 'minecraft:portal', name: '传送门', color: '#9932cc' },
            { id: 'minecraft:redstone', name: '红石', color: '#ff0000' },
            { id: 'minecraft:slime', name: '史莱姆', color: '#00ff00' },
            { id: 'minecraft:snowballpoof', name: '雪球', color: '#ffffff' },
            { id: 'minecraft:largeexplode', name: '大爆炸', color: '#ffa500' },
            { id: 'minecraft:hugeexplosion', name: '巨大爆炸', color: '#ff4500' },
            { id: 'minecraft:splash', name: '水花', color: '#4169e1' },
            { id: 'minecraft:witchmagic', name: '女巫魔法', color: '#800080' }
        ];
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('particle_editor')}</h2>
                    <div class="page-subtitle">基岩版粒子效果生成器</div>
                </div>
            </div>
            
            <div class="content-grid" style="grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));">
                ${particles.map(p => `
                    <div class="card" onclick="selectParticle('${p.id}')" style="text-align: center; cursor: pointer; border-top: 3px solid ${p.color};">
                        <div style="width: 40px; height: 40px; margin: 0 auto 8px; border-radius: 50%; background: ${p.color}; box-shadow: 0 0 10px ${p.color};"></div>
                        <div class="card-title" style="font-size: 0.9rem;">${p.name}</div>
                        <div style="font-size: 0.7rem; color: #64748b; margin-top: 4px;">${p.id.replace('minecraft:', '')}</div>
                    </div>
                `).join('')}
            </div>
            
            <div id="particleConfig" class="input-area" style="margin-top: 20px; display: none;">
                <h3 style="color: #22d3ee; margin-bottom: 16px;"><i class="fas fa-cog"></i> 粒子配置</h3>
                <div style="display: grid; gap: 12px;">
                    <div><label style="color: #94a3b8;">粒子ID</label>
                        <input type="text" id="particleId" class="search-input" readonly></div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div><label style="color: #94a3b8;">X坐标</label>
                            <input type="text" id="particleX" class="search-input" value="~" placeholder="~"></div>
                        <div><label style="color: #94a3b8;">Y坐标</label>
                            <input type="text" id="particleY" class="search-input" value="~" placeholder="~"></div>
                        <div><label style="color: #94a3b8;">Z坐标</label>
                            <input type="text" id="particleZ" class="search-input" value="~" placeholder="~"></div>
                    </div>
                    <div><label style="color: #94a3b8;">粒子数据 (可选)</label>
                        <input type="text" id="particleData" class="search-input" placeholder="如: 1"></div>
                </div>
                <div class="action-buttons">
                    <button onclick="generateParticleCommand()" class="btn btn-primary" style="background: linear-gradient(135deg, #22d3ee, #0891b2);">
                        <i class="fas fa-magic"></i> 生成指令
                    </button>
                </div>
                <div id="particleResult" style="margin-top: 12px; padding: 12px; background: rgba(6,182,212,0.1); border-radius: 8px; font-family: 'JetBrains Mono', monospace; display: none;"></div>
            </div>
        `;
    }
    
    function selectParticle(id) {
        document.getElementById('particleConfig').style.display = 'block';
        document.getElementById('particleId').value = id;
        document.getElementById('particleResult').style.display = 'none';
        document.getElementById('particleConfig').scrollIntoView({ behavior: 'smooth' });
    }
    
    function generateParticleCommand() {
        const id = document.getElementById('particleId').value;
        const x = document.getElementById('particleX').value || '~';
        const y = document.getElementById('particleY').value || '~';
        const z = document.getElementById('particleZ').value || '~';
        const data = document.getElementById('particleData').value;
        
        // Bedrock format
        let command = `/particle ${id.replace('minecraft:', '')} ${x} ${y} ${z}`;
        if(data) command += ` ${data}`;
        
        const resultDiv = document.getElementById('particleResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="color: #22d3ee; margin-bottom: 8px;">${escapeHtml(command)}</div>
            <button onclick="copyText('${command.replace(/'/g, "\\'")}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">
                <i class="fas fa-copy"></i> ${t('copy')}
            </button>
        `;
    }
    
    // ==================== Material Calculator ====================
    function renderMaterialCalculator(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('material_calculator')}</h2>
                    <div class="page-subtitle">计算建筑所需材料</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchMaterialPanel('blocks', this)">方块计算</button>
                <button class="tab-btn" onclick="switchMaterialPanel('items', this)">物品合成</button>
                <button class="tab-btn" onclick="switchMaterialPanel('beacon', this)">信标金字塔</button>
            </div>
            
            <div id="material-panel-blocks">
                <div class="input-area">
                    <h3 style="color: #4ade80; margin-bottom: 16px;"><i class="fas fa-cube"></i> 方块数量计算</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div><label style="color: #94a3b8;">长度</label>
                            <input type="number" id="blockLength" class="search-input" placeholder="0" min="0" oninput="calculateBlocks()"></div>
                        <div><label style="color: #94a3b8;">宽度</label>
                            <input type="number" id="blockWidth" class="search-input" placeholder="0" min="0" oninput="calculateBlocks()"></div>
                        <div><label style="color: #94a3b8;">高度</label>
                            <input type="number" id="blockHeight" class="search-input" placeholder="1" value="1" min="1" oninput="calculateBlocks()"></div>
                    </div>
                    <div style="margin-top: 16px; padding: 16px; background: rgba(74,222,128,0.1); border-radius: 10px; border: 1px solid rgba(74,222,128,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #94a3b8;">所需方块总数:</span>
                            <span id="blockTotal" style="font-family: 'VT323', monospace; font-size: 2rem; color: #4ade80;">0</span>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.85rem; color: #64748b;">
                            等于 <span id="blockStacks">0</span> 组 + <span id="blockRemainder">0</span> 个
                        </div>
                    </div>
                </div>
                
                <div class="content-grid">
                    <div class="card">
                        <div class="card-title" style="color: #4ade80;">常用材料</div>
                        <div class="card-desc" style="margin-top: 8px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                                <span class="tag">石头</span>
                                <span class="tag">木头</span>
                                <span class="tag">圆石</span>
                                <span class="tag">泥土</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title" style="color: #fbbf24;">装饰方块</div>
                        <div class="card-desc" style="margin-top: 8px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                                <span class="tag tag-gold">羊毛</span>
                                <span class="tag tag-gold">玻璃</span>
                                <span class="tag tag-gold">混凝土</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="material-panel-items" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #fbbf24; margin-bottom: 16px;"><i class="fas fa-crafting"></i> 合成计算器</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div><label style="color: #94a3b8;">目标物品</label>
                            <select id="craftItem" class="search-input" onchange="calculateCrafting()">
                                <option value="">选择物品...</option>
                                <option value="planks:4">橡木木板 (1原木→4)</option>
                                <option value="sticks:4">木棍 (2木板→4)</option>
                                <option value="crafting_table:1">工作台 (4木板→1)</option>
                                <option value="chest:1">箱子 (8木板→1)</option>
                                <option value="torch:4">火把 (1煤+1木棍→4)</option>
                                <option value="ladder:3">梯子 (7木棍→3)</option>
                                <option value="fence:3">栅栏 (4木板+2木棍→3)</option>
                                <option value="door:3">门 (6木板→3)</option>
                                <option value="glass_pane:16">玻璃板 (6玻璃→16)</option>
                                <option value="iron_block:1">铁块 (9铁锭→1)</option>
                                <option value="gold_block:1">金块 (9金锭→1)</option>
                                <option value="diamond_block:1">钻石块 (9钻石→1)</option>
                            </select></div>
                        <div><label style="color: #94a3b8;">需要数量</label>
                            <input type="number" id="craftAmount" class="search-input" placeholder="1" value="1" min="1" oninput="calculateCrafting()"></div>
                    </div>
                    <div id="craftResult" style="margin-top: 16px; display: none;"></div>
                </div>
            </div>
            
            <div id="material-panel-beacon" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #fbbf24; margin-bottom: 16px;"><i class="fas fa-star"></i> 信标金字塔计算器</h3>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; display: block; margin-bottom: 8px;">金字塔层数</label>
                        <select id="beaconLayers" class="search-input" onchange="calculateBeacon()" style="max-width: 200px;">
                            <option value="1">1层 (3×3)</option>
                            <option value="2">2层 (5×5)</option>
                            <option value="3">3层 (7×7)</option>
                            <option value="4">4层 (9×9)</option>
                        </select>
                    </div>
                    <div style="padding: 16px; background: rgba(251,191,36,0.1); border-radius: 10px; border: 1px solid rgba(251,191,36,0.3);">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div><span style="color: #94a3b8;">所需矿物块:</span>
                                <div id="beaconBlocks" style="font-family: 'VT323', monospace; font-size: 1.8rem; color: #fbbf24;">9</div></div>
                            <div><span style="color: #94a3b8;">所需矿物锭:</span>
                                <div id="beaconIngots" style="font-family: 'VT323', monospace; font-size: 1.8rem; color: #fbbf24;">81</div></div>
                        </div>
                        <div style="margin-top: 12px; font-size: 0.85rem; color: #64748b;">
                            效果范围: <span id="beaconRange">20</span> 格 | 效果时长: <span id="beaconDuration">11</span> 秒
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchMaterialPanel(panel, btn) {
        document.querySelectorAll('[id^="material-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`material-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function calculateBlocks() {
        const l = parseInt(document.getElementById('blockLength')?.value) || 0;
        const w = parseInt(document.getElementById('blockWidth')?.value) || 0;
        const h = parseInt(document.getElementById('blockHeight')?.value) || 1;
        
        const total = l * w * h;
        const stacks = Math.floor(total / 64);
        const remainder = total % 64;
        
        document.getElementById('blockTotal').textContent = total.toLocaleString();
        document.getElementById('blockStacks').textContent = stacks;
        document.getElementById('blockRemainder').textContent = remainder;
    }
    
    function calculateCrafting() {
        const itemVal = document.getElementById('craftItem')?.value;
        const amount = parseInt(document.getElementById('craftAmount')?.value) || 1;
        const resultDiv = document.getElementById('craftResult');
        
        if(!itemVal) {
            resultDiv.style.display = 'none';
            return;
        }
        
        const [item, ratio] = itemVal.split(':');
        const ratioNum = parseInt(ratio);
        const batches = Math.ceil(amount / ratioNum);
        
        const recipes = {
            planks: { '原木': 1 },
            sticks: { '木板': 2 },
            crafting_table: { '木板': 4 },
            chest: { '木板': 8 },
            torch: { '煤/木炭': 1, '木棍': 1 },
            ladder: { '木棍': 7 },
            fence: { '木板': 4, '木棍': 2 },
            door: { '木板': 6 },
            glass_pane: { '玻璃': 6 },
            iron_block: { '铁锭': 9 },
            gold_block: { '金锭': 9 },
            diamond_block: { '钻石': 9 }
        };
        
        let html = '<div style="color: #fbbf24; margin-bottom: 8px;">所需材料:</div>';
        const recipe = recipes[item];
        if(recipe) {
            for(const [mat, count] of Object.entries(recipe)) {
                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 6px;">
                    <span>${mat}</span>
                    <span style="color: #fbbf24; font-weight: 600;">${count * batches}</span>
                </div>`;
            }
        }
        
        resultDiv.innerHTML = html;
        resultDiv.style.display = 'block';
    }
    
    function calculateBeacon() {
        const layers = parseInt(document.getElementById('beaconLayers')?.value) || 1;
        
        const layerBlocks = [9, 25, 49, 81];
        const ranges = [20, 30, 40, 50];
        const durations = [11, 13, 15, 17];
        
        const totalBlocks = layerBlocks.slice(0, layers).reduce((a, b) => a + b, 0);
        
        document.getElementById('beaconBlocks').textContent = totalBlocks;
        document.getElementById('beaconIngots').textContent = totalBlocks * 9;
        document.getElementById('beaconRange').textContent = ranges[layers - 1];
        document.getElementById('beaconDuration').textContent = durations[layers - 1];
    }
    
    // ==================== Enchantment Tool ====================
    function renderEnchantmentTool(container) {
        const enchantments = [
            { id: 'protection', name: '保护', max: 4 },
            { id: 'fire_protection', name: '火焰保护', max: 4 },
            { id: 'feather_falling', name: '摔落保护', max: 4 },
            { id: 'blast_protection', name: '爆炸保护', max: 4 },
            { id: 'projectile_protection', name: '弹射物保护', max: 4 },
            { id: 'respiration', name: '水下呼吸', max: 3 },
            { id: 'aqua_affinity', name: '水下速掘', max: 1 },
            { id: 'thorns', name: '荆棘', max: 3 },
            { id: 'depth_strider', name: '深海探索者', max: 3 },
            { id: 'frost_walker', name: '冰霜行者', max: 2 },
            { id: 'soul_speed', name: '灵魂疾行', max: 3 },
            { id: 'sharpness', name: '锋利', max: 5 },
            { id: 'smite', name: '亡灵杀手', max: 5 },
            { id: 'bane_of_arthropods', name: '节肢杀手', max: 5 },
            { id: 'knockback', name: '击退', max: 2 },
            { id: 'fire_aspect', name: '火焰附加', max: 2 },
            { id: 'looting', name: '抢夺', max: 3 },
            { id: 'sweeping', name: '横扫之刃', max: 3 },
            { id: 'efficiency', name: '效率', max: 5 },
            { id: 'silk_touch', name: '精准采集', max: 1 },
            { id: 'unbreaking', name: '耐久', max: 3 },
            { id: 'fortune', name: '时运', max: 3 },
            { id: 'power', name: '力量', max: 5 },
            { id: 'punch', name: '冲击', max: 2 },
            { id: 'flame', name: '火矢', max: 1 },
            { id: 'infinity', name: '无限', max: 1 },
            { id: 'luck_of_the_sea', name: '海之眷顾', max: 3 },
            { id: 'lure', name: '饵钓', max: 3 },
            { id: 'loyalty', name: '忠诚', max: 3 },
            { id: 'impaling', name: '穿刺', max: 5 },
            { id: 'riptide', name: '激流', max: 3 },
            { id: 'channeling', name: '引雷', max: 1 },
            { id: 'multishot', name: '多重射击', max: 1 },
            { id: 'quick_charge', name: '快速装填', max: 3 },
            { id: 'piercing', name: '穿透', max: 4 },
            { id: 'mending', name: '经验修补', max: 1 },
            { id: 'vanishing_curse', name: '消失诅咒', max: 1 },
            { id: 'binding_curse', name: '绑定诅咒', max: 1 }
        ];
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('enchantment')}</h2>
                    <div class="page-subtitle">附魔成本计算器 & 最优顺序推荐</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchEnchantPanel('calculator', this)">附魔计算器</button>
                <button class="tab-btn" onclick="switchEnchantPanel('optimal', this)">最优顺序</button>
                <button class="tab-btn" onclick="switchEnchantPanel('probability', this)">附魔概率</button>
            </div>
            
            <div id="enchant-panel-calculator">
                <div class="input-area">
                    <h3 style="color: #60a5fa; margin-bottom: 16px;"><i class="fas fa-calculator"></i> 铁砧成本计算</h3>
                    <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 12px;">选择要添加的附魔，计算所需经验等级</p>
                    
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
                        ${enchantments.map(e => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" class="enchant-check" data-id="${e.id}" data-max="${e.max}" onchange="calculateEnchantCost()">
                                    <span style="margin-left: 8px;">${e.name}</span>
                                </label>
                                <select class="enchant-level" data-id="${e.id}" onchange="calculateEnchantCost()" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 4px 8px; color: #fff; width: 70px;">
                                    ${Array.from({length: e.max}, (_, i) => `<option value="${i+1}">${i+1}级</option>`).join('')}
                                </select>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 16px; padding: 16px; background: rgba(96,165,250,0.1); border-radius: 10px; border: 1px solid rgba(96,165,250,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: #94a3b8;">预计总成本:</span>
                            <span id="enchantTotalCost" style="font-family: 'VT323', monospace; font-size: 2rem; color: #60a5fa;">0</span>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.85rem; color: #64748b;">
                            经验等级 (可能需要多次铁砧操作)
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="generateEnchantCommand()" class="btn btn-primary" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);">
                            <i class="fas fa-magic"></i> 生成give指令
                        </button>
                        <button onclick="clearEnchantSelection()" class="btn btn-secondary">清除选择</button>
                    </div>
                    
                    <div id="enchantCommandResult" style="margin-top: 12px; display: none;"></div>
                </div>
            </div>
            
            <div id="enchant-panel-optimal" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #fbbf24; margin-bottom: 16px;"><i class="fas fa-sort-amount-down"></i> 最优附魔顺序</h3>
                    <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 12px;">根据贪心算法，按以下顺序附魔可以最小化经验成本</p>
                    <ol style="color: #e2e8f0; line-height: 2;">
                        <li>从高等级到低等级依次附魔</li>
                        <li>先附魔成本高的附魔</li>
                        <li>将两件已附魔物品合并时，成本是两者之和+合并惩罚</li>
                        <li>建议顺序: 耐久→经验修补→主要附魔(锋利/保护等)→次要附魔</li>
                    </ol>
                    <div style="margin-top: 16px; padding: 12px; background: rgba(251,191,36,0.1); border-radius: 8px;">
                        <div style="color: #fbbf24; font-size: 0.85rem;">💡 提示: 使用附魔书在铁砧上附魔时，书籍的获取顺序也会影响最终成本</div>
                    </div>
                </div>
            </div>
            
            <div id="enchant-panel-probability" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #a855f7; margin-bottom: 16px;"><i class="fas fa-dice"></i> 附魔台概率</h3>
                    <p style="color: #94a3b8; font-size: 0.85rem;">附魔台提供的附魔等级取决于书架数量(0-15个)</p>
                    <div style="margin-top: 16px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <tr style="background: rgba(255,255,255,0.05);">
                                <th style="padding: 10px; text-align: left; color: #94a3b8;">书架数</th>
                                <th style="padding: 10px; text-align: center; color: #94a3b8;">最低等级</th>
                                <th style="padding: 10px; text-align: center; color: #94a3b8;">最高等级</th>
                            </tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">0</td><td style="text-align: center;">1</td><td style="text-align: center;">5</td></tr>
                            <tr style="background: rgba(255,255,255,0.03);"><td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">1-8</td><td style="text-align: center;">1-5</td><td style="text-align: center;">8-13</td></tr>
                            <tr><td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">9-14</td><td style="text-align: center;">1-11</td><td style="text-align: center;">14-24</td></tr>
                            <tr style="background: rgba(255,255,255,0.03);"><td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">15</td><td style="text-align: center;">1-17</td><td style="text-align: center;">17-30</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchEnchantPanel(panel, btn) {
        document.querySelectorAll('[id^="enchant-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`enchant-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function calculateEnchantCost() {
        const checks = document.querySelectorAll('.enchant-check:checked');
        let totalCost = 0;
        
        checks.forEach(check => {
            const id = check.dataset.id;
            const level = document.querySelector(`.enchant-level[data-id="${id}"]`)?.value || 1;
            // Simple cost calculation (actual formula is more complex)
            const baseCost = { protection: 1, sharpness: 1, efficiency: 1, power: 1 };
            const cost = (baseCost[id] || 2) * parseInt(level);
            totalCost += cost;
        });
        
        // Add penalty for multiple enchantments
        if(checks.length > 1) {
            totalCost += (checks.length - 1) * 2;
        }
        
        document.getElementById('enchantTotalCost').textContent = totalCost;
    }
    
    function generateEnchantCommand() {
        const checks = document.querySelectorAll('.enchant-check:checked');
        if(checks.length === 0) {
            showToast('请先选择附魔');
            return;
        }
        
        const enchantments = [];
        checks.forEach(check => {
            const id = check.dataset.id;
            const level = document.querySelector(`.enchant-level[data-id="${id}"]`)?.value || 1;
            enchantments.push(`{id:"minecraft:${id}",lvl:${level}s}`);
        });
        
        const command = `/give @p minecraft:diamond_sword{Enchantments:[${enchantments.join(',')}]} 1`;
        
        const resultDiv = document.getElementById('enchantCommandResult');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; margin-bottom: 10px;">
                ${escapeHtml(command)}
            </div>
            <button onclick="copyText('${command.replace(/'/g, "\\'")}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">
                <i class="fas fa-copy"></i> ${t('copy')}
            </button>
        `;
    }
    
    function clearEnchantSelection() {
        document.querySelectorAll('.enchant-check').forEach(c => c.checked = false);
        document.getElementById('enchantTotalCost').textContent = '0';
        document.getElementById('enchantCommandResult').style.display = 'none';
    }


    
    // ==================== XP Calculator ====================
    function renderXPCalculator(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('xp_calculator')}</h2>
                    <div class="page-subtitle">经验等级与点数转换计算</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchXPPanel('level', this)">等级计算器</button>
                <button class="tab-btn" onclick="switchXPPanel('points', this)">点数计算器</button>
                <button class="tab-btn" onclick="switchXPPanel('anvil', this)">铁砧惩罚</button>
            </div>
            
            <div id="xp-panel-level">
                <div class="input-area">
                    <h3 style="color: #fbbf24; margin-bottom: 16px;"><i class="fas fa-chart-line"></i> 等级与点数转换</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="color: #94a3b8; display: block; margin-bottom: 8px;">目标等级</label>
                            <input type="number" id="targetLevel" class="search-input" placeholder="30" min="0" max="1000" oninput="calculateXPFromLevel()">
                            <div style="margin-top: 12px; padding: 12px; background: rgba(251,191,36,0.1); border-radius: 8px;">
                                <span style="color: #94a3b8;">所需总经验:</span>
                                <div id="xpFromLevelResult" style="font-family: 'VT323', monospace; font-size: 1.8rem; color: #fbbf24;">0</div>
                            </div>
                        </div>
                        <div>
                            <label style="color: #94a3b8; display: block; margin-bottom: 8px;">经验点数</label>
                            <input type="number" id="xpPoints" class="search-input" placeholder="1000" min="0" oninput="calculateLevelFromXP()">
                            <div style="margin-top: 12px; padding: 12px; background: rgba(251,191,36,0.1); border-radius: 8px;">
                                <span style="color: #94a3b8;">可达等级:</span>
                                <div id="levelFromXPResult" style="font-family: 'VT323', monospace; font-size: 1.8rem; color: #fbbf24;">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: #94a3b8; margin-bottom: 10px;">经验来源参考</h4>
                        <div class="content-grid" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));">
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">1-3</div><div style="font-size: 0.8rem; color: #94a3b8;">击杀怪物</div></div>
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">0.2</div><div style="font-size: 0.8rem; color: #94a3b8;">挖掘 coal</div></div>
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">1-7</div><div style="font-size: 0.8rem; color: #94a3b8;">挖掘钻石</div></div>
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">2-4</div><div style="font-size: 0.8rem; color: #94a3b8;">钓鱼/繁殖</div></div>
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">0.35</div><div style="font-size: 0.8rem; color: #94a3b8;">烧炼物品</div></div>
                            <div class="card" style="padding: 12px;"><div style="color: #fbbf24; font-size: 1.2rem;">50+</div><div style="font-size: 0.8rem; color: #94a3b8;">击杀末影龙</div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="xp-panel-points" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #4ade80; margin-bottom: 16px;"><i class="fas fa-calculator"></i> 经验点数计算器</h3>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; display: block; margin-bottom: 8px;">当前等级</label>
                        <input type="number" id="currentLvl" class="search-input" placeholder="0" min="0" oninput="calculateXPPoints()">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; display: block; margin-bottom: 8px;">当前经验条进度 (%)</label>
                        <input type="number" id="currentProgress" class="search-input" placeholder="0" min="0" max="100" oninput="calculateXPPoints()">
                    </div>
                    <div style="padding: 16px; background: rgba(74,222,128,0.1); border-radius: 10px; border: 1px solid rgba(74,222,128,0.3);">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">当前总经验:</span>
                                <div id="currentTotalXP" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #4ade80;">0</div>
                            </div>
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">升到下一级需要:</span>
                                <div id="xpToNext" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #4ade80;">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="xp-panel-anvil" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #f97316; margin-bottom: 16px;"><i class="fas fa-hammer"></i> 铁砧操作惩罚</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">每次在铁砧上操作都会增加"操作惩罚"，导致后续操作更昂贵</p>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="color: #94a3b8; display: block; margin-bottom: 8px;">物品已操作次数</label>
                        <input type="number" id="anvilCount" class="search-input" placeholder="0" min="0" max="6" oninput="calculateAnvilPenalty()">
                    </div>
                    
                    <div style="padding: 16px; background: rgba(249,115,22,0.1); border-radius: 10px; border: 1px solid rgba(249,115,22,0.3);">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">额外经验惩罚:</span>
                                <div id="anvilPenalty" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #f97316;">0</div>
                            </div>
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">操作后惩罚等级:</span>
                                <div id="nextPenalty" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #f97316;">1</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; font-size: 0.85rem; color: #64748b;">
                            公式: 惩罚 = 2^n - 1 (n为操作次数)
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchXPPanel(panel, btn) {
        document.querySelectorAll('[id^="xp-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`xp-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function getXPForLevel(level) {
        if(level <= 16) return level * level + 6 * level;
        if(level <= 31) return 2.5 * level * level - 40.5 * level + 360;
        return 4.5 * level * level - 162.5 * level + 2220;
    }
    
    function getLevelFromXP(xp) {
        let level = 0;
        while(getXPForLevel(level + 1) <= xp) level++;
        return level;
    }
    
    function calculateXPFromLevel() {
        const level = parseInt(document.getElementById('targetLevel')?.value) || 0;
        const xp = getXPForLevel(level);
        document.getElementById('xpFromLevelResult').textContent = Math.floor(xp).toLocaleString();
    }
    
    function calculateLevelFromXP() {
        const xp = parseInt(document.getElementById('xpPoints')?.value) || 0;
        const level = getLevelFromXP(xp);
        document.getElementById('levelFromXPResult').textContent = level;
    }
    
    function calculateXPPoints() {
        const level = parseInt(document.getElementById('currentLvl')?.value) || 0;
        const progress = parseInt(document.getElementById('currentProgress')?.value) || 0;
        
        const totalXP = getXPForLevel(level);
        const nextLevelXP = getXPForLevel(level + 1);
        const currentLevelXP = totalXP + (nextLevelXP - totalXP) * (progress / 100);
        
        document.getElementById('currentTotalXP').textContent = Math.floor(currentLevelXP).toLocaleString();
        document.getElementById('xpToNext').textContent = Math.ceil(nextLevelXP - currentLevelXP).toLocaleString();
    }
    
    function calculateAnvilPenalty() {
        const count = parseInt(document.getElementById('anvilCount')?.value) || 0;
        const penalty = Math.pow(2, count) - 1;
        document.getElementById('anvilPenalty').textContent = penalty;
        document.getElementById('nextPenalty').textContent = count + 1;
    }
    
    // ==================== Smelting Calculator ====================
    function renderSmeltingCalculator(container) {
        const fuels = [
            { name: '煤炭', time: 80, items: 8 },
            { name: '木炭', time: 80, items: 8 },
            { name: '煤炭块', time: 800, items: 80 },
            { name: '原木', time: 15, items: 1.5 },
            { name: '木板', time: 15, items: 1.5 },
            { name: '木棍', time: 1, items: 0.1 },
            { name: '岩浆桶', time: 1000, items: 100 },
            { name: '烈焰棒', time: 120, items: 12 },
            { name: '干海带块', time: 200, items: 20 },
            { name: '脚手架', time: 2, items: 0.2 }
        ];
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('smelting')}</h2>
                    <div class="page-subtitle">熔炼燃料计算与时间管理</div>
                </div>
            </div>
            
            <div class="content-grid" style="grid-template-columns: 2fr 1fr;">
                <div class="input-area">
                    <h3 style="color: #f97316; margin-bottom: 16px;"><i class="fas fa-fire"></i> 燃料计算器</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="color: #94a3b8; display: block; margin-bottom: 8px;">要熔炼的物品数量</label>
                            <input type="number" id="smeltItems" class="search-input" placeholder="64" min="1" oninput="calculateFuelNeeded()">
                        </div>
                        <div>
                            <label style="color: #94a3b8; display: block; margin-bottom: 8px;">选择燃料类型</label>
                            <select id="fuelType" class="search-input" onchange="calculateFuelNeeded()">
                                ${fuels.map(f => `<option value="${f.items}">${f.name} (${f.items}个物品)</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div style="padding: 16px; background: rgba(249,115,22,0.1); border-radius: 10px; border: 1px solid rgba(249,115,22,0.3);">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">需要燃料:</span>
                                <div id="fuelNeeded" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #f97316;">0</div>
                            </div>
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">熔炼时间:</span>
                                <div id="smeltTime" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #f97316;">0s</div>
                            </div>
                            <div>
                                <span style="color: #94a3b8; font-size: 0.85rem;">获得经验:</span>
                                <div id="smeltXP" style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #f97316;">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <h3 style="color: #fbbf24; margin-bottom: 12px; font-size: 1rem;"><i class="fas fa-list"></i> 燃料列表</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${fuels.map(f => `
                            <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span style="font-size: 0.85rem;">${f.name}</span>
                                <span style="color: #f97316; font-size: 0.85rem;">${f.items} 物品</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <div class="content-grid" style="margin-top: 20px;">
                <div class="card">
                    <div class="card-title" style="color: #f97316;">熔炼技巧</div>
                    <ul style="color: #94a3b8; font-size: 0.85rem; margin-top: 10px; padding-left: 16px; line-height: 1.8;">
                        <li>使用漏斗自动输入/输出提高效率</li>
                        <li>煤炭块是性价比最高的燃料</li>
                        <li>岩浆桶可以熔炼100个物品</li>
                    </ul>
                </div>
                <div class="card">
                    <div class="card-title" style="color: #4ade80;">经验农场</div>
                    <ul style="color: #94a3b8; font-size: 0.85rem; margin-top: 10px; padding-left: 16px; line-height: 1.8;">
                        <li>烧炼圆石→石头获得经验</li>
                        <li>仙人掌农场可以无限获取燃料</li>
                        <li>海带干块是海洋农场的好选择</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    function calculateFuelNeeded() {
        const items = parseInt(document.getElementById('smeltItems')?.value) || 0;
        const fuelPower = parseFloat(document.getElementById('fuelType')?.value) || 8;
        
        const fuelNeeded = Math.ceil(items / fuelPower);
        const smeltTime = items * 10; // 10 seconds per item
        const xpGained = items * 0.1; // approx 0.1 xp per smelt
        
        document.getElementById('fuelNeeded').textContent = fuelNeeded;
        document.getElementById('smeltTime').textContent = smeltTime >= 60 
            ? Math.floor(smeltTime / 60) + '分' + (smeltTime % 60) + '秒' 
            : smeltTime + '秒';
        document.getElementById('smeltXP').textContent = xpGained.toFixed(1);
    }
    
    // ==================== Coordinate Converter ====================
    function renderCoordConverter(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('coord_convert')}</h2>
                    <div class="page-subtitle">不同坐标系之间的转换</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchCoordPanel('overworld', this)">主世界↔下界</button>
                <button class="tab-btn" onclick="switchCoordPanel('spherical', this)">球面坐标</button>
                <button class="tab-btn" onclick="switchCoordPanel('chunk', this)">区块坐标</button>
            </div>
            
            <div id="coord-panel-overworld">
                <div class="input-area">
                    <h3 style="color: #22d3ee; margin-bottom: 16px;"><i class="fas fa-exchange-alt"></i> 主世界与下界坐标转换</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">下界坐标 = 主世界坐标 ÷ 8 (X和Z轴)</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="padding: 16px; background: rgba(34,211,238,0.1); border-radius: 10px; border: 1px solid rgba(34,211,238,0.3);">
                            <h4 style="color: #22d3ee; margin-bottom: 12px;"><i class="fas fa-globe"></i> 主世界</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                                <input type="number" id="overworldX" class="search-input" placeholder="X" oninput="convertToNether()">
                                <input type="number" id="overworldY" class="search-input" placeholder="Y">
                                <input type="number" id="overworldZ" class="search-input" placeholder="Z" oninput="convertToNether()">
                            </div>
                        </div>
                        
                        <div style="padding: 16px; background: rgba(220,38,38,0.1); border-radius: 10px; border: 1px solid rgba(220,38,38,0.3);">
                            <h4 style="color: #ef4444; margin-bottom: 12px;"><i class="fas fa-fire"></i> 下界</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                                <input type="number" id="netherX" class="search-input" placeholder="X" oninput="convertToOverworld()">
                                <input type="number" id="netherY" class="search-input" placeholder="Y">
                                <input type="number" id="netherZ" class="search-input" placeholder="Z" oninput="convertToOverworld()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="copyCoords('overworld')" class="btn btn-secondary" style="padding: 8px 14px; font-size: 0.85rem;">
                            <i class="fas fa-copy"></i> 复制主世界
                        </button>
                        <button onclick="copyCoords('nether')" class="btn btn-secondary" style="padding: 8px 14px; font-size: 0.85rem;">
                            <i class="fas fa-copy"></i> 复制下界
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="coord-panel-spherical" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #a855f7; margin-bottom: 16px;"><i class="fas fa-globe-americas"></i> 球面坐标转换</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">用于计算两点之间的距离和方向</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 16px;">
                        <div>
                            <h4 style="color: #94a3b8; margin-bottom: 10px;">起点坐标</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <input type="number" id="sphereX1" class="search-input" placeholder="X">
                                <input type="number" id="sphereZ1" class="search-input" placeholder="Z">
                            </div>
                        </div>
                        <div>
                            <h4 style="color: #94a3b8; margin-bottom: 10px;">终点坐标</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <input type="number" id="sphereX2" class="search-input" placeholder="X">
                                <input type="number" id="sphereZ2" class="search-input" placeholder="Z">
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="calculateSphericalCoords()" class="btn btn-primary" style="background: linear-gradient(135deg, #a855f7, #7c3aed);">
                        <i class="fas fa-calculator"></i> 计算
                    </button>
                    
                    <div id="sphericalResult" style="margin-top: 16px; display: none;"></div>
                </div>
            </div>
            
            <div id="coord-panel-chunk" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #4ade80; margin-bottom: 16px;"><i class="fas fa-th"></i> 区块坐标转换</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">世界坐标与区块坐标的转换</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="color: #94a3b8;">世界坐标</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                                <input type="number" id="worldChunkX" class="search-input" placeholder="X" oninput="convertToChunk()">
                                <input type="number" id="worldChunkZ" class="search-input" placeholder="Z" oninput="convertToChunk()">
                            </div>
                        </div>
                        <div>
                            <label style="color: #94a3b8;">区块坐标</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                                <input type="number" id="chunkX" class="search-input" placeholder="Chunk X" oninput="convertToWorld()">
                                <input type="number" id="chunkZ" class="search-input" placeholder="Chunk Z" oninput="convertToWorld()">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: rgba(74,222,128,0.1); border-radius: 8px;">
                        <span style="color: #94a3b8; font-size: 0.85rem;">区块内坐标: </span>
                        <span id="chunkLocal" style="color: #4ade80;">0, 0</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchCoordPanel(panel, btn) {
        document.querySelectorAll('[id^="coord-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`coord-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function convertToNether() {
        const x = parseInt(document.getElementById('overworldX')?.value) || 0;
        const z = parseInt(document.getElementById('overworldZ')?.value) || 0;
        const y = parseInt(document.getElementById('overworldY')?.value) || 64;
        
        document.getElementById('netherX').value = Math.floor(x / 8);
        document.getElementById('netherZ').value = Math.floor(z / 8);
        document.getElementById('netherY').value = y;
    }
    
    function convertToOverworld() {
        const x = parseInt(document.getElementById('netherX')?.value) || 0;
        const z = parseInt(document.getElementById('netherZ')?.value) || 0;
        const y = parseInt(document.getElementById('netherY')?.value) || 64;
        
        document.getElementById('overworldX').value = x * 8;
        document.getElementById('overworldZ').value = z * 8;
        document.getElementById('overworldY').value = y;
    }
    
    function copyCoords(type) {
        const x = document.getElementById(`${type}X`)?.value || 0;
        const y = document.getElementById(`${type}Y`)?.value || 64;
        const z = document.getElementById(`${type}Z`)?.value || 0;
        copyText(`${x} ${y} ${z}`);
        showToast('坐标已复制');
    }
    
    function calculateSphericalCoords() {
        const x1 = parseInt(document.getElementById('sphereX1')?.value) || 0;
        const z1 = parseInt(document.getElementById('sphereZ1')?.value) || 0;
        const x2 = parseInt(document.getElementById('sphereX2')?.value) || 0;
        const z2 = parseInt(document.getElementById('sphereZ2')?.value) || 0;
        
        const dx = x2 - x1;
        const dz = z2 - z1;
        const distance = Math.sqrt(dx * dx + dz * dz);
        
        // Calculate angle (in degrees, 0 = +Z, 90 = -X, 180 = -Z, 270 = +X)
        let angle = Math.atan2(dx, dz) * 180 / Math.PI;
        if(angle < 0) angle += 360;
        
        // Convert to Minecraft facing
        const facing = ['南 (-Z)', '西南', '西 (-X)', '西北', '北 (+Z)', '东北', '东 (+X)', '东南'][Math.round(angle / 45) % 8];
        
        document.getElementById('sphericalResult').innerHTML = `
            <div style="padding: 16px; background: rgba(168,85,247,0.1); border-radius: 10px; border: 1px solid rgba(168,85,247,0.3);">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div><span style="color: #94a3b8;">直线距离:</span>
                        <div style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #a855f7;">${Math.round(distance)} 格</div></div>
                    <div><span style="color: #94a3b8;">方向:</span>
                        <div style="font-family: 'VT323', monospace; font-size: 1.6rem; color: #a855f7;">${facing}</div></div>
                </div>
                <div style="margin-top: 8px; color: #94a3b8; font-size: 0.85rem;">
                    角度: ${Math.round(angle)}° | ΔX: ${dx}, ΔZ: ${dz}
                </div>
            </div>
        `;
        document.getElementById('sphericalResult').style.display = 'block';
    }
    
    function convertToChunk() {
        const x = parseInt(document.getElementById('worldChunkX')?.value) || 0;
        const z = parseInt(document.getElementById('worldChunkZ')?.value) || 0;
        
        document.getElementById('chunkX').value = Math.floor(x / 16);
        document.getElementById('chunkZ').value = Math.floor(z / 16);
        document.getElementById('chunkLocal').textContent = `${x & 15}, ${z & 15}`;
    }
    
    function convertToWorld() {
        const cx = parseInt(document.getElementById('chunkX')?.value) || 0;
        const cz = parseInt(document.getElementById('chunkZ')?.value) || 0;
        
        document.getElementById('worldChunkX').value = cx * 16;
        document.getElementById('worldChunkZ').value = cz * 16;
    }


    
    // ==================== Structure Extractor ====================
    function renderStructureExtractor(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('structure_extractor')}</h2>
                    <div class="page-subtitle">Java版和基岩版存档结构提取与转移</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchStructurePanel('java', this)">Java版</button>
                <button class="tab-btn" onclick="switchStructurePanel('bedrock', this)">基岩版</button>
                <button class="tab-btn" onclick="switchStructurePanel('convert', this)">格式转换</button>
            </div>
            
            <div id="structure-panel-java">
                <div class="input-area">
                    <h3 style="color: #f59e0b; margin-bottom: 16px;"><i class="fas fa-coffee"></i> Java版结构文件 (.nbt)</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">从存档的 generated/minecraft/structures/ 目录中提取</p>
                    
                    <div style="border: 2px dashed rgba(245,158,11,0.3); border-radius: 12px; padding: 30px; text-align: center; margin-bottom: 16px;"
                         ondragover="event.preventDefault()" ondrop="handleStructureDrop(event, 'java')">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; color: #f59e0b; margin-bottom: 10px;"></i>
                        <p style="color: #94a3b8;">拖拽 .nbt 文件到此处</p>
                        <input type="file" id="javaStructureInput" accept=".nbt" style="display: none;" onchange="handleStructureFile(event, 'java')">
                        <button onclick="document.getElementById('javaStructureInput').click()" class="btn btn-secondary" style="margin-top: 10px;">
                            选择文件
                        </button>
                    </div>
                    
                    <div id="javaStructureInfo" style="display: none;">
                        <h4 style="color: #f59e0b; margin-bottom: 10px;">结构信息</h4>
                        <div id="javaStructureDetails"></div>
                    </div>
                </div>
            </div>
            
            <div id="structure-panel-bedrock" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #22d3ee; margin-bottom: 16px;"><i class="fas fa-mobile-alt"></i> 基岩版结构文件</h3>
                    <p style="color: #94a3b8; margin-bottom: 16px;">基岩版结构存储在世界数据库中，可使用行为包导出</p>
                    
                    <div class="content-grid">
                        <div class="card">
                            <div class="card-title" style="color: #22d3ee;">使用结构方块</div>
                            <div class="card-desc" style="margin-top: 8px;">
                                1. 放置结构方块<br>
                                2. 设置保存区域<br>
                                3. 命名并保存<br>
                                4. 导出到行为包
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-title" style="color: #22d3ee;">使用外部工具</div>
                            <div class="card-desc" style="margin-top: 8px;">
                                推荐: Universal Minecraft Editor<br>
                                或: MCEdit (旧版本)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="structure-panel-convert" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #a855f7; margin-bottom: 16px;"><i class="fas fa-exchange-alt"></i> 结构格式转换</h3>
                    <p style="color: #94a3b8;">在 Java 版和基岩版结构格式之间转换</p>
                    
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 16px;"></i>
                        <p>功能开发中，请使用外部工具如:</p>
                        <p style="margin-top: 10px;">• jmc2obj (Java→OBJ)</p>
                        <p>• MCCToolChest (跨版本转换)</p>
                    </div>
                </div>
            </div>
        `;
    }
    
    function switchStructurePanel(panel, btn) {
        document.querySelectorAll('[id^="structure-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`structure-panel-${panel}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function handleStructureDrop(event, type) {
        event.preventDefault();
        const files = event.dataTransfer.files;
        if(files.length > 0) {
            processStructureFile(files[0], type);
        }
    }
    
    function handleStructureFile(event, type) {
        const file = event.target.files[0];
        if(file) processStructureFile(file, type);
    }
    
    function processStructureFile(file, type) {
        showToast(`已加载: ${file.name}`);
        // Structure file processing would go here
        document.getElementById('javaStructureInfo').style.display = 'block';
        document.getElementById('javaStructureDetails').innerHTML = `
            <div style="padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <span style="color: #64748b;">文件名:</span><span>${file.name}</span>
                    <span style="color: #64748b;">大小:</span><span>${(file.size / 1024).toFixed(2)} KB</span>
                    <span style="color: #64748b;">类型:</span><span>${type.toUpperCase()}</span>
                </div>
            </div>
        `;
    }
    
    // ==================== Seed Map & Slime Finder ====================
    function renderSeedMap(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('seed_map')}</h2>
                    <div class="page-subtitle">种子地图查看器 (基础版)</div>
                </div>
            </div>
            
            <div class="input-area">
                <h3 style="color: #a855f7; margin-bottom: 16px;"><i class="fas fa-map"></i> 种子分析</h3>
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <input type="text" id="seedInput" class="search-input" placeholder="输入世界种子..." style="flex: 1;">
                    <button onclick="analyzeSeed()" class="btn btn-primary" style="background: linear-gradient(135deg, #a855f7, #7c3aed);">
                        <i class="fas fa-search"></i> 分析
                    </button>
                </div>
                
                <div id="seedResult" style="display: none;"></div>
                
                <div style="margin-top: 20px; padding: 16px; background: rgba(168,85,247,0.1); border-radius: 10px;">
                    <p style="color: #94a3b8; font-size: 0.85rem;">
                        <i class="fas fa-info-circle"></i> 提示: 使用 <a href="https://www.chunkbase.com/apps/seed-map" target="_blank" style="color: #a855f7;">Chunkbase</a> 获得更详细的种子地图
                    </p>
                </div>
            </div>
        `;
    }
    
    function analyzeSeed() {
        const seed = document.getElementById('seedInput')?.value;
        if(!seed) {
            showToast('请输入种子');
            return;
        }
        
        // Simple seed hash for demonstration
        let hash = 0;
        for(let i = 0; i < seed.length; i++) {
            hash = ((hash << 5) - hash) + seed.charCodeAt(i);
            hash |= 0;
        }
        
        const biomes = ['平原', '森林', '沙漠', '热带草原', '针叶林', '沼泽', '蘑菇岛', '恶地'];
        const structures = ['村庄', '掠夺者前哨站', '沙漠神殿', '丛林神庙', '海底遗迹', '要塞'];
        
        document.getElementById('seedResult').innerHTML = `
            <div style="padding: 16px; background: rgba(168,85,247,0.1); border-radius: 10px; border: 1px solid rgba(168,85,247,0.3);">
                <h4 style="color: #a855f7; margin-bottom: 12px;">种子分析结果</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div>
                        <span style="color: #94a3b8; font-size: 0.85rem;">可能的主要生态:</span>
                        <div style="color: #e2e8f0; margin-top: 4px;">${biomes[Math.abs(hash) % biomes.length]}</div>
                    </div>
                    <div>
                        <span style="color: #94a3b8; font-size: 0.85rem;">附近结构:</span>
                        <div style="color: #e2e8f0; margin-top: 4px;">${structures[Math.abs(hash >> 4) % structures.length]}</div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('seedResult').style.display = 'block';
    }
    
    function renderSlimeFinder(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('slime_finder')}</h2>
                    <div class="page-subtitle">查找史莱姆区块</div>
                </div>
            </div>
            
            <div class="input-area">
                <h3 style="color: #4ade80; margin-bottom: 16px;"><i class="fas fa-th"></i> 史莱姆区块计算器</h3>
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <input type="text" id="slimeSeed" class="search-input" placeholder="输入世界种子..." style="flex: 1;">
                    <button onclick="findSlimeChunks()" class="btn btn-primary" style="background: linear-gradient(135deg, #4ade80, #16a34a);">
                        <i class="fas fa-search"></i> 查找
                    </button>
                </div>
                
                <div id="slimeResult" style="display: none;"></div>
                
                <div style="margin-top: 20px;">
                    <h4 style="color: #94a3b8; margin-bottom: 10px;">关于史莱姆区块</h4>
                    <ul style="color: #94a3b8; font-size: 0.85rem; padding-left: 20px; line-height: 1.8;">
                        <li>Java版中约 1/10 的区块是史莱姆区块</li>
                        <li>史莱姆只在 Y < 40 的区域生成</li>
                        <li>史莱姆区块的位置由世界种子决定</li>
                        <li> swamp 生物群系在满月时史莱姆生成率最高</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    function findSlimeChunks() {
        const seed = document.getElementById('slimeSeed')?.value;
        if(!seed) {
            showToast('请输入种子');
            return;
        }
        
        // Simple slime chunk calculation (Java edition algorithm simplified)
        let seedNum = parseInt(seed);
        if(isNaN(seedNum)) {
            // Hash string seed
            seedNum = 0;
            for(let i = 0; i < seed.length; i++) {
                seedNum = ((seedNum << 5) - seedNum) + seed.charCodeAt(i);
                seedNum |= 0;
            }
        }
        
        // Generate some "slime chunks" for display
        const slimeChunks = [];
        const rnd = (s) => {
            s = Math.sin(s) * 10000;
            return s - Math.floor(s);
        };
        
        for(let x = -10; x <= 10; x++) {
            for(let z = -10; z <= 10; z++) {
                const chunkSeed = seedNum + x * x * 0x4c1906 + x * 0x5ac0db + z * z * 0x4307a7 + z * 0x5f24f;
                if(rnd(chunkSeed) < 0.1) {
                    slimeChunks.push({x, z});
                }
            }
        }
        
        // Display simple grid
        let gridHtml = '<div style="display: inline-grid; grid-template-columns: repeat(21, 20px); gap: 1px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">';
        for(let z = -10; z <= 10; z++) {
            for(let x = -10; x <= 10; x++) {
                const isSlime = slimeChunks.some(c => c.x === x && c.z === z);
                gridHtml += `<div style="width: 20px; height: 20px; background: ${isSlime ? '#4ade80' : '#374151'}; border-radius: 2px;" title="${x}, ${z}"></div>`;
            }
        }
        gridHtml += '</div>';
        
        document.getElementById('slimeResult').innerHTML = `
            <div style="padding: 16px; background: rgba(74,222,128,0.1); border-radius: 10px; border: 1px solid rgba(74,222,128,0.3);">
                <h4 style="color: #4ade80; margin-bottom: 12px;">史莱姆区块分布 (中心区域)</h4>
                <div style="overflow-x: auto;">${gridHtml}</div>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #64748b;">
                    <span style="display: inline-block; width: 12px; height: 12px; background: #4ade80; border-radius: 2px; margin-right: 4px;"></span> 史莱姆区块
                    <span style="display: inline-block; width: 12px; height: 12px; background: #374151; border-radius: 2px; margin-left: 10px; margin-right: 4px;"></span> 普通区块
                </div>
            </div>
        `;
        document.getElementById('slimeResult').style.display = 'block';
    }
    
    // ==================== AI Assistant ====================
    function renderAIPage(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('ai_assistant')}</h2>
                    <div class="page-subtitle">自然语言转换为Minecraft指令</div>
                </div>
            </div>
            
            <div class="input-area">
                <div style="margin-bottom: 12px;">
                    <span style="color: #64748b; font-size: 0.9rem;">
                        <i class="fas fa-robot" style="color: var(--mc-purple);"></i> 描述你想要实现的效果
                    </span>
                </div>
                <textarea class="command-textarea" id="aiInput" placeholder="例如: 给最近的玩家一把附魔锋利V的钻石剑"></textarea>
                <div class="action-buttons">
                    <button onclick="aiGenerateCommand()" class="btn btn-primary" style="background: linear-gradient(135deg, var(--mc-purple), #7c3aed);">
                        <i class="fas fa-magic"></i> AI生成命令
                    </button>
                </div>
            </div>
            
            <div id="aiResult"></div>
            
            <div style="margin-top: 24px; background: rgba(147,51,234,0.1); border-radius: 14px; padding: 18px; border: 1px solid rgba(147,51,234,0.3);">
                <h3 style="color: var(--mc-purple); margin-bottom: 14px; font-size: 1rem;">
                    <i class="fas fa-lightbulb"></i> 示例提示
                </h3>
                <div class="content-grid" style="grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));">
                    <div class="card" onclick="setAIInput('给最近的玩家传送一套钻石装备')" style="cursor: pointer; border-top-color: var(--mc-purple); padding: 14px;">
                        <div class="card-desc" style="font-size: 0.85rem;">给最近的玩家传送一套钻石装备</div>
                    </div>
                    <div class="card" onclick="setAIInput('召唤一只带着鞍的马')" style="cursor: pointer; border-top-color: var(--mc-purple); padding: 14px;">
                        <div class="card-desc" style="font-size: 0.85rem;">召唤一只带着鞍的马</div>
                    </div>
                    <div class="card" onclick="setAIInput('创建一个计分板显示击杀数')" style="cursor: pointer; border-top-color: var(--mc-purple); padding: 14px;">
                        <div class="card-desc" style="font-size: 0.85rem;">创建一个计分板显示击杀数</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function setAIInput(text) {
        document.getElementById('aiInput').value = text;
    }
    
    function aiGenerateCommand() {
        const input = document.getElementById('aiInput').value.trim();
        const result = document.getElementById('aiResult');
        
        if(!input) {
            showToast('请输入描述');
            return;
        }
        
        // Simple keyword matching for demo
        let command = '';
        let confidence = 0;
        
        const lower = input.toLowerCase();
        
        if(lower.includes('钻石') && lower.includes('装备')) {
            command = '/give @p minecraft:diamond_helmet\n/give @p minecraft:diamond_chestplate\n/give @p minecraft:diamond_leggings\n/give @p minecraft:diamond_boots';
            confidence = 85;
        } else if(lower.includes('马') && lower.includes('鞍')) {
            command = '/summon minecraft:horse ~ ~ ~ {Tame:1b, SaddleItem:{id:"minecraft:saddle",Count:1b}}';
            confidence = 90;
        } else if(lower.includes('计分板') && lower.includes('击杀')) {
            command = '/scoreboard objectives add kills totalKillCount "击杀数"\n/scoreboard objectives setdisplay sidebar kills';
            confidence = 80;
        } else if(lower.includes('锋利') || lower.includes('剑')) {
            command = '/give @p minecraft:diamond_sword{Enchantments:[{id:"minecraft:sharpness",lvl:5s}]} 1';
            confidence = 75;
        } else {
            command = '/say 抱歉，暂无法识别该指令。请尝试更具体的描述。';
            confidence = 0;
        }
        
        result.innerHTML = `
            <div class="result-panel" style="animation: fadeInUp 0.3s ease;">
                <div class="result-header">
                    <div class="result-title" style="color: var(--mc-purple);">
                        <i class="fas fa-robot"></i> AI生成结果
                    </div>
                    <div style="color: ${confidence >= 80 ? '#4ade80' : confidence >= 50 ? '#fbbf24' : '#ef4444'};">
                        置信度: ${confidence}%
                    </div>
                </div>
                <div style="background: rgba(0,0,0,0.4); padding: 14px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; color: #e2e8f0; margin-bottom: 12px; border-left: 3px solid var(--mc-purple);">
                    ${escapeHtml(command).replace(/\n/g, '<br>')}
                </div>
                <div class="action-buttons">
                    <button onclick="copyText('${command.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')" class="btn btn-primary">
                        <i class="fas fa-copy"></i> ${t('copy')}
                    </button>
                    <button onclick="addToFavorites({id: Date.now(), type: 'ai_command', content: '${command.replace(/'/g, "\\'")}', name: 'AI: ${input.substring(0, 15)}...'})" class="btn btn-secondary">
                        <i class="fas fa-star"></i> ${t('add_favorite')}
                    </button>
                </div>
            </div>
        `;
    }
    
    // ==================== Version Compare ====================
    function renderComparePage(container) {
        const versionData = {
            '1.13': { name: '水域更新', changes: ['扁平化', 'execute重写', '数据包'], color: '#22d3ee' },
            '1.14': { name: '村庄与掠夺', changes: ['新村庄', '掠夺者', '营火'], color: '#f97316' },
            '1.15': { name: '嗡嗡蜂群', changes: ['蜜蜂', '蜂蜜'], color: '#fbbf24' },
            '1.16': { name: '下界更新', changes: ['新下界', '猪灵', '远古残骸'], color: '#dc2626' },
            '1.17': { name: '洞穴与山崖 I', changes: ['新洞穴', '美西螈', '发光鱿鱼'], color: '#a855f7' },
            '1.18': { name: '洞穴与山崖 II', changes: ['地形更新', '高度扩展'], color: '#4ade80' },
            '1.19': { name: '荒野更新', changes: ['深暗之域', '监守者', '红树'], color: '#0ea5e9' },
            '1.20': { name: '足迹与故事', changes: ['樱花', '考古', '饰纹陶罐'], color: '#f472b6' },
            '1.21': { name: '棘巧试炼', changes: ['试炼密室', '旋风人', '重锤'], color: '#84cc16' }
        };
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('version_compare')}</h2>
                    <div class="page-subtitle">Minecraft Java版版本更新对比</div>
                </div>
            </div>
            
            <div class="content-grid">
                ${Object.entries(versionData).map(([ver, info]) => `
                    <div class="card" style="border-top-color: ${info.color};">
                        <div class="card-header">
                            <div>
                                <div class="card-title" style="color: ${info.color};">1.${ver.split('.')[1]}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">${info.name}</div>
                            </div>
                            <span class="tag" style="background: ${info.color}20; color: ${info.color};">${ver}</span>
                        </div>
                        <div class="card-desc">
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                                ${info.changes.map(c => `<span style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${c}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="input-area" style="margin-top: 20px;">
                <h3 style="color: #fbbf24; margin-bottom: 16px;"><i class="fas fa-code-branch"></i> 版本指令差异</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <tr style="background: rgba(255,255,255,0.05);">
                            <th style="padding: 12px; text-align: left; color: #94a3b8; border-bottom: 1px solid rgba(255,255,255,0.1);">变化</th>
                            <th style="padding: 12px; text-align: left; color: #94a3b8; border-bottom: 1px solid rgba(255,255,255,0.1);">旧版本</th>
                            <th style="padding: 12px; text-align: left; color: #94a3b8; border-bottom: 1px solid rgba(255,255,255,0.1);">新版本</th>
                        </tr>
                        <tr>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #fbbf24;">execute</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">execute @p ~ ~ ~ say hi</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">execute as @p run say hi</td>
                        </tr>
                        <tr style="background: rgba(255,255,255,0.03);">
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #fbbf24;">数字ID</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">give @p 1 64</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">give @p minecraft:stone 64</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #fbbf24;">选择器</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">@a[r=10,m=0]</td>
                            <td style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);">@a[distance=..10,gamemode=survival]</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
    }
    
    // ==================== Converter Page ====================
    function renderConverterPage(container) {
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('converter')}</h2>
                    <div class="page-subtitle">多引擎指令转换系统</div>
                </div>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchConverterTab('java', this)">Java版转换</button>
                <button class="tab-btn" onclick="switchConverterTab('bedrock', this)">基岩版转换</button>
            </div>
            
            <div id="converter-panel-java">
                <div class="input-area">
                    <h3 style="color: var(--mc-green); margin-bottom: 12px;">多引擎验证转换</h3>
                    <textarea class="command-textarea" id="converterInput" placeholder="输入需要转换的指令..."></textarea>
                    <div class="action-buttons">
                        <button onclick="processConversion()" class="btn btn-primary">
                            <i class="fas fa-cogs"></i> 转换
                        </button>
                        <button onclick="clearConversion()" class="btn btn-secondary">${t('clear')}</button>
                    </div>
                </div>
                <div id="converterResult"></div>
            </div>
            
            <div id="converter-panel-bedrock" style="display: none;">
                <div class="input-area">
                    <h3 style="color: #22d3ee; margin-bottom: 12px;">基岩版格式转换</h3>
                    <textarea class="command-textarea" id="bedrockConverterInput" placeholder="输入Java版指令转换为基岩版..."></textarea>
                    <div class="action-buttons">
                        <button onclick="convertToBedrock()" class="btn btn-primary" style="background: linear-gradient(135deg, #22d3ee, #0891b2);">
                            <i class="fas fa-exchange-alt"></i> 转基岩版
                        </button>
                        <button onclick="clearBedrockConversion()" class="btn btn-secondary">${t('clear')}</button>
                    </div>
                </div>
                <div id="bedrockConverterResult"></div>
            </div>
        `;
    }
    
    function switchConverterTab(tab, btn) {
        document.querySelectorAll('[id^="converter-panel-"]').forEach(el => el.style.display = 'none');
        document.getElementById(`converter-panel-${tab}`).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function processConversion() {
        const input = document.getElementById('converterInput').value;
        if(!input.trim()) {
            showToast('请输入指令');
            return;
        }
        
        // Simple conversion for demo
        let output = input;
        const changes = [];
        
        if(input.match(/execute\s+@\w+\s+[~-]?\d/)) {
            output = output.replace(/execute\s+(@\w+)\s+([~-]?\d+\s+[~-]?\d+\s+[~-]?\d+)\s*/, 'execute as $1 at @s positioned $2 ');
            changes.push('转换旧版execute语法');
        }
        
        if(input.match(/@\w+\[r=/)) {
            output = output.replace(/r=(\d+)/g, 'distance=..$1');
            changes.push('r= → distance=');
        }
        
        document.getElementById('converterResult').innerHTML = `
            <div class="result-panel">
                <div class="result-header">
                    <div class="result-title"><i class="fas fa-check-circle"></i> 转换结果</div>
                </div>
                ${changes.length > 0 ? `<div style="margin-bottom: 12px;">${changes.map(c => `<span class="tag" style="margin-right: 6px;">${c}</span>`).join('')}</div>` : ''}
                <div style="background: rgba(0,0,0,0.4); padding: 14px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; color: var(--mc-green); margin-bottom: 12px;">
                    ${escapeHtml(output)}
                </div>
                <button onclick="copyText('${output.replace(/'/g, "\\'")}')" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.85rem;">
                    <i class="fas fa-copy"></i> ${t('copy')}
                </button>
            </div>
        `;
    }
    
    function convertToBedrock() {
        const input = document.getElementById('bedrockConverterInput').value;
        if(!input.trim()) {
            showToast('请输入指令');
            return;
        }
        
        let output = input;
        output = output.replace(/minecraft:/g, '');
        output = output.replace(/@\w+\[[^\]]*\]/g, (match) => match.split('[')[0]);
        output = output.replace(/execute\s+as\s+(@\w+)\s+at\s+@s\s+run\s+/g, 'execute $1 ');
        output = output.replace(/\{[^}]*\}/g, '');
        
        document.getElementById('bedrockConverterResult').innerHTML = `
            <div class="result-panel">
                <div class="result-header">
                    <div class="result-title" style="color: #22d3ee;"><i class="fas fa-check-circle"></i> 基岩版结果</div>
                </div>
                <div style="background: rgba(6,182,212,0.1); padding: 14px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; color: #22d3ee; margin-bottom: 12px;">
                    ${escapeHtml(output)}
                </div>
                <button onclick="copyText('${output.replace(/'/g, "\\'")}')" class="btn btn-primary" style="background: linear-gradient(135deg, #22d3ee, #0891b2); padding: 8px 16px; font-size: 0.85rem;">
                    <i class="fas fa-copy"></i> ${t('copy')}
                </button>
            </div>
        `;
    }
    
    function clearConversion() {
        document.getElementById('converterInput').value = '';
        document.getElementById('converterResult').innerHTML = '';
    }
    
    function clearBedrockConversion() {
        document.getElementById('bedrockConverterInput').value = '';
        document.getElementById('bedrockConverterResult').innerHTML = '';
    }


    
    // ==================== Credits & Contributors ====================
    const DEFAULT_CREDITS = [
        { name: "轮回道尘", role: "项目创始人", desc: "创建并维护本项目", date: "2025-09", link: "https://afdian.com/a/daoze1" },
        { name: "Minecraft Wiki", role: "资料参考", desc: "提供完整的指令文档", link: "https://minecraft.wiki/" },
        { name: "Tailwind CSS", role: "UI框架", desc: "提供优雅的样式工具", link: "https://tailwindcss.com/" }
    ];
    
    const DEFAULT_CONTRIBUTORS = [
        { name: "轮回道尘", role: "主要开发者", contributions: ["架构设计", "功能开发", "UI设计"], date: "2025-09" }
    ];
    
    function renderCreditsPage(container) {
        let creditsHtml = '';
        if(data.credits.length === 0) data.credits = DEFAULT_CREDITS;
        
        creditsHtml = data.credits.map((credit, index) => `
            <div class="card" style="animation: fadeInUp 0.5s ease ${index * 0.05}s both;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                    <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--mc-gold), #f59e0b); display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #fff;">${credit.name}</div>
                        <div style="font-size: 0.8rem; color: var(--mc-gold);">${credit.role}</div>
                    </div>
                </div>
                <div style="color: #94a3b8; font-size: 0.85rem;">${credit.desc || ''}</div>
                ${credit.link ? `<a href="${credit.link}" target="_blank" style="color: #64748b; font-size: 0.8rem; margin-top: 8px; display: inline-block;"><i class="fas fa-external-link-alt"></i> 访问链接</a>` : ''}
            </div>
        `).join('');
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('supporters')}</h2>
                    <div class="page-subtitle">感谢所有支持者</div>
                </div>
            </div>
            <div class="content-grid">${creditsHtml}</div>
        `;
    }
    
    function renderContributorsPage(container) {
        if(data.contributors.length === 0) data.contributors = DEFAULT_CONTRIBUTORS;
        
        const contributorsHtml = data.contributors.map((c, index) => `
            <div class="card" style="animation: fadeInUp 0.5s ease ${index * 0.05}s both; border-left: 3px solid var(--mc-gold);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                    <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #a855f7, #7c3aed); display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                        <i class="fas fa-code"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #fff;">${c.name}</div>
                        <div style="font-size: 0.8rem; color: #a855f7;">${c.role}</div>
                    </div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                    ${c.contributions.map(con => `<span class="tag tag-purple" style="font-size: 0.75rem;">${con}</span>`).join('')}
                </div>
            </div>
        `).join('');
        
        container.innerHTML = `
            <div class="page-header">
                <div>
                    <h2 class="page-title">${t('developers')}</h2>
                    <div class="page-subtitle">项目贡献开发者</div>
                </div>
            </div>
            <div class="content-grid">${contributorsHtml}</div>
        `;
    }
    
    // ==================== Data Parsing ====================
    function processContent(text, filename) {
        const lower = filename.toLowerCase();
        
        if(lower.includes('item')) {
            data.items.push(...parseItems(text));
        } else if(lower.includes('redstone')) {
            data.redstone.push(...parseRedstone(text));
        } else if(lower.includes('block')) {
            data.blocks.push(...parseBlocks(text));
        } else if(lower.includes('advancement')) {
            data.advancements.push(...parseAdvancements(text));
        } else {
            let source = 'unknown';
            if(lower.includes('java')) source = 'java';
            else if(lower.includes('bedrock')) source = 'bedrock';
            else if(lower.includes('edu')) source = 'education';
            parseCommands(text, source);
        }
        
        updateStats();
        updateFilters();
        renderContent();
        saveToStorage();
    }
    
    function parseItems(text) {
        const items = [];
        const entries = text.split(/(?=【)/);
        for(const entry of entries) {
            if(!entry.includes('【')) continue;
            const lines = entry.trim().split('\n');
            let item = {};
            for(const line of lines) {
                if(line.includes('【') && line.includes('】')) item.name = cleanText(line);
                else if(line.includes('ID')) item.id = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('分类')) item.category = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('简介')) item.desc = cleanText(line.split(/[：:]/)[1] || '');
            }
            if(item.name) items.push(item);
        }
        return items;
    }
    
    function parseRedstone(text) {
        const items = [];
        const entries = text.split(/(?=【)/);
        for(const entry of entries) {
            if(!entry.includes('【')) continue;
            const lines = entry.trim().split('\n');
            let item = { features: [] };
            for(const line of lines) {
                if(line.includes('【') && line.includes('】')) item.name = cleanText(line);
                else if(line.includes('类型')) item.type = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('功能')) item.desc = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('特性')) item.features.push(cleanText(line.split(/[：:]/)[1] || ''));
            }
            if(item.name) items.push(item);
        }
        return items;
    }
    
    function parseBlocks(text) {
        const blocks = [];
        const entries = text.split(/(?=【)/);
        for(const entry of entries) {
            if(!entry.includes('【')) continue;
            const lines = entry.trim().split('\n');
            let block = { tips: [] };
            for(const line of lines) {
                if(line.includes('【') && line.includes('】')) block.name = cleanText(line);
                else if(line.includes('类型')) block.type = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('功能')) block.desc = cleanText(line.split(/[：:]/)[1] || '');
                else if(line.includes('技巧')) block.tips.push(cleanText(line.split(/[：:]/)[1] || ''));
            }
            if(block.name) blocks.push(block);
        }
        return blocks;
    }
    
    function parseAdvancements(text) {
        const advs = [];
        const lines = text.split('\n');
        let current = null;
        for(const line of lines) {
            const trimmed = line.trim();
            if(trimmed.startsWith('【') && trimmed.includes('】')) {
                if(current && current.id) advs.push(current);
                current = { name: cleanText(trimmed), category: '', id: '', desc: '' };
            } else if(current && trimmed.includes('ID')) {
                current.id = cleanText(trimmed.split(/[：:]/)[1] || '');
            } else if(current && trimmed.includes('分类')) {
                current.category = cleanText(trimmed.split(/[：:]/)[1] || '');
            } else if(current && trimmed.includes('简介')) {
                current.desc = cleanText(trimmed.split(/[：:]/)[1] || '');
            }
        }
        if(current && current.id) advs.push(current);
        return advs;
    }
    
    function parseCommands(text, source) {
        const lines = text.split('\n');
        let current = null;
        for(let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const trimmed = line.trim();
            if(!trimmed || trimmed.startsWith('—')) continue;
            if(trimmed.startsWith('/') && !trimmed.includes('：') && !line.includes(':')) {
                if(current && current.name) {
                    data.commands.set(`${current.name}_${source}`, current);
                }
                current = { name: cleanText(trimmed.split(/\s+/)[0]), desc: '', syntax: cleanText(trimmed), source: source, examples: [] };
            } else if(current) {
                if(trimmed.startsWith('简介')) current.desc = cleanText(trimmed.substring(3));
                else if(trimmed.startsWith('语法')) current.syntax = cleanText(trimmed.substring(3));
                else if(trimmed.startsWith('>')) current.examples.push(cleanText(trimmed.substring(1)));
            }
        }
        if(current && current.name) {
            data.commands.set(`${current.name}_${source}`, current);
        }
    }
    
    function cleanText(text) {
        if(!text) return '';
        return text.replace(/【|】/g, '').replace(/[（(].*?[)）]/g, '').replace(/^\s*[-–—]\s*/g, '').trim();
    }
    
    // ==================== UI Helpers ====================
    function updateStats() {
        const total = data.commands.size + data.blocks.length + data.redstone.length + data.items.length + data.advancements.length;
        
        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-cmd').textContent = data.commands.size;
        document.getElementById('badge-cmd').textContent = data.commands.size;
        document.getElementById('badge-block').textContent = data.blocks.length;
        document.getElementById('badge-redstone').textContent = data.redstone.length;
        document.getElementById('badge-item').textContent = data.items.length;
        document.getElementById('badge-adv').textContent = data.advancements.length;
    }
    
    function updateFilters() {
        const container = document.getElementById('filters');
        if(!container) return;
        
        let html = '<div class="chip active" onclick="setFilter(\'all\', event)">全部</div>';
        
        if(currentTab === 'commands') {
            const versions = {};
            data.commands.forEach(c => { versions[c.source] = (versions[c.source] || 0) + 1; });
            Object.entries(versions).forEach(([v, n]) => {
                const name = { java: 'Java版', bedrock: '基岩版', education: '教育版', unknown: '未知' }[v] || v;
                html += `<div class="chip" onclick="setFilter('${v}', event)">${name} (${n})</div>`;
            });
        }
        
        container.innerHTML = html;
    }
    
    function setFilter(filter, eventObj) {
        currentFilter = filter;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        if(eventObj && eventObj.target) eventObj.target.classList.add('active');
        renderContent();
    }
    
    function handleSearch() { renderContent(); }
    
    function renderContent() {
        const keyword = (document.getElementById('searchInput')?.value || '').toLowerCase();
        const container = document.getElementById('mainContent');
        if(!container) return;
        
        let html = '';
        
        switch(currentTab) {
            case 'commands':
                const cmds = Array.from(data.commands.values()).filter(c => {
                    if(currentFilter !== 'all' && c.source !== currentFilter) return false;
                    return !keyword || c.name.toLowerCase().includes(keyword) || (c.desc && c.desc.toLowerCase().includes(keyword));
                });
                html = cmds.map(c => `
                    <div class="card card-cmd" onclick="showCommandDetail('${c.name}', '${c.source}')">
                        <div class="card-header">
                            <div class="card-title" style="color: var(--mc-green);">${c.name}</div>
                            <span class="tag">${{java: 'Java', bedrock: 'BE', education: 'Edu', unknown: '?' }[c.source] || c.source}</span>
                        </div>
                        <div class="card-desc">${c.desc || '暂无简介'}</div>
                    </div>
                `).join('');
                break;
                
            case 'blocks':
                const blocks = data.blocks.filter(b => !keyword || b.name.toLowerCase().includes(keyword));
                html = blocks.map(b => `
                    <div class="card card-block">
                        <div class="card-header">
                            <div class="card-title" style="color: var(--mc-orange);">${b.name}</div>
                            ${b.type ? `<span class="tag tag-orange">${b.type}</span>` : ''}
                        </div>
                        <div class="card-desc">${b.desc || ''}</div>
                    </div>
                `).join('');
                break;
                
            case 'redstone':
                const reds = data.redstone.filter(r => !keyword || r.name.toLowerCase().includes(keyword));
                html = reds.map(r => `
                    <div class="card card-redstone">
                        <div class="card-header">
                            <div class="card-title" style="color: var(--mc-red);">${r.name}</div>
                            ${r.type ? `<span class="tag tag-red">${r.type}</span>` : ''}
                        </div>
                        <div class="card-desc">${r.desc || ''}</div>
                    </div>
                `).join('');
                break;
                
            case 'items':
                const items = data.items.filter(i => !keyword || i.name.toLowerCase().includes(keyword) || i.id.toLowerCase().includes(keyword));
                html = items.map(i => `
                    <div class="card card-item">
                        <div class="card-header">
                            <div class="card-title" style="color: var(--mc-blue);">${i.name}</div>
                            ${i.category ? `<span class="tag tag-blue">${i.category}</span>` : ''}
                        </div>
                        <div class="id-block" onclick="event.stopPropagation(); copyText('${(i.id || '').replace(/'/g, "\\'")}')">${i.id}</div>
                        <div class="card-desc" style="margin-top: 8px;">${i.desc || ''}</div>
                    </div>
                `).join('');
                break;
                
            case 'advancements':
                const advs = data.advancements.filter(a => !keyword || a.id.toLowerCase().includes(keyword) || a.name.toLowerCase().includes(keyword));
                html = advs.map(a => `
                    <div class="card card-adv">
                        <div class="card-header">
                            <div>
                                ${a.category ? `<span class="tag tag-cyan" style="font-size: 0.7rem;">${a.category}</span>` : ''}
                                <div class="card-title" style="color: var(--mc-cyan); margin-top: 4px;">${a.name}</div>
                            </div>
                        </div>
                        <div class="id-block" onclick="event.stopPropagation(); copyText('${(a.id || '').replace(/'/g, "\\'")}')">${a.id}</div>
                        <div class="card-desc" style="margin-top: 8px;">${a.desc || ''}</div>
                    </div>
                `).join('');
                break;
        }
        
        if(html === '') {
            html = `<div class="empty-state">
                <div style="font-size: 3rem; margin-bottom: 12px;">🔍</div>
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 6px;">未找到数据</div>
                <div style="font-size: 0.85rem; color: #64748b;">请上传文件或更改搜索条件</div>
            </div>`;
        }
        
        container.innerHTML = html;
    }
    
    function showCommandDetail(name, source) {
        const cmd = data.commands.get(`${name}_${source}`);
        if(!cmd) return;
        
        const modal = document.getElementById('modal');
        const body = document.getElementById('modal-body');
        
        body.innerHTML = `
            <h2 style="font-family: VT323, monospace; font-size: 2rem; color: var(--mc-green); margin-bottom: 16px;">${cmd.name}</h2>
            <div style="margin-bottom: 16px;">
                <span class="tag">${{java: 'Java版', bedrock: '基岩版', education: '教育版'}[cmd.source] || cmd.source}</span>
            </div>
            <div style="margin-bottom: 16px;">
                <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 6px;">简介</div>
                <div>${cmd.desc || '暂无'}</div>
            </div>
            <div style="margin-bottom: 16px;">
                <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 6px;">语法</div>
                <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; color: var(--mc-gold);">${escapeHtml(cmd.syntax)}</div>
            </div>
            ${cmd.examples.length ? `
            <div>
                <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 6px;">示例</div>
                ${cmd.examples.map(e => `<div style="background: rgba(93,140,58,0.1); padding: 10px; border-radius: 6px; margin-bottom: 6px; font-family: 'JetBrains Mono', monospace; cursor: pointer;" onclick="copyText('${e.replace(/'/g, "\\'")}')">${e}</div>`).join('')}
            </div>` : ''}
            <div class="action-buttons" style="margin-top: 16px;">
                <button onclick="addToFavorites({id: Date.now(), type: 'command', content: '${cmd.syntax.replace(/'/g, "\\'")}', name: '${cmd.name}'})" class="btn btn-secondary">
                    <i class="fas fa-star"></i> ${t('add_favorite')}
                </button>
            </div>
        `;
        
        modal.style.display = 'block';
    }
    
    // ==================== File Handling ====================
    function selectFiles() {
        document.getElementById('fileInput')?.click();
    }
    
    function setupDragDrop() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        if(!dropZone || !fileInput) return;
        
        fileInput.onchange = async (e) => {
            for(const file of e.target.files) {
                const text = await file.text();
                processContent(text, file.name);
            }
            showToast('文件已导入');
        };
        
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--mc-green)'; };
        dropZone.ondragleave = () => { dropZone.style.borderColor = 'rgba(93,140,58,0.3)'; };
        dropZone.ondrop = async (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'rgba(93,140,58,0.3)';
            for(const file of e.dataTransfer.files) {
                if(file.name.endsWith('.zip')) {
                    const zip = await JSZip.loadAsync(file);
                    for(const [name, zipFile] of Object.entries(zip.files)) {
                        if(name.endsWith('.txt')) {
                            const content = await zipFile.async('text');
                            processContent(content, name);
                        }
                    }
                } else {
                    const text = await file.text();
                    processContent(text, file.name);
                }
            }
            showToast('文件已导入');
        };
    }
    
    function clearAllData() {
        if(!confirm('确定要清空所有数据吗？')) return;
        data.commands.clear();
        data.blocks = [];
        data.redstone = [];
        data.items = [];
        data.advancements = [];
        localStorage.removeItem(STORAGE_KEY);
        updateStats();
        updateFilters();
        renderContent();
        showToast('数据已清空');
    }
    
    function saveToStorage() {
        try {
            const saveData = {
                commands: Array.from(data.commands.entries()),
                blocks: data.blocks,
                redstone: data.redstone,
                items: data.items,
                advancements: data.advancements
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
        } catch(e) { console.error('保存失败:', e); }
    }
    
    function loadFromStorage() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                const parsed = JSON.parse(saved);
                if(parsed.commands) parsed.commands.forEach(([k,v]) => data.commands.set(k,v));
                if(parsed.blocks) data.blocks = parsed.blocks;
                if(parsed.redstone) data.redstone = parsed.redstone;
                if(parsed.items) data.items = parsed.items;
                if(parsed.advancements) data.advancements = parsed.advancements;
                updateStats();
            }
        } catch(e) { console.error('加载失败:', e); }
    }
    
    // ==================== Utilities ====================
    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => showToast(t('copied') || '已复制'));
    }
    
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2500);
    }
    
    function closeModal(e) {
        if(!e || e.target.id === 'modal') {
            document.getElementById('modal').style.display = 'none';
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function initParticles() {
        const container = document.getElementById('particles');
        if(!container) return;
        
        for(let i = 0; i < 30; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + '%';
            p.style.animationDelay = Math.random() * 15 + 's';
            p.style.animationDuration = (12 + Math.random() * 15) + 's';
            container.appendChild(p);
        }
    }
    
    // ==================== Initialization ====================
    window.onload = function() {
        initI18n();
        initParticles();
        loadTheme();
        loadFavorites();
        loadFromStorage();
        
        // Init sidebar toggle for mobile
        if(window.innerWidth <= 1024) {
            document.querySelector('.sidebar')?.classList.remove('open');
        }
        
        renderMainContent();
    };
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') {
            closeModal();
            if(window.innerWidth <= 1024) {
                document.getElementById('sidebar')?.classList.remove('open');
                document.getElementById('overlay')?.classList.remove('show');
            }
        }
    });
    </script>
</body>
</html>
